"use strict";function e(e,t,i,r){return new(i||(i=Promise))((function(s,n){function o(e){try{f(r.next(e))}catch(e){n(e)}}function a(e){try{f(r.throw(e))}catch(e){n(e)}}function f(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}f((r=r.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const t=["requestFullscreen","webkitRequestFullscreen","mozRequestFullScreen","msRequestFullscreen"],i=["fullscreenchange","webkitfullscreenchange","mozfullscreenchange","msfullscreenchange"],r=new class{constructor(){this._onFullScreenChangeCallbacks=[],this._isInitialized=!1}_initialize(){if(this._isInitialized)return;this._isInitialized=!0;const e=()=>{this._onFullScreenChangeCallbacks.forEach((e=>e()))};for(const t of i)document.addEventListener(t,e,!1)}isCompatible(e){for(const i of t)if(i in e)return!0;return!1}isFullScreen(e){return document.fullscreenElement===e}requestFullScreen(i){return e(this,void 0,void 0,(function*(){if(this.isFullScreen(i))return{success:!1,message:"element already in full screen"};this._initialize();for(const e of t)if(e in i)return i[e](),{success:!0,message:"request for full screen done"};return{success:!1,message:"unsupported request for full screen"}}))}addOnFullScreenChange(e){this._onFullScreenChangeCallbacks.push(e)}removeOnFullScreenChange(e){const t=this._onFullScreenChangeCallbacks.indexOf(e);t<0||this._onFullScreenChangeCallbacks.splice(t,1)}removeAllCallbacks(){this._onFullScreenChangeCallbacks.length=0}},s={Num0:48,Num1:49,Num2:50,Num3:51,Num4:52,Num5:53,Num6:54,Num7:55,Num8:56,Num9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,Semicolon:186,Equal:187,Comma:188,Minus:189,Period:190,BackQuote:192,BracketLeft:219,Backslash:220,BracketRight:221,Quote:222,Shift:16,Ctrl:17,Alt:18,CapsLock:20,Tab:9,Enter:13,Pause:19,Escape:27,Space:32,PageUp:33,PageDown:34,End:35,Home:36,ArrowLeft:37,ArrowUp:38,ArrowRight:39,ArrowDown:40,PrintScreen:44,Insert:45,Delete:46,ContextMenu:93,ScrollLock:145,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,F13:124,F14:125,F15:126,F16:127,F17:128,F18:129,F19:130,F20:131,F21:132,F22:133,F23:134,F24:135,NumPad0:96,NumPad1:97,NumPad2:98,NumPad3:99,NumPad4:100,NumPad5:101,NumPad6:102,NumPad7:103,NumPad8:104,NumPad9:105,NumPadMultiply:106,NumPadAdd:107,NumPadSubtract:109,NumPadDecimal:110,NumPadDivide:111,NumLock:144,NumPadComma:194,NumPadEqual:12},n=e=>e>=s.A&&e<=s.Z,o=e=>e>=s.Num0&&e<=s.Num9||e>=s.NumPad0&&e<=s.NumPad9,a=new class{constructor(){this._pressedKeysSet=new Set,this._preventDefaultKeysSet=new Set,this._activated=!1,this._activated=!1,this._handleKeyDown=(e=>{const{keyCode:t}=e;this._onEvent&&this._onEvent(),this._preventDefaultKeysSet.has(t)&&e.preventDefault(),this._pressedKeysSet.add(t)}).bind(this),this._handleKeyUp=(e=>{const{keyCode:t}=e;this._onEvent&&this._onEvent(),this._preventDefaultKeysSet.has(t)&&e.preventDefault(),this._pressedKeysSet.delete(t)}).bind(this)}isPressed(...e){for(const t of e)if(this._pressedKeysSet.has(s[t]))return!0;return!1}preventDefault(e){this._preventDefaultKeysSet.add(s[e])}enableDefault(e){this._preventDefaultKeysSet.delete(s[e])}activate(){this._activated||(this._pressedKeysSet.clear(),document.addEventListener("keydown",this._handleKeyDown),document.addEventListener("keyup",this._handleKeyUp),this._activated=!0)}deactivate(){this._activated&&(this._pressedKeysSet.clear(),document.removeEventListener("keydown",this._handleKeyDown),document.removeEventListener("keyup",this._handleKeyUp),this._activated=!1)}onEvent(e){this._onEvent=e}},f={Left:0,Middle:1,Right:2},d=new class{constructor(){this._pressedButtonsSet=new Set,this._activated=!1,this._positionX=0,this._positionY=0,this._deltaX=0,this._deltaY=0,this._wheelDeltaY=0,this._activated=!1,this._handleMouseDown=(e=>{this._onEvent&&this._onEvent(),this._positionX=e.pageX,this._positionY=e.pageY,this._pressedButtonsSet.add(e.button)}).bind(this),this._handleMouseUp=(e=>{this._onEvent&&this._onEvent(),this._positionX=e.pageX,this._positionY=e.pageY,this._pressedButtonsSet.delete(e.button)}).bind(this),this._handleMouseMove=(e=>{this._onEvent&&this._onEvent(),this._positionX=e.pageX,this._positionY=e.pageY,this._deltaX+=e.movementX||e.mozMovementX||e.webkitMovementX||0,this._deltaY+=e.movementY||e.mozMovementY||e.webkitMovementY||0}).bind(this),this._handleMouseWheel=(e=>{this._onEvent&&this._onEvent(),this._wheelDeltaY+=e.deltaY||0}).bind(this)}activate(e){this._activated||(this._pressedButtonsSet.clear(),e.addEventListener("mousedown",this._handleMouseDown),e.addEventListener("mouseup",this._handleMouseUp),e.addEventListener("mousemove",this._handleMouseMove),e.addEventListener("wheel",this._handleMouseWheel),this._activated=!0)}deactivate(e){this._activated&&(this._pressedButtonsSet.clear(),e.removeEventListener("mousedown",this._handleMouseDown),e.removeEventListener("mouseup",this._handleMouseUp),e.removeEventListener("mousemove",this._handleMouseMove),e.removeEventListener("wheel",this._handleMouseWheel),this._activated=!1)}isButtonPressed(e){return this._pressedButtonsSet.has(f[e])}get positionX(){return this._positionX}get positionY(){return this._positionY}deltaX(){return this._deltaX}deltaY(){return this._deltaY}wheelDeltaY(){return this._wheelDeltaY}resetDeltas(){this._deltaX=0,this._deltaY=0,this._wheelDeltaY=0}onEvent(e){this._onEvent=e}},h=["requestPointerLock","mozRequestPointerLock","webkitRequestPointerLock"],c=["exitPointerLock","mozExitPointerLock","webkitExitPointerLock"],u=["pointerLockElement","mozPointerLockElement","webkitPointerLockElement"],_=[{methodName:"onpointerlockchange",propertyName:"pointerlockchange"},{methodName:"onmozpointerlockchange",propertyName:"mozpointerlockchange"},{methodName:"onwebkitpointerlockchange",propertyName:"webkitpointerlockchange"}],l=[{methodName:"onpointerlockerror",propertyName:"pointerlockerror"},{methodName:"onmozpointerlockerror",propertyName:"mozpointerlockerror"},{methodName:"onwebkitpointerlockerror",propertyName:"webkitpointerlockerror"}],p=new class{constructor(){this._onLockChangeCallbacks=[],this._onLockErrorCallbacks=[],this._timeSinceLastLockChange=0,this._isInitialized=!1}_initialize(){if(this._isInitialized)return;this._isInitialized=!0;const e=()=>{this._timeSinceLastLockChange=Date.now(),this._onLockChangeCallbacks.forEach((e=>e()))},t=e=>{this._timeSinceLastLockChange=Date.now(),this._onLockErrorCallbacks.forEach((t=>t(e)))};for(const t of _)if(t.methodName in document){document.addEventListener(t.propertyName,e,!1);break}for(const e of l)if(e.methodName in document){document.addEventListener(e.propertyName,t,!1);break}}canBePointerLocked(e){for(const t of h)if(t in e)return!0;return!1}isPointerLocked(e){for(const t of u)if(t in document)return document[t]===e;return!1}requestPointerLock(t){return e(this,void 0,void 0,(function*(){if(this.isPointerLocked(t))return{success:!1,message:"element already locked"};if(this._initialize(),this._timeSinceLastLockChange>0){const e=(Date.now()-this._timeSinceLastLockChange)/1e3;if(e<1.1)return{success:!1,message:`request for lock was too early, time to wait: ${e.toFixed(2)}sec`}}this._timeSinceLastLockChange=Date.now();for(const e of h)if(e in t){const i={unadjustedMovement:!1};try{yield t[e](i)}catch(e){return{success:!1,message:`request for lock was too early, time to wait: ${((Date.now()-this._timeSinceLastLockChange)/1e3).toFixed(2)}sec`}}return this._timeSinceLastLockChange=Date.now(),{success:!0,message:"request for lock done"}}return{success:!1,message:"unsupported request for lock"}}))}allowPointerLockedOnClickEvent(t){if(t===this._latestRequestHtmlElement)return;this._latestRequestHtmlElement=t;const i=()=>e(this,void 0,void 0,(function*(){t.removeEventListener("click",i);const e=yield this.requestPointerLock(t);this._latestRequestHtmlElement=void 0,e.success||this.allowPointerLockedOnClickEvent(t)}));t.addEventListener("click",i)}exitPointerLock(){for(const e of c)if(e in document){document[e]();break}}addOnLockChange(e){this._onLockChangeCallbacks.push(e)}removeOnLockChange(e){const t=this._onLockChangeCallbacks.indexOf(e);t<0||this._onLockChangeCallbacks.splice(t,1)}addOnLockError(e){this._onLockErrorCallbacks.push(e)}removeOnLockError(e){const t=this._onLockErrorCallbacks.indexOf(e);t<0||this._onLockErrorCallbacks.splice(t,1)}removeAllCallbacks(){this._onLockChangeCallbacks.length=0,this._onLockErrorCallbacks.length=0}};class m{constructor(e,t,i){this.createdAt=Date.now(),this.deltaX=0,this.deltaY=0,this.id=e,this.positionX=t,this.positionY=i}resetDelta(){this.deltaX=0,this.deltaY=0}}const g=new class{constructor(){this._activated=!1,this._allTouchDataMap=new Map,this._allCachedTouchDataArray=[],this._activated=!1,this._handleTouchStart=(e=>{e.preventDefault(),this._onEvent&&this._onEvent();for(let t=0;t<e.changedTouches.length;++t){const{identifier:i,pageX:r,pageY:s}=e.changedTouches[t],n=new m(i,r,s);this._allTouchDataMap.set(`${i}`,n),this._allCachedTouchDataArray.length=0}}).bind(this),this._handleTouchEnd=(e=>{e.preventDefault(),this._onEvent&&this._onEvent();for(let t=0;t<e.changedTouches.length;++t){const{identifier:i}=e.changedTouches[t];this._allTouchDataMap.delete(`${i}`),this._allCachedTouchDataArray.length=0}}).bind(this),this._handleTouchMove=(e=>{e.preventDefault(),this._onEvent&&this._onEvent();for(let t=0;t<e.changedTouches.length;++t){const{identifier:i,pageX:r,pageY:s}=e.changedTouches[t],n=this._allTouchDataMap.get(`${i}`);if(!n)continue;const o=r-n.positionX,a=s-n.positionY;n.deltaX+=o,n.deltaY+=a,n.positionX=r,n.positionY=s}}).bind(this)}isSupported(e){return"ontouchstart"in e}activate(e){this.isSupported(e)&&(this._activated||(this._allTouchDataMap.clear(),this._allCachedTouchDataArray.length=0,e.addEventListener("touchstart",this._handleTouchStart),e.addEventListener("touchend",this._handleTouchEnd),e.addEventListener("touchcancel",this._handleTouchEnd),e.addEventListener("touchmove",this._handleTouchMove,{passive:!1}),this._activated=!0))}deactivate(e){this._activated&&(this._allTouchDataMap.clear(),this._allCachedTouchDataArray.length=0,e.removeEventListener("touchstart",this._handleTouchStart),e.removeEventListener("touchend",this._handleTouchEnd),e.removeEventListener("touchcancel",this._handleTouchEnd),e.removeEventListener("touchmove",this._handleTouchMove),this._activated=!1)}_refreshCache(){0===this._allCachedTouchDataArray.length&&(this._allCachedTouchDataArray=[...this._allTouchDataMap.values()])}getTouchData(){return this._refreshCache(),this._allCachedTouchDataArray}resetDeltas(){this._refreshCache(),this._allCachedTouchDataArray.forEach((e=>e.resetDelta()))}onEvent(e){this._onEvent=e}},b=new class{constructor(){this._activated=!1,this._onVisibilityChangeCallbacks=[],this._handleVisibilityChange=(()=>{const e=this.isVisible();this._onVisibilityChangeCallbacks.forEach((t=>t(e)))}).bind(this)}activate(){this.isSupported()&&(this._activated||(document.addEventListener("visibilitychange",this._handleVisibilityChange,!1),this._activated=!0))}deactivate(){this._activated&&(document.removeEventListener("visibilitychange",this._handleVisibilityChange,!1),this._activated=!1)}isSupported(){return"onvisibilitychange"in document}isVisible(){return"visible"===document.visibilityState}addVisibilityChange(e){this._onVisibilityChangeCallbacks.push(e)}removeVisibilityChange(e){const t=this._onVisibilityChangeCallbacks.indexOf(e);t<0||this._onVisibilityChangeCallbacks.splice(t,1)}removeAllCallbacks(){this._onVisibilityChangeCallbacks.length=0}};var x=Object.freeze({__proto__:null,AllKeyCodes:s,GlobalFullScreenManager:r,GlobalKeyboardManager:a,GlobalMouseManager:d,GlobalPointerLockManager:p,GlobalTouchManager:g,GlobalVisibilityManager:b,isAlphanumeric:e=>o(e)||n(e),isLetter:n,isNumber:o,isWebGL2Supported:()=>!!window.WebGL2RenderingContext,isWebWorkerSupported:()=>!!window.Worker}),v=1e-6,E="undefined"!=typeof Float32Array?Float32Array:Array;function w(){var e=new E(16);return E!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function T(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function S(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function C(e,t,i){var r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],f=t[5],d=t[6],h=t[7],c=t[8],u=t[9],_=t[10],l=t[11],p=t[12],m=t[13],g=t[14],b=t[15],x=i[0],v=i[1],E=i[2],w=i[3];return e[0]=x*r+v*a+E*c+w*p,e[1]=x*s+v*f+E*u+w*m,e[2]=x*n+v*d+E*_+w*g,e[3]=x*o+v*h+E*l+w*b,x=i[4],v=i[5],E=i[6],w=i[7],e[4]=x*r+v*a+E*c+w*p,e[5]=x*s+v*f+E*u+w*m,e[6]=x*n+v*d+E*_+w*g,e[7]=x*o+v*h+E*l+w*b,x=i[8],v=i[9],E=i[10],w=i[11],e[8]=x*r+v*a+E*c+w*p,e[9]=x*s+v*f+E*u+w*m,e[10]=x*n+v*d+E*_+w*g,e[11]=x*o+v*h+E*l+w*b,x=i[12],v=i[13],E=i[14],w=i[15],e[12]=x*r+v*a+E*c+w*p,e[13]=x*s+v*f+E*u+w*m,e[14]=x*n+v*d+E*_+w*g,e[15]=x*o+v*h+E*l+w*b,e}function R(e,t,i,r){var s,n,o,a,f,d,h,c,u,_,l,p,m,g,b,x,E,w,T,S,C,R,A,y,k=r[0],D=r[1],P=r[2],z=Math.hypot(k,D,P);return z<v?null:(k*=z=1/z,D*=z,P*=z,s=Math.sin(i),o=1-(n=Math.cos(i)),a=t[0],f=t[1],d=t[2],h=t[3],c=t[4],u=t[5],_=t[6],l=t[7],p=t[8],m=t[9],g=t[10],b=t[11],x=k*k*o+n,E=D*k*o+P*s,w=P*k*o-D*s,T=k*D*o-P*s,S=D*D*o+n,C=P*D*o+k*s,R=k*P*o+D*s,A=D*P*o-k*s,y=P*P*o+n,e[0]=a*x+c*E+p*w,e[1]=f*x+u*E+m*w,e[2]=d*x+_*E+g*w,e[3]=h*x+l*E+b*w,e[4]=a*T+c*S+p*C,e[5]=f*T+u*S+m*C,e[6]=d*T+_*S+g*C,e[7]=h*T+l*S+b*C,e[8]=a*R+c*A+p*y,e[9]=f*R+u*A+m*y,e[10]=d*R+_*A+g*y,e[11]=h*R+l*A+b*y,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)}function A(){var e=new E(3);return E!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function y(e,t,i){var r=new E(3);return r[0]=e,r[1]=t,r[2]=i,r}function k(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function D(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e}function P(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e}function z(e,t,i){var r=t[0],s=t[1],n=t[2],o=i[3]*r+i[7]*s+i[11]*n+i[15];return o=o||1,e[0]=(i[0]*r+i[4]*s+i[8]*n+i[12])/o,e[1]=(i[1]*r+i[5]*s+i[9]*n+i[13])/o,e[2]=(i[2]*r+i[6]*s+i[10]*n+i[14])/o,e}function M(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var L,F=function(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e};function U(e,t,i,r){var s=new E(4);return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function B(){var e=new E(4);return E!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function I(){var e=new E(2);return E!=Float32Array&&(e[0]=0,e[1]=0),e}function N(e,t){var i=new E(2);return i[0]=e,i[1]=t,i}A(),function(){var e;e=new E(4),E!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0)}(),A(),y(1,0,0),y(0,1,0),B(),B(),L=new E(9),E!=Float32Array&&(L[1]=0,L[2]=0,L[3]=0,L[5]=0,L[6]=0,L[7]=0),L[0]=1,L[4]=1,L[8]=1,I();const X=e=>e*Math.PI/180,G={X:0,Y:1,Z:2};class V{constructor(e){this._isActivated=!1,this._theta=0,this._phi=0,this._touchWasActive=!1,this._touchStartTime=0,this._touchMoveForward=!1,this._position=y(0,0,0),this._target=y(0,0,0),this._forwardAxis=y(1,0,0),this._leftAxis=y(0,0,1),this._upAxis=y(0,1,0),this._move_forwardAxis=y(1,0,0),this._move_leftAxis=y(0,0,1),this._move_upAxis=y(0,1,0),this._mouseSensibility=e.mouseSensibility,this._keyboardSensibility=e.keyboardSensibility,this._touchSensibility=e.touchSensibility,this._movingSpeed=e.movingSpeed,k(this._position,e.position),this._axisIndices=[e.coordinates?G[e.coordinates[0]]:G.X,e.coordinates?G[e.coordinates[1]]:G.Y,e.coordinates?G[e.coordinates[2]]:G.Z],this._theta=e.theta,this._phi=e.phi}isActivated(){return this._isActivated}activate(){this._isActivated=!0,a.preventDefault("Z"),a.preventDefault("W"),a.preventDefault("S"),a.preventDefault("A"),a.preventDefault("Q"),a.preventDefault("D"),a.preventDefault("Shift"),a.preventDefault("C"),a.preventDefault("Space"),a.preventDefault("ArrowUp"),a.preventDefault("ArrowDown"),a.preventDefault("ArrowLeft"),a.preventDefault("ArrowRight")}deactivate(){this._isActivated=!1,a.enableDefault("Z"),a.enableDefault("W"),a.enableDefault("S"),a.enableDefault("A"),a.enableDefault("Q"),a.enableDefault("D"),a.enableDefault("Shift"),a.enableDefault("C"),a.enableDefault("Space"),a.enableDefault("ArrowUp"),a.enableDefault("ArrowDown"),a.enableDefault("ArrowLeft"),a.enableDefault("ArrowRight")}isInteractedWith(){return a.isPressed("Z","W","S","A","Q","D")||a.isPressed("Shift","C","Space")||a.isPressed("ArrowUp","ArrowDown","ArrowLeft","ArrowRight")}update(e,t=!1){let i=!1,r=!1,s=!1,n=!1,o=!1,f=!1,h=!1,c=0,u=0;{const t=d.deltaX()*this._mouseSensibility,i=d.deltaY()*this._mouseSensibility;c-=X(t)*e,u-=X(i)*e}const _=g.getTouchData().length>0;if(_){if(!this._touchWasActive){const e=Date.now();(e-this._touchStartTime)/1e3<.25?this._touchMoveForward=!0:this._touchStartTime=e}const t=g.getTouchData()[0],i=t.deltaX*this._touchSensibility,r=t.deltaY*this._touchSensibility;c-=X(i)*e,u-=X(r)*e}else this._touchMoveForward=!1;this._touchWasActive=_,this._touchMoveForward&&(i=!0),a.isPressed("Z","W")&&(i=!0),a.isPressed("S")&&(r=!0),a.isPressed("A","Q")&&(s=!0),a.isPressed("D")&&(n=!0),a.isPressed("Shift")&&(o=!0),t||(a.isPressed("C")&&(f=!0),a.isPressed("Space")&&(h=!0));const l=this._movingSpeed*(o?4:1)*e,p=this._keyboardSensibility*e;a.isPressed("ArrowUp")?u+=p:a.isPressed("ArrowDown")&&(u-=p),a.isPressed("ArrowLeft")?c+=p:a.isPressed("ArrowRight")&&(c-=p),this._theta+=c,this._phi+=u;const m=.5*Math.PI,b=.95*m;this._phi=Math.min(Math.max(this._phi,-b),+b);const x=Math.cos(this._theta),v=Math.sin(this._theta),[E,w,T]=this._axisIndices,S=Math.cos(this._phi+m);this._upAxis[E]=S*x,this._upAxis[w]=S*v,this._upAxis[T]=Math.sin(this._phi+m);const C=Math.cos(this._phi);this._forwardAxis[E]=C*x,this._forwardAxis[w]=C*v,this._forwardAxis[T]=Math.sin(this._phi),function(e,t,i){var r=t[0],s=t[1],n=t[2],o=i[0],a=i[1],f=i[2];e[0]=s*f-n*a,e[1]=n*o-r*f,e[2]=r*a-s*o}(this._leftAxis,this._upAxis,this._forwardAxis),t?(this._move_forwardAxis[E]=x,this._move_forwardAxis[w]=v,this._move_forwardAxis[T]=0,this._move_leftAxis[E]=-v,this._move_leftAxis[w]=x,this._move_leftAxis[T]=0,this._move_upAxis[E]=0,this._move_upAxis[w]=0,this._move_upAxis[T]=1):(k(this._move_forwardAxis,this._forwardAxis),k(this._move_leftAxis,this._leftAxis),k(this._move_upAxis,this._upAxis));const R=y(0,0,0);P(R,this._move_forwardAxis,l);const A=y(0,0,0);P(A,this._move_leftAxis,l);const z=y(0,0,0);P(z,this._move_upAxis,l),i?D(this._position,this._position,R):r&&F(this._position,this._position,R),s?D(this._position,this._position,A):n&&F(this._position,this._position,A),h?D(this._position,this._position,z):f&&F(this._position,this._position,z),D(this._target,this._position,this._forwardAxis)}getPosition(){return this._position}setPosition(e){k(this._position,e),D(this._target,this._position,this._forwardAxis)}getTarget(){return this._target}getUpAxis(){return this._upAxis}getTheta(){return this._theta}getPhi(){return this._phi}getTouchMoveForward(){return this._touchMoveForward}}class O{constructor(){this._framesDelta=[],this._averageDelta=0,this._minDelta=0,this._maxDelta=0}pushDelta(e){this._framesDelta.length>=100&&this._framesDelta.shift(),this._framesDelta.push(e),this._minDelta=999999999,this._maxDelta=-999999999,this._averageDelta=0;for(const e of this._framesDelta)this._minDelta=Math.min(this._minDelta,e),this._maxDelta=Math.max(this._maxDelta,e),this._averageDelta+=e;this._averageDelta/=this._framesDelta.length}get framesDelta(){return this._framesDelta}get averageDelta(){return this._averageDelta}get minDelta(){return this._minDelta}get maxDelta(){return this._maxDelta}}var W,Y;!function(e){e[e.perspective=0]="perspective",e[e.orthogonal=1]="orthogonal"}(W||(W={}));class ${constructor(){this._projectionType=W.perspective,this._viewportPos=N(0,0),this._viewportSize=N(0,0),this._projectionMatrix=w(),this._viewMatrix=w(),this._composedMatrix=w(),this._eye=y(0,0,0),this._target=y(0,0,0),this._upAxis=y(0,0,0)}setAsPerspective(e){this._projectionType=W.perspective;let t=e.aspectRatio;void 0===t&&(t=this._viewportSize[0]/this._viewportSize[1]),this._perspectiveData={fovy:e.fovy,aspectRatio:t,near:e.near,far:e.far}}setAsOrthogonal(e){this._projectionType=W.orthogonal,this._orthogonalData=Object.assign({},e)}setViewportPos(e,t){this._viewportPos[0]=e,this._viewportPos[1]=t}getViewportPos(){return this._viewportPos}setViewportSize(e,t){this._viewportSize[0]=e,this._viewportSize[1]=t,this._projectionType!==W.perspective&&this._perspectiveData&&(this._perspectiveData.aspectRatio=this._viewportSize[0]/this._viewportSize[1])}getViewportSize(){return this._viewportSize}lookAt(e,t,i){this.setEye(e),this.setTarget(t),this.setUpAxis(i)}setEye(e){k(this._eye,e)}setTarget(e){k(this._target,e)}setUpAxis(e){k(this._upAxis,e)}getEye(){return this._eye}getTarget(){return this._target}getUpAxis(){return this._upAxis}computeMatrices(){if(this._projectionType===W.perspective){const{fovy:e,aspectRatio:t,near:i,far:r}=this._perspectiveData;!function(e,t,i,r,s){var n,o=1/Math.tan(t/2);e[0]=o/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=s&&s!==1/0?(n=1/(r-s),e[10]=(s+r)*n,e[14]=2*s*r*n):(e[10]=-1,e[14]=-2*r)}(this._projectionMatrix,X(e),t,i,r)}else if(this._projectionType===W.orthogonal){const{left:e,right:t,top:i,bottom:r,near:s,far:n}=this._orthogonalData;!function(e,t,i,r,s,n,o){var a=1/(t-i),f=1/(r-s),d=1/(n-o);e[0]=-2*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*f,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*d,e[11]=0,e[12]=(t+i)*a,e[13]=(s+r)*f,e[14]=(o+n)*d,e[15]=1}(this._projectionMatrix,e,t,i,r,s,n)}!function(e,t,i,r){var s,n,o,a,f,d,h,c,u,_,l=t[0],p=t[1],m=t[2],g=r[0],b=r[1],x=r[2],E=i[0],w=i[1],T=i[2];Math.abs(l-E)<v&&Math.abs(p-w)<v&&Math.abs(m-T)<v?S(e):(h=l-E,c=p-w,u=m-T,s=b*(u*=_=1/Math.hypot(h,c,u))-x*(c*=_),n=x*(h*=_)-g*u,o=g*c-b*h,(_=Math.hypot(s,n,o))?(s*=_=1/_,n*=_,o*=_):(s=0,n=0,o=0),a=c*o-u*n,f=u*s-h*o,d=h*n-c*s,(_=Math.hypot(a,f,d))?(a*=_=1/_,f*=_,d*=_):(a=0,f=0,d=0),e[0]=s,e[1]=a,e[2]=h,e[3]=0,e[4]=n,e[5]=f,e[6]=c,e[7]=0,e[8]=o,e[9]=d,e[10]=u,e[11]=0,e[12]=-(s*l+n*p+o*m),e[13]=-(a*l+f*p+d*m),e[14]=-(h*l+c*p+u*m),e[15]=1)}(this._viewMatrix,this._eye,this._target,this._upAxis),this.computeComposedMatrix()}computeComposedMatrix(){C(this._composedMatrix,this._projectionMatrix,this._viewMatrix)}setProjectionMatrix(e){T(this._projectionMatrix,e)}setViewMatrix(e){T(this._viewMatrix,e)}setComposedMatrix(e){T(this._composedMatrix,e)}getProjectionMatrix(){return this._projectionMatrix}getViewMatrix(){return this._viewMatrix}getComposedMatrix(){return this._composedMatrix}getPerspectiveData(){if(this._projectionType!==W.perspective)throw new Error("not a perspective projection");return this._perspectiveData}getOrthogonalData(){if(this._projectionType!==W.orthogonal)throw new Error("not an orthogonal projection");return this._orthogonalData}}!function(e){e[e.Right=0]="Right",e[e.Left=1]="Left",e[e.Bottom=2]="Bottom",e[e.Top=3]="Top",e[e.Back=4]="Back",e[e.Front=5]="Front"}(Y||(Y={}));class H{constructor(){this._frustum=new Float32Array(24)}_setPlane(e,t,i,r){const s=4*e;this._frustum[s+0]=t[0]+i[0]*r,this._frustum[s+1]=t[1]+i[1]*r,this._frustum[s+2]=t[2]+i[2]*r,this._frustum[s+3]=t[3]+i[3]*r;const n=Math.sqrt(this._frustum[s+0]*this._frustum[s+0]+this._frustum[s+1]*this._frustum[s+1]+this._frustum[s+2]*this._frustum[s+2]);0!==n&&(this._frustum[s+0]/=n,this._frustum[s+1]/=n,this._frustum[s+2]/=n,this._frustum[s+3]/=n)}calculateFrustum(e,t){const i=C(w(),e,t),r=U(i[0],i[4],i[8],i[12]),s=U(i[1],i[5],i[9],i[13]),n=U(i[2],i[6],i[10],i[14]),o=U(i[3],i[7],i[11],i[15]);this._setPlane(Y.Right,o,r,-1),this._setPlane(Y.Left,o,r,1),this._setPlane(Y.Bottom,o,s,1),this._setPlane(Y.Top,o,s,-1),this._setPlane(Y.Back,o,n,-1),this._setPlane(Y.Front,o,n,1)}sphereInFrustum(e,t,i,r){for(let s=0;s<6;++s){const n=4*s;if(this._frustum[n+0]*e+this._frustum[n+1]*t+this._frustum[n+2]*i+this._frustum[n+3]<=-r)return!1}return!0}pointInFrustum(e,t,i){return this.sphereInFrustum(e,t,i,0)}cubeInFrustumVec3(e,t){return this.cubeInFrustum(e[0],e[1],e[2],t)}cubeInFrustum(e,t,i,r){const s=.5*r,n=e-s,o=t-s,a=i-s,f=e+s,d=t+s,h=i+s;for(let e=0;e<6;++e){const t=4*e,i=this._frustum[t+0],r=this._frustum[t+1],s=this._frustum[t+2],c=this._frustum[t+3];if(!(i*n+r*o+s*a+c>0||i*f+r*o+s*a+c>0||i*n+r*d+s*a+c>0||i*f+r*d+s*a+c>0||i*n+r*o+s*h+c>0||i*f+r*o+s*h+c>0||i*n+r*d+s*h+c>0||i*f+r*d+s*h+c>0))return!1}return!0}}let j=class e{static initialize(t){if(e._gl=t.getContext("webgl2",{alpha:!1,antialias:!1,depth:!0,failIfMajorPerformanceCaveat:!1,powerPreference:"high-performance",premultipliedAlpha:!0,preserveDrawingBuffer:!0,desynchronized:!0,stencil:!1}),!e._gl)throw new Error("could not create webgl context");e._extensionLoseContext=e._gl.getExtension("WEBGL_lose_context"),e._gl.getExtension("EXT_color_buffer_float"),e._gl.getExtension("EXT_float_blend")}static getContext(){if(!e._gl)throw new Error("webgl context not initialized");return e._gl}static getExtensionLoseContext(){return e._extensionLoseContext}static getExtensionLoseContextStrict(){if(!e._extensionLoseContext)throw new Error("lose context extension not available");return e._extensionLoseContext}};var q;j._gl=null,j._extensionLoseContext=null,function(e){e[e.positiveX=0]="positiveX",e[e.negativeX=1]="negativeX",e[e.positiveY=2]="positiveY",e[e.negativeY=3]="negativeY",e[e.positiveZ=4]="positiveZ",e[e.negativeZ=5]="negativeZ"}(q||(q={}));const Z=e=>{const t=j.getContext();switch(e){case q.positiveX:return t.TEXTURE_CUBE_MAP_POSITIVE_X;case q.negativeX:return t.TEXTURE_CUBE_MAP_NEGATIVE_X;case q.positiveY:return t.TEXTURE_CUBE_MAP_POSITIVE_Y;case q.negativeY:return t.TEXTURE_CUBE_MAP_NEGATIVE_Y;case q.positiveZ:return t.TEXTURE_CUBE_MAP_POSITIVE_Z;case q.negativeZ:return t.TEXTURE_CUBE_MAP_NEGATIVE_Z}};class K{constructor(){this._width=0,this._height=0,this._minBufferSize=0,this._texture=null}initialize(e,t){if(e<1)throw new Error(`cube map: width is < 1, input: ${e}`);if(t<1)throw new Error(`cube map: height is < 1, input: ${t}`);const i=j.getContext();this._texture=i.createTexture(),this._width=e,this._height=t,this._minBufferSize=this._width*this._height*4}dispose(){j.getContext().deleteTexture(this._texture)}rawBind(){if(!this._texture)throw new Error("cube map: not initialized");const e=j.getContext();e.bindTexture(e.TEXTURE_CUBE_MAP,this._texture)}bind(e){this.rawBind(),e(this),K.unbind()}static unbind(){const e=j.getContext();e.bindTexture(e.TEXTURE_CUBE_MAP,null)}loadFromMemory(e,t){if(!this._texture)throw new Error("cube map: not initialized");if(t.length<this._minBufferSize)throw new Error(`cube map: miss-matching pixels buffer size, input: ${t.length}`);const i=j.getContext(),r=i.RGBA,s=i.RGBA,n=i.UNSIGNED_BYTE;i.texImage2D(Z(e),0,r,this._width,this._height,0,s,n,t)}allocate(){const e=j.getContext(),t=e.RGBA,i=e.RGBA,r=e.UNSIGNED_BYTE,s=new Uint8Array(this._width*this._height*4);[q.negativeX,q.negativeY,q.negativeZ,q.positiveX,q.positiveY,q.positiveZ].forEach((n=>{e.texImage2D(Z(n),0,t,this._width,this._height,0,i,r,s)}))}complete(){const e=j.getContext();e.generateMipmap(e.TEXTURE_CUBE_MAP),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_LINEAR)}getWidth(){if(!this._texture)throw new Error("cube map: not initialized");return this._width}getHeight(){if(!this._texture)throw new Error("cube map: not initialized");return this._height}getRawObject(){if(!this._texture)throw new Error("texture not initialized");return this._texture}}class Q{constructor(){this._texture=null}initialize(e){if(this._texture)throw new Error("data texture already initialized");const t=j.getContext();if(this._texture=t.createTexture(),!this._texture)throw new Error("data texture failed to be created");t.bindTexture(t.TEXTURE_2D,this._texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),this.allocate(e)}dispose(){j.getContext().deleteTexture(this._texture)}allocate(e){if(!this._texture)throw new Error("data texture not initialized");const t=Array.isArray(e)?e.length:e;if(t<=0)throw new Error("texture: width must be positive");if(t>2048)throw new Error(`data texture max size is 2048 (input was ${t})`);const i=j.getContext();i.bindTexture(i.TEXTURE_2D,this._texture),Array.isArray(e),this._buffer=new Float32Array(e);const r=i.R32F,s=t,n=i.RED,o=i.FLOAT;i.texImage2D(i.TEXTURE_2D,0,r,s,1,0,n,o,this._buffer)}update(e,t){if(!this._texture)throw new Error("data texture not initialized");if(!this._buffer)throw new Error("data texture update but not previously allocated");if(e+t.length>this._buffer.length)throw new Error(`data texture update but size is larger (start: ${e}, length: ${t.length}, max: ${this._buffer.length})`);const i=j.getContext();i.bindTexture(i.TEXTURE_2D,this._texture);for(let e=0;e<t.length;++e)this._buffer[e]=t[e];const r=t.length,s=i.RED,n=i.FLOAT,o=e;i.texSubImage2D(i.TEXTURE_2D,0,o,0,r,1,s,n,this._buffer,0)}rawBind(){if(!this._texture)throw new Error("data texture not initialized");const e=j.getContext();e.bindTexture(e.TEXTURE_2D,this._texture)}preBind(e){this.rawBind(),e(this)}bind(e){this.preBind(e),Q.unbind()}static unbind(){const e=j.getContext();e.bindTexture(e.TEXTURE_2D,null)}}class J{constructor(){this._texture=null}initialize(e=[]){if(this._texture)throw new Error("data texture already initialized");const t=j.getContext();if(this._texture=t.createTexture(),!this._texture)throw new Error("data texture failed to be created");t.bindTexture(t.TEXTURE_2D,this._texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),this.allocate(e)}dispose(){j.getContext().deleteTexture(this._texture)}allocate(e){if(!this._texture)throw new Error("data texture not initialized");if(e.length<=0)throw new Error("texture: width must be positive");const t=j.getContext();t.bindTexture(t.TEXTURE_2D,this._texture),this._buffer=new Uint8Array(e.flat());const i=t.RGBA,r=e.length,s=t.RGBA,n=t.UNSIGNED_BYTE;t.texImage2D(t.TEXTURE_2D,0,i,r,1,0,s,n,this._buffer)}update(e,t){if(!this._texture)throw new Error("data texture not initialized");if(!this._buffer)throw new Error("data texture update but not previously allocated");if(e+t.length>this._buffer.length)throw new Error(`data texture update but size is larger (start: ${e}, length: ${t.length}, max: ${this._buffer.length})`);const i=j.getContext();i.bindTexture(i.TEXTURE_2D,this._texture);for(let e=0;e<t.length;++e)this._buffer[4*e+0]=t[e][0],this._buffer[4*e+1]=t[e][1],this._buffer[4*e+2]=t[e][2],this._buffer[4*e+3]=t[e][3];const r=t.length,s=i.RGBA,n=i.UNSIGNED_BYTE,o=e;i.texSubImage2D(i.TEXTURE_2D,0,o,0,r,1,s,n,this._buffer,0)}rawBind(){if(!this._texture)throw new Error("data texture not initialized");const e=j.getContext();e.bindTexture(e.TEXTURE_2D,this._texture)}preBind(e){this.rawBind(),e(this)}bind(e){this.preBind(e),J.unbind()}static unbind(){const e=j.getContext();e.bindTexture(e.TEXTURE_2D,null)}}class ee{constructor(){const e=j.getContext().createFramebuffer();if(null===e)throw new Error("null frame buffer object");this._frameBuffer=e}dispose(){j.getContext().deleteFramebuffer(this._frameBuffer)}rawBind(){const e=j.getContext();e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer)}bind(e){this.rawBind(),e(this),ee.unbind()}static unbind(){const e=j.getContext();e.bindFramebuffer(e.FRAMEBUFFER,null)}attachTexture(e){const t=j.getContext();t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e.getRawObject(),0)}attachDepthTexture(e){const t=j.getContext();t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,e.getRawObject(),0)}attachRenderBuffer(e){const t=j.getContext();t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e.getRawObject())}attachCubeMap(e,t){const i=j.getContext();i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,Z(t),e.getRawObject(),0)}getPixels(e,t,i,r,s){const n=j.getContext();n.readPixels(e,t,i,r,n.RGBA,n.UNSIGNED_BYTE,s)}}var te;!function(e){e[e.float=0]="float",e[e.vec2f=1]="vec2f",e[e.vec3f=2]="vec3f",e[e.vec4f=3]="vec4f",e[e.mat3f=4]="mat3f",e[e.mat4f=5]="mat4f"}(te||(te={}));const ie=e=>{switch(e){case te.float:return 1;case te.vec2f:return 2;case te.vec3f:return 3;case te.vec4f:return 4;case te.mat3f:return 9;case te.mat4f:return 16}};var re;!function(e){e[e.lines=0]="lines",e[e.lineStrip=1]="lineStrip",e[e.lineLoop=2]="lineLoop",e[e.triangles=3]="triangles",e[e.triangleStrip=4]="triangleStrip",e[e.triangleFan=5]="triangleFan"}(re||(re={}));const se=e=>e instanceof Float32Array?e:new Float32Array(e),ne=e=>{const t=j.getContext();return"dynamic"===e?t.DYNAMIC_DRAW:"streaming"===e?t.STREAM_DRAW:t.STATIC_DRAW};class oe{constructor(e,t){this._primitiveStart=0,this._primitiveCount=0,this._instanceCount=0,this._isInstanced=!1;const i=j.getContext();if(0===t.vbos.length)throw new Error("empty vbo definition");for(const i of t.vbos){if(0===i.attrs.length)throw new Error("empty vbo attribute definition");for(const t of i.attrs)if(!e.hasAttribute(t.name))throw new Error(`attribute not found, name="${t.name}"`)}switch(this._def=t,t.primitiveType){case re.lines:this._primitiveType=i.LINES;break;case re.lineStrip:this._primitiveType=i.LINE_STRIP;break;case re.lineLoop:this._primitiveType=i.LINE_LOOP;break;case re.triangles:this._primitiveType=i.TRIANGLES;break;case re.triangleStrip:this._primitiveType=i.TRIANGLE_STRIP;break;case re.triangleFan:this._primitiveType=i.TRIANGLE_FAN;break;default:throw new Error("primitive type not found")}const r=i.createVertexArray();if(!r)throw new Error("fail o create a vao unit");this._vao=r,i.bindVertexArray(this._vao),this._vbos=[];for(const t of this._def.vbos){const r=i.createBuffer();if(!r)throw new Error("fail o create a vbo unit");this._vbos.push({object:r,maxSize:0,mode:t.mode||"static"}),i.bindBuffer(i.ARRAY_BUFFER,r);let s=t.stride||0;if(!s){for(const e of t.attrs)switch(e.type){case te.float:s+=1;break;case te.vec2f:s+=2;break;case te.vec3f:s+=3;break;case te.vec4f:s+=4;break;case te.mat3f:s+=9;break;case te.mat4f:s+=16}s*=4}for(const r of t.attrs){let n=1,o=1;switch(r.type){case te.float:n=1,o=1;break;case te.vec2f:n=2,o=1;break;case te.vec3f:n=3,o=1;break;case te.vec4f:n=4,o=1;break;case te.mat3f:n=3,o=3;break;case te.mat4f:n=4,o=4}const a=e.getAttribute(r.name);for(let e=0;e<o;++e){const o=a+e,f=4*(r.index+e*n);i.enableVertexAttribArray(o),i.vertexAttribPointer(o,n,i.FLOAT,!1,s,f),!0===t.instanced&&(i.vertexAttribDivisor(o,1),this._isInstanced=!0)}}}i.bindVertexArray(null)}dispose(){const e=j.getContext();for(const t of this._vbos)e.deleteBuffer(t.object);this._vbos.length=0,e.deleteVertexArray(this._vao)}setBufferSize(e,t){if(e<0||e>=this._vbos.length)throw new Error(`no vbo available to that index (input: ${e})`);if(t<=0)throw new Error(`vbo must be > 0 (input: ${t})`);const i=this._vbos[e];if(t<i.maxSize)return;i.maxSize=t;const r=j.getContext();r.bindBuffer(r.ARRAY_BUFFER,i.object),r.bufferData(r.ARRAY_BUFFER,t,ne(i.mode)),r.bindBuffer(r.ARRAY_BUFFER,null)}setFloatBufferSize(e,t){this.setBufferSize(e,4*t)}allocateBuffer(e,t,i){if(e<0||e>=this._vbos.length)throw new Error(`no vbo available to that index (input: ${e}, total vbos: ${this._vbos.length})`);if(i<=0)throw new Error(`size must be > 0 (input: ${i})`);const r=this._vbos[e];if(i<=0)throw new Error(`vbo must be > 0 (input: ${i})`);r.maxSize=i;const s=se(t),n=j.getContext();n.bindBuffer(n.ARRAY_BUFFER,r.object),n.bufferData(n.ARRAY_BUFFER,s,ne(r.mode),0,i),n.bindBuffer(n.ARRAY_BUFFER,null)}updateBuffer(e,t,i,r){if(e<0||e>=this._vbos.length)throw new Error(`no vbo available to that index (input: ${e}, total vbos: ${this._vbos.length})`);if(i<=0)throw new Error(`size must be > 0 (input: ${i})`);const s=this._vbos[e];if(void 0!==r){if(r<0)throw new Error(`offset must be >= 0 (input: ${r})`);const e=r+i;if(e>s.maxSize)throw new Error(`offset + size > to vbo max size (input: ${e}, max size: ${s.maxSize})`)}else if(i>s.maxSize)throw new Error(`size must be < to vbo max size (input: ${i}, max size: ${s.maxSize})`);const n=se(t),o=j.getContext();o.bindBuffer(o.ARRAY_BUFFER,s.object),o.bufferSubData(o.ARRAY_BUFFER,null!=r?r:0,n.slice(0,i),0,i),o.bindBuffer(o.ARRAY_BUFFER,null)}render(){if(0==this._primitiveCount)return;if(this._isInstanced&&0==this._instanceCount)return;const e=j.getContext();e.bindVertexArray(this._vao),!0===this._isInstanced?e.drawArraysInstanced(this._primitiveType,this._primitiveStart,this._primitiveCount,this._instanceCount):e.drawArrays(this._primitiveType,this._primitiveStart,this._primitiveCount),e.bindVertexArray(null)}setPrimitiveStart(e){this._primitiveStart=e}setPrimitiveCount(e){this._primitiveCount=e}setInstancedCount(e){this._instanceCount=e}}class ae{constructor(){this._def={vbos:[],primitiveType:re.lines}}reset(){return this._def={vbos:[],primitiveType:re.lines},this}getDef(){return this._def}setPrimitiveType(e){return this._def.primitiveType=re[e],this}addVbo(){return this._def.vbos.push({attrs:[],instanced:!1}),this}setVboAsInstanced(){return this._getLastVbo().instanced=!0,this}setVboAsDynamic(){return this._getLastVbo().mode="dynamic",this}setVboAsStreaming(){return this._getLastVbo().mode="streaming",this}setStride(e){return this._getLastVbo().stride=e,this}addVboAttribute(e,t){const i=this._getLastVbo(),r=i.attrs.length>0?i.attrs[i.attrs.length-1]:null;return i.attrs.push({name:e,type:te[t],index:r?r.index+ie(r.type):0}),this}_getLastVbo(){if(0===this._def.vbos.length)throw new Error("no VBO setup");return this._def.vbos[this._def.vbos.length-1]}}var fe=Object.freeze({__proto__:null,get AttributeType(){return te},BytesPerPixel:4,Geometry:oe,GeometryBuilder:ae,get PrimitiveType(){return re}});class de{constructor(){const e=j.getContext().createRenderbuffer();if(null===e)throw new Error("null render buffer object");this._buffer=e}dispose(){j.getContext().deleteRenderbuffer(this._buffer)}rawBind(){const e=j.getContext();e.bindRenderbuffer(e.RENDERBUFFER,this._buffer)}preBind(e){this.rawBind(),e(this)}bind(e){this.preBind(e),de.unbind()}static unbind(){const e=j.getContext();e.bindRenderbuffer(e.RENDERBUFFER,null)}setSize(e,t,i){const r=j.getContext();let s=r.DEPTH_COMPONENT32F;switch(e){case"depth16":case"depth24":s=r.DEPTH_COMPONENT16}r.renderbufferStorage(r.RENDERBUFFER,s,t,i)}getRawObject(){return this._buffer}}let he=class e{constructor(e,t){this._attributes=new Map,this._uniforms=new Map,this._name=e;const i=j.getContext(),r=this._getShader(t.vertexSrc,i.VERTEX_SHADER),s=this._getShader(t.fragmentSrc,i.FRAGMENT_SHADER),n=i.createProgram();if(!n)throw new Error("could not create a shader program");if(i.attachShader(n,r),i.attachShader(n,s),i.linkProgram(n),i.deleteShader(r),i.deleteShader(s),!i.getProgramParameter(n,i.LINK_STATUS)){const e=i.getProgramInfoLog(n);throw new Error("Failed to initialized shaders, Error linking:"+e)}this._program=n,this.bind((()=>{this._getAttributes(t.attributes),this._getUniforms(t.uniforms)}))}dispose(){j.getContext().deleteProgram(this._program)}bind(t){if(null!==e._isBound)throw new Error(`Double shader binding (bound: ${e._isBound._name}, binding: ${this._name})`);e._isBound=this,j.getContext().useProgram(this._program),t(this),e.unbind()}static unbind(){j.getContext().useProgram(null),e._isBound=null}isBound(){return e._isBound===this}hasAttribute(e){return this._attributes.has(e)}getAttribute(e){const t=this._attributes.get(e);if(void 0===t)throw new Error(`attribute not found: ${e}`);return t}getUniform(e){const t=this._uniforms.get(e);if(void 0===t)throw new Error(`uniform not found: ${e}`);return t}setTextureUniform(e,t,i){const r=j.getContext();r.activeTexture(r.TEXTURE0+i),r.uniform1i(this.getUniform(e),i),t.rawBind()}setInteger1Uniform(e,t){j.getContext().uniform1i(this.getUniform(e),t)}setInteger2Uniform(e,t,i){j.getContext().uniform2i(this.getUniform(e),t,i)}setInteger3Uniform(e,t,i,r){j.getContext().uniform3i(this.getUniform(e),t,i,r)}setFloat1Uniform(e,t){j.getContext().uniform1f(this.getUniform(e),t)}setFloat2Uniform(e,t,i){j.getContext().uniform2f(this.getUniform(e),t,i)}setFloat3Uniform(e,t,i,r){j.getContext().uniform3f(this.getUniform(e),t,i,r)}setMatrix3Uniform(e,t){j.getContext().uniformMatrix3fv(this.getUniform(e),!1,t)}setMatrix4Uniform(e,t){j.getContext().uniformMatrix4fv(this.getUniform(e),!1,t)}_getAttributes(e){const t=j.getContext();for(let i=0;i<e.length;++i){const r=t.getAttribLocation(this._program,e[i]);if(r<0)throw new Error(`attribute not found => ${e[i]}`);this._attributes.set(e[i],r)}}_getUniforms(e){const t=j.getContext();for(let i=0;i<e.length;++i){const r=t.getUniformLocation(this._program,e[i]);if(null===r)throw new Error(`uniform not found => ${e[i]}`);this._uniforms.set(e[i],r)}}_getShader(e,t){const i=j.getContext(),r=i.createShader(t);if(!r)throw new Error("could not create a shader");if(i.shaderSource(r,e),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS)){let e=i.getShaderInfoLog(r);throw e||(e="failed to compile a shader"),new Error(e)}return r}};var ce,ue;he._isBound=null,function(e){e[e.pixelated=0]="pixelated",e[e.linear=1]="linear",e[e.mipmap=2]="mipmap"}(ce||(ce={})),function(e){e[e.noRepeat=0]="noRepeat",e[e.repeat=1]="repeat"}(ue||(ue={}));class _e{constructor(){this._width=0,this._height=0,this._texture=null}initialize(){if(this._texture)throw new Error("texture: already initialized");const e=j.getContext();this._texture=e.createTexture()}rawBind(){if(!this._texture)throw new Error("texture: not initialized");const e=j.getContext();e.bindTexture(e.TEXTURE_2D,this._texture)}preBind(e){this.rawBind(),e(this)}bind(e){this.preBind(e),_e.unbind()}static unbind(){const e=j.getContext();e.bindTexture(e.TEXTURE_2D,null)}loadFromImage(e,t=ce.pixelated,i=ue.noRepeat){this._allocate(e.width,e.height,e,t,i)}loadFromMemory(e,t,i,r=ce.pixelated,s=ue.noRepeat){this._allocate(e,t,i,r,s)}allocate(e,t,i=ce.pixelated,r=ue.noRepeat){this._allocate(e,t,null,i,r)}allocateDepth(e,t,i=ce.pixelated,r=ue.noRepeat){this._allocate(e,t,null,i,r,!0)}resize(e,t,i=ce.pixelated,r=ue.noRepeat){this._allocate(e,t,null,i,r)}_allocate(e,t,i=null,r=ce.pixelated,s=ue.noRepeat,n=!1){if(!this._texture)throw new Error("texture: not initialized");if(e<=0)throw new Error("texture: width must be positive");if(t<=0)throw new Error("texture: height must be positive");const o=j.getContext();this._width=e,this._height=t;const a=n?o.DEPTH_COMPONENT32F:o.RGBA,f=n?o.DEPTH_COMPONENT:o.RGBA,d=n?o.FLOAT:o.UNSIGNED_BYTE;i instanceof HTMLImageElement?o.texImage2D(o.TEXTURE_2D,0,a,f,d,i):o.texImage2D(o.TEXTURE_2D,0,a,e,t,0,f,d,i),s===ue.noRepeat?(o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE)):s===ue.repeat&&(o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.REPEAT),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.REPEAT)),r===ce.pixelated?(o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.NEAREST)):r===ce.linear?(o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR)):r===ce.mipmap&&(o.generateMipmap(o.TEXTURE_2D),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR_MIPMAP_LINEAR))}getWidth(){if(!this._texture)throw new Error("texture not initialized");return this._width}getHeight(){if(!this._texture)throw new Error("texture not initialized");return this._height}getRawObject(){if(!this._texture)throw new Error("texture not initialized");return this._texture}}var le=Object.freeze({__proto__:null,CubeMap:K,get CubeMapType(){return q},DataTexture:Q,DataTextureVec4:J,FenceSync:class{constructor(){}dispose(){this._sync&&(j.getContext().deleteSync(this._sync),this._sync=void 0)}isStarted(){return void 0!==this._sync}start(){this._sync&&this.dispose();const e=j.getContext(),t=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0);if(null===t)throw new Error("could not create a webgl fence");this._sync=t,e.flush(),e.finish()}isSignaled(){if(!this._sync)throw new Error("fence not started");const e=j.getContext();return e.getSyncParameter(this._sync,e.SYNC_STATUS)===e.SIGNALED}wait(e){if(!this._sync)throw new Error("fence not started");const t=j.getContext();switch(t.clientWaitSync(this._sync,0,e)){case t.TIMEOUT_EXPIRED:return"timed-out";case t.WAIT_FAILED:return console.warn("fence.wait -> should never get here"),this.dispose(),"done";case t.ALREADY_SIGNALED:case t.CONDITION_SATISFIED:default:return this.dispose(),"done"}}},FrameBuffer:ee,GeometryWrapper:fe,RenderBuffer:de,ShaderProgram:he,Texture:_e,TextureArray:class e{constructor(){this._width=0,this._height=0,this._texture=null}initialize(){if(this._texture)throw new Error("texture: already initialized");const e=j.getContext();this._texture=e.createTexture()}dispose(){j.getContext().deleteTexture(this._texture)}rawBind(){if(!this._texture)throw new Error("texture: not initialized");const e=j.getContext();e.bindTexture(e.TEXTURE_2D_ARRAY,this._texture)}preBind(e){this.rawBind(),e(this)}bind(t){this.preBind(t),e.unbind()}static unbind(){const e=j.getContext();e.bindTexture(e.TEXTURE_2D_ARRAY,null)}loadFromImage(e,t,i,r,s=ce.pixelated,n=ue.noRepeat){this._allocate(e,t,i,r,s,n)}loadFromMemory(e,t,i,r,s=ce.pixelated,n=ue.noRepeat){this._allocate(e,t,i,r,s,n)}_allocate(e,t,i,r=null,s=ce.pixelated,n=ue.noRepeat){if(!this._texture)throw new Error("texture: not initialized");if(e<=0)throw new Error("texture: width must be positive");if(t<=0)throw new Error("texture: height must be positive");const o=j.getContext();this._width=e,this._height=t;const a=o.RGBA,f=o.RGBA,d=o.UNSIGNED_BYTE;HTMLImageElement,o.texImage3D(o.TEXTURE_2D_ARRAY,0,a,e,t,i,0,f,d,r),n===ue.noRepeat?(o.texParameteri(o.TEXTURE_2D_ARRAY,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D_ARRAY,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE)):n===ue.repeat&&(o.texParameteri(o.TEXTURE_2D_ARRAY,o.TEXTURE_WRAP_S,o.REPEAT),o.texParameteri(o.TEXTURE_2D_ARRAY,o.TEXTURE_WRAP_T,o.REPEAT)),s===ce.pixelated?(o.texParameteri(o.TEXTURE_2D_ARRAY,o.TEXTURE_MAG_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D_ARRAY,o.TEXTURE_MIN_FILTER,o.NEAREST)):s===ce.linear?(o.texParameteri(o.TEXTURE_2D_ARRAY,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D_ARRAY,o.TEXTURE_MIN_FILTER,o.LINEAR)):s===ce.mipmap&&(o.generateMipmap(o.TEXTURE_2D_ARRAY),o.texParameteri(o.TEXTURE_2D_ARRAY,o.TEXTURE_MAG_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D_ARRAY,o.TEXTURE_MIN_FILTER,o.LINEAR_MIPMAP_LINEAR))}getWidth(){if(!this._texture)throw new Error("texture not initialized");return this._width}getHeight(){if(!this._texture)throw new Error("texture not initialized");return this._height}getRawObject(){if(!this._texture)throw new Error("texture not initialized");return this._texture}},get TextureFilter(){return ce},get TextureRepeat(){return ue},WebGLContext:j,checkError:()=>{const e=j.getContext();switch(e.getError()){case e.INVALID_ENUM:throw new Error("gl.INVALID_ENUM\nAn unacceptable value is specified for an enumerated argument. The offending command is ignored and has no other side effect than to set the error flag.");case e.INVALID_VALUE:throw new Error("gl.INVALID_VALUE\nA numeric argument is out of range. The offending command is ignored and has no other side effect than to set the error flag.");case e.INVALID_OPERATION:throw new Error("gl.INVALID_OPERATION\nThe specified operation is not allowed in the current state. The offending command is ignored and has no other side effect than to set the error flag.");case e.INVALID_FRAMEBUFFER_OPERATION:throw new Error("gl.INVALID_FRAMEBUFFER_OPERATION\nThe framebuffer object is not complete. The offending command is ignored and has no other side effect than to set the error flag.");case e.OUT_OF_MEMORY:throw new Error("gl.OUT_OF_MEMORY\nThere is not enough memory left to execute the command. The state of the GL is undefined, except for the state of the error flags, after this error is recorded.");case e.CONTEXT_LOST_WEBGL:throw new Error("gl.CONTEXT_LOST_WEBGL\n If the WebGL context is lost, this error is returned on the first call to getError. Afterwards and until the context has been restored, it returns gl.NO_ERROR.")}},getCubeMapType:Z});class pe{constructor(e,t){this._width=0,this._height=0,this._frameBuffer=new ee,this._renderBuffer=new de,this._colorTextures=[],this._currentIndex=0,this._colorTextures.push(new _e),this._colorTextures.push(new _e),this._colorTextures.forEach((e=>e.initialize())),this.resize(e,t)}resize(e,t){this._width=e,this._height=t,this._renderBuffer.bind((e=>{e.setSize("depth32f",this._width,this._height)})),this._colorTextures.forEach((e=>{e.bind((e=>{e.allocate(this._width,this._height)}))})),this._frameBuffer.bind((e=>{this._renderBuffer.bind((t=>{e.attachRenderBuffer(t)}))}))}captureScene(e){this._frameBuffer.bind((t=>{this._colorTextures[this._currentIndex].bind((e=>{t.attachTexture(e)}));const i=j.getContext();i.viewport(0,0,this._width,this._height),i.clearColor(0,0,0,0),e()})),this._currentIndex=(this._currentIndex+1)%this._colorTextures.length}get colorTexture(){return this._colorTextures[this._currentIndex]}}var me="\n#version 300 es\n\nprecision highp float;\n\nuniform mat4 u_composedMatrix;\n\nin vec3  a_vertex_position;\nin vec2  a_vertex_texCoord;\n\nout vec2 v_texCoord;\n\nvoid main(void)\n{\n  v_texCoord = a_vertex_texCoord;\n  gl_Position = u_composedMatrix * vec4(a_vertex_position, 1.0);\n}\n\n".trim(),ge="\n#version 300 es\n\nprecision highp float;\n\nuniform sampler2D u_texture;\n\nin vec2 v_texCoord;\n\nout vec4 o_color;\n\nvoid main(void)\n{\n  o_color = texture(u_texture, v_texCoord);\n}\n".trim();class be{constructor(e,t){this._width=0,this._height=0,this._shader=new he("RenderHudTexture",{vertexSrc:me,fragmentSrc:ge,attributes:["a_vertex_position","a_vertex_texCoord"],uniforms:["u_composedMatrix","u_texture"]});const i=new ae;i.reset().setPrimitiveType("triangleStrip").addVbo().addVboAttribute("a_vertex_position","vec3f").addVboAttribute("a_vertex_texCoord","vec2f"),this._geometry=new oe(this._shader,i.getDef()),this.resize(e,t)}resize(e,t){this._width=e,this._height=t;const i=[{pos:[0*this._width,0*this._height,-1],tex:[0,0]},{pos:[1*this._width,0*this._height,-1],tex:[1,0]},{pos:[0*this._width,1*this._height,-1],tex:[0,1]},{pos:[1*this._width,1*this._height,-1],tex:[1,1]}].map((e=>[e.pos[0],e.pos[1],e.pos[2],e.tex[0],e.tex[1]])).flat();this._geometry.allocateBuffer(0,i,i.length),this._geometry.setPrimitiveCount(i.length/5)}flush(e,t){this._shader.bind((i=>{i.setMatrix4Uniform("u_composedMatrix",e),i.setTextureUniform("u_texture",t,0),this._geometry.render()}))}}class xe{constructor(e,t){this._sceneCapturer=new pe(e,t),this._renderHudTexture=new be(e,t)}resize(e,t){this._sceneCapturer.resize(e,t),this._renderHudTexture.resize(e,t)}captureScene(e){this._sceneCapturer.captureScene(e)}renderHud(e){this._renderHudTexture.flush(e,this._sceneCapturer.colorTexture)}}var ve="\n#version 300 es\n\nprecision highp float;\n\nuniform mat4 u_composedMatrix;\n\nin vec3 a_vertex_position;\nin vec4 a_vertex_color;\n\nflat out vec4 v_color;\n\nvoid main(void)\n{\n  gl_Position = u_composedMatrix * vec4(a_vertex_position, 1.0);\n\n  v_color = a_vertex_color;\n}\n".trim(),Ee="\n#version 300 es\n\nprecision lowp float;\n\nflat in vec4 v_color;\n\nout vec4 o_color;\n\nvoid main(void)\n{\n  o_color = v_color;\n}\n".trim();class we{constructor(e,t){this._buffer=new Float32Array(14336),this._currentSize=0,this._shader=e;const i=Object.assign(Object.assign({},t),{primitiveType:re.lines});this._geometry=new oe(e,i)}pushLine(e,t,i){var r;if(this._currentSize+14>=this._buffer.length){if(!this._shader.isBound())return;this.flush()}const s=null!==(r=i[3])&&void 0!==r?r:1;this._buffer[this._currentSize+0]=e[0],this._buffer[this._currentSize+1]=e[1],this._buffer[this._currentSize+2]=e[2],this._buffer[this._currentSize+3]=i[0],this._buffer[this._currentSize+4]=i[1],this._buffer[this._currentSize+5]=i[2],this._buffer[this._currentSize+6]=s,this._currentSize+=7,this._buffer[this._currentSize+0]=t[0],this._buffer[this._currentSize+1]=t[1],this._buffer[this._currentSize+2]=t[2],this._buffer[this._currentSize+3]=i[0],this._buffer[this._currentSize+4]=i[1],this._buffer[this._currentSize+5]=i[2],this._buffer[this._currentSize+6]=s,this._currentSize+=7}canRender(){return this._currentSize>0}flush(){this.canRender()&&(this._geometry.allocateBuffer(0,this._buffer.slice(0,this._currentSize),this._currentSize),this._geometry.setPrimitiveCount(this._currentSize/7),this._geometry.render(),this.clear())}clear(){this._currentSize=0}}class Te{constructor(e,t){this._buffer=new Float32Array(7168),this._currentSize=0,this._shader=e;const i=Object.assign(Object.assign({},t),{primitiveType:re.triangles});this._geometry=new oe(e,i)}pushTriangle(e,t,i,r){var s;if(this._currentSize+42>=this._buffer.length){if(!this._shader.isBound())return;this.flush()}const n=null!==(s=r[3])&&void 0!==s?s:1;this._buffer[this._currentSize+0]=e[0],this._buffer[this._currentSize+1]=e[1],this._buffer[this._currentSize+2]=e[2],this._buffer[this._currentSize+3]=r[0],this._buffer[this._currentSize+4]=r[1],this._buffer[this._currentSize+5]=r[2],this._buffer[this._currentSize+6]=n,this._currentSize+=7,this._buffer[this._currentSize+0]=t[0],this._buffer[this._currentSize+1]=t[1],this._buffer[this._currentSize+2]=t[2],this._buffer[this._currentSize+3]=r[0],this._buffer[this._currentSize+4]=r[1],this._buffer[this._currentSize+5]=r[2],this._buffer[this._currentSize+6]=n,this._currentSize+=7,this._buffer[this._currentSize+0]=i[0],this._buffer[this._currentSize+1]=i[1],this._buffer[this._currentSize+2]=i[2],this._buffer[this._currentSize+3]=r[0],this._buffer[this._currentSize+4]=r[1],this._buffer[this._currentSize+5]=r[2],this._buffer[this._currentSize+6]=n,this._currentSize+=7}pushLine(e,t,i,r){if(this._currentSize+42>=this._buffer.length)return;const s=t[0]-e[0],n=t[1]-e[1],o=Math.atan2(n,s)+.5*Math.PI,a=Math.cos(o)*i*.5,f=Math.sin(o)*i*.5;this.pushTriangle([e[0]-a,e[1]-f,e[2]],[t[0]-a,t[1]-f,t[2]],[t[0]+a,t[1]+f,t[2]],r),this.pushTriangle([e[0]-a,e[1]-f,e[2]],[t[0]+a,t[1]+f,t[2]],[e[0]+a,e[1]+f,e[2]],r)}pushRotatedLine(e,t,i,r,s){this.pushLine([e[0]-i*Math.cos(t),e[1]-i*Math.sin(t),e[2]],[e[0]+i*Math.cos(t),e[1]+i*Math.sin(t),e[2]],r,s)}pushOriginBoundRectangle(e,t,i){if(this._currentSize+42>=this._buffer.length)return;const r=[e[0]+t[0],e[1]+t[1]];this.pushTriangle([e[0],e[1],e[2]],[r[0],r[1],e[2]],[e[0],r[1],e[2]],i),this.pushTriangle([e[0],e[1],e[2]],[r[0],e[1],e[2]],[r[0],r[1],e[2]],i)}pushCenteredRectangle(e,t,i){const r=[e[0]-.5*t[0],e[1]-.5*t[1],e[2]];this.pushOriginBoundRectangle(r,t,i)}canRender(){return this._currentSize>0}flush(){this.canRender()&&(this._geometry.allocateBuffer(0,this._buffer.slice(0,this._currentSize),this._currentSize),this._geometry.setPrimitiveCount(this._currentSize/7),this._geometry.render(),this.clear())}clear(){this._currentSize=0}}class Se{constructor(){this._shader=new he("StackRenderers",{vertexSrc:ve,fragmentSrc:Ee,attributes:["a_vertex_position","a_vertex_color"],uniforms:["u_composedMatrix"]});const e=new ae;e.reset().setPrimitiveType("lines").addVbo().setVboAsDynamic().addVboAttribute("a_vertex_position","vec3f").addVboAttribute("a_vertex_color","vec4f"),this._wireFramesStackRenderer=new we(this._shader,e.getDef()),this._trianglesStackRenderer=new Te(this._shader,e.getDef())}pushLine(e,t,i){this._wireFramesStackRenderer.pushLine(e,t,i)}pushCross(e,t,i){const r=[[e[0]-t,e[1],e[2]],[e[0]+t,e[1],e[2]],[e[0],e[1]-t,e[2]],[e[0],e[1]+t,e[2]],[e[0],e[1],e[2]-t],[e[0],e[1],e[2]+t]],s=[0,1,2,3,4,5];for(let e=0;e<s.length;e+=2){const t=r[e+0],s=r[e+1];this._wireFramesStackRenderer.pushLine(t,s,i)}}pushThickLine(e,t,i,r){this._trianglesStackRenderer.pushLine(e,t,i,r)}pushRotatedLine(e,t,i,r,s){this._trianglesStackRenderer.pushRotatedLine(e,t,i,r,s)}pushOriginBoundRectangle(e,t,i){this._trianglesStackRenderer.pushOriginBoundRectangle(e,t,i)}pushCenteredRectangle(e,t,i){this._trianglesStackRenderer.pushCenteredRectangle(e,t,i)}pushTriangle(e,t,i,r){this._trianglesStackRenderer.pushTriangle(e,t,i,r)}pushQuad(e,t,i){this.pushTriangle([e[0]+0*t[0],e[1]+0*t[1],e[2]],[e[0]+1*t[0],e[1]+1*t[1],e[2]],[e[0]+1*t[0],e[1]+0*t[1],e[2]],i),this.pushTriangle([e[0]+0*t[0],e[1]+0*t[1],e[2]],[e[0]+1*t[0],e[1]+1*t[1],e[2]],[e[0]+0*t[0],e[1]+1*t[1],e[2]],i)}flush(e){(this._wireFramesStackRenderer.canRender()||this._trianglesStackRenderer.canRender())&&this._shader.bind((t=>{t.setMatrix4Uniform("u_composedMatrix",e),this._wireFramesStackRenderer.flush(),this._trianglesStackRenderer.flush()}))}safeRender(e,t){this._shader.bind((i=>{i.setMatrix4Uniform("u_composedMatrix",e),t(),this._wireFramesStackRenderer.flush(),this._trianglesStackRenderer.flush()}))}clear(){this._wireFramesStackRenderer.clear(),this._trianglesStackRenderer.clear()}}var Ce="\n#version 300 es\n\nprecision highp float;\n\nuniform mat4 u_composedMatrix;\n\nin vec2 a_vertex_position;\nin vec2 a_vertex_texCoord;\nin vec3 a_offset_position;\nin vec2 a_offset_texCoord;\nin vec3 a_offset_color;\nin float a_offset_scale;\n\nout vec2 v_texCoord;\nflat out vec3 v_color;\n\nvoid main(void)\n{\n  vec3 position = vec3(a_vertex_position, 0.0) * a_offset_scale + a_offset_position;\n\n  gl_Position = u_composedMatrix * vec4(position, 1.0);\n\n  v_texCoord = a_vertex_texCoord + a_offset_texCoord;\n  v_color = a_offset_color;\n}\n".trim(),Re="\n#version 300 es\n\nprecision mediump float;\n\nuniform sampler2D u_texture;\n\nin vec2 v_texCoord;\nflat in vec3 v_color;\n\nout vec4 o_color;\n\nvoid main(void)\n{\n  vec4 textureColor = texture(u_texture, v_texCoord);\n  if (textureColor.a < 0.5)\n  {\n    discard;\n  }\n  else\n  {\n    o_color = vec4(v_color, textureColor.a);\n  }\n}\n".trim();const Ae=[16,6],ye=[1/Ae[0],1/Ae[1]];class ke{constructor(){this._texture=new _e,this._buffer=new Float32Array(36864),this._currentSize=0,this._textScale=14,this._textColor=[1,1,1],this._horizontalTextAlign="left",this._verticalTextAlign="top",this._shader=new he("TextRenderer",{vertexSrc:Ce,fragmentSrc:Re,attributes:["a_vertex_position","a_vertex_texCoord","a_offset_position","a_offset_texCoord","a_offset_color","a_offset_scale"],uniforms:["u_composedMatrix","u_texture"]});const e=new ae;e.reset().setPrimitiveType("triangles").addVbo().addVboAttribute("a_vertex_position","vec2f").addVboAttribute("a_vertex_texCoord","vec2f").setStride(16).addVbo().setVboAsDynamic().setVboAsInstanced().addVboAttribute("a_offset_position","vec3f").addVboAttribute("a_offset_texCoord","vec2f").addVboAttribute("a_offset_color","vec3f").addVboAttribute("a_offset_scale","float").setStride(36),this._geometry=new oe(this._shader,e.getDef());const t=[{position:[.5,-.5],texCoord:[1*ye[0],1*ye[1]]},{position:[-.5,-.5],texCoord:[0*ye[0],1*ye[1]]},{position:[.5,.5],texCoord:[1*ye[0],0*ye[1]]},{position:[-.5,.5],texCoord:[0*ye[0],0*ye[1]]}],i=[1,0,2,1,2,3],r=[];for(const e of i){const i=t[e];r.push(i.position[0],i.position[1],i.texCoord[0],i.texCoord[1])}this._geometry.allocateBuffer(0,r,r.length),this._geometry.setPrimitiveCount(r.length/4),this._texCoordMap=new Map([[" ",[0*ye[0],0*ye[1]]],["!",[1*ye[0],0*ye[1]]],['"',[2*ye[0],0*ye[1]]],["#",[3*ye[0],0*ye[1]]],["$",[4*ye[0],0*ye[1]]],["%",[5*ye[0],0*ye[1]]],["&",[6*ye[0],0*ye[1]]],["'",[7*ye[0],0*ye[1]]],["(",[8*ye[0],0*ye[1]]],[")",[9*ye[0],0*ye[1]]],["*",[10*ye[0],0*ye[1]]],["+",[11*ye[0],0*ye[1]]],[",",[12*ye[0],0*ye[1]]],["-",[13*ye[0],0*ye[1]]],[".",[14*ye[0],0*ye[1]]],["/",[15*ye[0],0*ye[1]]],["0",[0*ye[0],1*ye[1]]],["1",[1*ye[0],1*ye[1]]],["2",[2*ye[0],1*ye[1]]],["3",[3*ye[0],1*ye[1]]],["4",[4*ye[0],1*ye[1]]],["5",[5*ye[0],1*ye[1]]],["6",[6*ye[0],1*ye[1]]],["7",[7*ye[0],1*ye[1]]],["8",[8*ye[0],1*ye[1]]],["9",[9*ye[0],1*ye[1]]],[":",[10*ye[0],1*ye[1]]],[";",[11*ye[0],1*ye[1]]],["<",[12*ye[0],1*ye[1]]],["=",[13*ye[0],1*ye[1]]],[">",[14*ye[0],1*ye[1]]],["?",[15*ye[0],1*ye[1]]],["@",[0*ye[0],2*ye[1]]],["A",[1*ye[0],2*ye[1]]],["B",[2*ye[0],2*ye[1]]],["C",[3*ye[0],2*ye[1]]],["D",[4*ye[0],2*ye[1]]],["E",[5*ye[0],2*ye[1]]],["F",[6*ye[0],2*ye[1]]],["G",[7*ye[0],2*ye[1]]],["H",[8*ye[0],2*ye[1]]],["I",[9*ye[0],2*ye[1]]],["J",[10*ye[0],2*ye[1]]],["K",[11*ye[0],2*ye[1]]],["L",[12*ye[0],2*ye[1]]],["M",[13*ye[0],2*ye[1]]],["N",[14*ye[0],2*ye[1]]],["O",[15*ye[0],2*ye[1]]],["P",[0*ye[0],3*ye[1]]],["Q",[1*ye[0],3*ye[1]]],["R",[2*ye[0],3*ye[1]]],["S",[3*ye[0],3*ye[1]]],["T",[4*ye[0],3*ye[1]]],["U",[5*ye[0],3*ye[1]]],["V",[6*ye[0],3*ye[1]]],["W",[7*ye[0],3*ye[1]]],["X",[8*ye[0],3*ye[1]]],["Y",[9*ye[0],3*ye[1]]],["Z",[10*ye[0],3*ye[1]]],["[",[11*ye[0],3*ye[1]]],["\\",[12*ye[0],3*ye[1]]],["]",[13*ye[0],3*ye[1]]],["^",[14*ye[0],3*ye[1]]],["_",[15*ye[0],3*ye[1]]],["`",[0*ye[0],4*ye[1]]],["a",[1*ye[0],4*ye[1]]],["b",[2*ye[0],4*ye[1]]],["c",[3*ye[0],4*ye[1]]],["d",[4*ye[0],4*ye[1]]],["e",[5*ye[0],4*ye[1]]],["f",[6*ye[0],4*ye[1]]],["g",[7*ye[0],4*ye[1]]],["h",[8*ye[0],4*ye[1]]],["i",[9*ye[0],4*ye[1]]],["j",[10*ye[0],4*ye[1]]],["k",[11*ye[0],4*ye[1]]],["l",[12*ye[0],4*ye[1]]],["m",[13*ye[0],4*ye[1]]],["n",[14*ye[0],4*ye[1]]],["o",[15*ye[0],4*ye[1]]],["p",[0*ye[0],5*ye[1]]],["q",[1*ye[0],5*ye[1]]],["r",[2*ye[0],5*ye[1]]],["s",[3*ye[0],5*ye[1]]],["t",[4*ye[0],5*ye[1]]],["u",[5*ye[0],5*ye[1]]],["v",[6*ye[0],5*ye[1]]],["w",[7*ye[0],5*ye[1]]],["x",[8*ye[0],5*ye[1]]],["y",[9*ye[0],5*ye[1]]],["z",[10*ye[0],5*ye[1]]],["{",[11*ye[0],5*ye[1]]],["|",[12*ye[0],5*ye[1]]],["}",[13*ye[0],5*ye[1]]],["~",[14*ye[0],5*ye[1]]]]);const s=new Uint8Array(98304);{let e=0;for(let t=0;t<5818;t+=2){let i=parseInt(`${"7e7e28fd03fd07fe04fe0aff02ff7e4dfd0cfd03fd07fe04fe0aff02ff1afc0dfd10fc08fc0ffe55ff15fb0bfd03fd07fe04fe08f707fd04ff07fe02fe0cfd0ffd0cfd0aff03fe03ff0afe44fe15fb0bfd03fd04f204f607fd03fe07fe02fe0cfd0efd0efd0aff02fe02ff0bfe43fd15fb0cfe03fe05f204fe01ff02ff0afd02fd07fe02fe0bfd0efd10fd0afa0cfe42fd16fb1bfe04fe07fe01ff02ff0efd09fc1cfd12fd09fa0cfe41fd17fb1bfe04fe07f70bfd0afc04ff17fd12fd06f405f616f61cfd19fd1cfe04fe08f709fd0bfb02fe17fd12fd06f405f616f61bfd1afd1cfe04fe0aff02ff01fe08fd0bfe02fa17fd12fd09fa0cfe3efd37f207ff02ff01fe07fd02fd07fe03fc19fd10fd0afa0cfe3dfd38f204f607fe03fd07fe03fd1bfd0efd0aff02fe02ff0bfe0cfd1dfd0dfd1dfd1cfe04fe07f708ff04fd07fe02fb1bfd0cfd0aff03fe03ff0afe0cfd1dfd0cfd1efd1cfe04fe0aff02ff1afb02fe1bfc08fc0ffe1cfd1dfd0bfd1ffd1cfe04fe0aff02ff7afd7e7e7e7e7e7e0efd17fd10fc0af80bfe0bf909f90dfd08f609fb08f506f808f82cfd19fd0df807fd04fd0afe0afd03fd07fd03fd0bfc08fd0ffd0bfd05fd05fd04fd06fd04fd2afd1bfd0bfc02fc06fd03fc09fd0afd04fd06fd04fd09fb08fd0efd0cfd05fd05fd04fd06fd04fd09fd0cfd0efd1dfd0afe05fd06fd02fb06fa11fd0dfd08fe01fd08fd0dfd0dfd05fd05fd04fd06fd04fd09fd0cfd0dfd0af409fd10fd06fd02fb06fa10fd0dfd08fe02fd08fd0dfd15fd05fb02fd06fd04fd09fd0cfd0cfd0bf40afd0efd07fd01fe01fd09fd0ffd0bfb08fe03fd08f808f70efd08fa08f626fd23fd0cfd08fd01fe01fd09fd0efd0cfb08f606f707f60cfd09fa09f726fd23fd0bfd09fb02fd09fd0dfd10fd07f60cfc06fd04fd0bfd08fd02fb0dfd09fd0cfd0cfd0bf40afd0cfd09fb02fd09fd0cfd12fd0bfd0ffd06fd04fd0afd09fd04fd0dfd09fd0cfd0dfd0af409fd19fc03fd09fd0bfd03fd06fd04fd0bfd08fd04fd06fd04fd09fd0afd04fd0cfd0afd0cfd0efd1dfd1afd04fd09fd0afd04fd06fd03fd0cfd08fd03fd07fd04fd09fd0afd04fd0bfd19fd10fd1bfd0ffd0af807f707f607f90bf907f909f80afd0bf809fb2efd19fd10fd7e51fd17fd11fd7e7e7e7e13f87e78fd05fd08fc09f709f907f808f606f608f907fd03fd07f90df905fc03fd06fb0bfd05fd05fd05fd08fb08fd05fd07fa09fd03fd07fd03fd07fd02fd08fd04fe07fd04fe07fd03fd06fd03fd09fd11fd08fd03fd07fd0cfc03fc05fd05fd07fd01fd07fd05fd06fd02fd08fd03fd06fd04fd07fd03fd07fd05ff07fd05ff06fd04fd06fd03fd09fd11fd08fd02fd08fd0cfb01fb05fc04fd06fd03fd06fd05fd05fd04fd07fd03fd06fd0efd03fd07fd0dfd0cfd04fd06fd03fd09fd11fd08fd01fd09fd0cf505fb03fd05fd05fd05fd02fa05fd04fd07fd03fd06fd0efd03fd07fd03fe08fd03fe07fd0dfd03fd09fd11fd08fa0afd0cf505fa02fd05fd05fd05fd02fa05fd04fd07f807fd0efd03fd07f808f807fd0df709fd11fd08fb0bfd0cfd01fd01fd05fd01fd01fd05fd05fd05fd02fa05fd04fd07f807fd0efd03fd07f808f807fd0df709fd11fd08fb0bfd0cfd02ff02fd05fd02fa05fd05fd05fd02fa05f607fd03fd06fd0efd03fd07fd03fe08fd03fe07fd02fb06fd03fd09fd0bfd03fd08fa0afd0cfd05fd05fd03fb05fd05fd05fd0dfd04fd07fd03fd06fd0efd03fd07fd0dfd0cfd04fd06fd03fd09fd0bfd03fd08fd01fd09fd05ff06fd05fd05fd04fc05fd05fd05fd0dfd04fd07fd03fd06fd04fd07fd03fd07fd05ff07fd0cfd04fd06fd03fd09fd0bfd03fd08fd02fd08fd04fe06fd05fd05fd05fd06fd03fd06fd0dfd04fd07fd03fd07fd03fd07fd02fd08fd04fe07fd0dfd03fd06fd03fd09fd0bfd03fd08fd03fd07fd03fd06fd05fd05fd05fd07fd01fd07fd0dfd04fd06f709f907f808f606fb0df806fd03fd07f90af908fc03fd06f606fd05fd05fd05fd08fb0af87e7e7e7e7e7e7e68fe1af70afb08f708f807f505fd03fd07fd03fd07fd05fd05fd03fd07fd03fd07f608f907ff11f90afc1afd03fd07fc01fc07fd03fd06fd04fd06fe02fd02fe05fd03fd07fd03fd07fd05fd05fd03fd07fd03fd07fd04fd08fd0bfe14fd09fa19fd03fd07fd03fd07fd03fd06fd04fd06ff03fd03ff05fd03fd07fd03fd07fd05fd05fd03fd07fd03fd07fe05fd08fd0bfd13fd08fd02fd18fd03fd06fd05fd06fd03fd06fd04fd0afd09fd03fd07fd03fd07fd05fd06fd01fd08fd03fd07ff05fd09fd0cfd12fd07fd04fd17fd03fd06fd05fd06fd03fd06fd11fd09fd03fd07fd03fd07fd05fd07fb09fd03fd0cfd0afd0dfd11fd28f807fd05fd06f808f90cfd09fd03fd07fd03fd07fd02ff02fd08fd0bfd01fd0cfd0bfd0efd10fd28f807fd05fd06f809f90bfd09fd03fd07fd03fd07fd02ff02fd08fd0cfb0cfd0cfd0ffd0ffd28fd0cfd03fb06fd02fd0efd0afd09fd03fd07fd03fd07fd02ff02fd07fb0cfd0cfd0dfd10fd0efd28fd0cfd02fa06fd03fd06fd04fd0afd09fd03fd07fd03fd08f707fd01fd0bfd0bfd05ff08fd11fd0dfd28fd0df707fd03fd06fd04fd0afd09fd03fd08fd01fd09fc01fc06fd03fd0afd0afd05fe08fd12fd0cfd28fd0df707fd03fd06fd04fd0afd09fd03fd09fb0bfd01fd07fd03fd0afd0afd04fd08fd13fd0bfd27fb12fd06fc03fd07f809f908f90bfd0cfd01fd07fd03fd08f908f608f910fd06f93cfa7e54f07e72f07e7e7e7e0bfd1dfc21fb19fb18fc10fd0ffd07fc0dfa39fd1efd22fd19fd01fd18fd10fd0ffd08fd10fd3bfd1cfd22fd19fd01fd18fd10fd0ffd08fd10fd3bfd1cfd22fd19fd1cfd2dfd10fd4af909f808f909f808f90afd0cfb02fe07fd01fc08fa0cfa08fd03fd0afd09f606f809f91efd08fd03fd06fd03fd07fd03fd07fd03fd07f808fd03fd08fc02fd0afd0ffd08fd02fd0bfd09fd02ff02fd05fd03fd07fd03fd1dfd08fd03fd06fd03fd07fd03fd07fd03fd07f808fd03fd08fc02fd0afd0ffd08fd01fd0cfd09fd02ff02fd05fd03fd07fd03fd18f808fd03fd06fd0dfd03fd07f709fd0bfd03fd08fd03fd0afd0ffd08fa0dfd09fd02ff02fd05fd03fd07fd03fd17fd03fd08fd03fd06fd0dfd03fd07fd0ffd0bfd03fd08fd03fd0afd0ffd08fd01fd0cfd09fd02ff02fd05fd03fd07fd03fd17fd03fd08fd03fd06fd03fd07fd03fd07fd03fd09fd0cf808fd03fd0afd0ffd08fd02fd0bfd09fd02ff02fd05fd03fd07fd03fd17fd03fd08fd03fd06fd03fd07fd03fd07fd03fd09fd0df908fd03fd0afd0ffd08fd03fd0afd09fd02ff02fd05fd03fd07fd03fd18fb02fe06fe02fb08f909fb02fe07f908f90ffd07fc03fd07f706fd03fd07fc03fd07f706fd05fd05fd03fd08f978fd03fd27fd03fd7e4af92afa7e7e7e7e7e7e18fa09fc09fa1efe4eff6efd0dfc0dfd1cfc4cfe6efd0dfc0dfd1bfa4afd6efd0dfc0dfd1afd02fd07fe02fb07fb02fe07fc02fd08f908f707fd03fd07fd03fd07fd05fd05fd02fd09fd03fd06f80afd0efc0efd08fb03fd05fd04fd07fd03fd05fd03fd09f706fd04fe09fd0bfd03fd07fd03fd07fd05fd05fd02fd09fd03fd06fe03fd08fd24fd05fd01fd02fd05fe06fe07fd03fd05fd03fd09fc02fd06fd04fe09fd0bfd03fd07fd03fd07fd05fd06fa0afd03fd06ff03fd09fd24fd05fd02fd01fd05fe06fe07fd03fd05fd03fd09fd0dfb0cfd0bfd03fd07fd03fd07fd02ff02fd07fc0bfd03fd09fd0cfd0efc0efd07fd03fb06fe06fe07fd03fd05fd03fd09fd0ffb0afd0bfd03fd07fd03fd07fd02ff02fd07fc0bfd03fd08fd0efd0dfc0dfd19fe06fe07fd03fd05fd03fd09fd0cfe04fd09fd01fd07fd03fd08fd01fd09fc01fc07fa0bf908fd03ff0bfd0dfc0dfd19fe06fe07f807f809fd0cfe04fd09fd01fd07fd03fd09fb0bfd01fd07fd02fd0bfb08fd03fe0bfd0dfc0dfd19f607fd11fd08fb0cf90bfb09fb02fe09fd0cfd01fd07fd02fd0dfd08f80cfa09fc09fa1af607fd11fd7cfd69fb0ffb77fa".substring(t,t+2)}000000`,16)>>24,r=0;i<0&&(i=-i,r=255);for(let t=0;t<i;++t)s[4*e+0]=r,s[4*e+1]=r,s[4*e+2]=r,s[4*e+3]=r,++e}}this._texture.initialize(),this._texture.bind((e=>{e.loadFromMemory(256,96,s)}))}setTextAlign(e,t){return this._horizontalTextAlign=e,this._verticalTextAlign=t,this}setTextScale(e){return this._textScale=e,this}setTextColor(e,t,i){return this._textColor[0]=e,this._textColor[1]=t,this._textColor[2]=i,this}pushText(e,t){if(0===e.length)return this;if(this._textScale<=0)return this;const i=[0];for(let t=0;t<e.length;++t)"\n"==e[t]?i.push(0):i[i.length-1]+=1;if(0===i.length)return this;let r=0;const s=[0,0],n=.5*this._textScale;switch(this._horizontalTextAlign){case"left":s[0]=t[0];break;case"centered":s[0]=t[0]-i[r]*n+n;break;case"right":s[0]=t[0]-i[r]*this._textScale+this._textScale}switch(this._verticalTextAlign){case"top":s[1]=t[1];break;case"centered":s[1]=t[1]+i.length*n-n;break;case"bottom":s[1]=t[1]-(i.length-1)*this._textScale}for(let o=0;o<e.length;++o){const a=e[o];if("\n"==a){switch(r+=1,this._horizontalTextAlign){case"left":s[0]=t[0];break;case"centered":s[0]=t[0]-i[r]*n+n;break;case"right":s[0]=t[0]-i[r]*this._textScale+this._textScale}s[1]-=this._textScale}else this._pushLetter(a,s),s[0]+=this._textScale}return this}_pushLetter(e,t){if(this._currentSize+90>=this._buffer.length)return;const i=this._texCoordMap.get(e);if(!i)throw new Error(`fail to find a letter, letter=${e}`);for(let e=-1;e<=1;++e)for(let r=-1;r<=1;++r)this._buffer[this._currentSize++]=t[0]+2*r,this._buffer[this._currentSize++]=t[1]+2*e,this._buffer[this._currentSize++]=-.1,this._buffer[this._currentSize++]=i[0],this._buffer[this._currentSize++]=i[1],this._buffer[this._currentSize++]=0,this._buffer[this._currentSize++]=0,this._buffer[this._currentSize++]=0,this._buffer[this._currentSize++]=this._textScale;this._buffer[this._currentSize++]=t[0],this._buffer[this._currentSize++]=t[1],this._buffer[this._currentSize++]=0,this._buffer[this._currentSize++]=i[0],this._buffer[this._currentSize++]=i[1],this._buffer[this._currentSize++]=this._textColor[0],this._buffer[this._currentSize++]=this._textColor[1],this._buffer[this._currentSize++]=this._textColor[2],this._buffer[this._currentSize++]=this._textScale}flush(e){return 0===this._currentSize||(this._shader.bind((t=>{t.setMatrix4Uniform("u_composedMatrix",e),t.setTextureUniform("u_texture",this._texture,0),this._geometry.allocateBuffer(1,this._buffer.slice(0,this._currentSize),this._currentSize),this._geometry.setInstancedCount(this._currentSize/9),this._geometry.render()})),_e.unbind(),this.clear()),this}clear(){return this._currentSize=0,this}}const De=[.2,.2,.2],Pe=[.2,.6,.2],ze=(e,t,i)=>{const{center:r}=e;t.pushCenteredRectangle(y(r[0],r[1],-.3),e.size,[0,0,0]),t.pushCenteredRectangle(y(r[0],r[1],-.2),[e.size[0]-2,e.size[1]-2],e.color),e.text&&i.setTextScale(16).setTextAlign("centered","centered").pushText(e.text,r).setTextAlign("left","top"),e.lines&&e.lines.forEach((e=>{t.pushThickLine([r[0]+e.a[0],r[1]+e.a[1],0],[r[0]+e.b[0],r[1]+e.b[1],0],e.thickness,e.color)}))},Me=(e,t,i,r,s,n=!1)=>{const o=5*Math.ceil(i.maxDelta/5);{r.pushOriginBoundRectangle(e,t,[0,0,0,.5]);const i=[[e[0]+0*t[0],e[1]+0*t[1],0],[e[0]+1*t[0],e[1]+0*t[1],0],[e[0]+1*t[0],e[1]+1*t[1],0],[e[0]+0*t[0],e[1]+1*t[1],0]];r.pushLine(i[0],i[1],[1,1,1]),r.pushLine(i[1],i[2],[1,1,1]),r.pushLine(i[2],i[3],[1,1,1]),r.pushLine(i[3],i[0],[1,1,1])}for(let i=5;i<o;i+=5){const s=i/o,n=[e[0]+0,e[1]+t[1]*s,0],a=[e[0]+t[0],e[1]+t[1]*s,0];r.pushLine(n,a,[.5,.5,.5])}if(i.framesDelta.length>=2){const s=t[0]/i.framesDelta.length;let n=i.framesDelta[0],a=0,f=t[1]*n/o;for(let d=1;d<i.framesDelta.length;++d){const h=i.framesDelta[d],c=d*s,u=t[1]*h/o,_=[e[0]+a,e[1]+f,0],l=[e[0]+c,e[1]+u,0];r.pushLine(_,l,[1,1,1]),n=h,a=c,f=u}}{const r=14,o=.5*r,a=i.averageDelta,f=i.maxDelta,d=i.minDelta;let h=`~${a.toFixed(0)}ms`,c=`<${f}ms`,u=`>${d}ms`;if(!0===n){const e=e=>e<999?e.toFixed(0):"???";h+=`\n~${e(1e3/a)}fps`,c+=`\n<${e(1e3/f)}fps`,u+=`\n>${e(1e3/d)}fps`}s.setTextScale(r).setTextAlign("left","top").setTextColor(1,1,.75).pushText(h,[e[0]+7,e[1]-8]).setTextAlign("left","centered").setTextColor(1,.75,.75).pushText(c,[e[0]+t[0]+o,e[1]+t[1]-1*o]).setTextColor(.75,1,.75).pushText(u,[e[0]+t[0]+o,e[1]+1*o]).setTextColor(1,1,1)}},Le=.55*Math.PI;class Fe{constructor(){this._hashSet=new Set}clear(){this._hashSet.clear()}add(e){this._hashSet.add(Fe._getName(e))}delete(e){this._hashSet.delete(Fe._getName(e))}has(e){this._hashSet.has(Fe._getName(e))}static _getName(e){return`${e[0]}/${e[1]}/${e[2]}`}}class Ue{constructor(e){this._unusedWorkers=[],this._inUseWorkers=[],this._onWorkerResult=e}areAllWorkerAvailable(){return 0===this._inUseWorkers.length}isWorkerAvailable(){return this._unusedWorkers.length>0}getInUseWorkersData(){return this._inUseWorkers.map((e=>e.data))}pushTask(e){if(!this.isWorkerAvailable())return!1;const t=this._unusedWorkers.pop();return this._inUseWorkers.push(t),e(t.data,((e,i)=>{t.instance.postMessage(e,i)})),!0}addOneWorker(e,t){const i={instance:new Worker(e),data:t};this._unusedWorkers.push(i),i.instance.addEventListener("message",(e=>{const t=this._inUseWorkers.indexOf(i);t>=0&&(this._unusedWorkers.push(i),this._inUseWorkers.splice(t,1)),this._onWorkerResult(i.data,e.data)}),!1)}}class Be{constructor(e){this._cameraPosition=y(0,0,0),this._chunkPositionQueue=[],this._savedIndex=[999,999,999],this._unusedChunks=[],this._usedChunks=[],this._usedSet=new Fe,this._def=e}clear(){this._chunkPositionQueue.length=0,this._unusedChunks.forEach((e=>this._def.releaseGeometry(e.geometry))),this._unusedChunks.length=0,this._usedChunks.forEach((e=>this._def.releaseGeometry(e.geometry))),this._usedChunks.length=0,this._usedSet.clear()}isEmpty(){return 0===this._usedChunks.length}isNotDone(){return this._chunkPositionQueue.length>0}getChunks(){return this._usedChunks}pushNew(e,t,i,r,s){const n=this._def.acquireGeometry(r),o=i.slice(0,s);if(0===this._unusedChunks.length)this._usedChunks.push({realPosition:[...t],indexPosition:[...e],geometry:n,isVisible:!1,isDirty:!0,geometryFloat32buffer:new Float32Array(o),geometryBufferSizeUsed:s});else{const i=this._unusedChunks.pop();i.realPosition=[...t],i.indexPosition=[...e],i.isVisible=!1,i.isDirty=!0,i.geometryFloat32buffer=new Float32Array(o),i.geometryBufferSizeUsed=s,this._usedChunks.push(i)}this._usedSet.add(e),this._def.onChunkCreated()}update(e,t){this._updateGeneration(e,t);for(const e of this._usedChunks){const t=this._def.chunkIsVisible(e.realPosition);e.isVisible=t}for(const e of this._usedChunks)if(e.isVisible&&e.isDirty){e.geometry.update(e.realPosition,e.geometryBufferSizeUsed,e.geometryFloat32buffer),e.isDirty=!1;break}}_updateGeneration(e,t){k(this._cameraPosition,e);const i=[Math.floor(e[0]/this._def.chunkGraphicSize),Math.floor(e[1]/this._def.chunkGraphicSize),Math.floor(e[2]/this._def.chunkGraphicSize)];let r=!1;if(0===this._usedChunks.length&&t.areAllWorkerAvailable()&&(r=!0),r||M(i,this._savedIndex)||(r=!0),!1===r)return;k(this._savedIndex,i),this._chunkPositionQueue.length=0;const{chunkGenerationRange:s}=this._def,n=[Math.floor(i[0]-s),Math.floor(i[1]-s),Math.floor(i[2]-s)],o=[Math.floor(i[0]+s),Math.floor(i[1]+s),Math.floor(i[2]+s)];for(let e=0;e<this._usedChunks.length;){const{indexPosition:t}=this._usedChunks[e];if(t[0]<n[0]||t[0]>o[0]||t[1]<n[1]||t[1]>o[1]||t[2]<n[2]||t[2]>o[2]){this._def.releaseGeometry(this._usedChunks[e].geometry);const i=this._usedChunks.splice(e,1);this._unusedChunks.push(i[0]),this._usedSet.delete(t),this._def.onChunkDiscarded()}else++e}const a=[0,0,0];for(a[2]=n[2];a[2]<=o[2];++a[2])for(a[1]=n[1];a[1]<=o[1];++a[1])for(a[0]=n[0];a[0]<=o[0];++a[0])this._usedChunks.findIndex((e=>this._usedSet.has(e.indexPosition)))>=0||t.getInUseWorkersData().findIndex((e=>M(e.processing.indexPosition,a)))>=0||this._chunkPositionQueue.push({indexPosition:[...a],realPosition:[a[0]*this._def.chunkGraphicSize,a[1]*this._def.chunkGraphicSize,a[2]*this._def.chunkGraphicSize]})}getBestNextChunkPosition(){if(0===this._chunkPositionQueue.length)return;const e=e=>{const t=.5*this._def.chunkGraphicSize;return r=(i=[this._cameraPosition[0]-(e[0]+t),this._cameraPosition[1]-(e[1]+t),this._cameraPosition[2]-(e[2]+t)])[0],s=i[1],n=i[2],Math.hypot(r,s,n);var i,r,s,n};let t=-1,i=-1;for(let r=0;r<this._chunkPositionQueue.length;++r){const{realPosition:s}=this._chunkPositionQueue[r];if(!this._def.chunkIsVisible(s))continue;const n=e(s);i>=0&&i<n||(t=r,i=n)}return t<0?void 0:this._chunkPositionQueue.splice(t,1)[0]}}class Ie{constructor(e){this._running=!1,this._frameProfiler=new O,this._def=e,this._chunkManager=new Be({chunkGraphicSize:e.chunkGraphicSize,chunkGenerationRange:e.chunkGenerationRange,chunkLogicSize:e.chunkLogicSize,chunkIsVisible:e.chunkIsVisible,acquireGeometry:e.acquireGeometry,releaseGeometry:e.releaseGeometry,onChunkCreated:e.onChunkCreated,onChunkDiscarded:e.onChunkDiscarded}),this._workerManager=new Ue(((e,t)=>{const{indexPosition:i,realPosition:r,geometryFloat32buffer:s,geometryBufferSize:n,sizeUsed:o}=t,a=Date.now()-t.time;this._frameProfiler.pushDelta(a),e.geometryFloat32buffer=s,e.processing=void 0,this._running&&(this._chunkManager.pushNew(i,r,e.geometryFloat32buffer,n,o),this._launchWorker())})),this._dataBufferSize=Math.pow(this._def.chunkLogicSize+1+1,3),this._geometryBufferSize=20*this._dataBufferSize*6*3;for(let e=0;e<this._def.workerTotal;++e)this._workerManager.addOneWorker(this._def.workerFile,{geometryFloat32buffer:new Float32Array(this._geometryBufferSize)})}start(){this._running=!0}stop(){this._running&&(this._running=!1,this._chunkManager.clear())}update(e){this._running&&(this._chunkManager.update(e,this._workerManager),this._launchWorker())}_launchWorker(){for(;this._chunkManager.isNotDone()&&this._workerManager.isWorkerAvailable();){const e=this._chunkManager.getBestNextChunkPosition();if(!e)break;this._workerManager.pushTask(((t,i)=>{t.processing=e,i({realPosition:e.realPosition,indexPosition:e.indexPosition,geometryFloat32buffer:t.geometryFloat32buffer,geometryBufferSize:this._geometryBufferSize,sizeUsed:0,time:Date.now()},[t.geometryFloat32buffer.buffer])}))}}getChunks(){return this._chunkManager.getChunks()}getFrameProfiler(){return this._frameProfiler}getProcessingRealPositions(){return this._workerManager.getInUseWorkersData().map((e=>e.processing.realPosition))}}var Ne="\n#version 300 es\n\nprecision highp float;\n\nuniform mat4 u_composedMatrix;\nuniform float u_sceneScale;\nuniform float u_tileRepeat;\n\nin vec3 a_vertex_position;\nin vec3 a_vertex_normal;\nin vec3 a_offset_origin;\n\nout vec3 v_chunkSpacePosition;\nout vec3 v_worldSpacePosition;\nout vec3 v_worldSpaceNormal;\n\nvoid main(void)\n{\n  vec3 chunkSpacePosition = a_vertex_position * u_sceneScale;\n\n  v_chunkSpacePosition = a_vertex_position * u_tileRepeat;\n  v_worldSpacePosition = a_offset_origin + chunkSpacePosition;\n  v_worldSpaceNormal = a_vertex_normal;\n\n  gl_Position = u_composedMatrix * vec4(v_worldSpacePosition, 1.0);\n}\n".trim(),Xe="\n#version 300 es\n\nprecision lowp float;\nprecision highp sampler2DArray;\n\nconst float k_ambiantCoef = 0.1;\nconst vec3 k_specColor = vec3(1.0, 1.0, 1.0);\n\nuniform sampler2DArray u_textureArray;\n\nuniform vec3 u_eyePosition;\n\nin vec3 v_chunkSpacePosition;\nin vec3 v_worldSpacePosition;\nin vec3 v_worldSpaceNormal;\n\nout vec4 o_color;\n\nvec4 _getColorValue()\n{\n\n  // current 3d texture coordinate\n  vec3 flooredPos = vec3(\n    v_chunkSpacePosition.x - floor(v_chunkSpacePosition.x),\n    v_chunkSpacePosition.y - floor(v_chunkSpacePosition.y),\n    v_chunkSpacePosition.z - floor(v_chunkSpacePosition.z)\n  );\n\n  vec3 blendWeights = abs( normalize( v_worldSpaceNormal.xyz ) );\n  blendWeights = max( ( blendWeights - 0.2 ) * 7.0, 0.0 );\n  blendWeights /= ( blendWeights.x + blendWeights.y + blendWeights.z );\n\n  // horizontal texture coordinates -> should be a wall\n  vec2 texCoordX = vec2(flooredPos.y, flooredPos.z);\n  vec2 texCoordY = vec2(flooredPos.x, flooredPos.z);\n\n  // vertical texture coord -> should be green grass\n  vec2 texCoordZ = vec2(flooredPos.x, flooredPos.y);\n\n  // horizontal color\n  vec3 texColorX = texture( u_textureArray, vec3(texCoordX, 2) ).rgb;\n  vec3 texColorY = texture( u_textureArray, vec3(texCoordY, 2) ).rgb;\n\n  float specularRatioX = texture( u_textureArray, vec3(texCoordX, 3) ).r * blendWeights.x;\n  float specularRatioY = texture( u_textureArray, vec3(texCoordY, 3) ).r * blendWeights.y;\n  float specularRatio = max( specularRatioX, specularRatioY );\n\n  // vertical color\n  vec3 texColorZ = vec3(0.0);\n  if (v_worldSpaceNormal.z < 0.0)\n  {\n    texColorZ = texture( u_textureArray, vec3(texCoordZ, 0) ).rgb;\n  }\n  else\n  {\n    texColorZ = texture( u_textureArray, vec3(texCoordZ, 1) ).rgb;\n  }\n\n  return vec4(\n    texColorX * blendWeights.xxx +\n    texColorY * blendWeights.yyy +\n    texColorZ * blendWeights.zzz,\n    specularRatio\n  );\n}\n\nvec3 _getLightColor(vec4 currentColor)\n{\n  vec3 normal = normalize(v_worldSpaceNormal);\n  vec3 lightDir = normalize(u_eyePosition - v_worldSpacePosition);\n\n  float diffuseCoef = max(dot(lightDir,v_worldSpaceNormal.xyz), 0.0);\n  float specularCoef = 0.0;\n\n  if (diffuseCoef > 0.0)\n  {\n    // specular\n\n    vec3 reflectDir = reflect(-lightDir, normal);\n    vec3 viewDir = normalize(u_eyePosition - v_worldSpacePosition);\n\n    float specAngle = max(dot(reflectDir, viewDir), 0.0);\n    specularCoef = pow(specAngle, 16.0);\n  }\n\n  vec3 diffuseColor = currentColor.rgb * (k_ambiantCoef + diffuseCoef);\n  vec3 specularColor = k_specColor * specularCoef * currentColor.a;\n\n  return diffuseColor + specularColor;\n}\n\nvoid main(void)\n{\n  o_color = vec4(_getLightColor(_getColorValue()), 1.0);\n}\n".trim();const{GeometryWrapper:Ge,ShaderProgram:Ve,TextureArray:Oe,FenceSync:We}=le;class Ye{constructor(e,t,i){this._origin=y(0,0,0),this._size=0,this._fence=new We,this._geometry=new Ge.Geometry(e,t),this._geometry.setFloatBufferSize(0,i),this._geometry.setFloatBufferSize(1,12)}update(e,t,i){k(this._origin,e),this._size=t,this._geometry.updateBuffer(0,i.slice(0,t),t),this._geometry.setPrimitiveCount(t/6);const r=new Float32Array([e[0],e[1],e[2]]);this._geometry.updateBuffer(1,r,r.length),this._geometry.setInstancedCount(1),this._fence.start()}render(){if(this._fence.isStarted()){if(!this._fence.isSignaled())return;this._fence.dispose()}this._geometry.render()}reuse(){this._fence.dispose()}getOrigin(){return this._origin}getSize(){return this._size}}class $e{constructor(){this._textureArray=new Oe,this._unusedGeometries=[],this._inUseGeometries=[],this._shader=new Ve("ChunksRenderer",{vertexSrc:Ne,fragmentSrc:Xe,attributes:["a_vertex_position","a_vertex_normal","a_offset_origin"],uniforms:["u_composedMatrix","u_eyePosition","u_sceneScale","u_tileRepeat","u_textureArray"]});const e=new Ge.GeometryBuilder;e.reset().setPrimitiveType("triangles").addVbo().addVboAttribute("a_vertex_position","vec3f").addVboAttribute("a_vertex_normal","vec3f").setStride(24).addVbo().setVboAsInstanced().addVboAttribute("a_offset_origin","vec3f").setStride(12),this._geometryDefinition=e.getDef()}initialize(){return e(this,void 0,void 0,(function*(){const e=yield new Promise(((e,t)=>{const i=new Image;i.onerror=t,i.onload=()=>{e(i)},i.src="assets/composed.png"}));this._textureArray.initialize(),this._textureArray.bind((t=>{t.loadFromImage(512,512,4,e)})),this._shader.bind((e=>{e.setTextureUniform("u_textureArray",this._textureArray,1)}))}))}acquireGeometry(e){if(this._unusedGeometries.length>0){const e=this._unusedGeometries.pop();return this._inUseGeometries.push(e),e}const t=new Ye(this._shader,this._geometryDefinition,e);return this._inUseGeometries.push(t),t}releaseGeometry(e){const t=e,i=this._inUseGeometries.indexOf(t);i<0||(t.reuse(),this._unusedGeometries.push(t),this._inUseGeometries.splice(i,1))}render(e,t,i){const r=e.getEye();this._shader.bind((s=>{s.setMatrix4Uniform("u_composedMatrix",e.getComposedMatrix()),s.setFloat3Uniform("u_eyePosition",r[0],r[1],r[2]),s.setFloat1Uniform("u_sceneScale",i),s.setFloat1Uniform("u_tileRepeat",2),this._inUseGeometries.map((e=>{const t=.5*e.getSize(),i=e.getOrigin()[0]+t,r=e.getOrigin()[1]+t,s=e.getOrigin()[2]+t;return{geometry:e,center:[i,r,s],distance:0}})).filter((({center:e,geometry:i})=>t.cubeInFrustumVec3(e,i.getSize()))).map((t=>{var i,r,s,n,o;return t.distance=(i=t.center,s=(r=e.getEye())[0]-i[0],n=r[1]-i[1],o=r[2]-i[2],Math.hypot(s,n,o)),t})).sort(((e,t)=>e.distance-t.distance)).forEach((e=>e.geometry.render()))}))}}var He="\n#version 300 es\n\nprecision highp float;\n\nuniform mat4 u_composedMatrix;\n\nin vec3  a_vertex_position;\n\nin vec3  a_offset_center;\nin float a_offset_scale;\nin vec4  a_offset_color;\n\nflat out vec4 v_color;\n\nvoid main(void)\n{\n  vec3 position = a_offset_center + a_vertex_position * a_offset_scale;\n\n  gl_Position = u_composedMatrix * vec4(position, 1.0);\n\n  v_color = a_offset_color;\n}\n".trim(),je="\n#version 300 es\n\nprecision lowp float;\n\nflat in vec4 v_color;\n\nout vec4 out_color;\n\nvoid main(void)\n{\n  out_color = v_color;\n}\n".trim();const{ShaderProgram:qe,GeometryWrapper:Ze}=le,Ke=(e,t)=>{const i=[],r=.5*t[0],s=.5*t[1],n=.5*t[2],o=[[e[0]-r,e[1]-s,e[2]-n],[e[0]+r,e[1]-s,e[2]-n],[e[0]-r,e[1]+s,e[2]-n],[e[0]+r,e[1]+s,e[2]-n],[e[0]-r,e[1]-s,e[2]+n],[e[0]+r,e[1]-s,e[2]+n],[e[0]-r,e[1]+s,e[2]+n],[e[0]+r,e[1]+s,e[2]+n]],a=[];a.push(0,2,1),a.push(2,3,1),a.push(4,5,6),a.push(6,5,7),a.push(1,3,5),a.push(5,3,7),a.push(0,4,2),a.push(4,6,2),a.push(2,6,3),a.push(6,7,3),a.push(0,1,4),a.push(4,1,5);for(const e of a)i.push(o[e]);return i};class Qe{constructor(){this._buffer=new Float32Array(32768),this._currentSize=0,this._shader=new qe("TriangleCubesRenderer",{vertexSrc:He,fragmentSrc:je,attributes:["a_vertex_position","a_offset_center","a_offset_scale","a_offset_color"],uniforms:["u_composedMatrix"]});const e=new Ze.GeometryBuilder;e.reset().setPrimitiveType("triangles").addVbo().addVboAttribute("a_vertex_position","vec3f").setStride(12).addVbo().setVboAsDynamic().setVboAsInstanced().addVboAttribute("a_offset_center","vec3f").addVboAttribute("a_offset_scale","float").addVboAttribute("a_offset_color","vec4f").setStride(32);const t=(()=>{const e=1/512,t=.4990234375,i=[...Ke([1*-t,1*-t,0],[e,e,1]),...Ke([1*+t,1*-t,0],[e,e,1]),...Ke([1*+t,1*+t,0],[e,e,1]),...Ke([1*-t,1*+t,0],[e,e,1]),...Ke([1*-t,0,1*-t],[e,1,e]),...Ke([1*+t,0,1*-t],[e,1,e]),...Ke([1*+t,0,1*+t],[e,1,e]),...Ke([1*-t,0,1*+t],[e,1,e]),...Ke([0,1*-t,1*-t],[1,e,e]),...Ke([0,1*+t,1*-t],[1,e,e]),...Ke([0,1*+t,1*+t],[1,e,e]),...Ke([0,1*-t,1*+t],[1,e,e])],r=[];return i.forEach((e=>{r.push(e[0],e[1],e[2])})),r})();this._geometry=new Ze.Geometry(this._shader,e.getDef()),this._geometry.allocateBuffer(0,t,t.length),this._geometry.setPrimitiveCount(t.length/3),this._geometry.setFloatBufferSize(1,32768)}pushCenteredCube(e,t,i){this._currentSize+8>=this._buffer.length||(this._buffer[this._currentSize++]=e[0],this._buffer[this._currentSize++]=e[1],this._buffer[this._currentSize++]=e[2],this._buffer[this._currentSize++]=t,this._buffer[this._currentSize++]=i[0],this._buffer[this._currentSize++]=i[1],this._buffer[this._currentSize++]=i[2],this._buffer[this._currentSize++]=i[3]||1)}pushOriginBoundCube(e,t,i){if(this._currentSize+8>=this._buffer.length)return;const r=.5*t;this._buffer[this._currentSize++]=e[0]+r,this._buffer[this._currentSize++]=e[1]+r,this._buffer[this._currentSize++]=e[2]+r,this._buffer[this._currentSize++]=t,this._buffer[this._currentSize++]=i[0],this._buffer[this._currentSize++]=i[1],this._buffer[this._currentSize++]=i[2],this._buffer[this._currentSize++]=i[3]||1}flush(e){this._currentSize<=0||(this._shader.bind((t=>{t.setMatrix4Uniform("u_composedMatrix",e.getComposedMatrix()),this._geometry.updateBuffer(1,this._buffer.slice(0,this._currentSize),this._currentSize),this._geometry.setInstancedCount(this._currentSize/8),this._geometry.render()})),this.clear())}clear(){this._currentSize=0}}var Je="\n#version 300 es\n\nprecision highp float;\n\nuniform mat4 u_composedMatrix;\n\nin vec3  a_vertex_position;\n\nin vec3  a_offset_center;\nin float a_offset_scale;\nin vec4  a_offset_color;\n\nflat out vec4 v_color;\n\nvoid main(void)\n{\n  vec3 position = a_offset_center + a_vertex_position * a_offset_scale;\n\n  gl_Position = u_composedMatrix * vec4(position, 1.0);\n\n  v_color = a_offset_color;\n}\n".trim(),et="\n#version 300 es\n\nprecision lowp float;\n\nflat in vec4 v_color;\n\nout vec4 out_color;\n\nvoid main(void)\n{\n  out_color = v_color;\n}\n".trim();const{ShaderProgram:tt,GeometryWrapper:it}=le;class rt{constructor(){this._buffer=new Float32Array(32768),this._currentSize=0,this._shader=new tt("WireFrameCubesRenderer",{vertexSrc:Je,fragmentSrc:et,attributes:["a_vertex_position","a_offset_center","a_offset_scale","a_offset_color"],uniforms:["u_composedMatrix"]});const e=new it.GeometryBuilder;e.reset().setPrimitiveType("lines").addVbo().addVboAttribute("a_vertex_position","vec3f").setStride(12).addVbo().setVboAsDynamic().setVboAsInstanced().addVboAttribute("a_offset_center","vec3f").addVboAttribute("a_offset_scale","float").addVboAttribute("a_offset_color","vec4f").setStride(32);const t=(()=>{const e=[];e.push([.5,.5,.5]),e.push([-.5,.5,.5]),e.push([.5,-.5,.5]),e.push([-.5,-.5,.5]),e.push([.5,.5,-.5]),e.push([-.5,.5,-.5]),e.push([.5,-.5,-.5]),e.push([-.5,-.5,-.5]);const t=[];t.push(0,1,1,3,3,2,2,0),t.push(4,5,5,7,7,6,6,4),t.push(0,4,1,5,3,7,2,6);const i=[];for(let r=0;r<t.length;++r){const s=e[t[r]];i.push(s[0],s[1],s[2])}return i})();this._geometry=new it.Geometry(this._shader,e.getDef()),this._geometry.allocateBuffer(0,t,t.length),this._geometry.setPrimitiveCount(t.length/3),this._geometry.setFloatBufferSize(1,32768)}pushCenteredCube(e,t,i){this._currentSize+8>=this._buffer.length||(this._buffer[this._currentSize++]=e[0],this._buffer[this._currentSize++]=e[1],this._buffer[this._currentSize++]=e[2],this._buffer[this._currentSize++]=t,this._buffer[this._currentSize++]=i[0],this._buffer[this._currentSize++]=i[1],this._buffer[this._currentSize++]=i[2],this._buffer[this._currentSize++]=i[3]||1)}pushOriginBoundCube(e,t,i){if(this._currentSize+8>=this._buffer.length)return;const r=.5*t;this._buffer[this._currentSize++]=e[0]+r,this._buffer[this._currentSize++]=e[1]+r,this._buffer[this._currentSize++]=e[2]+r,this._buffer[this._currentSize++]=t,this._buffer[this._currentSize++]=i[0],this._buffer[this._currentSize++]=i[1],this._buffer[this._currentSize++]=i[2],this._buffer[this._currentSize++]=i[3]||1}flush(e){this._currentSize<=0||(this._shader.bind((t=>{t.setMatrix4Uniform("u_composedMatrix",e),this._geometry.updateBuffer(1,this._buffer.slice(0,this._currentSize),this._currentSize),this._geometry.setInstancedCount(this._currentSize/8),this._geometry.render()})),this.clear())}clear(){this._currentSize=0}}const{GlobalMouseManager:st,GlobalTouchManager:nt}=x,{WebGLContext:ot,ShaderProgram:at}=le;class ft{constructor(e){this._viewportSize=I(),this._frustumCulling=new H,this._mainCamera=new $,this._mainHudCamera=new $,this.onContextLost=null,this.onContextRestored=null,this._def=e,ot.initialize(this._def.canvasDomElement),this._def.canvasDomElement.addEventListener("webglcontextlost",(e=>{e.preventDefault(),console.log("context is lost"),this.onContextLost&&this.onContextLost()}),!1),this._def.canvasDomElement.addEventListener("webglcontextrestored",(()=>{console.log("context is restored"),ot.initialize(this._def.canvasDomElement),this.onContextRestored&&this.onContextRestored()}),!1),this._scene={chunksRenderer:new $e,triangleCubesRenderer:new Qe},this._hud={textRenderer:new ke,stackRenderers:new Se,wireFrameCubesRenderer:new rt,multipleBuffering:new xe(this._def.canvasDomElement.width,this._def.canvasDomElement.height)},this.resize(this._def.canvasDomElement.width,this._def.canvasDomElement.height)}resize(e,t){this._viewportSize[0]=e,this._viewportSize[1]=t,this._mainCamera.setViewportSize(e,t),this._mainCamera.setAsPerspective({fovy:70,near:.1,far:70}),this._mainHudCamera.setViewportSize(e,t),this._mainHudCamera.setAsOrthogonal({left:.5*-e,right:.5*+e,top:.5*-t,bottom:.5*+t,near:-200,far:200}),this._mainHudCamera.setEye([.5*+e,.5*+t,1]),this._mainHudCamera.setTarget([.5*+e,.5*+t,0]),this._mainHudCamera.setUpAxis([0,1,0]),this._mainHudCamera.computeMatrices(),this._hud.multipleBuffering.resize(e,t)}toggleContextLoss(){const e=ot.getContext(),t=ot.getExtensionLoseContext();t&&(e.isContextLost()?t.restoreContext():t.loseContext())}contextIsLost(){return ot.getContext().isContextLost()}setOnContextLost(e){this.onContextLost=e}setOnContextRestored(e){this.onContextRestored=e}init(){return e(this,void 0,void 0,(function*(){const e=ot.getContext();e.clearColor(0,0,0,1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LESS),e.disable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_COLOR),e.activeTexture(e.TEXTURE0),e.enable(e.CULL_FACE),yield this._scene.chunksRenderer.initialize()}))}getSize(){return this._viewportSize}lookAt(e,t,i){this._mainCamera.setEye(e),this._mainCamera.setTarget(t),this._mainCamera.setUpAxis(i),this._mainCamera.computeMatrices()}update(){st.resetDeltas(),nt.resetDeltas(),this._frustumCulling.calculateFrustum(this._mainCamera.getProjectionMatrix(),this._mainCamera.getViewMatrix())}renderScene(e){const t=ot.getContext(),i=this._mainCamera.getViewportPos(),r=this._mainCamera.getViewportSize();t.viewport(i[0],i[1],r[0],r[1]),t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),e()}renderHUD(e){const t=ot.getContext(),i=this._mainHudCamera.getViewportPos(),r=this._mainHudCamera.getViewportSize();t.viewport(i[0],i[1],r[0],r[1]),t.clear(t.DEPTH_BUFFER_BIT),at.unbind(),e()}flush(){j.getContext().flush()}get mainCamera(){return this._mainCamera}get hudCamera(){return this._mainHudCamera}get frustumCulling(){return this._frustumCulling}get chunksRenderer(){return this._scene.chunksRenderer}get triangleCubesRenderer(){return this._scene.triangleCubesRenderer}get stackRenderers(){return this._hud.stackRenderers}get wireFrameCubesRenderer(){return this._hud.wireFrameCubesRenderer}get textRenderer(){return this._hud.textRenderer}get multipleBuffering(){return this._hud.multipleBuffering}}const{WebGLContext:dt}=le,{GlobalTouchManager:ht}=x,ct=new Map,{GlobalKeyboardManager:ut,GlobalTouchManager:_t,GlobalMouseManager:lt,GlobalPointerLockManager:pt}=x;class mt{constructor(e){this._chunksCreated=0,this._chunksDiscarded=0,this._currFrameTime=0,this._frameProfiler=new O,this._canvasElement=e,this._freeFlyController=new V({position:y(0,0,0),coordinates:["X","Y","Z"],theta:0,phi:0,mouseSensibility:15,movingSpeed:32,keyboardSensibility:Le,touchSensibility:15}),this._renderer=new ft({canvasDomElement:e}),this._chunkGenerator=new Ie({chunkGraphicSize:30,chunkGenerationRange:2,chunkLogicSize:8,workerTotal:2,workerFile:"./dist/worker.js",chunkIsVisible:e=>this._renderer.frustumCulling.cubeInFrustum(e[0]+15,e[1]+15,e[2]+15,30),acquireGeometry:e=>this._renderer.chunksRenderer.acquireGeometry(e),releaseGeometry:e=>{this._renderer.chunksRenderer.releaseGeometry(e)},onChunkCreated:()=>{++this._chunksCreated},onChunkDiscarded:()=>{++this._chunksDiscarded}}),ut.activate(),_t.activate(this._canvasElement),pt.allowPointerLockedOnClickEvent(e),pt.addOnLockChange((()=>{pt.isPointerLocked(e)?lt.activate(document.body):(lt.deactivate(document.body),pt.allowPointerLockedOnClickEvent(e))})),pt.addOnLockError((e=>{})),this._running=!1,this._errorGraphicContext=!1,this._renderer.setOnContextLost((()=>{throw console.log("on_context_lost"),new Error("WebGL2 context was lost")}))}init(){return e(this,void 0,void 0,(function*(){yield this._renderer.init()}))}resize(e,t){this._renderer.resize(e,t)}start(){this.isRunning()||(this._running=!0,this._chunkGenerator.start(),this._tick())}stop(){this._running=!1,this._chunkGenerator.stop()}isRunning(){return this._running&&!this._errorGraphicContext}_tick(){const e=()=>{this._running&&!this._errorGraphicContext&&(window.setTimeout(e,1e3/60),this._mainLoop())};e()}_mainLoop(){const e=Date.now(),t=(i=e-this._currFrameTime,Math.min(Math.max(i,0),1e3));var i;this._currFrameTime=e,this._frameProfiler.pushDelta(t);const r=t/1e3;this._freeFlyController.update(r),this._renderer.lookAt(this._freeFlyController.getPosition(),this._freeFlyController.getTarget(),this._freeFlyController.getUpAxis()),this._renderer.update();const s=this._freeFlyController.getPosition();this._chunkGenerator.update(s);let n=0;this._chunkGenerator.getChunks().forEach((e=>{e.isVisible&&++n})),this._renderer.multipleBuffering.captureScene((()=>{this._renderer.renderScene((()=>{this._renderer.wireFrameCubesRenderer.clear(),this._chunkGenerator.getChunks().forEach((e=>{e.isVisible&&this._renderer.triangleCubesRenderer.pushOriginBoundCube(e.realPosition,30,[1,1,1])})),this._renderer.triangleCubesRenderer.flush(this._renderer.mainCamera),this._renderer.chunksRenderer.render(this._renderer.mainCamera,this._renderer.frustumCulling,30)}))})),this._renderer.renderHUD((()=>{const e=j.getContext();e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this._renderer.multipleBuffering.renderHud(this._renderer.hudCamera.getComposedMatrix()),this._renderer.stackRenderers.clear(),this._renderer.textRenderer.clear(),((e,t,i,r,s)=>{const n=[e[0]-10,e[1]-10],o=[`Chunks\nGenerated:\n${t} <`,"",`Chunks\nDiscarded:\n${i} <`,"",`Live\nChunks:\n${t-i} <`,"",`Visible\nChunks:\n${r} <`].join("\n");s.setTextScale(14).setTextAlign("right","top").pushText(o,n)})(this._renderer.getSize(),this._chunksCreated,this._chunksDiscarded,n,this._renderer.textRenderer),((e,t,i,r)=>{const s=[Math.floor(i[0]/30),Math.floor(i[1]/30),Math.floor(i[2]/30)],n=["Coordinates:",`X: ${s[0]}`,`Y: ${s[1]}`,`Z: ${s[2]}`],o=[14,e[1]-200];r.setTextScale(14).setTextAlign("left","top").pushText(n.join("\n"),o)})(this._renderer.getSize(),0,s,this._renderer.textRenderer);{const e=[27,260],s=[7,35];t=[27,165],i=this._renderer.stackRenderers,r=this._renderer.textRenderer,ze({center:[t[0],t[1]],size:[40,40],text:"A\nQ",color:a.isPressed("A","Q")?Pe:De},i,r),ze({center:[t[0]+45,t[1]],size:[40,40],text:"S",color:a.isPressed("S")?Pe:De},i,r),ze({center:[t[0]+45,t[1]+45],size:[40,40],text:"W\nZ",color:a.isPressed("W","Z")?Pe:De},i,r),ze({center:[t[0]+90,t[1]],size:[40,40],text:"D",color:a.isPressed("D")?Pe:De},i,r),((e,t,i)=>{ze({center:[e[0],e[1]],size:[40,40],lines:[{a:[15,0],b:[-8,0],thickness:6,color:[1,1,1]},{a:[0,10],b:[-12,-2],thickness:6,color:[1,1,1]},{a:[0,-10],b:[-12,2],thickness:6,color:[1,1,1]}],color:a.isPressed("ArrowLeft")?Pe:De},t,i),ze({center:[e[0]+45,e[1]],size:[40,40],lines:[{a:[0,15],b:[0,-8],thickness:6,color:[1,1,1]},{a:[10,0],b:[-2,-12],thickness:6,color:[1,1,1]},{a:[-10,0],b:[2,-12],thickness:6,color:[1,1,1]}],color:a.isPressed("ArrowDown")?Pe:De},t,i),ze({center:[e[0]+45,e[1]+45],size:[40,40],lines:[{a:[0,-15],b:[0,8],thickness:6,color:[1,1,1]},{a:[10,0],b:[-2,12],thickness:6,color:[1,1,1]},{a:[-10,0],b:[2,12],thickness:6,color:[1,1,1]}],color:a.isPressed("ArrowUp")?Pe:De},t,i),ze({center:[e[0]+90,e[1]],size:[40,40],lines:[{a:[-15,0],b:[8,0],thickness:6,color:[1,1,1]},{a:[0,10],b:[12,-2],thickness:6,color:[1,1,1]},{a:[0,-10],b:[12,2],thickness:6,color:[1,1,1]}],color:a.isPressed("ArrowRight")?Pe:De},t,i)})(e,this._renderer.stackRenderers,this._renderer.textRenderer),((e,t,i,r)=>{g.isSupported(e)?ze({center:[t[0]+115,t[1]],size:[230,60],text:"Touch Events\nSupported\n(double tap)",color:[0,.5,0]},i,r):ze({center:[t[0]+115,t[1]],size:[230,60],text:"Touch Events\nNot Supported",color:[.5,0,0]},i,r),p.canBePointerLocked(e)?ze({center:[t[0]+105,t[1]+70],size:[210,60],text:"Mouse\nSupported",color:[0,.5,0]},i,r):ze({center:[t[0]+105,t[1]+70],size:[210,60],text:"Mouse Events\nNot Supported",color:[.5,0,0]},i,r)})(this._canvasElement,s,this._renderer.stackRenderers,this._renderer.textRenderer)}var t,i,r;Me([10,this._canvasElement.height-60,0],[100,50],this._frameProfiler,this._renderer.stackRenderers,this._renderer.textRenderer,!0),Me([10,this._canvasElement.height-150,0],[100,50],this._chunkGenerator.getFrameProfiler(),this._renderer.stackRenderers,this._renderer.textRenderer),((e,t,i)=>{const r=ht.getTouchData();if(0===r.length)ct.clear();else{const s=new Set,n=[1,0,0],o=[0,1,0],a=r.length>1?n:o;r.forEach((r=>{s.add(r.id);let n=ct.get(r.id);void 0===n&&(n=0,ct.set(r.id,n));const o=[0,.5];i&&o.push(.25,.75);for(const i of o){const s=n+i*Math.PI,o=[r.positionX,e[1]-r.positionY,0];t.pushRotatedLine(o,s,150,15,a)}n+=.1,ct.set(r.id,n)}));const f=new Set;ct.forEach(((e,t)=>{s.has(t)||f.add(t)})),f.forEach((e=>{ct.delete(e)}))}})(this._renderer.getSize(),this._renderer.stackRenderers,this._freeFlyController.getTouchMoveForward()),this._renderer.stackRenderers.flush(this._renderer.hudCamera.getComposedMatrix()),this._renderer.textRenderer.flush(this._renderer.hudCamera.getComposedMatrix()),this._renderer.stackRenderers.clear(),this._renderer.textRenderer.clear(),((e,t,i,r,s,n,o,a,f)=>{const d=dt.getContext(),[h,c]=n,u=new $,_=.5*Math.min(h,c),l=Math.max(_,300),p=Math.max(_,300),m=h-l;u.setViewportPos(m,0),u.setViewportSize(l,p);const g=l/p,b=g>=1?i:i*(1/g),x=b*g;u.setAsOrthogonal({left:-x,right:+x,top:-b,bottom:+b,near:-150,far:150}),u.setUpAxis([0,0,1]);const v=e.getEye(),E=e.getTarget(),T=F(A(),E,v),C=Math.atan2(T[1],T[0]),P=Math.atan2(T[2],(L=(M=N(T[1],T[0]))[0],B=M[1],Math.hypot(L,B)));var M,L,B;const I=C-.25*Math.PI,X=P+.5*Math.PI,G=Math.cos(I),V=Math.sin(I),O=Math.sin(X),W=k(A(),v);W[0]-=20*G,W[1]-=20*V,W[2]+=10*O,u.setEye(W),u.setTarget(v),u.computeMatrices();const Y=u.getViewportPos(),H=u.getViewportSize();d.viewport(Y[0],Y[1],H[0],H[1]),d.clear(d.DEPTH_BUFFER_BIT),d.disable(d.DEPTH_TEST),d.enable(d.BLEND),a.clear();const j=y(1,1,1),q=U(1,0,0,.8),Z=y(0,1,0),K=A(),Q=y(15,15,15);if(r.forEach((e=>{k(K,e.realPosition),D(K,K,Q),e.isVisible?a.pushCenteredCube(K,15,j):a.pushCenteredCube(K,15,q)})),o.length>0){const e=36;o.forEach((t=>{k(K,t),D(K,K,Q),a.pushCenteredCube(K,e,Z)}))}a.flush(u.getComposedMatrix()),f.flush(u.getComposedMatrix());{const t=e.getPerspectiveData();((e,t,i,r,s,n,o,a)=>{const f=Math.tan(e/360*Math.PI)*i,d=f*t,h=-d,c=+d,u=+f,_=-f,l=r*Math.sin(e*Math.PI/180),p=l*t,m=[];m.push([i,h,u]),m.push([i,c,u]),m.push([i,h,_]),m.push([i,c,_]),m.push([r,-p,+l]),m.push([r,+p,+l]),m.push([r,-p,-l]),m.push([r,+p,-l]),m.push([0,0,0]),m.push([100,0,0]),m.push([0,100,0]),m.push([0,0,100]);{const e=S(w());!function(e,t,i){var r,s,n,o,a,f,d,h,c,u,_,l,p=i[0],m=i[1],g=i[2];t===e?(e[12]=t[0]*p+t[4]*m+t[8]*g+t[12],e[13]=t[1]*p+t[5]*m+t[9]*g+t[13],e[14]=t[2]*p+t[6]*m+t[10]*g+t[14],e[15]=t[3]*p+t[7]*m+t[11]*g+t[15]):(r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],f=t[5],d=t[6],h=t[7],c=t[8],u=t[9],_=t[10],l=t[11],e[0]=r,e[1]=s,e[2]=n,e[3]=o,e[4]=a,e[5]=f,e[6]=d,e[7]=h,e[8]=c,e[9]=u,e[10]=_,e[11]=l,e[12]=r*p+a*m+c*g+t[12],e[13]=s*p+f*m+u*g+t[13],e[14]=n*p+d*m+_*g+t[14],e[15]=o*p+h*m+l*g+t[15])}(e,e,s),R(e,e,n,[0,0,1]),R(e,e,o,[0,-1,0]);for(let t=0;t<m.length;++t)m[t]=z(m[t],m[t],e)}{const e=[];e.push(0,1,1,3,3,2,2,0),e.push(0,4,1,5,2,6,3,7),e.push(4,5,5,7,7,6,6,4);const t=[1,1,0];for(let i=0;i<e.length;i+=2){const r=m[e[i+0]],s=m[e[i+1]];a.pushLine(r,s,t)}{const e=m[8],t=m[9],i=m[10],r=m[11];a.pushLine(e,t,[1,0,0]),a.pushLine(e,i,[0,1,0]),a.pushLine(e,r,[0,0,1])}}})(t.fovy,t.aspectRatio,t.near,t.far,v,C,P,f),f.flush(u.getComposedMatrix())}d.disable(d.BLEND),d.enable(d.DEPTH_TEST)})(this._renderer.mainCamera,0,150,this._chunkGenerator.getChunks(),0,this._renderer.getSize(),this._chunkGenerator.getProcessingRealPositions(),this._renderer.wireFrameCubesRenderer,this._renderer.stackRenderers),this._renderer.flush()}))}}const{isWebGL2Supported:gt,isWebWorkerSupported:bt,GlobalFullScreenManager:xt}=x,vt=e=>{const t=document.querySelector(e);if(!t)throw new Error(`html element "${e}" not found`);return t};window.addEventListener("load",(()=>e(void 0,void 0,void 0,(function*(){const e=vt("#main-canvas"),t=vt("#gui_toggle_start"),i=vt("#gui_fullscreen"),s=vt("#error-text");let n=null;if(window.addEventListener("error",(o=>{n&&(console.log("onPageError",o),n.stop(),n=null,a.deactivate(),d.deactivate(e),g.deactivate(e),r.removeAllCallbacks(),p.removeAllCallbacks(),b.removeAllCallbacks(),b.deactivate(),s.style.width="800px",s.style.height="600px",s.innerHTML=o.message,e.style.display="none",s.style.display="block",i.disabled=!0,t.disabled=!0,document.title+=" (ERR)")})),!gt())throw new Error("missing WebGL2 feature (unsupported)");if(!bt())throw new Error("missing WebWorker feature (unsupported)");t.addEventListener("click",(()=>{n&&(n.isRunning()?n.stop():n.start())})),n=new mt(e),yield n.init(),n.start(),((e,t)=>{if(!b.isSupported())return;let i=-1;b.addVisibilityChange((e=>{e?i>=0&&(clearTimeout(i),i=-1):i=window.setTimeout(t,6e4)})),b.activate()})(0,(()=>{throw new Error("<br/><br/><br/>The page was inactive for too long<br/><br/>please reload")})),((e,t,i)=>{r.isCompatible(i)&&(t.addEventListener("click",(()=>{r.requestFullScreen(i)})),r.addOnFullScreenChange((()=>{let t=null,s=null;r.isFullScreen(i)?(i.style.position="absolute",t=window.innerWidth,s=window.innerHeight):(i.style.position="relative",t=800,s=600),i.style.left="0px",i.style.top="0px",i.width=t,i.height=s,e.resize(t,s)})))})(n,i,e)}))));
