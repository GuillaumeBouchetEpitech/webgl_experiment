"use strict";function e(e,t,i,n){return new(i||(i=Promise))((function(s,r){function o(e){try{d(n.next(e))}catch(e){r(e)}}function f(e){try{d(n.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,f)}d((n=n.apply(e,t||[])).next())}))}const t=15,i=.45*Math.PI,n={Num0:48,Num1:49,Num2:50,Num3:51,Num4:52,Num5:53,Num6:54,Num7:55,Num8:56,Num9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,Semicolon:186,Equal:187,Comma:188,Minus:189,Period:190,BackQuote:192,BracketLeft:219,Backslash:220,BracketRight:221,Quote:222,Shift:16,Ctrl:17,Alt:18,CapsLock:20,Tab:9,Enter:13,Pause:19,Escape:27,Space:32,PageUp:33,PageDown:34,End:35,Home:36,ArrowLeft:37,ArrowUp:38,ArrowRight:39,ArrowDown:40,PrintScreen:44,Insert:45,Delete:46,ContextMenu:93,ScrollLock:145,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,F13:124,F14:125,F15:126,F16:127,F17:128,F18:129,F19:130,F20:131,F21:132,F22:133,F23:134,F24:135,NumPad0:96,NumPad1:97,NumPad2:98,NumPad3:99,NumPad4:100,NumPad5:101,NumPad6:102,NumPad7:103,NumPad8:104,NumPad9:105,NumPadMultiply:106,NumPadAdd:107,NumPadSubtract:109,NumPadDecimal:110,NumPadDivide:111,NumLock:144,NumPadComma:194,NumPadEqual:12};const s=new class{constructor(){this._pressedKeysSet=new Set,this._preventDefaultKeysSet=new Set,this._activated=!1;this._activated=!1,this._handleKeyDown=(e=>{const{keyCode:t}=e;this._preventDefaultKeysSet.has(t)&&e.preventDefault(),this._pressedKeysSet.add(t)}).bind(this),this._handleKeyUp=(e=>{const{keyCode:t}=e;this._preventDefaultKeysSet.has(t)&&e.preventDefault(),this._pressedKeysSet.delete(t)}).bind(this)}isPressed(...e){for(const t of e)if(this._pressedKeysSet.has(n[t]))return!0;return!1}preventDefault(e){this._preventDefaultKeysSet.add(n[e])}enableDefault(e){this._preventDefaultKeysSet.delete(n[e])}activate(){this._activated||(this._pressedKeysSet.clear(),document.addEventListener("keydown",this._handleKeyDown),document.addEventListener("keyup",this._handleKeyUp),this._activated=!0)}deactivate(){this._activated&&(this._pressedKeysSet.clear(),document.removeEventListener("keydown",this._handleKeyDown),document.removeEventListener("keyup",this._handleKeyUp),this._activated=!1)}},r={Left:0,Middle:1,Right:2};const o=new class{constructor(){this._pressedButtonsSet=new Set,this._activated=!1,this._deltaX=0,this._deltaY=0;this._activated=!1,this._handleMouseDown=(e=>{this._pressedButtonsSet.add(e.button)}).bind(this),this._handleMouseUp=(e=>{this._pressedButtonsSet.delete(e.button)}).bind(this),this._handleMouseMove=(e=>{this._deltaX+=e.movementX||e.mozMovementX||e.webkitMovementX||0,this._deltaY+=e.movementY||e.mozMovementY||e.webkitMovementY||0}).bind(this)}activate(){this._activated||(this._pressedButtonsSet.clear(),document.addEventListener("mousedown",this._handleMouseDown),document.addEventListener("mouseup",this._handleMouseUp),document.addEventListener("mousemove",this._handleMouseMove),this._activated=!0)}deactivate(){this._activated&&(this._pressedButtonsSet.clear(),document.removeEventListener("mousedown",this._handleMouseDown),document.removeEventListener("mouseup",this._handleMouseUp),document.removeEventListener("mousemove",this._handleMouseMove),this._activated=!1)}isButtonPressed(e){return this._pressedButtonsSet.has(r[e])}deltaX(){return this._deltaX}deltaY(){return this._deltaY}resetDelta(){this._deltaX=0,this._deltaY=0}},f=["requestPointerLock","mozRequestPointerLock","webkitRequestPointerLock"],d=["exitPointerLock","mozExitPointerLock","webkitExitPointerLock"],a=["pointerLockElement","mozPointerLockElement","webkitPointerLockElement"],h=[{methodName:"onpointerlockchange",propertyName:"pointerlockchange"},{methodName:"onmozpointerlockchange",propertyName:"mozpointerlockchange"},{methodName:"onwebkitpointerlockchange",propertyName:"webkitpointerlockchange"}],c=[{methodName:"onpointerlockerror",propertyName:"pointerlockerror"},{methodName:"onmozpointerlockerror",propertyName:"mozpointerlockerror"},{methodName:"onwebkitpointerlockerror",propertyName:"webkitpointerlockerror"}];const u=new class{constructor(){this._onLockChangeCallbacks=[],this._onLockErrorCallbacks=[],this._timeSinceLastLockChange=0,this._isInitialized=!1}_initialize(){if(this._isInitialized)return;this._isInitialized=!0;const e=()=>{this._timeSinceLastLockChange=Date.now(),this._onLockChangeCallbacks.forEach((e=>e()))},t=e=>{this._timeSinceLastLockChange=Date.now(),this._onLockErrorCallbacks.forEach((t=>t(e)))};for(const t of h)if(t.methodName in document){document.addEventListener(t.propertyName,e,!1);break}for(const e of c)if(e.methodName in document){document.addEventListener(e.propertyName,t,!1);break}}canBePointerLocked(e){for(const t of f)if(t in e)return!0;return!1}isPointerLocked(e){for(const t of a)if(t in document)return document[t]===e;return!1}requestPointerLock(t){return e(this,void 0,void 0,(function*(){if(this.isPointerLocked(t))return{success:!1,message:"element already locked"};if(this._initialize(),this._timeSinceLastLockChange>0){const e=(Date.now()-this._timeSinceLastLockChange)/1e3;if(e<1.1)return{success:!1,message:`request for lock was too early, time to wait: ${e.toFixed(2)}sec`}}this._timeSinceLastLockChange=Date.now();for(const e of f)if(e in t){const i={unadjustedMovement:!1};try{yield t[e](i)}catch(e){return{success:!1,message:`request for lock was too early, time to wait: ${((Date.now()-this._timeSinceLastLockChange)/1e3).toFixed(2)}sec`}}return this._timeSinceLastLockChange=Date.now(),{success:!0,message:"request for lock done"}}return{success:!1,message:"unsupported request for lock"}}))}allowPointerLockedOnClickEvent(t){if(t===this._latestRequestHtmlElement)return;this._latestRequestHtmlElement=t;const i=()=>e(this,void 0,void 0,(function*(){t.removeEventListener("click",i);const e=yield this.requestPointerLock(t);this._latestRequestHtmlElement=void 0,e.success||this.allowPointerLockedOnClickEvent(t)}));t.addEventListener("click",i)}exitPointerLock(){for(const e of d)if(e in document){document[e]();break}}addOnLockChange(e){this._onLockChangeCallbacks.push(e)}removeOnLockChange(e){const t=this._onLockChangeCallbacks.indexOf(e);t<0||this._onLockChangeCallbacks.splice(t,1)}addOnLockError(e){this._onLockErrorCallbacks.push(e)}removeOnLockError(e){const t=this._onLockErrorCallbacks.indexOf(e);t<0||this._onLockErrorCallbacks.splice(t,1)}};class l{constructor(e,t,i){this.createdAt=Date.now(),this.deltaX=0,this.deltaY=0,this.id=e,this.positionX=t,this.positionY=i}resetDelta(){this.deltaX=0,this.deltaY=0}}const _=new class{constructor(){this._pressedButtonsSet=new Set,this._activated=!1,this._allTouchData=[];this._activated=!1,this._handleTouchStart=(e=>{e.preventDefault();for(let t=0;t<e.changedTouches.length;++t){const i=e.changedTouches[t];this._allTouchData.push(new l(i.identifier,i.pageX,i.pageY))}}).bind(this),this._handleTouchEnd=(e=>{e.preventDefault();for(let t=0;t<e.changedTouches.length;++t){const i=e.changedTouches[t],n=this._allTouchData.findIndex((e=>e.id===i.identifier));n<0||this._allTouchData.splice(n,1)}}).bind(this),this._handleTouchMove=(e=>{e.preventDefault();for(let t=0;t<e.changedTouches.length;++t){const i=e.changedTouches[t],n=this._allTouchData.findIndex((e=>e.id===i.identifier));if(n<0)continue;const s=this._allTouchData[n];s.deltaX+=i.pageX-s.positionX,s.deltaY+=i.pageY-s.positionY,s.positionX=i.pageX,s.positionY=i.pageY}}).bind(this)}isSupported(){return"ontouchstart"in window}activate(){this.isSupported()&&(this._activated||(this._pressedButtonsSet.clear(),document.addEventListener("touchstart",this._handleTouchStart),document.addEventListener("touchend",this._handleTouchEnd),document.addEventListener("touchmove",this._handleTouchMove),this._activated=!0))}deactivate(){this._activated&&(this._pressedButtonsSet.clear(),document.removeEventListener("touchstart",this._handleTouchStart),document.removeEventListener("touchend",this._handleTouchEnd),document.removeEventListener("touchmove",this._handleTouchMove),this._activated=!1)}getTouchData(){return this._allTouchData}resetDeltas(){this._allTouchData.forEach((e=>e.resetDelta()))}};var p=1e-6,m="undefined"!=typeof Float32Array?Float32Array:Array;function v(){var e=new m(16);return m!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function g(e,t,i){var n=t[0],s=t[1],r=t[2],o=t[3],f=t[4],d=t[5],a=t[6],h=t[7],c=t[8],u=t[9],l=t[10],_=t[11],p=t[12],m=t[13],v=t[14],g=t[15],b=i[0],x=i[1],w=i[2],k=i[3];return e[0]=b*n+x*f+w*c+k*p,e[1]=b*s+x*d+w*u+k*m,e[2]=b*r+x*a+w*l+k*v,e[3]=b*o+x*h+w*_+k*g,b=i[4],x=i[5],w=i[6],k=i[7],e[4]=b*n+x*f+w*c+k*p,e[5]=b*s+x*d+w*u+k*m,e[6]=b*r+x*a+w*l+k*v,e[7]=b*o+x*h+w*_+k*g,b=i[8],x=i[9],w=i[10],k=i[11],e[8]=b*n+x*f+w*c+k*p,e[9]=b*s+x*d+w*u+k*m,e[10]=b*r+x*a+w*l+k*v,e[11]=b*o+x*h+w*_+k*g,b=i[12],x=i[13],w=i[14],k=i[15],e[12]=b*n+x*f+w*c+k*p,e[13]=b*s+x*d+w*u+k*m,e[14]=b*r+x*a+w*l+k*v,e[15]=b*o+x*h+w*_+k*g,e}function b(e,t,i,n){var s,r,o,f,d,a,h,c,u,l,_,m,v,g,b,x,w,k,C,y,E,T,S,P,M=n[0],R=n[1],L=n[2],A=Math.hypot(M,R,L);return A<p?null:(M*=A=1/A,R*=A,L*=A,s=Math.sin(i),o=1-(r=Math.cos(i)),f=t[0],d=t[1],a=t[2],h=t[3],c=t[4],u=t[5],l=t[6],_=t[7],m=t[8],v=t[9],g=t[10],b=t[11],x=M*M*o+r,w=R*M*o+L*s,k=L*M*o-R*s,C=M*R*o-L*s,y=R*R*o+r,E=L*R*o+M*s,T=M*L*o+R*s,S=R*L*o-M*s,P=L*L*o+r,e[0]=f*x+c*w+m*k,e[1]=d*x+u*w+v*k,e[2]=a*x+l*w+g*k,e[3]=h*x+_*w+b*k,e[4]=f*C+c*y+m*E,e[5]=d*C+u*y+v*E,e[6]=a*C+l*y+g*E,e[7]=h*C+_*y+b*E,e[8]=f*T+c*S+m*P,e[9]=d*T+u*S+v*P,e[10]=a*T+l*S+g*P,e[11]=h*T+_*S+b*P,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var x=function(e,t,i,n,s){var r,o=1/Math.tan(t/2);return e[0]=o/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=s&&s!==1/0?(r=1/(n-s),e[10]=(s+n)*r,e[14]=2*s*n*r):(e[10]=-1,e[14]=-2*n),e};var w=function(e,t,i,n,s,r,o){var f=1/(t-i),d=1/(n-s),a=1/(r-o);return e[0]=-2*f,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*d,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*a,e[11]=0,e[12]=(t+i)*f,e[13]=(s+n)*d,e[14]=(o+r)*a,e[15]=1,e};function k(e,t,i,n){var s,r,o,f,d,a,h,c,u,l,_=t[0],m=t[1],v=t[2],g=n[0],b=n[1],x=n[2],w=i[0],k=i[1],C=i[2];return Math.abs(_-w)<p&&Math.abs(m-k)<p&&Math.abs(v-C)<p?function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}(e):(h=_-w,c=m-k,u=v-C,s=b*(u*=l=1/Math.hypot(h,c,u))-x*(c*=l),r=x*(h*=l)-g*u,o=g*c-b*h,(l=Math.hypot(s,r,o))?(s*=l=1/l,r*=l,o*=l):(s=0,r=0,o=0),f=c*o-u*r,d=u*s-h*o,a=h*r-c*s,(l=Math.hypot(f,d,a))?(f*=l=1/l,d*=l,a*=l):(f=0,d=0,a=0),e[0]=s,e[1]=f,e[2]=h,e[3]=0,e[4]=r,e[5]=d,e[6]=c,e[7]=0,e[8]=o,e[9]=a,e[10]=u,e[11]=0,e[12]=-(s*_+r*m+o*v),e[13]=-(f*_+d*m+a*v),e[14]=-(h*_+c*m+u*v),e[15]=1,e)}function C(){var e=new m(3);return m!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function y(e,t,i){var n=new m(3);return n[0]=e,n[1]=t,n[2]=i,n}function E(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function T(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e}function S(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e}function P(e,t,i){var n=t[0],s=t[1],r=t[2],o=i[0],f=i[1],d=i[2];return e[0]=s*d-r*f,e[1]=r*o-n*d,e[2]=n*f-s*o,e}var M=function(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e};function R(){var e=new m(4);return m!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function L(){var e=new m(4);return m!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}C(),function(){var e=R()}();var A,D,F;C(),y(1,0,0),y(0,1,0),L(),L(),A=new m(9),m!=Float32Array&&(A[1]=0,A[2]=0,A[3]=0,A[5]=0,A[6]=0,A[7]=0),A[0]=1,A[4]=1,A[8]=1,function(){var e=function(){var e=new m(2);return m!=Float32Array&&(e[0]=0,e[1]=0),e}()}(),function(e){e[e.available=1]="available",e[e.working=2]="working"}(D||(D={}));class z{constructor(e){this._running=!1,this._chunks=[],this._chunkPositionQueue=[],this._geometriesPool=[],this._savedIndex=[999,999,999],this._workers=[],this._cameraPosition=y(0,0,0),this._processingPositions=[],this._def=e;for(let e=0;e<this._def.workerTotal;++e)this._addWorker()}_addWorker(){const e={instance:new Worker(this._def.workerFile),float32buffer:new Float32Array(this._def.workerBufferSize),status:D.available};e.instance.addEventListener("message",(t=>{const i=t.data.position;e.float32buffer=t.data.float32buffer,e.status=D.available;for(let e=0;e<this._processingPositions.length;++e)if(this._processingPositions[e][0]===i[0]&&this._processingPositions[e][1]===i[1]&&this._processingPositions[e][2]===i[2]){this._processingPositions.splice(e,1);break}if(!this._running)return;let n;0==this._geometriesPool.length?n=this._def.addGeometry(e.float32buffer):(n=this._geometriesPool.pop(),n&&this._def.updateGeometry(n,e.float32buffer)),n?(this._chunks.push({position:i,geometry:n,coord2d:null,visible:!1}),this._def.onChunkCreated&&this._def.onChunkCreated(),this._launchWorker()):console.log("worker: processing the result -> invalid geometry")}),!1),this._workers.push(e)}start(){this._running=!0}stop(){this._running&&(this._running=!1,this._chunkPositionQueue.length=0,this._chunks.length=0,this._geometriesPool.length=0)}update(e){if(!this._running)return;E(this._cameraPosition,e);const t=[Math.floor(e[0]/this._def.chunkSize),Math.floor(e[1]/this._def.chunkSize),Math.floor(e[2]/this._def.chunkSize)];if(0!=this._chunks.length&&t[0]==this._savedIndex[0]&&t[1]==this._savedIndex[1]&&t[2]==this._savedIndex[2])return;this._savedIndex[0]=t[0],this._savedIndex[1]=t[1],this._savedIndex[2]=t[2],this._chunkPositionQueue.length=0;const i=this._def.chunkRange,n=[Math.floor(t[0]-i),Math.floor(t[1]-i),Math.floor(t[2]-i)],s=[Math.floor(t[0]+i),Math.floor(t[1]+i),Math.floor(t[2]+i)];for(let e=0;e<this._chunks.length;++e){const t=[this._chunks[e].position[0]/this._def.chunkSize|0,this._chunks[e].position[1]/this._def.chunkSize|0,this._chunks[e].position[2]/this._def.chunkSize|0];(t[0]<n[0]||t[0]>s[0]||t[1]<n[1]||t[1]>s[1]||t[2]<n[2]||t[2]>s[2])&&(this._geometriesPool.push(this._chunks[e].geometry),this._chunks.splice(e,1),--e,this._def.onChunkDiscarded&&this._def.onChunkDiscarded())}for(let e=n[2];e<=s[2];++e)for(let t=n[1];t<=s[1];++t)for(let i=n[0];i<=s[0];++i){const n=[i*this._def.chunkSize,t*this._def.chunkSize,e*this._def.chunkSize];let s=!1;for(let e=0;e<this._chunks.length;++e){const t=this._chunks[e].position;if(t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]){s=!0;break}}s||this._chunkPositionQueue.push(n)}this._launchWorker()}_launchWorker(){const e=this._workers.find((e=>e.status==D.available));if(void 0===e)return;if(0==this._chunkPositionQueue.length)return;let t;if(1==this._chunkPositionQueue.length)t=this._chunkPositionQueue.pop();else{const e=e=>Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);let i,n=-1,s=999999;for(let t=0;t<this._chunkPositionQueue.length;++t){const r=this._chunkPositionQueue[t];if(-1==n||this._def.chunkIsVisible(r)){const o=.5*this._def.chunkSize,f=e([this._cameraPosition[0]-r[0]-o,this._cameraPosition[1]-r[1]-o,this._cameraPosition[2]-r[2]-o]);if(s<f)continue;n=t,s=f,i=this._chunkPositionQueue[n]}}this._chunkPositionQueue.splice(n,1),t=i}void 0!==t&&(this._processingPositions.push(t),e.status=D.working,e.instance.postMessage({position:t,float32buffer:e.float32buffer},[e.float32buffer.buffer]))}getChunks(){return this._chunks}getProcessingPositions(){return this._processingPositions}}class B{static initialize(e){if(B._gl=e.getContext("webgl2",{alpha:!1,antialias:!1,depth:!0,failIfMajorPerformanceCaveat:!1,powerPreference:"high-performance",premultipliedAlpha:!0,preserveDrawingBuffer:!0,stencil:!1}),!B._gl)throw new Error("could not create webgl context");B._extensionLoseContext=B._gl.getExtension("WEBGL_lose_context")}static getContext(){if(!B._gl)throw new Error("webgl context not initialized");return B._gl}static getExtensionLoseContext(){return B._extensionLoseContext}static getExtensionLoseContextStrict(){if(!B._extensionLoseContext)throw new Error("lose context extension not available");return B._extensionLoseContext}}B._gl=null,B._extensionLoseContext=null,function(e){let t,i;e.BytesPerPixel=4,function(e){e[e.float=0]="float",e[e.vec2f=1]="vec2f",e[e.vec3f=2]="vec3f",e[e.vec4f=3]="vec4f",e[e.mat3f=4]="mat3f",e[e.mat4f=5]="mat4f"}(t=e.AttributeType||(e.AttributeType={})),function(e){e[e.lines=0]="lines",e[e.triangles=1]="triangles",e[e.triangleStrip=2]="triangleStrip"}(i=e.PrimitiveType||(e.PrimitiveType={}));e.Geometry=class{constructor(n,s){this._primitiveStart=0,this._primitiveCount=0,this._instanceCount=0,this._isInstanced=!1;const r=B.getContext();if(0===s.vbos.length)throw new Error("empty vbo defintion");for(const e of s.vbos){if(0===e.attrs.length)throw new Error("empty vbo attribute defintion");for(const t of e.attrs)if(!n.hasAttribute(t.name))throw new Error(`attribute not found, name="${t.name}"`)}switch(this._def=s,s.primitiveType){case i.lines:this._primitiveType=r.LINES;break;case i.triangles:this._primitiveType=r.TRIANGLES;break;case i.triangleStrip:this._primitiveType=r.TRIANGLE_STRIP;break;default:throw new Error("primitive type not found")}const o=r.createVertexArray();if(!o)throw new Error("fail o create a vao unit");this._vao=o,r.bindVertexArray(this._vao),this._vbos=[];for(const i of this._def.vbos){const s=r.createBuffer();if(!s)throw new Error("fail o create a vbo unit");this._vbos.push(s),r.bindBuffer(r.ARRAY_BUFFER,s);let o=i.stride||0;if(!o){for(const e of i.attrs)switch(e.type){case t.float:o+=1;break;case t.vec2f:o+=2;break;case t.vec3f:o+=3;break;case t.vec4f:o+=4;break;case t.mat3f:o+=9;break;case t.mat4f:o+=16}o*=e.BytesPerPixel}for(const s of i.attrs){let f=1,d=1;switch(s.type){case t.float:f=1,d=1;break;case t.vec2f:f=2,d=1;break;case t.vec3f:f=3,d=1;break;case t.vec4f:f=4,d=1;break;case t.mat3f:f=3,d=3;break;case t.mat4f:f=4,d=4}const a=n.getAttribute(s.name);for(let t=0;t<d;++t){const n=a+t,d=(s.index+t*f)*e.BytesPerPixel;r.enableVertexAttribArray(n),r.vertexAttribPointer(n,f,r.FLOAT,!1,o,d),!0===i.instanced&&(r.vertexAttribDivisor(n,1),this._isInstanced=!0)}}}r.bindVertexArray(null)}dispose(){const e=B.getContext();for(const t of this._vbos)e.deleteBuffer(t);e.deleteVertexArray(this._vao)}updateBuffer(e,t,i=!1){if(e<0||e>=this._vbos.length)throw new Error("no buffer avaialble to tha index");const n=B.getContext(),s=this._vbos[e],r=t instanceof Float32Array?t:new Float32Array(t),o=i?n.DYNAMIC_DRAW:n.STATIC_DRAW;n.bindBuffer(n.ARRAY_BUFFER,s),n.bufferData(n.ARRAY_BUFFER,r,o),n.bindBuffer(n.ARRAY_BUFFER,null)}render(){if(0==this._primitiveCount||this._isInstanced&&0==this._instanceCount)return;const e=B.getContext();e.bindVertexArray(this._vao),!0===this._isInstanced?e.drawArraysInstanced(this._primitiveType,this._primitiveStart,this._primitiveCount,this._instanceCount):e.drawArrays(this._primitiveType,this._primitiveStart,this._primitiveCount),e.bindVertexArray(null)}setPrimitiveStart(e){this._primitiveStart=e}setPrimitiveCount(e){this._primitiveCount=e}setInstancedCount(e){this._instanceCount=e}}}(F||(F={}));class I{constructor(e){this._attributes=new Map,this._uniforms=new Map;const t=B.getContext(),i=this._getShader(e.vertexSrc,t.VERTEX_SHADER),n=this._getShader(e.fragmentSrc,t.FRAGMENT_SHADER),s=t.createProgram();if(!s)throw new Error("could not create a shader program");if(t.attachShader(s,i),t.attachShader(s,n),t.linkProgram(s),t.deleteShader(i),t.deleteShader(n),!t.getProgramParameter(s,t.LINK_STATUS)){const e=t.getProgramInfoLog(s);throw new Error("Failed to initialized shaders, Error linking:"+e)}this._program=s,this.bind(),this._getAttributes(e.attributes),this._getUniforms(e.uniforms),I.unbind()}bind(){B.getContext().useProgram(this._program)}static unbind(){B.getContext().useProgram(null)}hasAttribute(e){return this._attributes.has(e)}getAttribute(e){const t=this._attributes.get(e);if(void 0===t)throw new Error(`attribute not found: ${e}`);return t}getUniform(e){const t=this._uniforms.get(e);if(void 0===t)throw new Error(`uniform not found: ${e}`);return t}setInteger1Uniform(e,t){B.getContext().uniform1i(this.getUniform(e),t)}setInteger2Uniform(e,t,i){B.getContext().uniform2i(this.getUniform(e),t,i)}setInteger3Uniform(e,t,i,n){B.getContext().uniform3i(this.getUniform(e),t,i,n)}setFloat1Uniform(e,t){B.getContext().uniform1f(this.getUniform(e),t)}setFloat2Uniform(e,t,i){B.getContext().uniform2f(this.getUniform(e),t,i)}setFloat3Uniform(e,t,i,n){B.getContext().uniform3f(this.getUniform(e),t,i,n)}setMatrix4Uniform(e,t){B.getContext().uniformMatrix4fv(this.getUniform(e),!1,t)}_getAttributes(e){const t=B.getContext();for(let i=0;i<e.length;++i){const n=t.getAttribLocation(this._program,e[i]);if(n<0)throw new Error(`attribute not found => ${e[i]}`);this._attributes.set(e[i],n)}}_getUniforms(e){const t=B.getContext();for(let i=0;i<e.length;++i){const n=t.getUniformLocation(this._program,e[i]);if(null===n)throw new Error(`uniform not found => ${e[i]}`);this._uniforms.set(e[i],n)}}_getShader(e,t){const i=B.getContext(),n=i.createShader(t);if(!n)throw new Error("could not create a shader");if(i.shaderSource(n,e),i.compileShader(n),!i.getShaderParameter(n,i.COMPILE_STATUS)){let e=i.getShaderInfoLog(n);throw e||(e="failed to compile a shader"),new Error(e)}return n}}class U{constructor(){this._width=0,this._height=0,this._texture=null}load(t,i=!1){return e(this,void 0,void 0,(function*(){const e=B.getContext();this._texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this._texture);const n=e.RGBA,s=e.RGBA,r=e.UNSIGNED_BYTE,o=new Uint8Array([0,0,255,255]);return e.texImage2D(e.TEXTURE_2D,0,n,1,1,0,s,r,o),e.bindTexture(e.TEXTURE_2D,null),new Promise(((o,f)=>{const d=new Image;d.onerror=f,d.onload=()=>{this._width=d.width,this._height=d.height,e.bindTexture(e.TEXTURE_2D,this._texture),e.texImage2D(e.TEXTURE_2D,0,n,s,r,d),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const t=i?e.NEAREST:e.LINEAR;e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,t),e.bindTexture(e.TEXTURE_2D,null),o()},d.src=t}))}))}loadFromMemory(e,t,i,n=!1){const s=B.getContext();this._texture=s.createTexture(),s.bindTexture(s.TEXTURE_2D,this._texture),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);const r=n?s.NEAREST:s.LINEAR;s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,r),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,r);const o=s.RGBA,f=s.RGBA,d=s.UNSIGNED_BYTE;s.texImage2D(s.TEXTURE_2D,0,o,e,t,0,f,d,i),s.bindTexture(s.TEXTURE_2D,null)}getWidth(){if(!this._texture)throw new Error("texture not initialized");return this._width}getHeight(){if(!this._texture)throw new Error("texture not initialized");return this._height}bind(){if(!this._texture)throw new Error("texture not initialized");const e=B.getContext();e.bindTexture(e.TEXTURE_2D,this._texture)}static unbind(){const e=B.getContext();e.bindTexture(e.TEXTURE_2D,null)}}const N={X:0,Y:1,Z:2};class X{constructor(e){this._isActivated=!1,this._theta=0,this._phi=0,this._touchWasActive=!1,this._touchStartTime=0,this._touchMoveForward=!1,this._position=y(0,0,0),this._target=y(0,0,0),this._forwardAxis=y(1,0,0),this._leftAxis=y(0,0,1),this._upAxis=y(0,1,0),this._mouseSensibility=e.mouseSensibility,this._keyboardSensibility=e.keyboardSensibility,this._touchSensibility=e.touchSensibility,this._movingSpeed=e.movingSpeed,E(this._position,e.position),this._axisIndices=[e.coordinates?N[e.coordinates[0]]:N.X,e.coordinates?N[e.coordinates[1]]:N.Y,e.coordinates?N[e.coordinates[2]]:N.Z],this._theta=e.theta,this._phi=e.phi}isActivated(){return this._isActivated}update(e){let t=!1,i=!1,n=!1,r=!1,f=0,d=0;const a=Math.PI/180;f-=o.deltaX()*this._mouseSensibility*a,d-=o.deltaY()*this._mouseSensibility*a;const h=_.getTouchData().length>0;if(h){if(!this._touchWasActive){const e=Date.now();(e-this._touchStartTime)/1e3<.25?this._touchMoveForward=!0:this._touchStartTime=e}const e=_.getTouchData()[0];f-=e.deltaX*this._touchSensibility*a,d-=e.deltaY*this._touchSensibility*a}else this._touchMoveForward=!1;this._touchWasActive=h,this._touchMoveForward&&(t=!0);const c=this._movingSpeed*e,u=y(0,0,0);S(u,this._forwardAxis,c);const l=y(0,0,0);S(l,this._leftAxis,c),s.isPressed("Z","W")&&(t=!0),s.isPressed("S")&&(i=!0),s.isPressed("A","Q")&&(n=!0),s.isPressed("D")&&(r=!0);const p=this._keyboardSensibility*e;s.isPressed("ArrowUp")?d+=p:s.isPressed("ArrowDown")&&(d-=p),s.isPressed("ArrowLeft")?f+=p:s.isPressed("ArrowRight")&&(f-=p),this._theta+=f,this._phi+=d;const m=.5*Math.PI,v=.95*m;this._phi=Math.min(Math.max(this._phi,-v),+v);const g=Math.cos(this._theta),b=Math.sin(this._theta),[x,w,k]=this._axisIndices,C=Math.cos(this._phi+m);this._upAxis[x]=C*g,this._upAxis[w]=C*b,this._upAxis[k]=Math.sin(this._phi+m);const E=Math.cos(this._phi);this._forwardAxis[x]=E*g,this._forwardAxis[w]=E*b,this._forwardAxis[k]=Math.sin(this._phi),P(this._leftAxis,this._upAxis,this._forwardAxis),t?T(this._position,this._position,u):i&&M(this._position,this._position,u),n?T(this._position,this._position,l):r&&M(this._position,this._position,l),T(this._target,this._position,this._forwardAxis)}getPosition(){return this._position}setPosition(e){E(this._position,e)}getTarget(){return this._target}getUpAxis(){return this._upAxis}getTheta(){return this._theta}getPhi(){return this._phi}getTouchMoveForward(){return this._touchMoveForward}}var G,O;!function(e){e[e.Right=0]="Right",e[e.Left=1]="Left",e[e.Bottom=2]="Bottom",e[e.Top=3]="Top",e[e.Back=4]="Back",e[e.Front=5]="Front"}(G||(G={})),function(e){e[e.A=0]="A",e[e.B=1]="B",e[e.C=2]="C",e[e.D=3]="D"}(O||(O={}));class Y{constructor(){this._frustum=new Float32Array(24)}_normalizePlane(e){const t=4*e,i=Math.sqrt(this._frustum[t+O.A]*this._frustum[t+O.A]+this._frustum[t+O.B]*this._frustum[t+O.B]+this._frustum[t+O.C]*this._frustum[t+O.C]);0!==i&&(this._frustum[t+O.A]/=i,this._frustum[t+O.B]/=i,this._frustum[t+O.C]/=i,this._frustum[t+O.D]/=i)}calculateFrustum(e,t){const i=new Float32Array(16);i[0]=t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],i[1]=t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],i[2]=t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],i[3]=t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15],i[4]=t[4]*e[0]+t[5]*e[4]+t[6]*e[8]+t[7]*e[12],i[5]=t[4]*e[1]+t[5]*e[5]+t[6]*e[9]+t[7]*e[13],i[6]=t[4]*e[2]+t[5]*e[6]+t[6]*e[10]+t[7]*e[14],i[7]=t[4]*e[3]+t[5]*e[7]+t[6]*e[11]+t[7]*e[15],i[8]=t[8]*e[0]+t[9]*e[4]+t[10]*e[8]+t[11]*e[12],i[9]=t[8]*e[1]+t[9]*e[5]+t[10]*e[9]+t[11]*e[13],i[10]=t[8]*e[2]+t[9]*e[6]+t[10]*e[10]+t[11]*e[14],i[11]=t[8]*e[3]+t[9]*e[7]+t[10]*e[11]+t[11]*e[15],i[12]=t[12]*e[0]+t[13]*e[4]+t[14]*e[8]+t[15]*e[12],i[13]=t[12]*e[1]+t[13]*e[5]+t[14]*e[9]+t[15]*e[13],i[14]=t[12]*e[2]+t[13]*e[6]+t[14]*e[10]+t[15]*e[14],i[15]=t[12]*e[3]+t[13]*e[7]+t[14]*e[11]+t[15]*e[15];let n=4*G.Right;this._frustum[n+O.A]=i[3]-i[0],this._frustum[n+O.B]=i[7]-i[4],this._frustum[n+O.C]=i[11]-i[8],this._frustum[n+O.D]=i[15]-i[12],this._normalizePlane(G.Right),n=4*G.Left,this._frustum[n+O.A]=i[3]+i[0],this._frustum[n+O.B]=i[7]+i[4],this._frustum[n+O.C]=i[11]+i[8],this._frustum[n+O.D]=i[15]+i[12],this._normalizePlane(G.Left),n=4*G.Bottom,this._frustum[n+O.A]=i[3]+i[1],this._frustum[n+O.B]=i[7]+i[5],this._frustum[n+O.C]=i[11]+i[9],this._frustum[n+O.D]=i[15]+i[13],this._normalizePlane(G.Bottom),n=4*G.Top,this._frustum[n+O.A]=i[3]-i[1],this._frustum[n+O.B]=i[7]-i[5],this._frustum[n+O.C]=i[11]-i[9],this._frustum[n+O.D]=i[15]-i[13],this._normalizePlane(G.Top),n=4*G.Back,this._frustum[n+O.A]=i[3]-i[2],this._frustum[n+O.B]=i[7]-i[6],this._frustum[n+O.C]=i[11]-i[10],this._frustum[n+O.D]=i[15]-i[14],this._normalizePlane(G.Back),n=4*G.Front,this._frustum[n+O.A]=i[3]+i[2],this._frustum[n+O.B]=i[7]+i[6],this._frustum[n+O.C]=i[11]+i[10],this._frustum[n+O.D]=i[15]+i[14],this._normalizePlane(G.Front)}sphereInFrustum(e,t,i,n){for(let s=0;s<6;++s)if(this._frustum[4*s+O.A]*e+this._frustum[4*s+O.B]*t+this._frustum[4*s+O.C]*i+this._frustum[4*s+O.D]<=n)return!1;return!0}pointInFrustum(e,t,i){return this.sphereInFrustum(e,t,i,0)}cubeInFrustum(e,t,i,n){const s=e-n,r=t-n,o=i-n,f=e+n,d=t+n,a=i+n;for(let e=0;e<6;++e){const t=this._frustum[4*e+O.A],i=this._frustum[4*e+O.B],n=this._frustum[4*e+O.C],h=this._frustum[4*e+O.D];if(!(t*s+i*r+n*o+h>0)&&!(t*f+i*r+n*o+h>0||t*s+i*d+n*o+h>0||t*f+i*d+n*o+h>0||t*s+i*r+n*a+h>0||t*f+i*r+n*a+h>0||t*s+i*d+n*a+h>0||t*f+i*d+n*a+h>0))return!1}return!0}}const W=(e,t,i,n)=>{const s=function(e,t,i,n){var s=new m(4);return s[0]=e,s[1]=t,s[2]=i,s[3]=n,s}(e[0],e[1],e[2],1),r=v(),o=R();return g(r,i,t),function(e,t,i){var n=t[0],s=t[1],r=t[2],o=t[3];e[0]=i[0]*n+i[4]*s+i[8]*r+i[12]*o,e[1]=i[1]*n+i[5]*s+i[9]*r+i[13]*o,e[2]=i[2]*n+i[6]*s+i[10]*r+i[14]*o,e[3]=i[3]*n+i[7]*s+i[11]*r+i[15]*o}(o,s,r),0===o[3]?null:(o[3]=1/o[3],o[0]*=o[3],o[1]*=o[3],o[2]*=o[3],[(.5*o[0]+.5)*n[2]+n[0],(.5*o[1]+.5)*n[3]+n[1]])},q="\n#version 300 es\n\nprecision highp float;\n\nin vec3 a_vertex_position;\nin vec3 a_vertex_color;\nin vec3 a_vertex_normal;\nin vec3 a_vertex_baryCenter;\n\nuniform mat4 u_viewMatrix;\nuniform mat4 u_projMatrix;\nuniform vec3 u_eyePosition;\n\nout vec3 v_color;\n\n// lighting\nout vec3 v_worldSpaceNormal;\nout vec3 v_worldSpacePosition;\n// lighting\n\n// wireFrame\nout float v_distanceToCamera;\nout vec3  v_baryCenter;\n// wireFrame\n\n// texturing\nout vec3 v_rawPosition;\nout vec3 v_rawNormal;\n// texturing\n\nconst float k_rangeMin = 20.0;\nconst float k_rangeMax = 23.0;\n\nvoid main(void)\n{\n  vec4 transformedPosition = u_viewMatrix * vec4(a_vertex_position, 1.0);\n  v_worldSpacePosition = vec3(transformedPosition) / transformedPosition.w;\n  v_worldSpaceNormal = vec3(u_viewMatrix * vec4(a_vertex_normal, 0.0));\n\n  v_rawPosition = a_vertex_position;\n  v_rawNormal = a_vertex_normal;\n\n  float distanceToCamera = length(a_vertex_position - u_eyePosition);\n\n  v_distanceToCamera = distanceToCamera;\n\n  v_color = a_vertex_color;\n  v_baryCenter = a_vertex_baryCenter;\n\n  if (\n    distanceToCamera < k_rangeMin ||\n    distanceToCamera > k_rangeMax\n  ) {\n    gl_Position = u_projMatrix * u_viewMatrix * vec4(a_vertex_position, 1.0);\n  }\n  else\n  {\n    // bump effect -> bump in the direction of the normal\n\n    gl_Position = u_projMatrix * u_viewMatrix * vec4(a_vertex_position + a_vertex_normal, 1.0);\n  }\n}\n".trim(),H='\n#version 300 es\n\nprecision lowp float;\n\nuniform sampler2D u_texture;\n\nin vec3 v_color;\n\n// lighting\nin vec3 v_worldSpaceNormal;\nin vec3 v_worldSpacePosition;\n// lighting\n\n// wireFrame\nin float v_distanceToCamera;\nin vec3  v_baryCenter;\n// wireFrame\n\n// texturing\nin vec3 v_rawPosition;\nin vec3 v_rawNormal;\n// texturing\n\nout vec4 o_color;\n\nconst vec3 k_lightPos = vec3(0.0,0.0,0.0);\nconst vec3 k_specColor = vec3(1.0, 1.0, 1.0);\n\nconst float k_rangeMin = 20.0;\nconst float k_rangeMax = 23.0;\n\nvoid main(void)\n{\n\n  { // wireFrame\n\n    if (gl_FrontFacing)\n    {\n      // "bumped wireFrame" effect on the front facing\n\n      if (\n        v_distanceToCamera > k_rangeMin &&\n        v_distanceToCamera < k_rangeMax\n      ) {\n        if (\n          all(greaterThan(v_baryCenter, vec3(0.03))) &&\n          any(lessThan(v_baryCenter, vec3(0.08)))\n        ) {\n          o_color = vec4(v_color, 1.0);\n          return;\n        }\n      }\n    }\n    else\n    {\n      // normal wireFrame effect on the back facing\n\n      if (any(lessThan(v_baryCenter, vec3(0.06))))\n      {\n        o_color = vec4(1.0);\n        return;\n      }\n      else\n      {\n        // discard what is not part fo the wireFrame\n        discard;\n        return;\n      }\n    }\n\n  } // /wireFrame\n\n  vec3 currentColor = vec3(1);\n\n  { // texture\n\n    // current 3d texture coordinate\n    vec3 flooredPos = vec3(\n      v_rawPosition.x - floor(v_rawPosition.x),\n      v_rawPosition.y - floor(v_rawPosition.y),\n      v_rawPosition.z - floor(v_rawPosition.z)\n    );\n\n    vec3 blendWeights = abs( normalize( v_rawNormal.xyz ) );\n    blendWeights = max( ( blendWeights - 0.2 ) * 7.0, 0.0 );\n    blendWeights /= ( blendWeights.x + blendWeights.y + blendWeights.z );\n\n    // horizontal texture coordinates -> should be a wall\n    vec2 texCoordX = vec2(flooredPos.y * 0.5 + 0.5, flooredPos.z * 0.5);\n    vec2 texCoordY = vec2(flooredPos.x * 0.5 + 0.5, flooredPos.z * 0.5);\n\n    // vertical texture coord -> should be green grass\n    vec2 texCoordZ = vec2(flooredPos.x * 0.5, flooredPos.y * 0.5 + 0.5);\n\n    if (v_rawNormal.z < 0.0)\n    {\n      // switch the texture Y -> dirt on the ceiling instead of grass\n      texCoordZ.y -= 0.5;\n    }\n\n    // horizontal color\n    vec3 texColorX = texture( u_texture, texCoordX ).rgb;\n    vec3 texColorY = texture( u_texture, texCoordY ).rgb;\n\n    // vertical color\n    vec3 texColorZ = texture( u_texture, texCoordZ ).rgb;\n\n    currentColor = texColorX * blendWeights.xxx +\n                    texColorY * blendWeights.yyy +\n                    texColorZ * blendWeights.zzz;\n\n  } // texture\n\n  { // lighting\n\n    vec3 normal = normalize(v_worldSpaceNormal);\n    vec3 lightDir = normalize(k_lightPos - v_worldSpacePosition);\n\n    float diffuseCoef = max(dot(lightDir,v_worldSpaceNormal.xyz), 0.0);\n    float specularCoef = 0.0;\n\n    if (diffuseCoef > 0.0) {\n      // specular\n\n      vec3 reflectDir = reflect(-lightDir, normal);\n      vec3 viewDir = normalize(-v_worldSpacePosition);\n\n      float specAngle = max(dot(reflectDir, viewDir), 0.0);\n      specularCoef = pow(specAngle, 16.0);\n    }\n\n    vec3 ambiantColor = currentColor.xyz * 0.05;\n    vec3 diffuseColor = currentColor.xyz * diffuseCoef;\n    vec3 specularColor = k_specColor * specularCoef;\n\n    currentColor = ambiantColor + diffuseColor + specularColor;\n\n  } // lighting\n\n  o_color = vec4(currentColor, 1.0);\n}\n'.trim(),j="\n#version 300 es\n\nprecision highp float;\n\nuniform mat4 u_composedMatrix;\n\nin vec2 a_vertex_position;\nin vec2 a_vertex_texCoord;\nin vec3 a_offset_position;\nin vec2 a_offset_texCoord;\nin vec3 a_offset_color;\nin float a_offset_scale;\n\nout vec2 v_texCoord;\nflat out vec3 v_color;\n\nvoid main(void)\n{\n  vec3 position = vec3(a_vertex_position, 0.0) * a_offset_scale + a_offset_position;\n\n  gl_Position = u_composedMatrix * vec4(position, 1.0);\n\n  v_texCoord = a_vertex_texCoord + a_offset_texCoord;\n  v_color = a_offset_color;\n}\n".trim(),K="\n#version 300 es\n\nprecision mediump float;\n\nuniform sampler2D u_texture;\n\nin vec2 v_texCoord;\nflat in vec3 v_color;\n\nout vec4 o_color;\n\nvoid main(void)\n{\n  vec4 textureColor = texture(u_texture, v_texCoord);\n  if (textureColor.a < 0.5)\n  {\n    discard;\n  }\n  else\n  {\n    o_color = vec4(v_color, textureColor.a);\n  }\n}\n\n".trim(),Q="\n#version 300 es\n\nprecision highp float;\n\nuniform mat4 u_composedMatrix;\n\nin vec3  a_vertex_position;\n\nin vec3  a_offset_center;\nin float a_offset_scale;\nin vec3  a_offset_color;\n\nflat out vec3 v_color;\n\nvoid main(void)\n{\n  vec3 position = a_offset_center + a_vertex_position * a_offset_scale;\n\n  gl_Position = u_composedMatrix * vec4(position, 1.0);\n\n  v_color = a_offset_color;\n}\n".trim(),$="\n#version 300 es\n\nprecision lowp float;\n\nflat in vec3 v_color;\n\nout vec4 o_color;\n\nvoid main(void)\n{\n  o_color = vec4(v_color, 1.0);\n}\n\n".trim(),V="\n#version 300 es\n\nprecision highp float;\n\nuniform mat4 u_composedMatrix;\n\nin vec3 a_vertex_position;\nin vec4 a_vertex_color;\n\nflat out vec4 v_color;\n\nvoid main(void)\n{\n  gl_Position = u_composedMatrix * vec4(a_vertex_position, 1.0);\n\n  v_color = a_vertex_color;\n}\n".trim(),Z="\n#version 300 es\n\nprecision lowp float;\n\nflat in vec4 v_color;\n\nout vec4 o_color;\n\nvoid main(void)\n{\n  o_color = v_color;\n}\n\n".trim();class J{constructor(e,t){this._vertices=[];const i=Object.assign(Object.assign({},t),{primitiveType:F.PrimitiveType.lines});this._geometry=new F.Geometry(e,i)}pushLine(e,t,i){var n,s;this._vertices.push(e[0],e[1],e[2]),this._vertices.push(i[0],i[1],i[2],null!==(n=i[3])&&void 0!==n?n:1),this._vertices.push(t[0],t[1],t[2]),this._vertices.push(i[0],i[1],i[2],null!==(s=i[3])&&void 0!==s?s:1)}canRender(){return this._vertices.length>0}flush(){0!==this._vertices.length&&(this._geometry.updateBuffer(0,this._vertices,!0),this._geometry.setPrimitiveCount(this._vertices.length/7),this._geometry.render(),this._vertices.length=0)}}class ee{constructor(e,t){this._vertices=[];const i=Object.assign(Object.assign({},t),{primitiveType:F.PrimitiveType.triangles});this._geometry=new F.Geometry(e,i)}pushLine(e,t,i,n){const s=t[0]-e[0],r=t[1]-e[1],o=Math.atan2(r,s)+.5*Math.PI,f=Math.cos(o)*i*.5,d=Math.sin(o)*i*.5,a=[[e[0]-f,e[1]-d,e[2]],[e[0]+f,e[1]+d,e[2]],[t[0]-f,t[1]-d,t[2]],[t[0]+f,t[1]+d,t[2]]];[0,3,2,0,1,3].forEach((e=>{var t;const i=a[e];this._vertices.push(i[0],i[1],i[2]),this._vertices.push(n[0],n[1],n[2],null!==(t=n[3])&&void 0!==t?t:1)}))}pushRotatedLine(e,t,i,n,s){this.pushLine([e[0]-i*Math.cos(t),e[1]-i*Math.sin(t),e[2]],[e[0]+i*Math.cos(t),e[1]+i*Math.sin(t),e[2]],n,s)}pushOriginBoundRectangle(e,t,i){const n=[e[0]+t[0],e[1]+t[1]],s=[[e[0],e[1],e[2]],[n[0],e[1],e[2]],[n[0],n[1],e[2]],[e[0],n[1],e[2]]];[0,3,2,0,1,2].forEach((e=>{var t;const n=s[e];this._vertices.push(n[0],n[1],n[2]),this._vertices.push(i[0],i[1],i[2],null!==(t=i[3])&&void 0!==t?t:1)}))}pushCenteredRectangle(e,t,i){const n=[e[0]-.5*t[0],e[1]-.5*t[1],e[2]];this.pushOriginBoundRectangle(n,t,i)}canRender(){return this._vertices.length>0}flush(){0!==this._vertices.length&&(this._geometry.updateBuffer(0,this._vertices,!0),this._geometry.setPrimitiveCount(this._vertices.length/7),this._geometry.render(),this._vertices.length=0)}}class te{constructor(){this._shader=new I({vertexSrc:V,fragmentSrc:Z,attributes:["a_vertex_position","a_vertex_color"],uniforms:["u_composedMatrix"]});const e={vbos:[{attrs:[{name:"a_vertex_position",type:F.AttributeType.vec3f,index:0},{name:"a_vertex_color",type:F.AttributeType.vec4f,index:3}],stride:28,instanced:!1}],primitiveType:F.PrimitiveType.lines};this._wireFramesStackRenderer=new J(this._shader,e),this._trianglesStackRenderer=new ee(this._shader,e)}pushLine(e,t,i){this._wireFramesStackRenderer.pushLine(e,t,i)}pushThickLine(e,t,i,n){this._trianglesStackRenderer.pushLine(e,t,i,n)}pushRotatedLine(e,t,i,n,s){this._trianglesStackRenderer.pushRotatedLine(e,t,i,n,s)}pushOriginBoundRectangle(e,t,i){this._trianglesStackRenderer.pushOriginBoundRectangle(e,t,i)}pushCenteredRectangle(e,t,i){this._trianglesStackRenderer.pushCenteredRectangle(e,t,i)}flush(e){(this._wireFramesStackRenderer.canRender()||this._trianglesStackRenderer.canRender())&&(this._shader.bind(),this._shader.setMatrix4Uniform("u_composedMatrix",e),this._wireFramesStackRenderer.flush(),this._trianglesStackRenderer.flush())}}const ie="7e7e28fd03fd07fe04fe0aff02ff7e4dfd0cfd03fd07fe04fe0aff02ff1afc0dfd10fc08fc0ffe55ff15fb0bfd03fd07fe04fe08f707fd04ff07fe02fe0cfd0ffd0cfd0aff03fe03ff0afe44fe15fb0bfd03fd04f204f607fd03fe07fe02fe0cfd0efd0efd0aff02fe02ff0bfe43fd15fb0cfe03fe05f204fe01ff02ff0afd02fd07fe02fe0bfd0efd10fd0afa0cfe42fd16fb1bfe04fe07fe01ff02ff0efd09fc1cfd12fd09fa0cfe41fd17fb1bfe04fe07f70bfd0afc04ff17fd12fd06f405f616f61cfd19fd1cfe04fe08f709fd0bfb02fe17fd12fd06f405f616f61bfd1afd1cfe04fe0aff02ff01fe08fd0bfe02fa17fd12fd09fa0cfe3efd37f207ff02ff01fe07fd02fd07fe03fc19fd10fd0afa0cfe3dfd38f204f607fe03fd07fe03fd1bfd0efd0aff02fe02ff0bfe0cfd1dfd0dfd1dfd1cfe04fe07f708ff04fd07fe02fb1bfd0cfd0aff03fe03ff0afe0cfd1dfd0cfd1efd1cfe04fe0aff02ff1afb02fe1bfc08fc0ffe1cfd1dfd0bfd1ffd1cfe04fe0aff02ff7afd7e7e7e7e7e7e0efd17fd10fc0af80bfe0bf909f90dfd08f609fb08f506f808f82cfd19fd0df807fd04fd0afe0afd03fd07fd03fd0bfc08fd0ffd0bfd05fd05fd04fd06fd04fd2afd1bfd0bfc02fc06fd03fc09fd0afd04fd06fd04fd09fb08fd0efd0cfd05fd05fd04fd06fd04fd09fd0cfd0efd1dfd0afe05fd06fd02fb06fa11fd0dfd08fe01fd08fd0dfd0dfd05fd05fd04fd06fd04fd09fd0cfd0dfd0af409fd10fd06fd02fb06fa10fd0dfd08fe02fd08fd0dfd15fd05fb02fd06fd04fd09fd0cfd0cfd0bf40afd0efd07fd01fe01fd09fd0ffd0bfb08fe03fd08f808f70efd08fa08f626fd23fd0cfd08fd01fe01fd09fd0efd0cfb08f606f707f60cfd09fa09f726fd23fd0bfd09fb02fd09fd0dfd10fd07f60cfc06fd04fd0bfd08fd02fb0dfd09fd0cfd0cfd0bf40afd0cfd09fb02fd09fd0cfd12fd0bfd0ffd06fd04fd0afd09fd04fd0dfd09fd0cfd0dfd0af409fd19fc03fd09fd0bfd03fd06fd04fd0bfd08fd04fd06fd04fd09fd0afd04fd0cfd0afd0cfd0efd1dfd1afd04fd09fd0afd04fd06fd03fd0cfd08fd03fd07fd04fd09fd0afd04fd0bfd19fd10fd1bfd0ffd0af807f707f607f90bf907f909f80afd0bf809fb2efd19fd10fd7e51fd17fd11fd7e7e7e7e13f87e78fd05fd08fc09f709f907f808f606f608f907fd03fd07f90df905fc03fd06fb0bfd05fd05fd05fd08fb08fd05fd07fa09fd03fd07fd03fd07fd02fd08fd04fe07fd04fe07fd03fd06fd03fd09fd11fd08fd03fd07fd0cfc03fc05fd05fd07fd01fd07fd05fd06fd02fd08fd03fd06fd04fd07fd03fd07fd05ff07fd05ff06fd04fd06fd03fd09fd11fd08fd02fd08fd0cfb01fb05fc04fd06fd03fd06fd05fd05fd04fd07fd03fd06fd0efd03fd07fd0dfd0cfd04fd06fd03fd09fd11fd08fd01fd09fd0cf505fb03fd05fd05fd05fd02fa05fd04fd07fd03fd06fd0efd03fd07fd03fe08fd03fe07fd0dfd03fd09fd11fd08fa0afd0cf505fa02fd05fd05fd05fd02fa05fd04fd07f807fd0efd03fd07f808f807fd0df709fd11fd08fb0bfd0cfd01fd01fd05fd01fd01fd05fd05fd05fd02fa05fd04fd07f807fd0efd03fd07f808f807fd0df709fd11fd08fb0bfd0cfd02ff02fd05fd02fa05fd05fd05fd02fa05f607fd03fd06fd0efd03fd07fd03fe08fd03fe07fd02fb06fd03fd09fd0bfd03fd08fa0afd0cfd05fd05fd03fb05fd05fd05fd0dfd04fd07fd03fd06fd0efd03fd07fd0dfd0cfd04fd06fd03fd09fd0bfd03fd08fd01fd09fd05ff06fd05fd05fd04fc05fd05fd05fd0dfd04fd07fd03fd06fd04fd07fd03fd07fd05ff07fd0cfd04fd06fd03fd09fd0bfd03fd08fd02fd08fd04fe06fd05fd05fd05fd06fd03fd06fd0dfd04fd07fd03fd07fd03fd07fd02fd08fd04fe07fd0dfd03fd06fd03fd09fd0bfd03fd08fd03fd07fd03fd06fd05fd05fd05fd07fd01fd07fd0dfd04fd06f709f907f808f606fb0df806fd03fd07f90af908fc03fd06f606fd05fd05fd05fd08fb0af87e7e7e7e7e7e7e68fe1af70afb08f708f807f505fd03fd07fd03fd07fd05fd05fd03fd07fd03fd07f608f907ff11f90afc1afd03fd07fc01fc07fd03fd06fd04fd06fe02fd02fe05fd03fd07fd03fd07fd05fd05fd03fd07fd03fd07fd04fd08fd0bfe14fd09fa19fd03fd07fd03fd07fd03fd06fd04fd06ff03fd03ff05fd03fd07fd03fd07fd05fd05fd03fd07fd03fd07fe05fd08fd0bfd13fd08fd02fd18fd03fd06fd05fd06fd03fd06fd04fd0afd09fd03fd07fd03fd07fd05fd06fd01fd08fd03fd07ff05fd09fd0cfd12fd07fd04fd17fd03fd06fd05fd06fd03fd06fd11fd09fd03fd07fd03fd07fd05fd07fb09fd03fd0cfd0afd0dfd11fd28f807fd05fd06f808f90cfd09fd03fd07fd03fd07fd02ff02fd08fd0bfd01fd0cfd0bfd0efd10fd28f807fd05fd06f809f90bfd09fd03fd07fd03fd07fd02ff02fd08fd0cfb0cfd0cfd0ffd0ffd28fd0cfd03fb06fd02fd0efd0afd09fd03fd07fd03fd07fd02ff02fd07fb0cfd0cfd0dfd10fd0efd28fd0cfd02fa06fd03fd06fd04fd0afd09fd03fd07fd03fd08f707fd01fd0bfd0bfd05ff08fd11fd0dfd28fd0df707fd03fd06fd04fd0afd09fd03fd08fd01fd09fc01fc06fd03fd0afd0afd05fe08fd12fd0cfd28fd0df707fd03fd06fd04fd0afd09fd03fd09fb0bfd01fd07fd03fd0afd0afd04fd08fd13fd0bfd27fb12fd06fc03fd07f809f908f90bfd0cfd01fd07fd03fd08f908f608f910fd06f93cfa7e54f07e72f07e7e7e7e0bfd1dfc21fb19fb18fc10fd0ffd07fc0dfa39fd1efd22fd19fd01fd18fd10fd0ffd08fd10fd3bfd1cfd22fd19fd01fd18fd10fd0ffd08fd10fd3bfd1cfd22fd19fd1cfd2dfd10fd4af909f808f909f808f90afd0cfb02fe07fd01fc08fa0cfa08fd03fd0afd09f606f809f91efd08fd03fd06fd03fd07fd03fd07fd03fd07f808fd03fd08fc02fd0afd0ffd08fd02fd0bfd09fd02ff02fd05fd03fd07fd03fd1dfd08fd03fd06fd03fd07fd03fd07fd03fd07f808fd03fd08fc02fd0afd0ffd08fd01fd0cfd09fd02ff02fd05fd03fd07fd03fd18f808fd03fd06fd0dfd03fd07f709fd0bfd03fd08fd03fd0afd0ffd08fa0dfd09fd02ff02fd05fd03fd07fd03fd17fd03fd08fd03fd06fd0dfd03fd07fd0ffd0bfd03fd08fd03fd0afd0ffd08fd01fd0cfd09fd02ff02fd05fd03fd07fd03fd17fd03fd08fd03fd06fd03fd07fd03fd07fd03fd09fd0cf808fd03fd0afd0ffd08fd02fd0bfd09fd02ff02fd05fd03fd07fd03fd17fd03fd08fd03fd06fd03fd07fd03fd07fd03fd09fd0df908fd03fd0afd0ffd08fd03fd0afd09fd02ff02fd05fd03fd07fd03fd18fb02fe06fe02fb08f909fb02fe07f908f90ffd07fc03fd07f706fd03fd07fc03fd07f706fd05fd05fd03fd08f978fd03fd27fd03fd7e4af92afa7e7e7e7e7e7e18fa09fc09fa1efe4eff6efd0dfc0dfd1cfc4cfe6efd0dfc0dfd1bfa4afd6efd0dfc0dfd1afd02fd07fe02fb07fb02fe07fc02fd08f908f707fd03fd07fd03fd07fd05fd05fd02fd09fd03fd06f80afd0efc0efd08fb03fd05fd04fd07fd03fd05fd03fd09f706fd04fe09fd0bfd03fd07fd03fd07fd05fd05fd02fd09fd03fd06fe03fd08fd24fd05fd01fd02fd05fe06fe07fd03fd05fd03fd09fc02fd06fd04fe09fd0bfd03fd07fd03fd07fd05fd06fa0afd03fd06ff03fd09fd24fd05fd02fd01fd05fe06fe07fd03fd05fd03fd09fd0dfb0cfd0bfd03fd07fd03fd07fd02ff02fd07fc0bfd03fd09fd0cfd0efc0efd07fd03fb06fe06fe07fd03fd05fd03fd09fd0ffb0afd0bfd03fd07fd03fd07fd02ff02fd07fc0bfd03fd08fd0efd0dfc0dfd19fe06fe07fd03fd05fd03fd09fd0cfe04fd09fd01fd07fd03fd08fd01fd09fc01fc07fa0bf908fd03ff0bfd0dfc0dfd19fe06fe07f807f809fd0cfe04fd09fd01fd07fd03fd09fb0bfd01fd07fd02fd0bfb08fd03fe0bfd0dfc0dfd19f607fd11fd08fb0cf90bfb09fb02fe09fd0cfd01fd07fd02fd0dfd08f80cfa09fc09fa1af607fd11fd7cfd69fb0ffb77fa",ne=[16,6],se=[1/ne[0],1/ne[1]];class re{constructor(){this._texture=new U,this._vertices=[],this._shader=new I({vertexSrc:j,fragmentSrc:K,attributes:["a_vertex_position","a_vertex_texCoord","a_offset_position","a_offset_texCoord","a_offset_color","a_offset_scale"],uniforms:["u_composedMatrix","u_texture"]});const e={vbos:[{attrs:[{name:"a_vertex_position",type:F.AttributeType.vec2f,index:0},{name:"a_vertex_texCoord",type:F.AttributeType.vec2f,index:2}],stride:16,instanced:!1},{attrs:[{name:"a_offset_position",type:F.AttributeType.vec3f,index:0},{name:"a_offset_texCoord",type:F.AttributeType.vec2f,index:3},{name:"a_offset_color",type:F.AttributeType.vec3f,index:5},{name:"a_offset_scale",type:F.AttributeType.float,index:8}],stride:36,instanced:!0}],primitiveType:F.PrimitiveType.triangles};this._geometry=new F.Geometry(this._shader,e);const t=[{position:[.5,-.5],texCoord:[1*se[0],1*se[1]]},{position:[-.5,-.5],texCoord:[0*se[0],1*se[1]]},{position:[.5,.5],texCoord:[1*se[0],0*se[1]]},{position:[-.5,.5],texCoord:[0*se[0],0*se[1]]}],i=[1,0,2,1,3,2],n=[];for(const e of i){const i=t[e];n.push(i.position[0],i.position[1],i.texCoord[0],i.texCoord[1])}this._geometry.updateBuffer(0,n),this._geometry.setPrimitiveCount(n.length/4),this._texCoordMap=new Map([[" ",[0*se[0],0*se[1]]],["!",[1*se[0],0*se[1]]],['"',[2*se[0],0*se[1]]],["#",[3*se[0],0*se[1]]],["$",[4*se[0],0*se[1]]],["%",[5*se[0],0*se[1]]],["&",[6*se[0],0*se[1]]],["'",[7*se[0],0*se[1]]],["(",[8*se[0],0*se[1]]],[")",[9*se[0],0*se[1]]],["*",[10*se[0],0*se[1]]],["+",[11*se[0],0*se[1]]],[",",[12*se[0],0*se[1]]],["-",[13*se[0],0*se[1]]],[".",[14*se[0],0*se[1]]],["/",[15*se[0],0*se[1]]],["0",[0*se[0],1*se[1]]],["1",[1*se[0],1*se[1]]],["2",[2*se[0],1*se[1]]],["3",[3*se[0],1*se[1]]],["4",[4*se[0],1*se[1]]],["5",[5*se[0],1*se[1]]],["6",[6*se[0],1*se[1]]],["7",[7*se[0],1*se[1]]],["8",[8*se[0],1*se[1]]],["9",[9*se[0],1*se[1]]],[":",[10*se[0],1*se[1]]],[";",[11*se[0],1*se[1]]],["<",[12*se[0],1*se[1]]],["=",[13*se[0],1*se[1]]],[">",[14*se[0],1*se[1]]],["?",[15*se[0],1*se[1]]],["@",[0*se[0],2*se[1]]],["A",[1*se[0],2*se[1]]],["B",[2*se[0],2*se[1]]],["C",[3*se[0],2*se[1]]],["D",[4*se[0],2*se[1]]],["E",[5*se[0],2*se[1]]],["F",[6*se[0],2*se[1]]],["G",[7*se[0],2*se[1]]],["H",[8*se[0],2*se[1]]],["I",[9*se[0],2*se[1]]],["J",[10*se[0],2*se[1]]],["K",[11*se[0],2*se[1]]],["L",[12*se[0],2*se[1]]],["M",[13*se[0],2*se[1]]],["N",[14*se[0],2*se[1]]],["O",[15*se[0],2*se[1]]],["P",[0*se[0],3*se[1]]],["Q",[1*se[0],3*se[1]]],["R",[2*se[0],3*se[1]]],["S",[3*se[0],3*se[1]]],["T",[4*se[0],3*se[1]]],["U",[5*se[0],3*se[1]]],["V",[6*se[0],3*se[1]]],["W",[7*se[0],3*se[1]]],["X",[8*se[0],3*se[1]]],["Y",[9*se[0],3*se[1]]],["Z",[10*se[0],3*se[1]]],["[",[11*se[0],3*se[1]]],["\\",[12*se[0],3*se[1]]],["]",[13*se[0],3*se[1]]],["^",[14*se[0],3*se[1]]],["_",[15*se[0],3*se[1]]],["`",[0*se[0],4*se[1]]],["a",[1*se[0],4*se[1]]],["b",[2*se[0],4*se[1]]],["c",[3*se[0],4*se[1]]],["d",[4*se[0],4*se[1]]],["e",[5*se[0],4*se[1]]],["f",[6*se[0],4*se[1]]],["g",[7*se[0],4*se[1]]],["h",[8*se[0],4*se[1]]],["i",[9*se[0],4*se[1]]],["j",[10*se[0],4*se[1]]],["k",[11*se[0],4*se[1]]],["l",[12*se[0],4*se[1]]],["m",[13*se[0],4*se[1]]],["n",[14*se[0],4*se[1]]],["o",[15*se[0],4*se[1]]],["p",[0*se[0],5*se[1]]],["q",[1*se[0],5*se[1]]],["r",[2*se[0],5*se[1]]],["s",[3*se[0],5*se[1]]],["t",[4*se[0],5*se[1]]],["u",[5*se[0],5*se[1]]],["v",[6*se[0],5*se[1]]],["w",[7*se[0],5*se[1]]],["x",[8*se[0],5*se[1]]],["y",[9*se[0],5*se[1]]],["z",[10*se[0],5*se[1]]],["{",[11*se[0],5*se[1]]],["|",[12*se[0],5*se[1]]],["}",[13*se[0],5*se[1]]],["~",[14*se[0],5*se[1]]]]);const s=new Uint8Array(98304);{let e=0;for(let t=0;t<ie.length;t+=2){let i=parseInt(`${ie.substring(t,t+2)}000000`,16)>>24,n=0;i<0&&(i=-i,n=255);for(let t=0;t<i;++t)s[4*e+0]=n,s[4*e+1]=n,s[4*e+2]=n,s[4*e+3]=n,++e}}this._texture.loadFromMemory(256,96,s,!0)}pushText(e,t,i){const n=[t[0],t[1]];for(let s=0;s<e.length;++s){const r=e[s];"\n"!=r?(this._pushLetter(r,n,i),n[0]+=i):(n[0]=t[0],n[1]-=i)}}pushCenteredText(e,t,i){const n=[0];for(let t=0;t<e.length;++t)"\n"==e[t]?n.push(0):n[n.length-1]+=1;let s=0;const r=[0,0];r[0]=t[0]-n[s]*i*.5+.5*i,r[1]=t[1]+n.length*i*.5-.5*i;for(let o=0;o<e.length;++o){const f=e[o];"\n"==f?(s+=1,r[0]=t[0]-n[s]*i*.5+.5*i,r[1]-=i):(this._pushLetter(f,r,i),r[0]+=i)}}pushRightAlignedText(e,t,i){const n=[0];for(let t=0;t<e.length;++t)"\n"==e[t]?n.push(0):n[n.length-1]+=1;let s=0;const r=[0,0];r[0]=t[0]-n[s]*i+i,r[1]=t[1];for(let o=0;o<e.length;++o){const f=e[o];"\n"==f?(s+=1,r[0]=t[0]-n[s]*i+i,r[1]-=i):(this._pushLetter(f,r,i),r[0]+=i)}}_pushLetter(e,t,i){const n=this._texCoordMap.get(e);if(!n)throw new Error(`fail to find a letter, letter=${e}`);const s=[1,1,1],r=[0,0,0];for(let e=-1;e<=1;++e)for(let s=-1;s<=1;++s)this._vertices.push(t[0]+2*s,t[1]+2*e,-.1,n[0],n[1],r[0],r[1],r[2],i);this._vertices.push(t[0],t[1],0,n[0],n[1],s[0],s[1],s[2],i)}flush(e){this._shader.bind(),this._shader.setMatrix4Uniform("u_composedMatrix",e),this._texture.bind(),this._geometry.updateBuffer(1,this._vertices,!0),this._geometry.setInstancedCount(this._vertices.length/9),this._geometry.render(),U.unbind(),this._vertices.length=0}}class oe{constructor(){this._vertices=[],this._shader=new I({vertexSrc:Q,fragmentSrc:$,attributes:["a_vertex_position","a_offset_center","a_offset_scale","a_offset_color"],uniforms:["u_composedMatrix"]});const e={vbos:[{attrs:[{name:"a_vertex_position",type:F.AttributeType.vec3f,index:0}],stride:12,instanced:!1},{attrs:[{name:"a_offset_center",type:F.AttributeType.vec3f,index:0},{name:"a_offset_scale",type:F.AttributeType.float,index:3},{name:"a_offset_color",type:F.AttributeType.vec3f,index:4}],stride:28,instanced:!0}],primitiveType:F.PrimitiveType.lines};this._geometry=new F.Geometry(this._shader,e);const t=(e=>{const t=.5*e,i=[];i.push([+t,+t,+t]),i.push([-t,+t,+t]),i.push([+t,-t,+t]),i.push([-t,-t,+t]),i.push([+t,+t,-t]),i.push([-t,+t,-t]),i.push([+t,-t,-t]),i.push([-t,-t,-t]);const n=[];n.push(0,1,1,3,3,2,2,0),n.push(4,5,5,7,7,6,6,4),n.push(0,4,1,5,3,7,2,6);const s=[];for(let e=0;e<n.length;++e){const t=i[n[e]];s.push(t[0]),s.push(t[1]),s.push(t[2])}return s})(1);this._geometry.updateBuffer(0,t),this._geometry.setPrimitiveCount(t.length/3)}pushCenteredCube(e,t,i){this._vertices.push(e[0],e[1],e[2],t,i[0],i[1],i[2])}pushOriginBoundCube(e,t,i){this._vertices.push(e[0]+.5*t,e[1]+.5*t,e[2]+.5*t,t,i[0],i[1],i[2])}flush(e){B.getContext(),this._shader.bind(),this._shader.setMatrix4Uniform("u_composedMatrix",e),this._geometry.updateBuffer(1,this._vertices,!0),this._geometry.setInstancedCount(this._vertices.length/7),this._geometry.render(),this._vertices.length=0}}class fe{constructor(){this._texture=new U,this._shader=new I({vertexSrc:q,fragmentSrc:H,attributes:["a_vertex_position","a_vertex_color","a_vertex_normal","a_vertex_baryCenter"],uniforms:["u_viewMatrix","u_projMatrix","u_eyePosition","u_texture"]}),this._geometryDefinition={vbos:[{attrs:[{name:"a_vertex_position",type:F.AttributeType.vec3f,index:0},{name:"a_vertex_color",type:F.AttributeType.vec3f,index:3},{name:"a_vertex_normal",type:F.AttributeType.vec3f,index:6},{name:"a_vertex_baryCenter",type:F.AttributeType.vec3f,index:9}],stride:48,instanced:!1}],primitiveType:F.PrimitiveType.triangles}}initialize(){return e(this,void 0,void 0,(function*(){yield this._texture.load("assets/texture.png")}))}buildGeometry(e){const t=new F.Geometry(this._shader,this._geometryDefinition);return t.updateBuffer(0,e),t.setPrimitiveCount(e.length/12),t}render(e,t,i,n){const s=B.getContext();s.disable(s.BLEND),this._shader.bind(),this._shader.setInteger1Uniform("u_texture",0),this._shader.setMatrix4Uniform("u_viewMatrix",e),this._shader.setMatrix4Uniform("u_projMatrix",t),this._shader.setFloat3Uniform("u_eyePosition",i[0],i[1],i[2]),this._texture.bind(),n.forEach((e=>{e.render()}))}}class de{constructor(e){this.onContextLost=null,this.onContextRestored=null,this._fpsMeterAngle=0,this._fpsMeterSpeed=0,this._touchesAngleMap=new Map,this._def=e,this._viewportSize=[this._def.canvasDomElement.width,this._def.canvasDomElement.height],B.initialize(this._def.canvasDomElement),this._def.canvasDomElement.addEventListener("webglcontextlost",(e=>{e.preventDefault(),console.log("context is lost"),this.onContextLost&&this.onContextLost()}),!1),this._def.canvasDomElement.addEventListener("webglcontextrestored",(()=>{console.log("context is restored"),B.initialize(this._def.canvasDomElement),this.onContextRestored&&this.onContextRestored()}),!1),this._freeFlyController=new X({position:y(0,0,0),coordinates:["X","Y","Z"],theta:0,phi:0,mouseSensibility:this._def.mouseSensibility,keyboardSensibility:this._def.keyboardSensibility,touchSensibility:this._def.touchSensibility,movingSpeed:this._def.movingSpeed}),this._frustumCulling=new Y,this._projectionMatrix=v(),this._viewMatrix=v(),this._composedMatrix=v(),this._aspectRatio=.75*this._viewportSize[0]/this._viewportSize[1],this._textRenderer=new re,this._wireFrameCubesRenderer=new oe,this._stackRenderers=new te,this._chunksRenderer=new fe}resize(e,t){this._viewportSize[0]=e,this._viewportSize[1]=t,this._aspectRatio=.75*this._viewportSize[0]/this._viewportSize[1]}toggleContextLoss(){const e=B.getContext(),t=B.getExtensionLoseContext();t&&(e.isContextLost()?t.restoreContext():t.loseContext())}contextIsLost(){return B.getContext().isContextLost()}setOnContextLost(e){this.onContextLost=e}setOnContextRestored(e){this.onContextRestored=e}init(){return e(this,void 0,void 0,(function*(){const e=B.getContext();e.clearColor(0,0,0,1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LESS),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_COLOR),e.disable(e.CULL_FACE),e.enable(e.TEXTURE_2D),e.activeTexture(e.TEXTURE0),yield this._chunksRenderer.initialize()}))}getSize(){return this._viewportSize}update(e,t){this._freeFlyController.update(e),o.resetDelta(),_.resetDeltas();x(this._projectionMatrix,70,this._aspectRatio,.1,70),k(this._viewMatrix,this._freeFlyController.getPosition(),this._freeFlyController.getTarget(),this._freeFlyController.getUpAxis()),g(this._composedMatrix,this._projectionMatrix,this._viewMatrix),this._frustumCulling.calculateFrustum(this._projectionMatrix,this._viewMatrix);const i=[0,0,.75*this._viewportSize[0],this._viewportSize[1]],n=.5*this._def.chunkSize;for(const e of t){if(e.visible=this._frustumCulling.cubeInFrustum(e.position[0]+n,e.position[1]+n,e.position[2]+n,n),e.coord2d=null,!this._frustumCulling.pointInFrustum(e.position[0],e.position[1],e.position[2]))continue;const t=W(e.position,this._viewMatrix,this._projectionMatrix,i);t&&(e.coord2d=t)}}renderScene(e){const t=B.getContext();t.viewport(0,0,.75*this._viewportSize[0],this._viewportSize[1]),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);const i=this._freeFlyController.getPosition(),n=e.filter((e=>e.visible)).map((e=>e.geometry));this._chunksRenderer.render(this._viewMatrix,this._projectionMatrix,i,n);for(let t=0;t<e.length;++t)e[t].visible&&this._wireFrameCubesRenderer.pushOriginBoundCube(e[t].position,15,[1,1,1]);this._wireFrameCubesRenderer.flush(this._composedMatrix)}renderHUD(e,t,i){const n=B.getContext();n.clear(n.DEPTH_BUFFER_BIT),this._renderMainHud(e,i,t);const s=.25*this._viewportSize[0],r=.33*this._viewportSize[1],o=.75*this._viewportSize[0];this._renderSideHud(e,t,[o,0*r,s,r],[1,1.2,1],[0,0,1]),this._renderSideHud(e,t,[o,1*r,s,r],[0,1,0],[0,0,1]),this._renderSideHud(e,t,[o,2*r,s,r],[0,0,1],[0,1,0]),I.unbind()}_renderMainHud(e,t,i){const n=B.getContext();n.clear(n.DEPTH_BUFFER_BIT);const s=.75*this._viewportSize[0],r=this._viewportSize[1];n.viewport(0,0,s,r);const o=v();w(o,.5*-s,.5*+s,.5*-r,.5*+r,-200,200);const f=v();k(f,[.5*+s,.5*+r,1],[.5*+s,.5*+r,0],[0,1,0]);const d=v();g(d,o,f);const a=[100,50],h=[10,this._viewportSize[1]-10-a[1],0];{const e=1/30;{this._stackRenderers.pushOriginBoundRectangle(h,a,[0,0,0,.5]);const e=[[h[0]+0*a[0],h[1]+0*a[1],0],[h[0]+1*a[0],h[1]+0*a[1],0],[h[0]+1*a[0],h[1]+1*a[1],0],[h[0]+0*a[0],h[1]+1*a[1],0]];this._stackRenderers.pushLine(e[0],e[1],[1,1,1]),this._stackRenderers.pushLine(e[1],e[2],[1,1,1]),this._stackRenderers.pushLine(e[2],e[3],[1,1,1]),this._stackRenderers.pushLine(e[3],e[0],[1,1,1])}for(let i=1;i<t.length;++i){const n=(i-1)/t.length,s=i/t.length,r=Math.min(t[i-1],e)/e,o=Math.min(t[i],e)/e,f=[h[0]+a[0]*n,h[1]+a[1]*r,0],d=[h[0]+a[0]*s,h[1]+a[1]*o,0];this._stackRenderers.pushLine(f,d,[1,1,1])}{let e=0;for(const i of t)e+=i;e/=t.length;const i=1/e;let n="999";i<999&&(n=i.toFixed(0).padStart(3," ")),this._textRenderer.pushText(`${n}fps`,[h[0]+7,h[1]-8],14)}}{i.length>0?(this._fpsMeterSpeed+=5e-4,this._fpsMeterSpeed>.02&&(this._fpsMeterSpeed=.02)):(this._fpsMeterSpeed-=5e-4,this._fpsMeterSpeed<0&&(this._fpsMeterSpeed=0)),this._fpsMeterAngle+=this._fpsMeterSpeed;const e=[h[0]+a[0]+.6*a[1],h[1]+.5*a[1],0],t=[h[0]+a[0]+1.3*a[1],h[1]+.5*a[1],0],n=[{position:e,angle:this._fpsMeterAngle},{position:e,angle:this._fpsMeterAngle+.5*Math.PI},{position:t,angle:-this._fpsMeterAngle+.25*Math.PI},{position:t,angle:-this._fpsMeterAngle+.75*Math.PI}],s=.45*a[1],r=10,o=[1,1,1];n.forEach((e=>{this._stackRenderers.pushRotatedLine(e.position,e.angle,s,r,o)}))}{const e=_.getTouchData();if(0===e.length)this._touchesAngleMap.clear();else{const t=new Set,i=[1,0,0],n=[0,1,0],s=e.length>1?i:n;e.forEach((e=>{t.add(e.id);let i=this._touchesAngleMap.get(e.id);void 0===i&&(i=0,this._touchesAngleMap.set(e.id,i));const n=[0,.5];this._freeFlyController.getTouchMoveForward()&&n.push(.25,.75);for(const t of n){const n=i+t*Math.PI,r=[e.positionX,this._viewportSize[1]-e.positionY,0];this._stackRenderers.pushRotatedLine(r,n,150,15,s)}i+=.1,this._touchesAngleMap.set(e.id,i)}));const r=new Set;this._touchesAngleMap.forEach(((e,i)=>{t.has(i)||r.add(i)})),r.forEach((e=>{this._touchesAngleMap.delete(e)}))}}n.clear(n.DEPTH_BUFFER_BIT),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_DST_ALPHA),this._stackRenderers.flush(d),this._textRenderer.flush(d),n.disable(n.BLEND)}_renderSideHud(e,t,i,n,s){B.getContext().viewport(i[0],i[1],i[2],i[3]);const r=v(),o=i[2]/i[3];w(r,-65*o,65*o,-65,65,-200,200);const f=this._freeFlyController.getPosition(),d=v();k(d,[f[0]+n[0],f[1]+n[1],f[2]+n[2]],f,s);const a=v();g(a,r,d);{const e=20;this._stackRenderers.pushLine([0,0,0],[0+e,0,0],[1,0,0]),this._stackRenderers.pushLine([0,0,0],[0,0+e,0],[0,1,0]),this._stackRenderers.pushLine([0,0,0],[0,0,0+e],[0,0,1]),this._stackRenderers.flush(a)}for(const t of e)if(t.visible)this._wireFrameCubesRenderer.pushOriginBoundCube(t.position,15,[1,1,1]);else{const e=[t.position[0]+7.5,t.position[1]+7.5,t.position[2]+7.5];this._wireFrameCubesRenderer.pushCenteredCube(e,10.5,[1,0,0])}if(t.length>0)for(const e of t){const t=[e[0]+7.5,e[1]+7.5,e[2]+7.5];this._wireFrameCubesRenderer.pushCenteredCube(t,9,[0,1,0])}this._wireFrameCubesRenderer.flush(a),function(e,t,i){var n,s,r,o,f,d,a,h,c,u,l,_,p=i[0],m=i[1],v=i[2];t===e?(e[12]=t[0]*p+t[4]*m+t[8]*v+t[12],e[13]=t[1]*p+t[5]*m+t[9]*v+t[13],e[14]=t[2]*p+t[6]*m+t[10]*v+t[14],e[15]=t[3]*p+t[7]*m+t[11]*v+t[15]):(n=t[0],s=t[1],r=t[2],o=t[3],f=t[4],d=t[5],a=t[6],h=t[7],c=t[8],u=t[9],l=t[10],_=t[11],e[0]=n,e[1]=s,e[2]=r,e[3]=o,e[4]=f,e[5]=d,e[6]=a,e[7]=h,e[8]=c,e[9]=u,e[10]=l,e[11]=_,e[12]=n*p+f*m+c*v+t[12],e[13]=s*p+d*m+u*v+t[13],e[14]=r*p+a*m+l*v+t[14],e[15]=o*p+h*m+_*v+t[15])}(d,d,this._freeFlyController.getPosition()),b(d,d,this._freeFlyController.getTheta(),[0,0,1]),b(d,d,this._freeFlyController.getPhi(),[0,-1,0]),g(a,r,d);{const e=5,t=[[0-e,0,0],[0+100*e,0,0],[0,0-e,0],[0,0+e,0],[0,0,0-e],[0,0,0+e]],i=[0,1,2,3,4,5];for(let e=0;e<i.length;e+=2){const i=t[e+0],n=t[e+1];this._stackRenderers.pushLine(i,n,[1,1,1])}const n=((e,t,i,n)=>{const s=Math.tan(e/360*Math.PI)*i,r=s*t,o=-r,f=+r,d=+s,a=-s,h=n*Math.sin(e*Math.PI/180),c=h*t,u=[];u.push([i,o,d]),u.push([i,f,d]),u.push([i,o,a]),u.push([i,f,a]),u.push([n,-c,+h]),u.push([n,+c,+h]),u.push([n,-c,-h]),u.push([n,+c,-h]),u.push([n,1.66*-c,-h]),u.push([n,1.66*-c,+h]);const l=[];l.push(0,1,1,3,3,2,2,0),l.push(0,4,1,5,2,6,3,7),l.push(4,5,5,7,7,6,6,4),l.push(8,9),l.push(7,8),l.push(5,9);const _=[];for(let e=0;e<l.length;++e)_.push(u[l[e]]);return _})(70,this._aspectRatio,.1,40);for(let e=0;e<n.length;e+=2){const t=n[e+0],i=n[e+1];this._stackRenderers.pushLine(t,i,[1,1,0])}this._stackRenderers.flush(a)}}get freeFlyController(){return this._freeFlyController}get stackRenderers(){return this._stackRenderers}get textRenderer(){return this._textRenderer}get frustumCulling(){return this._frustumCulling}get chunksRenderer(){return this._chunksRenderer}}class ae{constructor(e){this._chunksCreated=0,this._chunksDiscarded=0,this._currFrameTime=0,this._framesDuration=[],this._canvasElement=e,this._helperTextCountDown=4e3,this._renderer=new de({canvasDomElement:e,chunkSize:t,mouseSensibility:.1,movingSpeed:16,keyboardSensibility:i,touchSensibility:.3}),this._renderer.freeFlyController.setPosition(y(11.25,11.25,0)),this._chunkGenerator=new z({chunkSize:t,chunkRange:3,workerTotal:2,workerFile:"./dist/worker.js",workerBufferSize:5e5,chunkIsVisible:e=>{const t=7.5;return this._renderer.frustumCulling.cubeInFrustum(e[0]+t,e[1]+t,e[2]+t,t)},pointIsVisible:e=>this._renderer.frustumCulling.pointInFrustum(e[0],e[1],e[2]),addGeometry:e=>this._renderer.chunksRenderer.buildGeometry(e),updateGeometry:(e,t)=>{e.updateBuffer(0,t)},onChunkCreated:()=>{++this._chunksCreated},onChunkDiscarded:()=>{++this._chunksDiscarded}}),s.activate(),_.activate(),u.allowPointerLockedOnClickEvent(e),u.addOnLockChange((()=>{u.isPointerLocked(e)?o.activate():(o.deactivate(),u.allowPointerLockedOnClickEvent(e))})),u.addOnLockError((e=>{}));const n=document.getElementById("gui_fullscreen");if(!n)throw new Error("guiFullscreen not found");n.addEventListener("click",(()=>{e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen()}));const r=()=>{let t=null,i=null;null!==document.fullscreenElement||document.mozFullScreen||document.webkitIsFullScreen||document.msFullscreenElement?(e.style.position="absolute",t=window.innerWidth,i=window.innerHeight):(e.style.position="relative",t=800,i=600),e.style.left="0px",e.style.top="0px",e.width=t,e.height=i,this._renderer.resize(t,i)};document.addEventListener("fullscreenchange",r,!1),document.addEventListener("mozfullscreenchange",r,!1),document.addEventListener("webkitfullscreenchange",r,!1),document.addEventListener("msfullscreenchange",r,!1),this._running=!1,this._errorGraphicContext=!1,this._renderer.setOnContextLost((()=>{console.log("on_context_lost"),this._errorGraphicContext=!0,this.stop()})),this._renderer.setOnContextRestored((()=>{console.log("on_context_restored"),this._errorGraphicContext=!1,this.start()}))}init(){return e(this,void 0,void 0,(function*(){yield this._renderer.init()}))}start(){this.isRunning()||(this._running=!0,this._chunkGenerator.start(),this._tick())}stop(){this._running=!1,this._chunkGenerator.stop()}isRunning(){return this._running&&!this._errorGraphicContext}_tick(){const e=()=>{this._running&&!this._errorGraphicContext&&(this._mainLoop(),window.requestAnimationFrame(e))};e()}_mainLoop(){const e=Date.now(),i=Math.min(e-this._currFrameTime,30);this._currFrameTime=e,this._framesDuration.push(i/1e3),this._helperTextCountDown>0&&(this._helperTextCountDown-=i,this._helperTextCountDown<0&&(this._helperTextCountDown=0));const n=this._renderer.freeFlyController.getPosition();this._chunkGenerator.update(n);const r=this._chunkGenerator.getChunks();this._renderer.update(i/1e3,r),this._renderer.renderScene(r);{let e=0;r.forEach((t=>{t.visible&&++e}));const t=[590,590],i=[`Chunks\nGenerated:\n${this._chunksCreated} <`,"",`Chunks\nDiscarded:\n${this._chunksDiscarded} <`,"",`Live\nChunks:\n${this._chunksCreated-this._chunksDiscarded} <`,"",`Visible\nChunks:\n${e} <`].join("\n");this._renderer.textRenderer.pushRightAlignedText(i,t,14)}{const e=[Math.floor(n[0]/t),Math.floor(n[1]/t),Math.floor(n[2]/t)];r.forEach((e=>{e.visible}));const i=["Coordinates:",`X: ${e[0]}`,`Y: ${e[1]}`,`Z: ${e[2]}`],s=[14,500];this._renderer.textRenderer.pushText(i.join("\n"),s,14)}{const e=[],t=[.2,.2,.2],i=[.2,.6,.2];e.push({center:[480,125],size:[40,40],text:"A\nQ",color:s.isPressed("A","Q")?i:t}),e.push({center:[525,125],size:[40,40],text:"S",color:s.isPressed("S")?i:t}),e.push({center:[525,170],size:[40,40],text:"W\nZ",color:s.isPressed("W","Z")?i:t}),e.push({center:[570,125],size:[40,40],text:"D",color:s.isPressed("D")?i:t}),e.push({center:[480,25],size:[40,40],lines:[{a:[15,0],b:[-8,0],thickness:6,color:[1,1,1]},{a:[0,10],b:[-12,-2],thickness:6,color:[1,1,1]},{a:[0,-10],b:[-12,2],thickness:6,color:[1,1,1]}],color:s.isPressed("ArrowLeft")?i:t}),e.push({center:[525,25],size:[40,40],lines:[{a:[0,15],b:[0,-8],thickness:6,color:[1,1,1]},{a:[10,0],b:[-2,-12],thickness:6,color:[1,1,1]},{a:[-10,0],b:[2,-12],thickness:6,color:[1,1,1]}],color:s.isPressed("ArrowDown")?i:t}),e.push({center:[525,70],size:[40,40],lines:[{a:[0,-15],b:[0,8],thickness:6,color:[1,1,1]},{a:[10,0],b:[-2,12],thickness:6,color:[1,1,1]},{a:[-10,0],b:[2,12],thickness:6,color:[1,1,1]}],color:s.isPressed("ArrowUp")?i:t}),e.push({center:[570,25],size:[40,40],lines:[{a:[-15,0],b:[8,0],thickness:6,color:[1,1,1]},{a:[0,10],b:[12,-2],thickness:6,color:[1,1,1]},{a:[0,-10],b:[12,2],thickness:6,color:[1,1,1]}],color:s.isPressed("ArrowRight")?i:t}),_.isSupported()?e.push({center:[120,35],size:[230,60],text:"Touch Events\nSupported\n(double tap)",color:[0,.5,0]}):e.push({center:[120,35],size:[230,60],text:"Touch Events\nNot Supported",color:[.5,0,0]}),u.canBePointerLocked(this._canvasElement)?e.push({center:[350,35],size:[210,60],text:"Mouse\nSupported",color:[0,.5,0]}):e.push({center:[350,35],size:[210,60],text:"Mouse Events\nNot Supported",color:[.5,0,0]}),e.forEach((e=>{const{center:t}=e;this._renderer.stackRenderers.pushCenteredRectangle(y(t[0],t[1],-.3),e.size,[0,0,0]),this._renderer.stackRenderers.pushCenteredRectangle(y(t[0],t[1],-.2),[e.size[0]-2,e.size[1]-2],e.color),e.text&&this._renderer.textRenderer.pushCenteredText(e.text,t,16),e.lines&&e.lines.forEach((e=>{this._renderer.stackRenderers.pushThickLine([t[0]+e.a[0],t[1]+e.a[1],0],[t[0]+e.b[0],t[1]+e.b[1],0],e.thickness,e.color)}))}))}this._renderer.renderHUD(this._chunkGenerator.getChunks(),this._chunkGenerator.getProcessingPositions(),this._framesDuration),this._framesDuration.length>100&&this._framesDuration.splice(0,this._framesDuration.length-100)}}window.onerror=(...e)=>{alert(JSON.stringify(e))};e(void 0,void 0,void 0,(function*(){const e=document.querySelector("#main-canvas");if(!e)throw new Error("main-canvas not found");const t=new ae(e);yield t.init(),t.start();{const e=document.getElementById("touch_id");e&&(_.isSupported()?e.innerHTML+="Supported":e.innerHTML+="Not Supported")}{const e=document.getElementById("gui_toggle_start");if(!e)throw new Error("gui_toggle_start not found");e.addEventListener("click",(()=>{console.log("toggle_start"),t.isRunning()?t.stop():t.start()}))}}));
