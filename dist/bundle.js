"use strict";function e(e,t,i,r){return new(i||(i=Promise))((function(s,n){function f(e){try{d(r.next(e))}catch(e){n(e)}}function o(e){try{d(r.throw(e))}catch(e){n(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(f,o)}d((r=r.apply(e,t||[])).next())}))}const t=15,i=.45*Math.PI,r=2e5,s=["requestFullscreen","webkitRequestFullscreen","mozRequestFullScreen","msRequestFullscreen"],n=["fullscreenchange","webkitfullscreenchange","mozfullscreenchange","msfullscreenchange"];const f=new class{constructor(){this._onFullScreenChangeCallbacks=[],this._isInitialized=!1}_initialize(){if(this._isInitialized)return;this._isInitialized=!0;const e=()=>{this._onFullScreenChangeCallbacks.forEach((e=>e()))};for(const t of n)document.addEventListener(t,e,!1)}isCompatible(e){for(const t of s)if(t in e)return!0;return!1}isFullScreen(e){return document.fullscreenElement===e}requestFullScreen(t){return e(this,void 0,void 0,(function*(){if(this.isFullScreen(t))return{success:!1,message:"element already in full screen"};this._initialize();for(const e of s)if(e in t)return t[e](),{success:!0,message:"request for full screen done"};return{success:!1,message:"unsupported request for full screen"}}))}addOnFullScreenChange(e){this._onFullScreenChangeCallbacks.push(e)}removeOnFullScreenChange(e){const t=this._onFullScreenChangeCallbacks.indexOf(e);t<0||this._onFullScreenChangeCallbacks.splice(t,1)}},o={Num0:48,Num1:49,Num2:50,Num3:51,Num4:52,Num5:53,Num6:54,Num7:55,Num8:56,Num9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,Semicolon:186,Equal:187,Comma:188,Minus:189,Period:190,BackQuote:192,BracketLeft:219,Backslash:220,BracketRight:221,Quote:222,Shift:16,Ctrl:17,Alt:18,CapsLock:20,Tab:9,Enter:13,Pause:19,Escape:27,Space:32,PageUp:33,PageDown:34,End:35,Home:36,ArrowLeft:37,ArrowUp:38,ArrowRight:39,ArrowDown:40,PrintScreen:44,Insert:45,Delete:46,ContextMenu:93,ScrollLock:145,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,F13:124,F14:125,F15:126,F16:127,F17:128,F18:129,F19:130,F20:131,F21:132,F22:133,F23:134,F24:135,NumPad0:96,NumPad1:97,NumPad2:98,NumPad3:99,NumPad4:100,NumPad5:101,NumPad6:102,NumPad7:103,NumPad8:104,NumPad9:105,NumPadMultiply:106,NumPadAdd:107,NumPadSubtract:109,NumPadDecimal:110,NumPadDivide:111,NumLock:144,NumPadComma:194,NumPadEqual:12};const d=new class{constructor(){this._pressedKeysSet=new Set,this._preventDefaultKeysSet=new Set,this._activated=!1;this._activated=!1,this._handleKeyDown=(e=>{const{keyCode:t}=e;this._preventDefaultKeysSet.has(t)&&e.preventDefault(),this._pressedKeysSet.add(t)}).bind(this),this._handleKeyUp=(e=>{const{keyCode:t}=e;this._preventDefaultKeysSet.has(t)&&e.preventDefault(),this._pressedKeysSet.delete(t)}).bind(this)}isPressed(...e){for(const t of e)if(this._pressedKeysSet.has(o[t]))return!0;return!1}preventDefault(e){this._preventDefaultKeysSet.add(o[e])}enableDefault(e){this._preventDefaultKeysSet.delete(o[e])}activate(){this._activated||(this._pressedKeysSet.clear(),document.addEventListener("keydown",this._handleKeyDown),document.addEventListener("keyup",this._handleKeyUp),this._activated=!0)}deactivate(){this._activated&&(this._pressedKeysSet.clear(),document.removeEventListener("keydown",this._handleKeyDown),document.removeEventListener("keyup",this._handleKeyUp),this._activated=!1)}},a={Left:0,Middle:1,Right:2};const h=new class{constructor(){this._pressedButtonsSet=new Set,this._activated=!1,this._deltaX=0,this._deltaY=0;this._activated=!1,this._handleMouseDown=(e=>{this._pressedButtonsSet.add(e.button)}).bind(this),this._handleMouseUp=(e=>{this._pressedButtonsSet.delete(e.button)}).bind(this),this._handleMouseMove=(e=>{this._deltaX+=e.movementX||e.mozMovementX||e.webkitMovementX||0,this._deltaY+=e.movementY||e.mozMovementY||e.webkitMovementY||0}).bind(this)}activate(){this._activated||(this._pressedButtonsSet.clear(),document.addEventListener("mousedown",this._handleMouseDown),document.addEventListener("mouseup",this._handleMouseUp),document.addEventListener("mousemove",this._handleMouseMove),this._activated=!0)}deactivate(){this._activated&&(this._pressedButtonsSet.clear(),document.removeEventListener("mousedown",this._handleMouseDown),document.removeEventListener("mouseup",this._handleMouseUp),document.removeEventListener("mousemove",this._handleMouseMove),this._activated=!1)}isButtonPressed(e){return this._pressedButtonsSet.has(a[e])}deltaX(){return this._deltaX}deltaY(){return this._deltaY}resetDelta(){this._deltaX=0,this._deltaY=0}},c=["requestPointerLock","mozRequestPointerLock","webkitRequestPointerLock"],u=["exitPointerLock","mozExitPointerLock","webkitExitPointerLock"],_=["pointerLockElement","mozPointerLockElement","webkitPointerLockElement"],l=[{methodName:"onpointerlockchange",propertyName:"pointerlockchange"},{methodName:"onmozpointerlockchange",propertyName:"mozpointerlockchange"},{methodName:"onwebkitpointerlockchange",propertyName:"webkitpointerlockchange"}],p=[{methodName:"onpointerlockerror",propertyName:"pointerlockerror"},{methodName:"onmozpointerlockerror",propertyName:"mozpointerlockerror"},{methodName:"onwebkitpointerlockerror",propertyName:"webkitpointerlockerror"}];const m=new class{constructor(){this._onLockChangeCallbacks=[],this._onLockErrorCallbacks=[],this._timeSinceLastLockChange=0,this._isInitialized=!1}_initialize(){if(this._isInitialized)return;this._isInitialized=!0;const e=()=>{this._timeSinceLastLockChange=Date.now(),this._onLockChangeCallbacks.forEach((e=>e()))},t=e=>{this._timeSinceLastLockChange=Date.now(),this._onLockErrorCallbacks.forEach((t=>t(e)))};for(const t of l)if(t.methodName in document){document.addEventListener(t.propertyName,e,!1);break}for(const e of p)if(e.methodName in document){document.addEventListener(e.propertyName,t,!1);break}}canBePointerLocked(e){for(const t of c)if(t in e)return!0;return!1}isPointerLocked(e){for(const t of _)if(t in document)return document[t]===e;return!1}requestPointerLock(t){return e(this,void 0,void 0,(function*(){if(this.isPointerLocked(t))return{success:!1,message:"element already locked"};if(this._initialize(),this._timeSinceLastLockChange>0){const e=(Date.now()-this._timeSinceLastLockChange)/1e3;if(e<1.1)return{success:!1,message:`request for lock was too early, time to wait: ${e.toFixed(2)}sec`}}this._timeSinceLastLockChange=Date.now();for(const e of c)if(e in t){const i={unadjustedMovement:!1};try{yield t[e](i)}catch(e){return{success:!1,message:`request for lock was too early, time to wait: ${((Date.now()-this._timeSinceLastLockChange)/1e3).toFixed(2)}sec`}}return this._timeSinceLastLockChange=Date.now(),{success:!0,message:"request for lock done"}}return{success:!1,message:"unsupported request for lock"}}))}allowPointerLockedOnClickEvent(t){if(t===this._latestRequestHtmlElement)return;this._latestRequestHtmlElement=t;const i=()=>e(this,void 0,void 0,(function*(){t.removeEventListener("click",i);const e=yield this.requestPointerLock(t);this._latestRequestHtmlElement=void 0,e.success||this.allowPointerLockedOnClickEvent(t)}));t.addEventListener("click",i)}exitPointerLock(){for(const e of u)if(e in document){document[e]();break}}addOnLockChange(e){this._onLockChangeCallbacks.push(e)}removeOnLockChange(e){const t=this._onLockChangeCallbacks.indexOf(e);t<0||this._onLockChangeCallbacks.splice(t,1)}addOnLockError(e){this._onLockErrorCallbacks.push(e)}removeOnLockError(e){const t=this._onLockErrorCallbacks.indexOf(e);t<0||this._onLockErrorCallbacks.splice(t,1)}};class b{constructor(e,t,i){this.createdAt=Date.now(),this.deltaX=0,this.deltaY=0,this.id=e,this.positionX=t,this.positionY=i}resetDelta(){this.deltaX=0,this.deltaY=0}}const g=new class{constructor(){this._activated=!1,this._allTouchDataMap=new Map,this._allCachedTouchDataArray=[];this._activated=!1,this._handleTouchStart=(e=>{e.preventDefault();for(let t=0;t<e.changedTouches.length;++t){const{identifier:i,pageX:r,pageY:s}=e.changedTouches[t],n=new b(i,r,s);this._allTouchDataMap.set(`${i}`,n),this._allCachedTouchDataArray.length=0}}).bind(this),this._handleTouchEnd=(e=>{e.preventDefault();for(let t=0;t<e.changedTouches.length;++t){const{identifier:i}=e.changedTouches[t];this._allTouchDataMap.delete(`${i}`),this._allCachedTouchDataArray.length=0}}).bind(this),this._handleTouchMove=(e=>{e.preventDefault();for(let t=0;t<e.changedTouches.length;++t){const{identifier:i,pageX:r,pageY:s}=e.changedTouches[t],n=this._allTouchDataMap.get(`${i}`);if(!n)continue;const f=r-n.positionX,o=s-n.positionY,d=2.5;f>-d&&f<+d&&o>-d&&o<+d||(n.deltaX+=f,n.deltaY+=o,n.positionX=r,n.positionY=s)}}).bind(this)}isSupported(){return"ontouchstart"in window}activate(){this.isSupported()&&(this._activated||(this._allTouchDataMap.clear(),this._allCachedTouchDataArray.length=0,document.addEventListener("touchstart",this._handleTouchStart),document.addEventListener("touchend",this._handleTouchEnd),document.addEventListener("touchcancel",this._handleTouchEnd),document.addEventListener("touchmove",this._handleTouchMove,{passive:!1}),this._activated=!0))}deactivate(){this._activated&&(this._allTouchDataMap.clear(),this._allCachedTouchDataArray.length=0,document.removeEventListener("touchstart",this._handleTouchStart),document.removeEventListener("touchend",this._handleTouchEnd),document.removeEventListener("touchcancel",this._handleTouchEnd),document.removeEventListener("touchmove",this._handleTouchMove),this._activated=!1)}_refreshCache(){0===this._allCachedTouchDataArray.length&&(this._allCachedTouchDataArray=[...this._allTouchDataMap.values()])}getTouchData(){return this._refreshCache(),this._allCachedTouchDataArray}resetDeltas(){this._refreshCache(),this._allCachedTouchDataArray.forEach((e=>e.resetDelta()))}};var v=1e-6,S="undefined"!=typeof Float32Array?Float32Array:Array;function x(){var e=new S(16);return S!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function C(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function w(e,t,i){var r=t[0],s=t[1],n=t[2],f=t[3],o=t[4],d=t[5],a=t[6],h=t[7],c=t[8],u=t[9],_=t[10],l=t[11],p=t[12],m=t[13],b=t[14],g=t[15],v=i[0],S=i[1],x=i[2],C=i[3];return e[0]=v*r+S*o+x*c+C*p,e[1]=v*s+S*d+x*u+C*m,e[2]=v*n+S*a+x*_+C*b,e[3]=v*f+S*h+x*l+C*g,v=i[4],S=i[5],x=i[6],C=i[7],e[4]=v*r+S*o+x*c+C*p,e[5]=v*s+S*d+x*u+C*m,e[6]=v*n+S*a+x*_+C*b,e[7]=v*f+S*h+x*l+C*g,v=i[8],S=i[9],x=i[10],C=i[11],e[8]=v*r+S*o+x*c+C*p,e[9]=v*s+S*d+x*u+C*m,e[10]=v*n+S*a+x*_+C*b,e[11]=v*f+S*h+x*l+C*g,v=i[12],S=i[13],x=i[14],C=i[15],e[12]=v*r+S*o+x*c+C*p,e[13]=v*s+S*d+x*u+C*m,e[14]=v*n+S*a+x*_+C*b,e[15]=v*f+S*h+x*l+C*g,e}function y(e,t,i,r){var s,n,f,o,d,a,h,c,u,_,l,p,m,b,g,S,x,C,w,y,z,k,E,P,T=r[0],M=r[1],R=r[2],A=Math.hypot(T,M,R);return A<v?null:(T*=A=1/A,M*=A,R*=A,s=Math.sin(i),f=1-(n=Math.cos(i)),o=t[0],d=t[1],a=t[2],h=t[3],c=t[4],u=t[5],_=t[6],l=t[7],p=t[8],m=t[9],b=t[10],g=t[11],S=T*T*f+n,x=M*T*f+R*s,C=R*T*f-M*s,w=T*M*f-R*s,y=M*M*f+n,z=R*M*f+T*s,k=T*R*f+M*s,E=M*R*f-T*s,P=R*R*f+n,e[0]=o*S+c*x+p*C,e[1]=d*S+u*x+m*C,e[2]=a*S+_*x+b*C,e[3]=h*S+l*x+g*C,e[4]=o*w+c*y+p*z,e[5]=d*w+u*y+m*z,e[6]=a*w+_*y+b*z,e[7]=h*w+l*y+g*z,e[8]=o*k+c*E+p*P,e[9]=d*k+u*E+m*P,e[10]=a*k+_*E+b*P,e[11]=h*k+l*E+g*P,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var z=function(e,t,i,r,s){var n,f=1/Math.tan(t/2);return e[0]=f/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=f,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=s&&s!==1/0?(n=1/(r-s),e[10]=(s+r)*n,e[14]=2*s*r*n):(e[10]=-1,e[14]=-2*r),e};var k=function(e,t,i,r,s,n,f){var o=1/(t-i),d=1/(r-s),a=1/(n-f);return e[0]=-2*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*d,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*a,e[11]=0,e[12]=(t+i)*o,e[13]=(s+r)*d,e[14]=(f+n)*a,e[15]=1,e};function E(){var e=new S(3);return S!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function P(e){var t=e[0],i=e[1],r=e[2];return Math.hypot(t,i,r)}function T(e,t,i){var r=new S(3);return r[0]=e,r[1]=t,r[2]=i,r}function M(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function R(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e}function A(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e}function L(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e}function F(e,t,i){var r=t[0],s=t[1],n=t[2],f=i[0],o=i[1],d=i[2];return e[0]=s*d-n*o,e[1]=n*f-r*d,e[2]=r*o-s*f,e}function D(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}var U=A;function B(e,t,i,r){var s=new S(4);return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function I(){var e=new S(4);return S!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}E(),function(){var e,t=(e=new S(4),S!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e)}();var N,O,G,X;function H(){var e=new S(2);return S!=Float32Array&&(e[0]=0,e[1]=0),e}function W(e,t){var i=new S(2);return i[0]=e,i[1]=t,i}E(),T(1,0,0),T(0,1,0),I(),I(),N=new S(9),S!=Float32Array&&(N[1]=0,N[2]=0,N[3]=0,N[5]=0,N[6]=0,N[7]=0),N[0]=1,N[4]=1,N[8]=1,function(){var e=H()}();class Y{constructor(e){this._running=!1,this._chunks=[],this._chunkPositionQueue=[],this._savedIndex=[999,999,999],this._unusedWorkers=[],this._inUseWorkers=[],this._cameraPosition=T(0,0,0),this._def=e;for(let e=0;e<this._def.workerTotal;++e)this._addWorker()}_addWorker(){const e={instance:new Worker(this._def.workerFile),float32buffer:new Float32Array(this._def.workerBufferSize)};this._unusedWorkers.push(e);e.instance.addEventListener("message",(t=>{const i=this._inUseWorkers.indexOf(e);i>=0&&(this._unusedWorkers.push(e),this._inUseWorkers.splice(i,1));const{indexPosition:r,realPosition:s,float32buffer:n,sizeUsed:f}=t.data;if(e.float32buffer=n,e.processing=void 0,!this._running)return;const o=this._def.acquireGeometry();o.update(e.float32buffer,f),this._chunks.push({realPosition:s,indexPosition:r,geometry:o,isVisible:!1}),this._def.onChunkCreated&&this._def.onChunkCreated(),this._launchWorker()}),!1)}start(){this._running=!0}stop(){this._running&&(this._running=!1,this._chunkPositionQueue.length=0,this._chunks.forEach((e=>this._def.releaseGeometry(e.geometry))),this._chunks.length=0)}update(e){if(this._running){this._updateGeneration(e);for(const e of this._chunks){const t=this._def.chunkIsVisible(e.realPosition);e.isVisible=t,e.geometry.setVisibility(t)}this._launchWorker()}}_updateGeneration(e){M(this._cameraPosition,e);const t=[Math.floor(e[0]/this._def.chunkSize),Math.floor(e[1]/this._def.chunkSize),Math.floor(e[2]/this._def.chunkSize)];if(0!=this._chunks.length&&D(t,this._savedIndex))return;M(this._savedIndex,t),this._chunkPositionQueue.length=0;const{chunkRange:i}=this._def,r=[Math.floor(t[0]-i),Math.floor(t[1]-i),Math.floor(t[2]-i)],s=[Math.floor(t[0]+i),Math.floor(t[1]+i),Math.floor(t[2]+i)];for(let e=0;e<this._chunks.length;){const{indexPosition:t}=this._chunks[e];t[0]<r[0]||t[0]>s[0]||t[1]<r[1]||t[1]>s[1]||t[2]<r[2]||t[2]>s[2]?(this._def.releaseGeometry(this._chunks[e].geometry),this._chunks.splice(e,1),this._def.onChunkDiscarded&&this._def.onChunkDiscarded()):++e}const n=[0,0,0];for(n[2]=r[2];n[2]<=s[2];++n[2])for(n[1]=r[1];n[1]<=s[1];++n[1])for(n[0]=r[0];n[0]<=s[0];++n[0]){if(this._chunks.findIndex((e=>{const{indexPosition:t}=e;return D(t,n)}))>=0)continue;if(this._inUseWorkers.findIndex((e=>{const{indexPosition:t}=e.processing;return D(t,n)}))>=0)continue;this._chunkPositionQueue.push({indexPosition:[...n],realPosition:[n[0]*this._def.chunkSize,n[1]*this._def.chunkSize,n[2]*this._def.chunkSize]})}}_launchWorker(){for(;this._chunkPositionQueue.length>0&&this._unusedWorkers.length>0;){const e=this._unusedWorkers.pop();this._inUseWorkers.push(e);const t=this._getBestNextChunkPosition();e.processing=t,e.instance.postMessage({realPosition:t.realPosition,indexPosition:t.indexPosition,float32buffer:e.float32buffer},[e.float32buffer.buffer])}}_getBestNextChunkPosition(){if(0===this._chunkPositionQueue.length)throw new Error("empty chunk position queue");if(1==this._chunkPositionQueue.length)return this._chunkPositionQueue.pop();const e=e=>{const t=.5*this._def.chunkSize;return P([this._cameraPosition[0]-(e[0]+t),this._cameraPosition[1]-(e[1]+t),this._cameraPosition[2]-(e[2]+t)])};let t=0,i=e(this._chunkPositionQueue[0].realPosition);for(let r=1;r<this._chunkPositionQueue.length;++r){const{realPosition:s}=this._chunkPositionQueue[r];if(!this._def.chunkIsVisible(s))continue;const n=e(s);i<n||(t=r,i=n)}return this._chunkPositionQueue.splice(t,1)[0]}getChunks(){return this._chunks}getProcessingRealPositions(){return this._inUseWorkers.map((e=>e.processing.realPosition))}}class V{static initialize(e){if(V._gl=e.getContext("webgl2",{alpha:!1,antialias:!1,depth:!0,failIfMajorPerformanceCaveat:!1,powerPreference:"high-performance",premultipliedAlpha:!0,preserveDrawingBuffer:!0,stencil:!1}),!V._gl)throw new Error("could not create webgl context");V._extensionLoseContext=V._gl.getExtension("WEBGL_lose_context"),V._gl.getExtension("EXT_color_buffer_float"),V._gl.getExtension("EXT_float_blend")}static getContext(){if(!V._gl)throw new Error("webgl context not initialized");return V._gl}static getExtensionLoseContext(){return V._extensionLoseContext}static getExtensionLoseContextStrict(){if(!V._extensionLoseContext)throw new Error("lose context extension not available");return V._extensionLoseContext}}V._gl=null,V._extensionLoseContext=null,function(e){e[e.RBGA_UBYTES=0]="RBGA_UBYTES",e[e.RBGA_FLOAT=1]="RBGA_FLOAT"}(O||(O={})),function(e){e[e.FLOAT=0]="FLOAT"}(G||(G={})),function(e){let t,i;e.BytesPerPixel=4,function(e){e[e.float=0]="float",e[e.vec2f=1]="vec2f",e[e.vec3f=2]="vec3f",e[e.vec4f=3]="vec4f",e[e.mat3f=4]="mat3f",e[e.mat4f=5]="mat4f"}(t=e.AttributeType||(e.AttributeType={})),function(e){e[e.lines=0]="lines",e[e.triangles=1]="triangles",e[e.triangleStrip=2]="triangleStrip"}(i=e.PrimitiveType||(e.PrimitiveType={}));e.Geometry=class{constructor(r,s){this._primitiveStart=0,this._primitiveCount=0,this._instanceCount=0,this._isInstanced=!1;const n=V.getContext();if(0===s.vbos.length)throw new Error("empty vbo defintion");for(const e of s.vbos){if(0===e.attrs.length)throw new Error("empty vbo attribute defintion");for(const t of e.attrs)if(!r.hasAttribute(t.name))throw new Error(`attribute not found, name="${t.name}"`)}switch(this._def=s,s.primitiveType){case i.lines:this._primitiveType=n.LINES;break;case i.triangles:this._primitiveType=n.TRIANGLES;break;case i.triangleStrip:this._primitiveType=n.TRIANGLE_STRIP;break;default:throw new Error("primitive type not found")}const f=n.createVertexArray();if(!f)throw new Error("fail o create a vao unit");this._vao=f,n.bindVertexArray(this._vao),this._vbos=[];for(const i of this._def.vbos){const s=n.createBuffer();if(!s)throw new Error("fail o create a vbo unit");this._vbos.push({object:s,maxSize:0,dynamic:i.dynamic||!1}),n.bindBuffer(n.ARRAY_BUFFER,s);let f=i.stride||0;if(!f){for(const e of i.attrs)switch(e.type){case t.float:f+=1;break;case t.vec2f:f+=2;break;case t.vec3f:f+=3;break;case t.vec4f:f+=4;break;case t.mat3f:f+=9;break;case t.mat4f:f+=16}f*=e.BytesPerPixel}for(const s of i.attrs){let o=1,d=1;switch(s.type){case t.float:o=1,d=1;break;case t.vec2f:o=2,d=1;break;case t.vec3f:o=3,d=1;break;case t.vec4f:o=4,d=1;break;case t.mat3f:o=3,d=3;break;case t.mat4f:o=4,d=4}const a=r.getAttribute(s.name);for(let t=0;t<d;++t){const r=a+t,d=(s.index+t*o)*e.BytesPerPixel;n.enableVertexAttribArray(r),n.vertexAttribPointer(r,o,n.FLOAT,!1,f,d),!0===i.instanced&&(n.vertexAttribDivisor(r,1),this._isInstanced=!0)}}}n.bindVertexArray(null)}dispose(){const e=V.getContext();for(const t of this._vbos)e.deleteBuffer(t.object);this._vbos.length=0,e.deleteVertexArray(this._vao)}setBufferSize(e,t){if(e<0||e>=this._vbos.length)throw new Error("no buffer available to that index");if(t<=0)return;const i=this._vbos[e];if(t<i.maxSize)return;i.maxSize=t;const r=V.getContext(),s=i.dynamic?r.DYNAMIC_DRAW:r.STATIC_DRAW;r.bindBuffer(r.ARRAY_BUFFER,i.object),r.bufferData(r.ARRAY_BUFFER,t,s),r.bindBuffer(r.ARRAY_BUFFER,null)}setFloatBufferSize(e,t){this.setBufferSize(e,4*t)}updateBuffer(e,t,i){if(e<0||e>=this._vbos.length)throw new Error("no buffer available to that index");if(i<=0)return;const r=V.getContext(),s=t instanceof Float32Array?t:new Float32Array(t),n=this._vbos[e];if(r.bindBuffer(r.ARRAY_BUFFER,n.object),i>n.maxSize){n.maxSize=i;const e=n.dynamic?r.DYNAMIC_DRAW:r.STATIC_DRAW;r.bufferData(r.ARRAY_BUFFER,s,e,0,i)}else r.bufferSubData(r.ARRAY_BUFFER,0,s,0,i);r.bindBuffer(r.ARRAY_BUFFER,null)}render(){if(0==this._primitiveCount)return;if(this._isInstanced&&0==this._instanceCount)return;const e=V.getContext();e.bindVertexArray(this._vao),!0===this._isInstanced?e.drawArraysInstanced(this._primitiveType,this._primitiveStart,this._primitiveCount,this._instanceCount):e.drawArrays(this._primitiveType,this._primitiveStart,this._primitiveCount),e.bindVertexArray(null)}setPrimitiveStart(e){this._primitiveStart=e}setPrimitiveCount(e){this._primitiveCount=e}setInstancedCount(e){this._instanceCount=e}}}(X||(X={}));class j{constructor(e){this._attributes=new Map,this._uniforms=new Map;const t=V.getContext(),i=this._getShader(e.vertexSrc,t.VERTEX_SHADER),r=this._getShader(e.fragmentSrc,t.FRAGMENT_SHADER),s=t.createProgram();if(!s)throw new Error("could not create a shader program");if(t.attachShader(s,i),t.attachShader(s,r),t.linkProgram(s),t.deleteShader(i),t.deleteShader(r),!t.getProgramParameter(s,t.LINK_STATUS)){const e=t.getProgramInfoLog(s);throw new Error("Failed to initialized shaders, Error linking:"+e)}this._program=s,this.bind(),this._getAttributes(e.attributes),this._getUniforms(e.uniforms),j.unbind()}bind(){V.getContext().useProgram(this._program)}static unbind(){V.getContext().useProgram(null)}hasAttribute(e){return this._attributes.has(e)}getAttribute(e){const t=this._attributes.get(e);if(void 0===t)throw new Error(`attribute not found: ${e}`);return t}getUniform(e){const t=this._uniforms.get(e);if(void 0===t)throw new Error(`uniform not found: ${e}`);return t}setInteger1Uniform(e,t){V.getContext().uniform1i(this.getUniform(e),t)}setInteger2Uniform(e,t,i){V.getContext().uniform2i(this.getUniform(e),t,i)}setInteger3Uniform(e,t,i,r){V.getContext().uniform3i(this.getUniform(e),t,i,r)}setFloat1Uniform(e,t){V.getContext().uniform1f(this.getUniform(e),t)}setFloat2Uniform(e,t,i){V.getContext().uniform2f(this.getUniform(e),t,i)}setFloat3Uniform(e,t,i,r){V.getContext().uniform3f(this.getUniform(e),t,i,r)}setMatrix4Uniform(e,t){V.getContext().uniformMatrix4fv(this.getUniform(e),!1,t)}_getAttributes(e){const t=V.getContext();for(let i=0;i<e.length;++i){const r=t.getAttribLocation(this._program,e[i]);if(r<0)throw new Error(`attribute not found => ${e[i]}`);this._attributes.set(e[i],r)}}_getUniforms(e){const t=V.getContext();for(let i=0;i<e.length;++i){const r=t.getUniformLocation(this._program,e[i]);if(null===r)throw new Error(`uniform not found => ${e[i]}`);this._uniforms.set(e[i],r)}}_getShader(e,t){const i=V.getContext(),r=i.createShader(t);if(!r)throw new Error("could not create a shader");if(i.shaderSource(r,e),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS)){let e=i.getShaderInfoLog(r);throw e||(e="failed to compile a shader"),new Error(e)}return r}}class q{constructor(){this._width=0,this._height=0,this._texture=null}load(t,i=!1){return e(this,void 0,void 0,(function*(){const e=V.getContext();this._texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this._texture);const r=e.RGBA,s=e.RGBA,n=e.UNSIGNED_BYTE,f=new Uint8Array([0,0,255,255]);return e.texImage2D(e.TEXTURE_2D,0,r,1,1,0,s,n,f),e.bindTexture(e.TEXTURE_2D,null),new Promise(((f,o)=>{const d=new Image;d.onerror=o,d.onload=()=>{this._width=d.width,this._height=d.height,e.bindTexture(e.TEXTURE_2D,this._texture),e.texImage2D(e.TEXTURE_2D,0,r,s,n,d),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);const t=i?e.NEAREST:e.LINEAR;e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,t),e.bindTexture(e.TEXTURE_2D,null),f()},d.src=t}))}))}loadFromMemory(e,t,i,r=!1){const s=V.getContext();this._texture=s.createTexture(),s.bindTexture(s.TEXTURE_2D,this._texture),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);const n=r?s.NEAREST:s.LINEAR;s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,n),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,n);const f=s.RGBA,o=s.RGBA,d=s.UNSIGNED_BYTE;s.texImage2D(s.TEXTURE_2D,0,f,e,t,0,o,d,i),s.bindTexture(s.TEXTURE_2D,null)}getWidth(){if(!this._texture)throw new Error("texture not initialized");return this._width}getHeight(){if(!this._texture)throw new Error("texture not initialized");return this._height}bind(){if(!this._texture)throw new Error("texture not initialized");const e=V.getContext();e.bindTexture(e.TEXTURE_2D,this._texture)}static unbind(){const e=V.getContext();e.bindTexture(e.TEXTURE_2D,null)}}const $={X:0,Y:1,Z:2};class K{constructor(e){this._isActivated=!1,this._theta=0,this._phi=0,this._touchWasActive=!1,this._touchStartTime=0,this._touchMoveForward=!1,this._position=T(0,0,0),this._target=T(0,0,0),this._forwardAxis=T(1,0,0),this._leftAxis=T(0,0,1),this._upAxis=T(0,1,0),this._mouseSensibility=e.mouseSensibility,this._keyboardSensibility=e.keyboardSensibility,this._touchSensibility=e.touchSensibility,this._movingSpeed=e.movingSpeed,M(this._position,e.position),this._axisIndices=[e.coordinates?$[e.coordinates[0]]:$.X,e.coordinates?$[e.coordinates[1]]:$.Y,e.coordinates?$[e.coordinates[2]]:$.Z],this._theta=e.theta,this._phi=e.phi}isActivated(){return this._isActivated}update(e){let t=!1,i=!1,r=!1,s=!1,n=0,f=0;const o=Math.PI/180;n-=h.deltaX()*this._mouseSensibility*o,f-=h.deltaY()*this._mouseSensibility*o;const a=g.getTouchData().length>0;if(a){if(!this._touchWasActive){const e=Date.now();(e-this._touchStartTime)/1e3<.25?this._touchMoveForward=!0:this._touchStartTime=e}const e=g.getTouchData()[0];n-=e.deltaX*this._touchSensibility*o,f-=e.deltaY*this._touchSensibility*o}else this._touchMoveForward=!1;this._touchWasActive=a,this._touchMoveForward&&(t=!0);const c=this._movingSpeed*e,u=T(0,0,0);L(u,this._forwardAxis,c);const _=T(0,0,0);L(_,this._leftAxis,c),d.isPressed("Z","W")&&(t=!0),d.isPressed("S")&&(i=!0),d.isPressed("A","Q")&&(r=!0),d.isPressed("D")&&(s=!0);const l=this._keyboardSensibility*e;d.isPressed("ArrowUp")?f+=l:d.isPressed("ArrowDown")&&(f-=l),d.isPressed("ArrowLeft")?n+=l:d.isPressed("ArrowRight")&&(n-=l),this._theta+=n,this._phi+=f;const p=.5*Math.PI,m=.95*p;this._phi=Math.min(Math.max(this._phi,-m),+m);const b=Math.cos(this._theta),v=Math.sin(this._theta),[S,x,C]=this._axisIndices,w=Math.cos(this._phi+p);this._upAxis[S]=w*b,this._upAxis[x]=w*v,this._upAxis[C]=Math.sin(this._phi+p);const y=Math.cos(this._phi);this._forwardAxis[S]=y*b,this._forwardAxis[x]=y*v,this._forwardAxis[C]=Math.sin(this._phi),F(this._leftAxis,this._upAxis,this._forwardAxis),t?R(this._position,this._position,u):i&&U(this._position,this._position,u),r?R(this._position,this._position,_):s&&U(this._position,this._position,_),R(this._target,this._position,this._forwardAxis)}getPosition(){return this._position}setPosition(e){M(this._position,e)}getTarget(){return this._target}getForwardAxis(){return this._forwardAxis}getLeftAxis(){return this._leftAxis}getUpAxis(){return this._upAxis}getTheta(){return this._theta}getPhi(){return this._phi}getTouchMoveForward(){return this._touchMoveForward}}var Q,Z;!function(e){e[e.Right=0]="Right",e[e.Left=1]="Left",e[e.Bottom=2]="Bottom",e[e.Top=3]="Top",e[e.Back=4]="Back",e[e.Front=5]="Front"}(Q||(Q={}));class J{constructor(){this._frustum=new Float32Array(24)}_setPlane(e,t,i,r){const s=4*e;this._frustum[s+0]=t[0]+i[0]*r,this._frustum[s+1]=t[1]+i[1]*r,this._frustum[s+2]=t[2]+i[2]*r,this._frustum[s+3]=t[3]+i[3]*r;const n=Math.sqrt(this._frustum[s+0]*this._frustum[s+0]+this._frustum[s+1]*this._frustum[s+1]+this._frustum[s+2]*this._frustum[s+2]);0!==n&&(this._frustum[s+0]/=n,this._frustum[s+1]/=n,this._frustum[s+2]/=n,this._frustum[s+3]/=n)}calculateFrustum(e,t){const i=w(x(),e,t),r=B(i[0],i[4],i[8],i[12]),s=B(i[1],i[5],i[9],i[13]),n=B(i[2],i[6],i[10],i[14]),f=B(i[3],i[7],i[11],i[15]);this._setPlane(Q.Right,f,r,-1),this._setPlane(Q.Left,f,r,1),this._setPlane(Q.Bottom,f,s,1),this._setPlane(Q.Top,f,s,-1),this._setPlane(Q.Back,f,n,-1),this._setPlane(Q.Front,f,n,1)}sphereInFrustum(e,t,i,r){for(let s=0;s<6;++s){const n=4*s;if(this._frustum[n+0]*e+this._frustum[n+1]*t+this._frustum[n+2]*i+this._frustum[n+3]<=-r)return!1}return!0}pointInFrustum(e,t,i){return this.sphereInFrustum(e,t,i,0)}cubeInFrustum(e,t,i,r){const s=e-r,n=t-r,f=i-r,o=e+r,d=t+r,a=i+r;for(let e=0;e<6;++e){const t=4*e,i=this._frustum[t+0],r=this._frustum[t+1],h=this._frustum[t+2],c=this._frustum[t+3];if(!(i*s+r*n+h*f+c>0||i*o+r*n+h*f+c>0||i*s+r*d+h*f+c>0||i*o+r*d+h*f+c>0||i*s+r*n+h*a+c>0||i*o+r*n+h*a+c>0||i*s+r*d+h*a+c>0||i*o+r*d+h*a+c>0))return!1}return!0}}!function(e){e[e.perspective=0]="perspective",e[e.orthogonal=1]="orthogonal"}(Z||(Z={}));class ee{constructor(){this._projectionType=Z.perspective,this._viewportPos=W(0,0),this._viewportSize=W(0,0),this._projectionMatrix=x(),this._viewMatrix=x(),this._composedMatrix=x(),this._eye=T(0,0,0),this._target=T(0,0,0),this._upAxis=T(0,0,0)}setAsPerspective(e){this._projectionType=Z.perspective;let t=e.aspectRatio;void 0===t&&(t=this._viewportSize[0]/this._viewportSize[1]),this._perspectiveData={fovy:e.fovy,aspectRatio:t,near:e.near,far:e.far}}setAsOrthogonal(e){this._projectionType=Z.orthogonal,this._orthogonalData=Object.assign({},e)}setViewportPos(e,t){this._viewportPos[0]=e,this._viewportPos[1]=t}getViewportPos(){return this._viewportPos}setViewportSize(e,t){this._viewportSize[0]=e,this._viewportSize[1]=t,this._projectionType!==Z.perspective&&this._perspectiveData&&(this._perspectiveData.aspectRatio=this._viewportSize[0]/this._viewportSize[1])}getViewportSize(){return this._viewportSize}lookAt(e,t,i){M(this._eye,e),M(this._target,t),M(this._upAxis,i)}setEye(e){M(this._eye,e)}setTarget(e){M(this._target,e)}setUpAxis(e){M(this._upAxis,e)}getEye(){return this._eye}getTarget(){return this._target}getUpAxis(){return this._upAxis}addOffset(e){R(this._eye,this._eye,e),R(this._target,this._target,e)}subOffset(e){A(this._eye,this._eye,e),A(this._target,this._target,e)}computeMatrices(){if(this._projectionType===Z.perspective){const{fovy:e,aspectRatio:t,near:i,far:r}=this._perspectiveData;z(this._projectionMatrix,e,t,i,r)}else if(this._projectionType===Z.orthogonal){const{left:e,right:t,top:i,bottom:r,near:s,far:n}=this._orthogonalData;k(this._projectionMatrix,e,t,i,r,s,n)}!function(e,t,i,r){var s,n,f,o,d,a,h,c,u,_,l=t[0],p=t[1],m=t[2],b=r[0],g=r[1],S=r[2],x=i[0],C=i[1],w=i[2];Math.abs(l-x)<v&&Math.abs(p-C)<v&&Math.abs(m-w)<v?function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(e):(h=l-x,c=p-C,u=m-w,s=g*(u*=_=1/Math.hypot(h,c,u))-S*(c*=_),n=S*(h*=_)-b*u,f=b*c-g*h,(_=Math.hypot(s,n,f))?(s*=_=1/_,n*=_,f*=_):(s=0,n=0,f=0),o=c*f-u*n,d=u*s-h*f,a=h*n-c*s,(_=Math.hypot(o,d,a))?(o*=_=1/_,d*=_,a*=_):(o=0,d=0,a=0),e[0]=s,e[1]=o,e[2]=h,e[3]=0,e[4]=n,e[5]=d,e[6]=c,e[7]=0,e[8]=f,e[9]=a,e[10]=u,e[11]=0,e[12]=-(s*l+n*p+f*m),e[13]=-(o*l+d*p+a*m),e[14]=-(h*l+c*p+u*m),e[15]=1)}(this._viewMatrix,this._eye,this._target,this._upAxis),this.computeComposedMatrix()}computeComposedMatrix(){w(this._composedMatrix,this._projectionMatrix,this._viewMatrix)}setProjectionMatrix(e){C(this._projectionMatrix,e)}setViewMatrix(e){C(this._viewMatrix,e)}setComposedMatrix(e){C(this._composedMatrix,e)}getProjectionMatrix(){return this._projectionMatrix}getViewMatrix(){return this._viewMatrix}getComposedMatrix(){return this._composedMatrix}getPerspectiveData(){if(this._projectionType!==Z.perspective)throw new Error("not a perspective projection");return this._perspectiveData}getOrthogonalData(){if(this._projectionType!==Z.orthogonal)throw new Error("not an orthogonal projection");return this._orthogonalData}}const te="\n#version 300 es\n\nprecision highp float;\n\nuniform mat4 u_composedMatrix;\n\nin vec3  a_vertex_position;\n\nin vec3  a_offset_center;\nin float a_offset_scale;\nin vec3  a_offset_color;\n\nflat out vec3 v_color;\n// out vec3 v_worldSpacePosition;\n\nvoid main(void)\n{\n  vec3 position = a_offset_center + a_vertex_position * a_offset_scale;\n\n  gl_Position = u_composedMatrix * vec4(position, 1.0);\n\n  v_color = a_offset_color;\n  // v_worldSpacePosition = position;\n}\n".trim(),ie="\n#version 300 es\n\nprecision lowp float;\n\nflat in vec3 v_color;\n// in vec3 v_worldSpacePosition;\n// in vec3 v_worldSpaceNormal;\n\nout vec4 out_color;\n// layout(location = 0) out vec4 out_color;\n// layout(location = 1) out vec4 out_position;\n// layout(location = 2) out vec4 out_normal;\n\nvoid main(void)\n{\n  out_color = vec4(v_color, 1.0);\n  // out_position = vec4(v_worldSpacePosition, 1.0);\n  // out_normal = vec4(0.0);\n}\n\n".trim();class re{constructor(){this._buffer=new Float32Array(28672),this._currentSize=0,this._shader=new j({vertexSrc:te,fragmentSrc:ie,attributes:["a_vertex_position","a_offset_center","a_offset_scale","a_offset_color"],uniforms:["u_composedMatrix"]});const e={vbos:[{attrs:[{name:"a_vertex_position",type:X.AttributeType.vec3f,index:0}],stride:12,instanced:!1,dynamic:!1},{attrs:[{name:"a_offset_center",type:X.AttributeType.vec3f,index:0},{name:"a_offset_scale",type:X.AttributeType.float,index:3},{name:"a_offset_color",type:X.AttributeType.vec3f,index:4}],stride:28,instanced:!0,dynamic:!0}],primitiveType:X.PrimitiveType.lines},t=(e=>{const t=.5*e,i=[];i.push([+t,+t,+t]),i.push([-t,+t,+t]),i.push([+t,-t,+t]),i.push([-t,-t,+t]),i.push([+t,+t,-t]),i.push([-t,+t,-t]),i.push([+t,-t,-t]),i.push([-t,-t,-t]);const r=[];r.push(0,1,1,3,3,2,2,0),r.push(4,5,5,7,7,6,6,4),r.push(0,4,1,5,3,7,2,6);const s=[];for(let e=0;e<r.length;++e){const t=i[r[e]];s.push(t[0]),s.push(t[1]),s.push(t[2])}return s})(1);this._geometry=new X.Geometry(this._shader,e),this._geometry.updateBuffer(0,t,t.length),this._geometry.setPrimitiveCount(t.length/3),this._geometry.setFloatBufferSize(1,28672)}pushCenteredCube(e,t,i){this._currentSize+7>=this._buffer.length||(this._buffer[this._currentSize++]=e[0],this._buffer[this._currentSize++]=e[1],this._buffer[this._currentSize++]=e[2],this._buffer[this._currentSize++]=t,this._buffer[this._currentSize++]=i[0],this._buffer[this._currentSize++]=i[1],this._buffer[this._currentSize++]=i[2])}pushOriginBoundCube(e,t,i){if(this._currentSize+7>=this._buffer.length)return;const r=.5*t;this._buffer[this._currentSize++]=e[0]+r,this._buffer[this._currentSize++]=e[1]+r,this._buffer[this._currentSize++]=e[2]+r,this._buffer[this._currentSize++]=t,this._buffer[this._currentSize++]=i[0],this._buffer[this._currentSize++]=i[1],this._buffer[this._currentSize++]=i[2]}flush(e){this._currentSize<=0||(this._shader.bind(),this._shader.setMatrix4Uniform("u_composedMatrix",e.getComposedMatrix()),this._geometry.updateBuffer(1,this._buffer,this._currentSize),this._geometry.setInstancedCount(this._currentSize/7),this._geometry.render(),this.clear())}clear(){this._currentSize=0}}const se="\n#version 300 es\n\nprecision highp float;\n\nuniform mat4 u_composedMatrix;\nuniform vec3 u_sceneOrigin;\n\nin vec3 a_vertex_position;\nin vec3 a_vertex_normal;\n\nout vec3 v_worldSpacePosition;\nout vec3 v_worldSpaceNormal;\n\nvoid main(void)\n{\n  v_worldSpacePosition = a_vertex_position - u_sceneOrigin;\n  v_worldSpaceNormal = a_vertex_normal;\n\n  gl_Position = u_composedMatrix * vec4(v_worldSpacePosition, 1.0);\n}\n".trim(),ne="\n#version 300 es\n\nprecision lowp float;\n\nuniform sampler2D u_texture;\nuniform vec3 u_eyePosition;\n\nin vec3 v_worldSpacePosition;\nin vec3 v_worldSpaceNormal;\n\nout vec4 o_color;\n\nconst vec3 k_specColor = vec3(1.0, 1.0, 1.0);\n\nvoid main(void)\n{\n\n  vec3 currentColor = vec3(1);\n\n  { // texture\n\n    // current 3d texture coordinate\n    vec3 flooredPos = vec3(\n      v_worldSpacePosition.x - floor(v_worldSpacePosition.x),\n      v_worldSpacePosition.y - floor(v_worldSpacePosition.y),\n      v_worldSpacePosition.z - floor(v_worldSpacePosition.z)\n    );\n    flooredPos *= 0.5;\n\n    vec3 blendWeights = abs( normalize( v_worldSpaceNormal.xyz ) );\n    blendWeights = max( ( blendWeights - 0.2 ) * 7.0, 0.0 );\n    blendWeights /= ( blendWeights.x + blendWeights.y + blendWeights.z );\n\n    // horizontal texture coordinates -> should be a wall\n    vec2 texCoordX = vec2(flooredPos.y * 0.5 + 0.5, flooredPos.z * 0.5);\n    vec2 texCoordY = vec2(flooredPos.x * 0.5 + 0.5, flooredPos.z * 0.5);\n\n    // vertical texture coord -> should be green grass\n    vec2 texCoordZ = vec2(flooredPos.x * 0.5, flooredPos.y * 0.5 + 0.5);\n\n    if (v_worldSpaceNormal.z < 0.0)\n    {\n      // switch the texture Y -> dirt on the ceiling instead of grass\n      texCoordZ.y -= 0.5;\n    }\n\n    // horizontal color\n    vec3 texColorX = texture( u_texture, texCoordX ).rgb;\n    vec3 texColorY = texture( u_texture, texCoordY ).rgb;\n\n    // vertical color\n    vec3 texColorZ = texture( u_texture, texCoordZ ).rgb;\n\n    currentColor = texColorX * blendWeights.xxx +\n                    texColorY * blendWeights.yyy +\n                    texColorZ * blendWeights.zzz;\n\n  } // texture\n\n  { // lighting\n\n    vec3 normal = normalize(v_worldSpaceNormal);\n    vec3 lightDir = normalize(u_eyePosition - v_worldSpacePosition);\n\n    float diffuseCoef = max(dot(lightDir,v_worldSpaceNormal.xyz), 0.0);\n    float specularCoef = 0.0;\n\n    if (diffuseCoef > 0.0)\n    {\n      // specular\n\n      vec3 reflectDir = reflect(-lightDir, normal);\n      vec3 viewDir = normalize(u_eyePosition - v_worldSpacePosition);\n\n      float specAngle = max(dot(reflectDir, viewDir), 0.0);\n      specularCoef = pow(specAngle, 16.0);\n    }\n\n    vec3 ambiantColor = currentColor.xyz * 0.05;\n    vec3 diffuseColor = currentColor.xyz * diffuseCoef;\n    vec3 specularColor = k_specColor * specularCoef;\n\n    currentColor = ambiantColor + diffuseColor + specularColor;\n\n  } // lighting\n\n  o_color = vec4(currentColor, 1.0);\n\n}\n".trim();class fe{constructor(e,t,i){this._isVisible=!1,this._geometry=new X.Geometry(e,t),this._geometry.setFloatBufferSize(0,i)}update(e,t){this._geometry.updateBuffer(0,e,t),this._geometry.setPrimitiveCount(t/6)}render(){this._isVisible&&this._geometry.render()}setVisibility(e){this._isVisible=e}}class oe{constructor(){this._texture=new q,this._unusedGeometries=[],this._inUseGeometries=[],this._shader=new j({vertexSrc:se,fragmentSrc:ne,attributes:["a_vertex_position","a_vertex_normal"],uniforms:["u_composedMatrix","u_eyePosition","u_sceneOrigin","u_texture"]}),this._geometryDefinition={vbos:[{attrs:[{name:"a_vertex_position",type:X.AttributeType.vec3f,index:0},{name:"a_vertex_normal",type:X.AttributeType.vec3f,index:3}],stride:24,instanced:!1}],primitiveType:X.PrimitiveType.triangles}}initialize(){return e(this,void 0,void 0,(function*(){yield this._texture.load("assets/texture.png")}))}acquireGeometry(e){if(this._unusedGeometries.length>0){const e=this._unusedGeometries.pop();return this._inUseGeometries.push(e),e}const t=new fe(this._shader,this._geometryDefinition,e);return this._inUseGeometries.push(t),t}releaseGeometry(e){const t=this._inUseGeometries.indexOf(e);t<0||(this._unusedGeometries.push(e),this._inUseGeometries.splice(t,1))}render(e,t){const i=V.getContext();i.disable(i.BLEND),this._shader.bind(),this._shader.setInteger1Uniform("u_texture",0),this._shader.setMatrix4Uniform("u_composedMatrix",e.getComposedMatrix());const r=e.getEye();this._shader.setFloat3Uniform("u_eyePosition",r[0],r[1],r[2]),this._shader.setFloat3Uniform("u_sceneOrigin",t[0],t[1],t[2]),this._texture.bind(),this._inUseGeometries.forEach((e=>e.render()))}}const de="\n#version 300 es\n\nprecision highp float;\n\nuniform mat4 u_composedMatrix;\n\nin vec3 a_vertex_position;\nin vec4 a_vertex_color;\n\nflat out vec4 v_color;\n\nvoid main(void)\n{\n  gl_Position = u_composedMatrix * vec4(a_vertex_position, 1.0);\n\n  v_color = a_vertex_color;\n}\n".trim(),ae="\n#version 300 es\n\nprecision lowp float;\n\nflat in vec4 v_color;\n\nout vec4 o_color;\n\nvoid main(void)\n{\n  o_color = v_color;\n}\n\n".trim();class he{constructor(e,t){this._buffer=new Float32Array(14336),this._currentSize=0;const i=Object.assign(Object.assign({},t),{primitiveType:X.PrimitiveType.lines});this._geometry=new X.Geometry(e,i),this._geometry.setFloatBufferSize(0,14336)}pushLine(e,t,i){var r;if(this._currentSize+14>=this._buffer.length)return;const s=null!==(r=i[3])&&void 0!==r?r:1;this._buffer[this._currentSize+0]=e[0],this._buffer[this._currentSize+1]=e[1],this._buffer[this._currentSize+2]=e[2],this._buffer[this._currentSize+3]=i[0],this._buffer[this._currentSize+4]=i[1],this._buffer[this._currentSize+5]=i[2],this._buffer[this._currentSize+6]=s,this._currentSize+=7,this._buffer[this._currentSize+0]=t[0],this._buffer[this._currentSize+1]=t[1],this._buffer[this._currentSize+2]=t[2],this._buffer[this._currentSize+3]=i[0],this._buffer[this._currentSize+4]=i[1],this._buffer[this._currentSize+5]=i[2],this._buffer[this._currentSize+6]=s,this._currentSize+=7}canRender(){return this._currentSize>0}flush(){this.canRender()&&(this._geometry.updateBuffer(0,this._buffer,this._currentSize),this._geometry.setPrimitiveCount(this._currentSize/7),this._geometry.render(),this.clear())}clear(){this._currentSize=0}}class ce{constructor(e,t){this._buffer=new Float32Array(7168),this._currentSize=0;const i=Object.assign(Object.assign({},t),{primitiveType:X.PrimitiveType.triangles});this._geometry=new X.Geometry(e,i),this._geometry.setFloatBufferSize(0,7168)}pushLine(e,t,i,r){var s;if(this._currentSize+42>=this._buffer.length)return;const n=t[0]-e[0],f=t[1]-e[1],o=Math.atan2(f,n)+.5*Math.PI,d=Math.cos(o)*i*.5,a=Math.sin(o)*i*.5,h=null!==(s=r[3])&&void 0!==s?s:1;this._buffer[this._currentSize+0]=e[0]-d,this._buffer[this._currentSize+1]=e[1]-a,this._buffer[this._currentSize+2]=e[2],this._buffer[this._currentSize+3]=r[0],this._buffer[this._currentSize+4]=r[1],this._buffer[this._currentSize+5]=r[2],this._buffer[this._currentSize+6]=h,this._currentSize+=7,this._buffer[this._currentSize+0]=t[0]-d,this._buffer[this._currentSize+1]=t[1]-a,this._buffer[this._currentSize+2]=t[2],this._buffer[this._currentSize+3]=r[0],this._buffer[this._currentSize+4]=r[1],this._buffer[this._currentSize+5]=r[2],this._buffer[this._currentSize+6]=h,this._currentSize+=7,this._buffer[this._currentSize+0]=t[0]+d,this._buffer[this._currentSize+1]=t[1]+a,this._buffer[this._currentSize+2]=t[2],this._buffer[this._currentSize+3]=r[0],this._buffer[this._currentSize+4]=r[1],this._buffer[this._currentSize+5]=r[2],this._buffer[this._currentSize+6]=h,this._currentSize+=7,this._buffer[this._currentSize+0]=e[0]-d,this._buffer[this._currentSize+1]=e[1]-a,this._buffer[this._currentSize+2]=e[2],this._buffer[this._currentSize+3]=r[0],this._buffer[this._currentSize+4]=r[1],this._buffer[this._currentSize+5]=r[2],this._buffer[this._currentSize+6]=h,this._currentSize+=7,this._buffer[this._currentSize+0]=t[0]+d,this._buffer[this._currentSize+1]=t[1]+a,this._buffer[this._currentSize+2]=t[2],this._buffer[this._currentSize+3]=r[0],this._buffer[this._currentSize+4]=r[1],this._buffer[this._currentSize+5]=r[2],this._buffer[this._currentSize+6]=h,this._currentSize+=7,this._buffer[this._currentSize+0]=e[0]+d,this._buffer[this._currentSize+1]=e[1]+a,this._buffer[this._currentSize+2]=e[2],this._buffer[this._currentSize+3]=r[0],this._buffer[this._currentSize+4]=r[1],this._buffer[this._currentSize+5]=r[2],this._buffer[this._currentSize+6]=h,this._currentSize+=7}pushRotatedLine(e,t,i,r,s){this.pushLine([e[0]-i*Math.cos(t),e[1]-i*Math.sin(t),e[2]],[e[0]+i*Math.cos(t),e[1]+i*Math.sin(t),e[2]],r,s)}pushOriginBoundRectangle(e,t,i){var r;if(this._currentSize+42>=this._buffer.length)return;const s=[e[0]+t[0],e[1]+t[1]],n=null!==(r=i[3])&&void 0!==r?r:1;this._buffer[this._currentSize+0]=e[0],this._buffer[this._currentSize+1]=e[1],this._buffer[this._currentSize+2]=e[2],this._buffer[this._currentSize+3]=i[0],this._buffer[this._currentSize+4]=i[1],this._buffer[this._currentSize+5]=i[2],this._buffer[this._currentSize+6]=n,this._currentSize+=7,this._buffer[this._currentSize+0]=s[0],this._buffer[this._currentSize+1]=s[1],this._buffer[this._currentSize+2]=e[2],this._buffer[this._currentSize+3]=i[0],this._buffer[this._currentSize+4]=i[1],this._buffer[this._currentSize+5]=i[2],this._buffer[this._currentSize+6]=n,this._currentSize+=7,this._buffer[this._currentSize+0]=e[0],this._buffer[this._currentSize+1]=s[1],this._buffer[this._currentSize+2]=e[2],this._buffer[this._currentSize+3]=i[0],this._buffer[this._currentSize+4]=i[1],this._buffer[this._currentSize+5]=i[2],this._buffer[this._currentSize+6]=n,this._currentSize+=7,this._buffer[this._currentSize+0]=e[0],this._buffer[this._currentSize+1]=e[1],this._buffer[this._currentSize+2]=e[2],this._buffer[this._currentSize+3]=i[0],this._buffer[this._currentSize+4]=i[1],this._buffer[this._currentSize+5]=i[2],this._buffer[this._currentSize+6]=n,this._currentSize+=7,this._buffer[this._currentSize+0]=s[0],this._buffer[this._currentSize+1]=e[1],this._buffer[this._currentSize+2]=e[2],this._buffer[this._currentSize+3]=i[0],this._buffer[this._currentSize+4]=i[1],this._buffer[this._currentSize+5]=i[2],this._buffer[this._currentSize+6]=n,this._currentSize+=7,this._buffer[this._currentSize+0]=s[0],this._buffer[this._currentSize+1]=s[1],this._buffer[this._currentSize+2]=e[2],this._buffer[this._currentSize+3]=i[0],this._buffer[this._currentSize+4]=i[1],this._buffer[this._currentSize+5]=i[2],this._buffer[this._currentSize+6]=n,this._currentSize+=7}pushCenteredRectangle(e,t,i){const r=[e[0]-.5*t[0],e[1]-.5*t[1],e[2]];this.pushOriginBoundRectangle(r,t,i)}canRender(){return this._currentSize>0}flush(){this.canRender()&&(this._geometry.updateBuffer(0,this._buffer,this._currentSize),this._geometry.setPrimitiveCount(this._currentSize/7),this._geometry.render(),this.clear())}clear(){this._currentSize=0}}class ue{constructor(){this._shader=new j({vertexSrc:de,fragmentSrc:ae,attributes:["a_vertex_position","a_vertex_color"],uniforms:["u_composedMatrix"]});const e={vbos:[{attrs:[{name:"a_vertex_position",type:X.AttributeType.vec3f,index:0},{name:"a_vertex_color",type:X.AttributeType.vec4f,index:3}],stride:28,instanced:!1,dynamic:!0}],primitiveType:X.PrimitiveType.lines};this._wireFramesStackRenderer=new he(this._shader,e),this._trianglesStackRenderer=new ce(this._shader,e)}pushLine(e,t,i){this._wireFramesStackRenderer.pushLine(e,t,i)}pushCross(e,t,i){const r=[[e[0]-t,e[1],e[2]],[e[0]+t,e[1],e[2]],[e[0],e[1]-t,e[2]],[e[0],e[1]+t,e[2]],[e[0],e[1],e[2]-t],[e[0],e[1],e[2]+t]],s=[0,1,2,3,4,5];for(let e=0;e<s.length;e+=2){const t=r[e+0],s=r[e+1];this._wireFramesStackRenderer.pushLine(t,s,i)}}pushThickLine(e,t,i,r){this._trianglesStackRenderer.pushLine(e,t,i,r)}pushRotatedLine(e,t,i,r,s){this._trianglesStackRenderer.pushRotatedLine(e,t,i,r,s)}pushOriginBoundRectangle(e,t,i){this._trianglesStackRenderer.pushOriginBoundRectangle(e,t,i)}pushCenteredRectangle(e,t,i){this._trianglesStackRenderer.pushCenteredRectangle(e,t,i)}flush(e){(this._wireFramesStackRenderer.canRender()||this._trianglesStackRenderer.canRender())&&(this._shader.bind(),this._shader.setMatrix4Uniform("u_composedMatrix",e.getComposedMatrix()),this._wireFramesStackRenderer.flush(),this._trianglesStackRenderer.flush())}clear(){this._wireFramesStackRenderer.clear(),this._trianglesStackRenderer.clear()}}const _e="\n#version 300 es\n\nprecision highp float;\n\nuniform mat4 u_composedMatrix;\n\nin vec2 a_vertex_position;\nin vec2 a_vertex_texCoord;\nin vec3 a_offset_position;\nin vec2 a_offset_texCoord;\nin vec3 a_offset_color;\nin float a_offset_scale;\n\nout vec2 v_texCoord;\nflat out vec3 v_color;\n\nvoid main(void)\n{\n  vec3 position = vec3(a_vertex_position, 0.0) * a_offset_scale + a_offset_position;\n\n  gl_Position = u_composedMatrix * vec4(position, 1.0);\n\n  v_texCoord = a_vertex_texCoord + a_offset_texCoord;\n  v_color = a_offset_color;\n}\n".trim(),le="\n#version 300 es\n\nprecision mediump float;\n\nuniform sampler2D u_texture;\n\nin vec2 v_texCoord;\nflat in vec3 v_color;\n\nout vec4 o_color;\n\nvoid main(void)\n{\n  vec4 textureColor = texture(u_texture, v_texCoord);\n  if (textureColor.a < 0.5)\n  {\n    discard;\n  }\n  else\n  {\n    o_color = vec4(v_color, textureColor.a);\n  }\n}\n\n".trim(),pe="7e7e28fd03fd07fe04fe0aff02ff7e4dfd0cfd03fd07fe04fe0aff02ff1afc0dfd10fc08fc0ffe55ff15fb0bfd03fd07fe04fe08f707fd04ff07fe02fe0cfd0ffd0cfd0aff03fe03ff0afe44fe15fb0bfd03fd04f204f607fd03fe07fe02fe0cfd0efd0efd0aff02fe02ff0bfe43fd15fb0cfe03fe05f204fe01ff02ff0afd02fd07fe02fe0bfd0efd10fd0afa0cfe42fd16fb1bfe04fe07fe01ff02ff0efd09fc1cfd12fd09fa0cfe41fd17fb1bfe04fe07f70bfd0afc04ff17fd12fd06f405f616f61cfd19fd1cfe04fe08f709fd0bfb02fe17fd12fd06f405f616f61bfd1afd1cfe04fe0aff02ff01fe08fd0bfe02fa17fd12fd09fa0cfe3efd37f207ff02ff01fe07fd02fd07fe03fc19fd10fd0afa0cfe3dfd38f204f607fe03fd07fe03fd1bfd0efd0aff02fe02ff0bfe0cfd1dfd0dfd1dfd1cfe04fe07f708ff04fd07fe02fb1bfd0cfd0aff03fe03ff0afe0cfd1dfd0cfd1efd1cfe04fe0aff02ff1afb02fe1bfc08fc0ffe1cfd1dfd0bfd1ffd1cfe04fe0aff02ff7afd7e7e7e7e7e7e0efd17fd10fc0af80bfe0bf909f90dfd08f609fb08f506f808f82cfd19fd0df807fd04fd0afe0afd03fd07fd03fd0bfc08fd0ffd0bfd05fd05fd04fd06fd04fd2afd1bfd0bfc02fc06fd03fc09fd0afd04fd06fd04fd09fb08fd0efd0cfd05fd05fd04fd06fd04fd09fd0cfd0efd1dfd0afe05fd06fd02fb06fa11fd0dfd08fe01fd08fd0dfd0dfd05fd05fd04fd06fd04fd09fd0cfd0dfd0af409fd10fd06fd02fb06fa10fd0dfd08fe02fd08fd0dfd15fd05fb02fd06fd04fd09fd0cfd0cfd0bf40afd0efd07fd01fe01fd09fd0ffd0bfb08fe03fd08f808f70efd08fa08f626fd23fd0cfd08fd01fe01fd09fd0efd0cfb08f606f707f60cfd09fa09f726fd23fd0bfd09fb02fd09fd0dfd10fd07f60cfc06fd04fd0bfd08fd02fb0dfd09fd0cfd0cfd0bf40afd0cfd09fb02fd09fd0cfd12fd0bfd0ffd06fd04fd0afd09fd04fd0dfd09fd0cfd0dfd0af409fd19fc03fd09fd0bfd03fd06fd04fd0bfd08fd04fd06fd04fd09fd0afd04fd0cfd0afd0cfd0efd1dfd1afd04fd09fd0afd04fd06fd03fd0cfd08fd03fd07fd04fd09fd0afd04fd0bfd19fd10fd1bfd0ffd0af807f707f607f90bf907f909f80afd0bf809fb2efd19fd10fd7e51fd17fd11fd7e7e7e7e13f87e78fd05fd08fc09f709f907f808f606f608f907fd03fd07f90df905fc03fd06fb0bfd05fd05fd05fd08fb08fd05fd07fa09fd03fd07fd03fd07fd02fd08fd04fe07fd04fe07fd03fd06fd03fd09fd11fd08fd03fd07fd0cfc03fc05fd05fd07fd01fd07fd05fd06fd02fd08fd03fd06fd04fd07fd03fd07fd05ff07fd05ff06fd04fd06fd03fd09fd11fd08fd02fd08fd0cfb01fb05fc04fd06fd03fd06fd05fd05fd04fd07fd03fd06fd0efd03fd07fd0dfd0cfd04fd06fd03fd09fd11fd08fd01fd09fd0cf505fb03fd05fd05fd05fd02fa05fd04fd07fd03fd06fd0efd03fd07fd03fe08fd03fe07fd0dfd03fd09fd11fd08fa0afd0cf505fa02fd05fd05fd05fd02fa05fd04fd07f807fd0efd03fd07f808f807fd0df709fd11fd08fb0bfd0cfd01fd01fd05fd01fd01fd05fd05fd05fd02fa05fd04fd07f807fd0efd03fd07f808f807fd0df709fd11fd08fb0bfd0cfd02ff02fd05fd02fa05fd05fd05fd02fa05f607fd03fd06fd0efd03fd07fd03fe08fd03fe07fd02fb06fd03fd09fd0bfd03fd08fa0afd0cfd05fd05fd03fb05fd05fd05fd0dfd04fd07fd03fd06fd0efd03fd07fd0dfd0cfd04fd06fd03fd09fd0bfd03fd08fd01fd09fd05ff06fd05fd05fd04fc05fd05fd05fd0dfd04fd07fd03fd06fd04fd07fd03fd07fd05ff07fd0cfd04fd06fd03fd09fd0bfd03fd08fd02fd08fd04fe06fd05fd05fd05fd06fd03fd06fd0dfd04fd07fd03fd07fd03fd07fd02fd08fd04fe07fd0dfd03fd06fd03fd09fd0bfd03fd08fd03fd07fd03fd06fd05fd05fd05fd07fd01fd07fd0dfd04fd06f709f907f808f606fb0df806fd03fd07f90af908fc03fd06f606fd05fd05fd05fd08fb0af87e7e7e7e7e7e7e68fe1af70afb08f708f807f505fd03fd07fd03fd07fd05fd05fd03fd07fd03fd07f608f907ff11f90afc1afd03fd07fc01fc07fd03fd06fd04fd06fe02fd02fe05fd03fd07fd03fd07fd05fd05fd03fd07fd03fd07fd04fd08fd0bfe14fd09fa19fd03fd07fd03fd07fd03fd06fd04fd06ff03fd03ff05fd03fd07fd03fd07fd05fd05fd03fd07fd03fd07fe05fd08fd0bfd13fd08fd02fd18fd03fd06fd05fd06fd03fd06fd04fd0afd09fd03fd07fd03fd07fd05fd06fd01fd08fd03fd07ff05fd09fd0cfd12fd07fd04fd17fd03fd06fd05fd06fd03fd06fd11fd09fd03fd07fd03fd07fd05fd07fb09fd03fd0cfd0afd0dfd11fd28f807fd05fd06f808f90cfd09fd03fd07fd03fd07fd02ff02fd08fd0bfd01fd0cfd0bfd0efd10fd28f807fd05fd06f809f90bfd09fd03fd07fd03fd07fd02ff02fd08fd0cfb0cfd0cfd0ffd0ffd28fd0cfd03fb06fd02fd0efd0afd09fd03fd07fd03fd07fd02ff02fd07fb0cfd0cfd0dfd10fd0efd28fd0cfd02fa06fd03fd06fd04fd0afd09fd03fd07fd03fd08f707fd01fd0bfd0bfd05ff08fd11fd0dfd28fd0df707fd03fd06fd04fd0afd09fd03fd08fd01fd09fc01fc06fd03fd0afd0afd05fe08fd12fd0cfd28fd0df707fd03fd06fd04fd0afd09fd03fd09fb0bfd01fd07fd03fd0afd0afd04fd08fd13fd0bfd27fb12fd06fc03fd07f809f908f90bfd0cfd01fd07fd03fd08f908f608f910fd06f93cfa7e54f07e72f07e7e7e7e0bfd1dfc21fb19fb18fc10fd0ffd07fc0dfa39fd1efd22fd19fd01fd18fd10fd0ffd08fd10fd3bfd1cfd22fd19fd01fd18fd10fd0ffd08fd10fd3bfd1cfd22fd19fd1cfd2dfd10fd4af909f808f909f808f90afd0cfb02fe07fd01fc08fa0cfa08fd03fd0afd09f606f809f91efd08fd03fd06fd03fd07fd03fd07fd03fd07f808fd03fd08fc02fd0afd0ffd08fd02fd0bfd09fd02ff02fd05fd03fd07fd03fd1dfd08fd03fd06fd03fd07fd03fd07fd03fd07f808fd03fd08fc02fd0afd0ffd08fd01fd0cfd09fd02ff02fd05fd03fd07fd03fd18f808fd03fd06fd0dfd03fd07f709fd0bfd03fd08fd03fd0afd0ffd08fa0dfd09fd02ff02fd05fd03fd07fd03fd17fd03fd08fd03fd06fd0dfd03fd07fd0ffd0bfd03fd08fd03fd0afd0ffd08fd01fd0cfd09fd02ff02fd05fd03fd07fd03fd17fd03fd08fd03fd06fd03fd07fd03fd07fd03fd09fd0cf808fd03fd0afd0ffd08fd02fd0bfd09fd02ff02fd05fd03fd07fd03fd17fd03fd08fd03fd06fd03fd07fd03fd07fd03fd09fd0df908fd03fd0afd0ffd08fd03fd0afd09fd02ff02fd05fd03fd07fd03fd18fb02fe06fe02fb08f909fb02fe07f908f90ffd07fc03fd07f706fd03fd07fc03fd07f706fd05fd05fd03fd08f978fd03fd27fd03fd7e4af92afa7e7e7e7e7e7e18fa09fc09fa1efe4eff6efd0dfc0dfd1cfc4cfe6efd0dfc0dfd1bfa4afd6efd0dfc0dfd1afd02fd07fe02fb07fb02fe07fc02fd08f908f707fd03fd07fd03fd07fd05fd05fd02fd09fd03fd06f80afd0efc0efd08fb03fd05fd04fd07fd03fd05fd03fd09f706fd04fe09fd0bfd03fd07fd03fd07fd05fd05fd02fd09fd03fd06fe03fd08fd24fd05fd01fd02fd05fe06fe07fd03fd05fd03fd09fc02fd06fd04fe09fd0bfd03fd07fd03fd07fd05fd06fa0afd03fd06ff03fd09fd24fd05fd02fd01fd05fe06fe07fd03fd05fd03fd09fd0dfb0cfd0bfd03fd07fd03fd07fd02ff02fd07fc0bfd03fd09fd0cfd0efc0efd07fd03fb06fe06fe07fd03fd05fd03fd09fd0ffb0afd0bfd03fd07fd03fd07fd02ff02fd07fc0bfd03fd08fd0efd0dfc0dfd19fe06fe07fd03fd05fd03fd09fd0cfe04fd09fd01fd07fd03fd08fd01fd09fc01fc07fa0bf908fd03ff0bfd0dfc0dfd19fe06fe07f807f809fd0cfe04fd09fd01fd07fd03fd09fb0bfd01fd07fd02fd0bfb08fd03fe0bfd0dfc0dfd19f607fd11fd08fb0cf90bfb09fb02fe09fd0cfd01fd07fd02fd0dfd08f80cfa09fc09fa1af607fd11fd7cfd69fb0ffb77fa",me=[16,6],be=[1/me[0],1/me[1]];class ge{constructor(){this._texture=new q,this._buffer=new Float32Array(36864),this._currentSize=0,this._shader=new j({vertexSrc:_e,fragmentSrc:le,attributes:["a_vertex_position","a_vertex_texCoord","a_offset_position","a_offset_texCoord","a_offset_color","a_offset_scale"],uniforms:["u_composedMatrix","u_texture"]});const e={vbos:[{attrs:[{name:"a_vertex_position",type:X.AttributeType.vec2f,index:0},{name:"a_vertex_texCoord",type:X.AttributeType.vec2f,index:2}],stride:16,instanced:!1,dynamic:!1},{attrs:[{name:"a_offset_position",type:X.AttributeType.vec3f,index:0},{name:"a_offset_texCoord",type:X.AttributeType.vec2f,index:3},{name:"a_offset_color",type:X.AttributeType.vec3f,index:5},{name:"a_offset_scale",type:X.AttributeType.float,index:8}],stride:36,instanced:!0,dynamic:!0}],primitiveType:X.PrimitiveType.triangles};this._geometry=new X.Geometry(this._shader,e);const t=[{position:[.5,-.5],texCoord:[1*be[0],1*be[1]]},{position:[-.5,-.5],texCoord:[0*be[0],1*be[1]]},{position:[.5,.5],texCoord:[1*be[0],0*be[1]]},{position:[-.5,.5],texCoord:[0*be[0],0*be[1]]}],i=[1,0,2,1,2,3],r=[];for(const e of i){const i=t[e];r.push(i.position[0],i.position[1],i.texCoord[0],i.texCoord[1])}this._geometry.updateBuffer(0,r,r.length),this._geometry.setPrimitiveCount(r.length/4),this._geometry.setFloatBufferSize(1,36864),this._texCoordMap=new Map([[" ",[0*be[0],0*be[1]]],["!",[1*be[0],0*be[1]]],['"',[2*be[0],0*be[1]]],["#",[3*be[0],0*be[1]]],["$",[4*be[0],0*be[1]]],["%",[5*be[0],0*be[1]]],["&",[6*be[0],0*be[1]]],["'",[7*be[0],0*be[1]]],["(",[8*be[0],0*be[1]]],[")",[9*be[0],0*be[1]]],["*",[10*be[0],0*be[1]]],["+",[11*be[0],0*be[1]]],[",",[12*be[0],0*be[1]]],["-",[13*be[0],0*be[1]]],[".",[14*be[0],0*be[1]]],["/",[15*be[0],0*be[1]]],["0",[0*be[0],1*be[1]]],["1",[1*be[0],1*be[1]]],["2",[2*be[0],1*be[1]]],["3",[3*be[0],1*be[1]]],["4",[4*be[0],1*be[1]]],["5",[5*be[0],1*be[1]]],["6",[6*be[0],1*be[1]]],["7",[7*be[0],1*be[1]]],["8",[8*be[0],1*be[1]]],["9",[9*be[0],1*be[1]]],[":",[10*be[0],1*be[1]]],[";",[11*be[0],1*be[1]]],["<",[12*be[0],1*be[1]]],["=",[13*be[0],1*be[1]]],[">",[14*be[0],1*be[1]]],["?",[15*be[0],1*be[1]]],["@",[0*be[0],2*be[1]]],["A",[1*be[0],2*be[1]]],["B",[2*be[0],2*be[1]]],["C",[3*be[0],2*be[1]]],["D",[4*be[0],2*be[1]]],["E",[5*be[0],2*be[1]]],["F",[6*be[0],2*be[1]]],["G",[7*be[0],2*be[1]]],["H",[8*be[0],2*be[1]]],["I",[9*be[0],2*be[1]]],["J",[10*be[0],2*be[1]]],["K",[11*be[0],2*be[1]]],["L",[12*be[0],2*be[1]]],["M",[13*be[0],2*be[1]]],["N",[14*be[0],2*be[1]]],["O",[15*be[0],2*be[1]]],["P",[0*be[0],3*be[1]]],["Q",[1*be[0],3*be[1]]],["R",[2*be[0],3*be[1]]],["S",[3*be[0],3*be[1]]],["T",[4*be[0],3*be[1]]],["U",[5*be[0],3*be[1]]],["V",[6*be[0],3*be[1]]],["W",[7*be[0],3*be[1]]],["X",[8*be[0],3*be[1]]],["Y",[9*be[0],3*be[1]]],["Z",[10*be[0],3*be[1]]],["[",[11*be[0],3*be[1]]],["\\",[12*be[0],3*be[1]]],["]",[13*be[0],3*be[1]]],["^",[14*be[0],3*be[1]]],["_",[15*be[0],3*be[1]]],["`",[0*be[0],4*be[1]]],["a",[1*be[0],4*be[1]]],["b",[2*be[0],4*be[1]]],["c",[3*be[0],4*be[1]]],["d",[4*be[0],4*be[1]]],["e",[5*be[0],4*be[1]]],["f",[6*be[0],4*be[1]]],["g",[7*be[0],4*be[1]]],["h",[8*be[0],4*be[1]]],["i",[9*be[0],4*be[1]]],["j",[10*be[0],4*be[1]]],["k",[11*be[0],4*be[1]]],["l",[12*be[0],4*be[1]]],["m",[13*be[0],4*be[1]]],["n",[14*be[0],4*be[1]]],["o",[15*be[0],4*be[1]]],["p",[0*be[0],5*be[1]]],["q",[1*be[0],5*be[1]]],["r",[2*be[0],5*be[1]]],["s",[3*be[0],5*be[1]]],["t",[4*be[0],5*be[1]]],["u",[5*be[0],5*be[1]]],["v",[6*be[0],5*be[1]]],["w",[7*be[0],5*be[1]]],["x",[8*be[0],5*be[1]]],["y",[9*be[0],5*be[1]]],["z",[10*be[0],5*be[1]]],["{",[11*be[0],5*be[1]]],["|",[12*be[0],5*be[1]]],["}",[13*be[0],5*be[1]]],["~",[14*be[0],5*be[1]]]]);const s=new Uint8Array(98304);{let e=0;for(let t=0;t<pe.length;t+=2){let i=parseInt(`${pe.substring(t,t+2)}000000`,16)>>24,r=0;i<0&&(i=-i,r=255);for(let t=0;t<i;++t)s[4*e+0]=r,s[4*e+1]=r,s[4*e+2]=r,s[4*e+3]=r,++e}}this._texture.loadFromMemory(256,96,s,!0)}pushText(e,t,i){const r=[t[0],t[1]];for(let s=0;s<e.length;++s){const n=e[s];"\n"!=n?(this._pushLetter(n,r,i),r[0]+=i):(r[0]=t[0],r[1]-=i)}}pushCenteredText(e,t,i){const r=[0];for(let t=0;t<e.length;++t)"\n"==e[t]?r.push(0):r[r.length-1]+=1;let s=0;const n=[0,0];n[0]=t[0]-r[s]*i*.5+.5*i,n[1]=t[1]+r.length*i*.5-.5*i;for(let f=0;f<e.length;++f){const o=e[f];"\n"==o?(s+=1,n[0]=t[0]-r[s]*i*.5+.5*i,n[1]-=i):(this._pushLetter(o,n,i),n[0]+=i)}}pushRightAlignedText(e,t,i){const r=[0];for(let t=0;t<e.length;++t)"\n"==e[t]?r.push(0):r[r.length-1]+=1;let s=0;const n=[0,0];n[0]=t[0]-r[s]*i+i,n[1]=t[1];for(let f=0;f<e.length;++f){const o=e[f];"\n"==o?(s+=1,n[0]=t[0]-r[s]*i+i,n[1]-=i):(this._pushLetter(o,n,i),n[0]+=i)}}_pushLetter(e,t,i){if(this._currentSize+90>=this._buffer.length)return;const r=this._texCoordMap.get(e);if(!r)throw new Error(`fail to find a letter, letter=${e}`);const s=[1,1,1],n=[0,0,0];for(let e=-1;e<=1;++e)for(let s=-1;s<=1;++s)this._buffer[this._currentSize++]=t[0]+2*s,this._buffer[this._currentSize++]=t[1]+2*e,this._buffer[this._currentSize++]=-.1,this._buffer[this._currentSize++]=r[0],this._buffer[this._currentSize++]=r[1],this._buffer[this._currentSize++]=n[0],this._buffer[this._currentSize++]=n[1],this._buffer[this._currentSize++]=n[2],this._buffer[this._currentSize++]=i;this._buffer[this._currentSize++]=t[0],this._buffer[this._currentSize++]=t[1],this._buffer[this._currentSize++]=0,this._buffer[this._currentSize++]=r[0],this._buffer[this._currentSize++]=r[1],this._buffer[this._currentSize++]=s[0],this._buffer[this._currentSize++]=s[1],this._buffer[this._currentSize++]=s[2],this._buffer[this._currentSize++]=i}flush(e){0!==this._currentSize&&(this._shader.bind(),this._shader.setMatrix4Uniform("u_composedMatrix",e),this._texture.bind(),this._geometry.updateBuffer(1,this._buffer,this._currentSize),this._geometry.setInstancedCount(this._currentSize/9),this._geometry.render(),q.unbind(),this.clear())}clear(){this._currentSize=0}}const ve=new Map;class Se{constructor(e){this._viewportSize=H(),this._mainCamera=new ee,this._mainHudCamera=new ee,this._miniMapHudCamera=new ee,this.onContextLost=null,this.onContextRestored=null,this._fpsMeterAngle=0,this._fpsMeterSpeed=0,this._def=e,this.resize(this._def.canvasDomElement.width,this._def.canvasDomElement.height),V.initialize(this._def.canvasDomElement),this._def.canvasDomElement.addEventListener("webglcontextlost",(e=>{e.preventDefault(),console.log("context is lost"),this.onContextLost&&this.onContextLost()}),!1),this._def.canvasDomElement.addEventListener("webglcontextrestored",(()=>{console.log("context is restored"),V.initialize(this._def.canvasDomElement),this.onContextRestored&&this.onContextRestored()}),!1),this._freeFlyController=new K({position:T(0,0,0),coordinates:["X","Y","Z"],theta:0,phi:0,mouseSensibility:this._def.mouseSensibility,keyboardSensibility:this._def.keyboardSensibility,touchSensibility:this._def.touchSensibility,movingSpeed:this._def.movingSpeed}),this._frustumCulling=new J,this._offsetSceneOrigin=T(0,0,0),this._common={wireFrameCubesRenderer:new re},this._scene={chunksRenderer:new oe},this._hud={textRenderer:new ge,stackRenderers:new ue}}resize(e,t){this._viewportSize[0]=e,this._viewportSize[1]=t,this._mainCamera.setViewportSize(this._viewportSize[0],this._viewportSize[1]),this._mainCamera.setAsPerspective({fovy:70,near:.1,far:55}),this._mainHudCamera.setViewportSize(this._viewportSize[0],this._viewportSize[1]),this._mainHudCamera.setAsOrthogonal({left:.5*-this._viewportSize[0],right:.5*+this._viewportSize[0],top:.5*-this._viewportSize[1],bottom:.5*+this._viewportSize[1],near:-200,far:200}),this._mainHudCamera.setEye([.5*+this._viewportSize[0],.5*+this._viewportSize[1],1]),this._mainHudCamera.setTarget([.5*+this._viewportSize[0],.5*+this._viewportSize[1],0]),this._mainHudCamera.setUpAxis([0,1,0]),this._mainHudCamera.computeMatrices();const i=.75*this._viewportSize[0];this._miniMapHudCamera.setViewportPos(i,0),this._miniMapHudCamera.setViewportSize(.25*this._viewportSize[0],.33*this._viewportSize[1]);const r=this._miniMapHudCamera.getViewportSize(),s=85*(r[0]/r[1]);this._miniMapHudCamera.setAsOrthogonal({left:-s,right:+s,top:-85,bottom:85,near:-200,far:200}),this._miniMapHudCamera.setUpAxis([0,0,1])}toggleContextLoss(){const e=V.getContext(),t=V.getExtensionLoseContext();t&&(e.isContextLost()?t.restoreContext():t.loseContext())}contextIsLost(){return V.getContext().isContextLost()}setOnContextLost(e){this.onContextLost=e}setOnContextRestored(e){this.onContextRestored=e}init(){return e(this,void 0,void 0,(function*(){const e=V.getContext();e.clearColor(0,0,0,1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LESS),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_COLOR),e.disable(e.CULL_FACE),e.activeTexture(e.TEXTURE0),e.enable(e.CULL_FACE),yield this._scene.chunksRenderer.initialize()}))}getSize(){return this._viewportSize}update(e){this._freeFlyController.update(e),h.resetDelta(),g.resetDeltas(),this._mainCamera.setEye(this._freeFlyController.getPosition()),this._mainCamera.setTarget(this._freeFlyController.getTarget()),this._mainCamera.setUpAxis(this._freeFlyController.getUpAxis()),this._mainCamera.computeMatrices(),this._frustumCulling.calculateFrustum(this._mainCamera.getProjectionMatrix(),this._mainCamera.getViewMatrix());const t=this._freeFlyController.getPosition();this._offsetSceneOrigin=T(Math.floor(t[0]/this._def.chunkSize)*this._def.chunkSize,Math.floor(t[1]/this._def.chunkSize)*this._def.chunkSize,Math.floor(t[2]/this._def.chunkSize)*this._def.chunkSize)}renderScene(){const e=V.getContext(),t=this._mainCamera.getViewportPos(),i=this._mainCamera.getViewportSize();e.viewport(t[0],t[1],i[0],i[1]),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),this._mainCamera.subOffset(this._offsetSceneOrigin),this._mainCamera.computeMatrices(),this._scene.chunksRenderer.render(this._mainCamera,this._offsetSceneOrigin),this._mainCamera.addOffset(this._offsetSceneOrigin),this._mainCamera.computeMatrices(),this._common.wireFrameCubesRenderer.flush(this._mainCamera)}renderHUD(e,t){const i=V.getContext();i.clear(i.DEPTH_BUFFER_BIT),this._renderMainHud(e,t),this._renderMiniMapHud(e,t),j.unbind()}_renderMainHud(e,t){const i=V.getContext();i.clear(i.DEPTH_BUFFER_BIT);const r=this._mainHudCamera.getViewportPos(),s=this._mainHudCamera.getViewportSize();i.viewport(r[0],r[1],s[0],s[1]),i.clear(i.DEPTH_BUFFER_BIT);const n=W(100,50),f=W(10,this._viewportSize[1]-10-n[1]);{t.length>0?(this._fpsMeterSpeed+=5e-4,this._fpsMeterSpeed>.02&&(this._fpsMeterSpeed=.02)):(this._fpsMeterSpeed-=5e-4,this._fpsMeterSpeed<0&&(this._fpsMeterSpeed=0)),this._fpsMeterAngle+=this._fpsMeterSpeed;const e=[f[0]+n[0]+.6*n[1],f[1]+.5*n[1],0],i=[f[0]+n[0]+1.3*n[1],f[1]+.5*n[1],0],r=[{position:e,angle:this._fpsMeterAngle},{position:e,angle:this._fpsMeterAngle+.5*Math.PI},{position:i,angle:-this._fpsMeterAngle+.25*Math.PI},{position:i,angle:-this._fpsMeterAngle+.75*Math.PI}],s=.45*n[1],o=10,d=[1,1,1];r.forEach((e=>{this._hud.stackRenderers.pushRotatedLine(e.position,e.angle,s,o,d)}))}((e,t,i)=>{const r=g.getTouchData();if(0===r.length)ve.clear();else{const s=new Set,n=[1,0,0],f=[0,1,0],o=r.length>1?n:f;r.forEach((r=>{s.add(r.id);let n=ve.get(r.id);void 0===n&&(n=0,ve.set(r.id,n));const f=[0,.5];i.getTouchMoveForward()&&f.push(.25,.75);for(const i of f){const s=n+i*Math.PI,f=[r.positionX,e[1]-r.positionY,0];t.pushRotatedLine(f,s,150,15,o)}n+=.1,ve.set(r.id,n)}));const d=new Set;ve.forEach(((e,t)=>{s.has(t)||d.add(t)})),d.forEach((e=>{ve.delete(e)}))}})(this._viewportSize,this._hud.stackRenderers,this._freeFlyController),i.clear(i.DEPTH_BUFFER_BIT),i.enable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_DST_ALPHA),this._hud.stackRenderers.flush(this._mainHudCamera),this._hud.textRenderer.flush(this._mainHudCamera.getComposedMatrix()),i.disable(i.BLEND)}_renderMiniMapHud(e,t){const i=V.getContext(),r=this._freeFlyController.getPosition(),s=T(1,1.2,1),n=E();R(n,r,s),this._miniMapHudCamera.setEye(n),this._miniMapHudCamera.setTarget(r),this._miniMapHudCamera.computeMatrices();const f=this._miniMapHudCamera.getViewportPos(),o=this._miniMapHudCamera.getViewportSize();i.viewport(f[0],f[1],o[0],o[1]);{const e=20;this._hud.stackRenderers.pushLine([0,0,0],[0+e,0,0],[1,0,0]),this._hud.stackRenderers.pushLine([0,0,0],[0,0+e,0],[0,1,0]),this._hud.stackRenderers.pushLine([0,0,0],[0,0,0+e],[0,0,1]),this._hud.stackRenderers.flush(this._miniMapHudCamera)}this._common.wireFrameCubesRenderer.clear();const d=.5*this._def.chunkSize;for(const t of e)if(t.isVisible)this._common.wireFrameCubesRenderer.pushOriginBoundCube(t.realPosition,this._def.chunkSize,[1,1,1]);else{const e=[t.realPosition[0]+d,t.realPosition[1]+d,t.realPosition[2]+d];this._hud.stackRenderers.pushCross(e,.25*this._def.chunkSize,[1,0,0])}if(t.length>0)for(const e of t){const t=[e[0]+d,e[1]+d,e[2]+d];this._common.wireFrameCubesRenderer.pushCenteredCube(t,1.2*this._def.chunkSize,[0,1,0])}this._common.wireFrameCubesRenderer.flush(this._miniMapHudCamera),this._hud.stackRenderers.flush(this._miniMapHudCamera);const a=C(x(),this._miniMapHudCamera.getViewMatrix());!function(e,t,i){var r,s,n,f,o,d,a,h,c,u,_,l,p=i[0],m=i[1],b=i[2];t===e?(e[12]=t[0]*p+t[4]*m+t[8]*b+t[12],e[13]=t[1]*p+t[5]*m+t[9]*b+t[13],e[14]=t[2]*p+t[6]*m+t[10]*b+t[14],e[15]=t[3]*p+t[7]*m+t[11]*b+t[15]):(r=t[0],s=t[1],n=t[2],f=t[3],o=t[4],d=t[5],a=t[6],h=t[7],c=t[8],u=t[9],_=t[10],l=t[11],e[0]=r,e[1]=s,e[2]=n,e[3]=f,e[4]=o,e[5]=d,e[6]=a,e[7]=h,e[8]=c,e[9]=u,e[10]=_,e[11]=l,e[12]=r*p+o*m+c*b+t[12],e[13]=s*p+d*m+u*b+t[13],e[14]=n*p+a*m+_*b+t[14],e[15]=f*p+h*m+l*b+t[15])}(a,a,this._freeFlyController.getPosition()),y(a,a,this._freeFlyController.getTheta(),[0,0,1]),y(a,a,this._freeFlyController.getPhi(),[0,-1,0]),this._miniMapHudCamera.setViewMatrix(a),this._miniMapHudCamera.computeComposedMatrix();{const e=5,t=[[0-e,0,0],[0+100*e,0,0],[0,0-e,0],[0,0+e,0],[0,0,0-e],[0,0,0+e]],i=[0,1,2,3,4,5];for(let e=0;e<i.length;e+=2){const i=t[e+0],r=t[e+1];this._hud.stackRenderers.pushLine(i,r,[1,1,1])}const r=this._mainCamera.getPerspectiveData(),s=[1,1,0],n=((e,t,i,r)=>{const s=Math.tan(e/360*Math.PI)*i,n=s*t,f=-n,o=+n,d=+s,a=-s,h=r*Math.sin(e*Math.PI/180),c=h*t,u=[];u.push([i,f,d]),u.push([i,o,d]),u.push([i,f,a]),u.push([i,o,a]),u.push([r,-c,+h]),u.push([r,+c,+h]),u.push([r,-c,-h]),u.push([r,+c,-h]);const _=[];_.push(0,1,1,3,3,2,2,0),_.push(0,4,1,5,2,6,3,7),_.push(4,5,5,7,7,6,6,4);const l=[];for(let e=0;e<_.length;++e)l.push(u[_[e]]);return l})(r.fovy,r.aspectRatio,r.near,r.far);for(let e=0;e<n.length;e+=2){const t=n[e+0],i=n[e+1];this._hud.stackRenderers.pushLine(t,i,s)}this._hud.stackRenderers.flush(this._miniMapHudCamera)}}get freeFlyController(){return this._freeFlyController}get wireFrameCubesRenderer(){return this._common.wireFrameCubesRenderer}get stackRenderers(){return this._hud.stackRenderers}get textRenderer(){return this._hud.textRenderer}get frustumCulling(){return this._frustumCulling}get chunksRenderer(){return this._scene.chunksRenderer}}class xe{constructor(e){this._chunksCreated=0,this._chunksDiscarded=0,this._currFrameTime=0,this._framesDuration=[],this._canvasElement=e,this._renderer=new Se({canvasDomElement:e,chunkSize:t,mouseSensibility:.1,movingSpeed:16,keyboardSensibility:i,touchSensibility:.3});const s=T(11.25,11.25,0);this._renderer.freeFlyController.setPosition(s),this._chunkGenerator=new Y({chunkSize:t,chunkRange:3,workerTotal:2,workerFile:"./dist/worker.js",workerBufferSize:r,chunkIsVisible:e=>{const t=7.5;return this._renderer.frustumCulling.cubeInFrustum(e[0]+t,e[1]+t,e[2]+t,t)},acquireGeometry:()=>this._renderer.chunksRenderer.acquireGeometry(r),releaseGeometry:e=>{this._renderer.chunksRenderer.releaseGeometry(e)},onChunkCreated:()=>{++this._chunksCreated},onChunkDiscarded:()=>{++this._chunksDiscarded}}),d.activate(),g.activate(),m.allowPointerLockedOnClickEvent(e),m.addOnLockChange((()=>{m.isPointerLocked(e)?h.activate():(h.deactivate(),m.allowPointerLockedOnClickEvent(e))})),m.addOnLockError((e=>{}));const n=document.getElementById("gui_fullscreen");if(!n)throw new Error("guiFullscreen not found");n.addEventListener("click",(()=>{f.requestFullScreen(e)})),f.addOnFullScreenChange((()=>{let t=800,i=600;f.isFullScreen(e)?(e.style.position="absolute",t=window.innerWidth,i=window.innerHeight):e.style.position="relative",e.style.left="0px",e.style.top="0px",e.width=t,e.height=i,this._renderer.resize(t,i)})),this._running=!1,this._errorGraphicContext=!1,this._renderer.setOnContextLost((()=>{console.log("on_context_lost"),this._errorGraphicContext=!0,this.stop()})),this._renderer.setOnContextRestored((()=>{console.log("on_context_restored"),this._errorGraphicContext=!1,this.start()}))}init(){return e(this,void 0,void 0,(function*(){yield this._renderer.init()}))}start(){this.isRunning()||(this._running=!0,this._chunkGenerator.start(),this._tick())}stop(){this._running=!1,this._chunkGenerator.stop()}isRunning(){return this._running&&!this._errorGraphicContext}_tick(){const e=()=>{this._running&&!this._errorGraphicContext&&(window.requestAnimationFrame(e),this._mainLoop())};e()}_mainLoop(){const e=Date.now(),i=Math.min(e-this._currFrameTime,30);this._currFrameTime=e,this._framesDuration.push(i),this._renderer.update(i/1e3);const r=this._renderer.freeFlyController.getPosition();this._chunkGenerator.update(r);let s=0;this._renderer.wireFrameCubesRenderer.clear(),this._chunkGenerator.getChunks().forEach((e=>{e.isVisible&&(++s,this._renderer.wireFrameCubesRenderer.pushOriginBoundCube(e.realPosition,t,[1,1,1]))})),this._renderer.renderScene(),this._renderer.stackRenderers.clear(),this._renderer.textRenderer.clear();{const e=[this._canvasElement.width-10,this._canvasElement.height-10],t=[`Chunks\nGenerated:\n${this._chunksCreated} <`,"",`Chunks\nDiscarded:\n${this._chunksDiscarded} <`,"",`Live\nChunks:\n${this._chunksCreated-this._chunksDiscarded} <`,"",`Visible\nChunks:\n${s} <`].join("\n");this._renderer.textRenderer.pushRightAlignedText(t,e,14)}{const e=[Math.floor(r[0]/t),Math.floor(r[1]/t),Math.floor(r[2]/t)],i=["Coordinates:",`X: ${e[0]}`,`Y: ${e[1]}`,`Z: ${e[2]}`],s=[14,this._canvasElement.height-100];this._renderer.textRenderer.pushText(i.join("\n"),s,14)}((e,t,i)=>{const r=[],s=[.2,.2,.2],n=[.2,.6,.2],f=[30,30],o=[30,130];r.push({center:[f[0],f[1]],size:[40,40],text:"A\nQ",color:d.isPressed("A","Q")?n:s}),r.push({center:[f[0]+45,f[1]],size:[40,40],text:"S",color:d.isPressed("S")?n:s}),r.push({center:[f[0]+45,f[1]+45],size:[40,40],text:"W\nZ",color:d.isPressed("W","Z")?n:s}),r.push({center:[f[0]+90,f[1]],size:[40,40],text:"D",color:d.isPressed("D")?n:s}),r.push({center:[o[0],o[1]],size:[40,40],lines:[{a:[15,0],b:[-8,0],thickness:6,color:[1,1,1]},{a:[0,10],b:[-12,-2],thickness:6,color:[1,1,1]},{a:[0,-10],b:[-12,2],thickness:6,color:[1,1,1]}],color:d.isPressed("ArrowLeft")?n:s}),r.push({center:[o[0]+45,o[1]],size:[40,40],lines:[{a:[0,15],b:[0,-8],thickness:6,color:[1,1,1]},{a:[10,0],b:[-2,-12],thickness:6,color:[1,1,1]},{a:[-10,0],b:[2,-12],thickness:6,color:[1,1,1]}],color:d.isPressed("ArrowDown")?n:s}),r.push({center:[o[0]+45,o[1]+45],size:[40,40],lines:[{a:[0,-15],b:[0,8],thickness:6,color:[1,1,1]},{a:[10,0],b:[-2,12],thickness:6,color:[1,1,1]},{a:[-10,0],b:[2,12],thickness:6,color:[1,1,1]}],color:d.isPressed("ArrowUp")?n:s}),r.push({center:[o[0]+90,o[1]],size:[40,40],lines:[{a:[-15,0],b:[8,0],thickness:6,color:[1,1,1]},{a:[0,10],b:[12,-2],thickness:6,color:[1,1,1]},{a:[0,-10],b:[12,2],thickness:6,color:[1,1,1]}],color:d.isPressed("ArrowRight")?n:s}),g.isSupported()?r.push({center:[260,35],size:[230,60],text:"Touch Events\nSupported\n(double tap)",color:[0,.5,0]}):r.push({center:[260,35],size:[230,60],text:"Touch Events\nNot Supported",color:[.5,0,0]}),m.canBePointerLocked(e)?r.push({center:[490,35],size:[210,60],text:"Mouse\nSupported",color:[0,.5,0]}):r.push({center:[490,35],size:[210,60],text:"Mouse Events\nNot Supported",color:[.5,0,0]}),r.forEach((e=>{const{center:r}=e;t.pushCenteredRectangle(T(r[0],r[1],-.3),e.size,[0,0,0]),t.pushCenteredRectangle(T(r[0],r[1],-.2),[e.size[0]-2,e.size[1]-2],e.color),e.text&&i.pushCenteredText(e.text,r,16),e.lines&&e.lines.forEach((e=>{t.pushThickLine([r[0]+e.a[0],r[1]+e.a[1],0],[r[0]+e.b[0],r[1]+e.b[1],0],e.thickness,e.color)}))}))})(this._canvasElement,this._renderer.stackRenderers,this._renderer.textRenderer),((e,t,i,r,s)=>{let n=0;for(let e=0;e<i.length;++e)n=Math.max(n,i[e]);const f=5*Math.ceil(n/5);{r.pushOriginBoundRectangle(e,t,[0,0,0,.5]);const i=[[e[0]+0*t[0],e[1]+0*t[1],0],[e[0]+1*t[0],e[1]+0*t[1],0],[e[0]+1*t[0],e[1]+1*t[1],0],[e[0]+0*t[0],e[1]+1*t[1],0]];r.pushLine(i[0],i[1],[1,1,1]),r.pushLine(i[1],i[2],[1,1,1]),r.pushLine(i[2],i[3],[1,1,1]),r.pushLine(i[3],i[0],[1,1,1])}for(let i=5;i<f;i+=5){const s=i/f,n=[e[0]+0,e[1]+t[1]*s,0],o=[e[0]+t[0],e[1]+t[1]*s,0];r.pushLine(n,o,[.5,.5,.5])}if(i.length>=2){const s=t[0]/i.length;let n=i[0],o=0,d=t[1]*n/f;for(let a=1;a<i.length;++a){const h=i[a],c=a*s,u=t[1]*h/f,_=[e[0]+o,e[1]+d,0],l=[e[0]+c,e[1]+u,0];r.pushLine(_,l,[1,1,1]),n=h,o=c,d=u}}{let t=0;for(const e of i)t+=e;t/=i.length;const r=1e3/t;let n=">999";r<999&&(n=`~${r.toFixed(0)}`.padStart(4," ")),s.pushText(`${n}fps`,[e[0]+7,e[1]-8],14)}})([10,this._canvasElement.height-60,0],[100,50],this._framesDuration,this._renderer.stackRenderers,this._renderer.textRenderer),this._renderer.renderHUD(this._chunkGenerator.getChunks(),this._chunkGenerator.getProcessingRealPositions()),this._framesDuration.length>100&&this._framesDuration.splice(0,this._framesDuration.length-100)}}window.onerror=(...e)=>{alert(JSON.stringify(e))};e(void 0,void 0,void 0,(function*(){const e=document.querySelector("#main-canvas");if(!e)throw new Error("main-canvas not found");const t=new xe(e);yield t.init(),t.start();{const e=document.getElementById("touch_id");e&&(g.isSupported()?e.innerHTML+="Supported":e.innerHTML+="Not Supported")}{const e=document.getElementById("gui_toggle_start");if(!e)throw new Error("gui_toggle_start not found");e.addEventListener("click",(()=>{console.log("toggle_start"),t.isRunning()?t.stop():t.start()}))}}));
