"use strict";function e(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))}function t(e,t){var r,n,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(a){return function(u){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;o&&(o=0,a[0]&&(s=0)),s;)try{if(r=1,n&&(i=2&a[0]?n.return:a[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,a[1])).done)return i;switch(n=0,i&&(a=[2&a[0],i.value]),a[0]){case 0:case 1:i=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!i||a[1]>i[0]&&a[1]<i[3])){s.label=a[1];break}if(6===a[0]&&s.label<i[1]){s.label=i[1],i=a;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(a);break}i[2]&&s.ops.pop(),s.trys.pop();continue}a=t.call(e,s)}catch(e){a=[6,e],n=0}finally{r=i=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}}var r,n=15,i=3,o=16,s=.2,a=80,u="./dist/worker.js",h=2,_=5e5;!function(e){e[e.available=1]="available",e[e.working=2]="working"}(r||(r={}));var c,f=function(){function e(e){this._running=!1,this._chunks=[],this._chunkPositionQueue=[],this._geometriesPool=[],this._savedIndex=[999,999,999],this._workers=[],this._cameraPosition=[0,0,0],this._processingPositions=[],this._def=e;for(var t=0;t<this._def.workerTotal;++t)this._addWorker()}return e.prototype._addWorker=function(){var e=this,t={instance:new Worker(this._def.workerFile),float32buffer:new Float32Array(this._def.workerBufferSize),status:r.available};t.instance.addEventListener("message",(function(n){var i=n.data.position;t.float32buffer=n.data.float32buffer,t.status=r.available;for(var o=0;o<e._processingPositions.length;++o)if(e._processingPositions[o][0]===i[0]&&e._processingPositions[o][1]===i[1]&&e._processingPositions[o][2]===i[2]){e._processingPositions.splice(o,1);break}if(e._running){var s=void 0;0==e._geometriesPool.length?s=e._def.addGeometry(t.float32buffer):(s=e._geometriesPool.pop())&&e._def.updateGeometry(s,t.float32buffer),s?(e._chunks.push({position:i,geometry:s,coord2d:null,visible:!1}),e._def.onChunkCreated&&e._def.onChunkCreated(),e._launchWorker()):console.log("worker: processing the result -> invalid geometry")}}),!1),this._workers.push(t)},e.prototype.start=function(){this._running=!0},e.prototype.stop=function(){this._running&&(this._running=!1,this._chunkPositionQueue.length=0,this._chunks.length=0,this._geometriesPool.length=0)},e.prototype.update=function(e){if(this._running){this._cameraPosition=e;var t=[Math.floor(e[0]/this._def.chunkSize),Math.floor(e[1]/this._def.chunkSize),Math.floor(e[2]/this._def.chunkSize)];if(0==this._chunks.length||t[0]!=this._savedIndex[0]||t[1]!=this._savedIndex[1]||t[2]!=this._savedIndex[2]){this._savedIndex[0]=t[0],this._savedIndex[1]=t[1],this._savedIndex[2]=t[2],this._chunkPositionQueue.length=0;for(var r=this._def.chunkRange,n=[Math.floor(t[0]-r),Math.floor(t[1]-r),Math.floor(t[2]-r)],i=[Math.floor(t[0]+r),Math.floor(t[1]+r),Math.floor(t[2]+r)],o=0;o<this._chunks.length;++o){var s=[this._chunks[o].position[0]/this._def.chunkSize|0,this._chunks[o].position[1]/this._def.chunkSize|0,this._chunks[o].position[2]/this._def.chunkSize|0];(s[0]<n[0]||s[0]>i[0]||s[1]<n[1]||s[1]>i[1]||s[2]<n[2]||s[2]>i[2])&&(this._geometriesPool.push(this._chunks[o].geometry),this._chunks.splice(o,1),--o,this._def.onChunkDiscarded&&this._def.onChunkDiscarded())}for(var a=n[2];a<=i[2];++a)for(var u=n[1];u<=i[1];++u)for(var h=n[0];h<=i[0];++h){var _=[h*this._def.chunkSize,u*this._def.chunkSize,a*this._def.chunkSize],c=!1;for(o=0;o<this._chunks.length;++o){var f=this._chunks[o].position;if(f[0]===_[0]&&f[1]===_[1]&&f[2]===_[2]){c=!0;break}}c||this._chunkPositionQueue.push(_)}this._launchWorker()}}},e.prototype._launchWorker=function(){var e=this._workers.find((function(e){return e.status==r.available}));if(void 0!==e&&0!=this._chunkPositionQueue.length){var t,n=void 0;if(1==this._chunkPositionQueue.length)n=this._chunkPositionQueue.pop();else{for(var i=-1,o=999999,s=void 0,a=0;a<this._chunkPositionQueue.length;++a){var u=this._chunkPositionQueue[a];if(-1==i||this._def.chunkIsVisible(u)){var h=[this._cameraPosition[0]-u[0]-this._def.chunkSize/2,this._cameraPosition[1]-u[1]-this._def.chunkSize/2,this._cameraPosition[2]-u[2]-this._def.chunkSize/2],_=(t=h,Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]));if(o<_)continue;i=a,o=_,s=this._chunkPositionQueue[i]}}this._chunkPositionQueue.splice(i,1),n=s}void 0!==n&&(this._processingPositions.push(n),e.status=r.working,e.instance.postMessage({position:n,float32buffer:e.float32buffer},[e.float32buffer.buffer]))}},e.prototype.getChunks=function(){return this._chunks},e.prototype.getProcessingPositions=function(){return this._processingPositions},e}(),l=function(){function e(){}return e.initialise=function(t){if(e._gl=t.getContext("webgl",{alpha:!0,antialias:!1,depth:!0,failIfMajorPerformanceCaveat:!1,powerPreference:"high-performance",premultipliedAlpha:!0,preserveDrawingBuffer:!0,stencil:!1}),!e._gl)throw new Error("could not create webgl context");e._extensionVAO=e._gl.getExtension("OES_vertex_array_object")||e._gl.getExtension("MOZ_OES_vertex_array_object")||e._gl.getExtension("WEBKIT_OES_vertex_array_object"),e._extensionLoseContext=e._gl.getExtension("WEBGL_lose_context"),e._extensionInstancing=e._gl.getExtension("ANGLE_instanced_arrays"),e._viewportSize[0]=t.clientWidth,e._viewportSize[1]=t.clientHeight},e.getContext=function(){if(!e._gl)throw new Error("webgl context not initialised");return e._gl},e.getExtensionVao=function(){return e._extensionVAO},e.getExtensionLoseContext=function(){return e._extensionLoseContext},e.getExtensionInstancing=function(){return e._extensionInstancing},e.getExtensionVaoStrict=function(){if(!e._extensionVAO)throw new Error("vao extension not available");return e._extensionVAO},e.getExtensionLoseContextStrict=function(){if(!e._extensionLoseContext)throw new Error("lose context extension not available");return e._extensionLoseContext},e.getExtensionInstancingStrict=function(){if(!e._extensionInstancing)throw new Error("instancing extension not available");return e._extensionInstancing},e.getViewportSize=function(){return e._viewportSize},e._gl=null,e._extensionVAO=null,e._extensionLoseContext=null,e._extensionInstancing=null,e._viewportSize=[0,0],e}(),d=function(){function e(t){this._attributes=new Map,this._uniforms=new Map;var r=l.getContext(),n=this._getShader(t.vertexSrc,r.VERTEX_SHADER),i=this._getShader(t.fragmentSrc,r.FRAGMENT_SHADER),o=r.createProgram();if(!o)throw new Error("could not create a shader program");if(r.attachShader(o,n),r.attachShader(o,i),r.linkProgram(o),r.deleteShader(n),r.deleteShader(i),!r.getProgramParameter(o,r.LINK_STATUS)){var s=r.getProgramInfoLog(o);throw new Error("Failed to initialised shaders, Error linking:"+s)}this._program=o,this.bind(),this._getAttributes(t.attributes),this._getUniforms(t.uniforms),e.unbind()}return e.prototype.bind=function(){l.getContext().useProgram(this._program)},e.unbind=function(){l.getContext().useProgram(null)},e.prototype.hasAttribute=function(e){return this._attributes.has(e)},e.prototype.getAttribute=function(e){var t=this._attributes.get(e);if(void 0===t)throw new Error("attribute not found: "+e);return t},e.prototype.getUniform=function(e){var t=this._uniforms.get(e);if(void 0===t)throw new Error("uniform not found: "+e);return t},e.prototype._getAttributes=function(e){for(var t=l.getContext(),r=0;r<e.length;++r){var n=t.getAttribLocation(this._program,e[r]);if(n<0)throw new Error("attribute not found => "+e[r]);this._attributes.set(e[r],n)}},e.prototype._getUniforms=function(e){for(var t=l.getContext(),r=0;r<e.length;++r){var n=t.getUniformLocation(this._program,e[r]);if(null===n)throw new Error("uniform not found => "+e[r]);this._uniforms.set(e[r],n)}},e.prototype._getShader=function(e,t){var r=l.getContext(),n=r.createShader(t);if(!n)throw new Error("could not create a shader");if(r.shaderSource(n,e),r.compileShader(n),!r.getShaderParameter(n,r.COMPILE_STATUS)){var i=r.getShaderInfoLog(n);throw i||(i="failed to compile a shader"),new Error(i)}return n},e}(),m=function(){function r(){this._width=0,this._height=0,this._texture=null}return r.prototype.load=function(r,n){return void 0===n&&(n=!1),e(this,void 0,void 0,(function(){var e,i,o,s,a,u=this;return t(this,(function(t){return e=l.getContext(),this._texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this._texture),0,i=e.RGBA,1,1,0,o=e.RGBA,s=e.UNSIGNED_BYTE,a=new Uint8Array([0,0,255,255]),e.texImage2D(e.TEXTURE_2D,0,i,1,1,0,o,s,a),e.bindTexture(e.TEXTURE_2D,null),[2,new Promise((function(t,a){var h=new Image;h.onerror=function(e){a(e)},h.onload=function(){u._width=h.width,u._height=h.height,e.bindTexture(e.TEXTURE_2D,u._texture),e.texImage2D(e.TEXTURE_2D,0,i,o,s,h),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);var r=n?e.NEAREST:e.LINEAR;e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r),e.bindTexture(e.TEXTURE_2D,null),t()},h.src=r}))]}))}))},r.prototype.getWidth=function(){if(!this._texture)throw new Error("texture not initialised");return this._width},r.prototype.getHeight=function(){if(!this._texture)throw new Error("texture not initialised");return this._height},r.prototype.bind=function(){if(!this._texture)throw new Error("texture not initialised");var e=l.getContext();e.bindTexture(e.TEXTURE_2D,this._texture)},r.unbind=function(){var e=l.getContext();e.bindTexture(e.TEXTURE_2D,null)},r}();!function(e){var t,r;e.BytesPerPixel=4,function(e){e[e.float=0]="float",e[e.vec2f=1]="vec2f",e[e.vec3f=2]="vec3f",e[e.vec4f=3]="vec4f",e[e.mat3f=4]="mat3f",e[e.mat4f=5]="mat4f"}(t=e.AttributeType||(e.AttributeType={})),function(e){e[e.lines=0]="lines",e[e.triangles=1]="triangles"}(r=e.PrimitiveType||(e.PrimitiveType={}));var n=function(){function n(n,i){this._primitiveStart=0,this._primitiveCount=0,this._instanceCount=0,this._isInstanced=!1;var o=l.getContext();if(0===i.vbos.length)throw new Error("empty vbo defintion");for(var s=0,a=i.vbos;s<a.length;s++){if(0===(g=a[s]).attrs.length)throw new Error("empty vbo attribute defintion");for(var u=0,h=g.attrs;u<h.length;u++){var _=h[u];if(!n.hasAttribute(_.name))throw new Error('attribute not found, name="'+_.name+'"')}}switch(this._def=i,i.primitiveType){case r.lines:this._primitiveType=o.LINES;break;case r.triangles:this._primitiveType=o.TRIANGLES;break;default:throw new Error("primitive type not found")}var c=l.getExtensionVaoStrict(),f=l.getExtensionInstancingStrict(),d=c.createVertexArrayOES();if(!d)throw new Error("fail o create a vao unit");this._vao=d,c.bindVertexArrayOES(this._vao),this._vbos=[];for(var m=0,v=this._def.vbos;m<v.length;m++){var g,p=v[m];if(!(g=o.createBuffer()))throw new Error("fail o create a vbo unit");this._vbos.push(g),o.bindBuffer(o.ARRAY_BUFFER,g);var x=p.stride||0;if(!x){for(var y=0,w=p.attrs;y<w.length;y++){switch((_=w[y]).type){case t.float:x+=1;break;case t.vec2f:x+=2;break;case t.vec3f:x+=3;break;case t.vec4f:x+=4;break;case t.mat3f:x+=9;break;case t.mat4f:x+=16}}x*=e.BytesPerPixel}for(var b=0,k=p.attrs;b<k.length;b++){var C=1,E=1;switch((_=k[b]).type){case t.float:C=1,E=1;break;case t.vec2f:C=2,E=1;break;case t.vec3f:C=3,E=1;break;case t.vec4f:C=4,E=1;break;case t.mat3f:C=3,E=3;break;case t.mat4f:C=4,E=4}for(var P=n.getAttribute(_.name),R=0;R<E;++R){var S=P+R,M=(_.index+R*C)*e.BytesPerPixel;o.enableVertexAttribArray(S),o.vertexAttribPointer(S,C,o.FLOAT,!1,x,M),!0===p.instanced&&(f.vertexAttribDivisorANGLE(S,1),this._isInstanced=!0)}}}c.bindVertexArrayOES(null)}return n.prototype.dispose=function(){for(var e=l.getContext(),t=l.getExtensionVaoStrict(),r=0;r<this._vbos.length;++r)e.deleteBuffer(this._vbos[r]);t.deleteVertexArrayOES(this._vao)},n.prototype.updateBuffer=function(e,t,r){if(void 0===r&&(r=!1),e<0||e>=this._vbos.length)throw new Error("no buffer avaialble to tha index");var n=l.getContext(),i=this._vbos[e],o=t instanceof Float32Array?t:new Float32Array(t),s=r?n.DYNAMIC_DRAW:n.STATIC_DRAW;n.bindBuffer(n.ARRAY_BUFFER,i),n.bufferData(n.ARRAY_BUFFER,o,s),n.bindBuffer(n.ARRAY_BUFFER,null)},n.prototype.render=function(){if(!(0==this._primitiveCount||this._isInstanced&&0==this._instanceCount)){var e=l.getContext(),t=l.getExtensionVaoStrict(),r=l.getExtensionInstancingStrict();t.bindVertexArrayOES(this._vao),!0===this._isInstanced?r.drawArraysInstancedANGLE(this._primitiveType,this._primitiveStart,this._primitiveCount,this._instanceCount):e.drawArrays(this._primitiveType,this._primitiveStart,this._primitiveCount),t.bindVertexArrayOES(null)}},n.prototype.setPrimitiveStart=function(e){this._primitiveStart=e},n.prototype.setPrimitiveCount=function(e){this._primitiveCount=e},n.prototype.setInstancedCount=function(e){this._instanceCount=e},n}();e.Geometry=n}(c||(c={}));var v=c,g=1e-6,p="undefined"!=typeof Float32Array?Float32Array:Array;function x(){var e=new p(16);return p!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function y(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function w(e,t,r){var n,i,o,s,a,u,h,_,c,f,l,d,m=r[0],v=r[1],g=r[2];return t===e?(e[12]=t[0]*m+t[4]*v+t[8]*g+t[12],e[13]=t[1]*m+t[5]*v+t[9]*g+t[13],e[14]=t[2]*m+t[6]*v+t[10]*g+t[14],e[15]=t[3]*m+t[7]*v+t[11]*g+t[15]):(n=t[0],i=t[1],o=t[2],s=t[3],a=t[4],u=t[5],h=t[6],_=t[7],c=t[8],f=t[9],l=t[10],d=t[11],e[0]=n,e[1]=i,e[2]=o,e[3]=s,e[4]=a,e[5]=u,e[6]=h,e[7]=_,e[8]=c,e[9]=f,e[10]=l,e[11]=d,e[12]=n*m+a*v+c*g+t[12],e[13]=i*m+u*v+f*g+t[13],e[14]=o*m+h*v+l*g+t[14],e[15]=s*m+_*v+d*g+t[15]),e}function b(e,t,r){var n=r[0],i=r[1],o=r[2];return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*o,e[9]=t[9]*o,e[10]=t[10]*o,e[11]=t[11]*o,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function k(e,t,r,n){var i,o,s,a,u,h,_,c,f,l,d,m,v,p,x,y,w,b,k,C,E,P,R,S,M=n[0],T=n[1],A=n[2],F=Math.hypot(M,T,A);return F<g?null:(M*=F=1/F,T*=F,A*=F,i=Math.sin(r),s=1-(o=Math.cos(r)),a=t[0],u=t[1],h=t[2],_=t[3],c=t[4],f=t[5],l=t[6],d=t[7],m=t[8],v=t[9],p=t[10],x=t[11],y=M*M*s+o,w=T*M*s+A*i,b=A*M*s-T*i,k=M*T*s-A*i,C=T*T*s+o,E=A*T*s+M*i,P=M*A*s+T*i,R=T*A*s-M*i,S=A*A*s+o,e[0]=a*y+c*w+m*b,e[1]=u*y+f*w+v*b,e[2]=h*y+l*w+p*b,e[3]=_*y+d*w+x*b,e[4]=a*k+c*C+m*E,e[5]=u*k+f*C+v*E,e[6]=h*k+l*C+p*E,e[7]=_*k+d*C+x*E,e[8]=a*P+c*R+m*S,e[9]=u*P+f*R+v*S,e[10]=h*P+l*R+p*S,e[11]=_*P+d*R+x*S,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var C=function(e,t,r,n,i){var o,s=1/Math.tan(t/2);return e[0]=s/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=i&&i!==1/0?(o=1/(n-i),e[10]=(i+n)*o,e[14]=2*i*n*o):(e[10]=-1,e[14]=-2*n),e};var E=function(e,t,r,n,i,o,s){var a=1/(t-r),u=1/(n-i),h=1/(o-s);return e[0]=-2*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*u,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*h,e[11]=0,e[12]=(t+r)*a,e[13]=(i+n)*u,e[14]=(s+o)*h,e[15]=1,e};function P(e,t,r,n){var i,o,s,a,u,h,_,c,f,l,d=t[0],m=t[1],v=t[2],p=n[0],x=n[1],w=n[2],b=r[0],k=r[1],C=r[2];return Math.abs(d-b)<g&&Math.abs(m-k)<g&&Math.abs(v-C)<g?y(e):(_=d-b,c=m-k,f=v-C,i=x*(f*=l=1/Math.hypot(_,c,f))-w*(c*=l),o=w*(_*=l)-p*f,s=p*c-x*_,(l=Math.hypot(i,o,s))?(i*=l=1/l,o*=l,s*=l):(i=0,o=0,s=0),a=c*s-f*o,u=f*i-_*s,h=_*o-c*i,(l=Math.hypot(a,u,h))?(a*=l=1/l,u*=l,h*=l):(a=0,u=0,h=0),e[0]=i,e[1]=a,e[2]=_,e[3]=0,e[4]=o,e[5]=u,e[6]=c,e[7]=0,e[8]=s,e[9]=h,e[10]=f,e[11]=0,e[12]=-(i*d+o*m+s*v),e[13]=-(a*d+u*m+h*v),e[14]=-(_*d+c*m+f*v),e[15]=1,e)}function R(){var e=new p(3);return p!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function S(e,t,r){var n=new p(3);return n[0]=e,n[1]=t,n[2]=r,n}function M(){var e=new p(4);return p!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function T(){var e=new p(4);return p!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}R(),function(){var e=M()}();var A,F;R(),S(1,0,0),S(0,1,0),T(),T(),A=new p(9),p!=Float32Array&&(A[1]=0,A[2]=0,A[3]=0,A[5]=0,A[6]=0,A[7]=0),A[0]=1,A[4]=1,A[8]=1,function(){var e=function(){var e=new p(2);return p!=Float32Array&&(e[0]=0,e[1]=0),e}()}(),function(e){e.KEY_Z="z",e.KEY_W="w",e.KEY_S="s",e.KEY_A="a",e.KEY_Q="q",e.KEY_D="d",e.ARROW_LEFT="ArrowLeft",e.ARROW_RIGHT="ArrowRight",e.ARROW_UP="ArrowUp",e.ARROW_DOWN="ArrowDown"}(F||(F={}));var D,I=function(){function e(){var e=this;this._pressedKeys=new Map,this._activated=!1;var t=[F.ARROW_LEFT,F.ARROW_RIGHT,F.ARROW_UP,F.ARROW_DOWN];this._activated=!1,this._handleKeyDown=function(r){-1!=t.indexOf(r.key)&&r.preventDefault(),e._pressedKeys.set(r.key,!0)}.bind(this),this._handleKeyUp=function(r){-1!=t.indexOf(r.key)&&r.preventDefault(),e._pressedKeys.set(r.key,!1)}.bind(this)}return e.prototype.isPressed=function(e){return this._pressedKeys.get(e)||!1},e.prototype.activate=function(){this._activated||(document.addEventListener("keydown",this._handleKeyDown),document.addEventListener("keyup",this._handleKeyUp),this._activated=!0)},e.prototype.deactivate=function(){this._activated&&(document.removeEventListener("keydown",this._handleKeyDown),document.removeEventListener("keyup",this._handleKeyUp),this._activated=!1)},e}(),z=function(e){e.targetElement.requestPointerLock=e.targetElement.requestPointerLock||e.targetElement.mozRequestPointerLock||e.targetElement.webkitRequestPointerLock,document.exitPointerLock=document.exitPointerLock||document.mozExitPointerLock||document.webkitExitPointerLock,e.targetElement.onclick=function(){e.targetElement.requestPointerLock&&e.targetElement.requestPointerLock()};var t=function(){document.pointerLockElement===e.targetElement||document.mozPointerLockElement===e.targetElement||document.webkitPointerLockElement===e.targetElement?(console.log("The pointer lock status is now locked"),e.enabledCallback()):(console.log("The pointer lock status is now unlocked"),e.disabledCallback())},r=function(t){console.error("Pointer lock failed"),console.error(t),e.errorCallback&&e.errorCallback(t)};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document?document.addEventListener("mozpointerlockchange",t,!1):"onwebkitpointerlockchange"in document&&document.addEventListener("webkitpointerlockchange",t,!1),"onpointerlockerror"in document?document.addEventListener("pointerlockerror",r,!1):"onmozpointerlockerror"in document?document.addEventListener("mozpointerlockerror",r,!1):"onwebkitpointerlockerror"in document&&document.addEventListener("webkitpointerlockerror",r,!1)};!function(e){e[e.forward=1]="forward",e[e.backward=2]="backward",e[e.left=4]="left",e[e.right=8]="right"}(D||(D={}));var L,B,U=function(){function e(e){var t=this;this._phi=0,this._theta=0,this._forward=[1,0,0],this._left=[0,0,0],this._position=[0,0,0],this._target=[0,0,0],this._movementFlag=0,this._keyboardHandler=new I,this._forceForward=!1,this._timeImmobile=0,this._lastTime=0,this._movingSpeed=e.movingSpeed,this._mouseSensitivity=e.mouseSensitivity,this._keyboardSensitivity=e.keyboardSensitivity,this._lastTime=Date.now();var r=function(e){var r=e.movementX||e.mozMovementX||e.webkitMovementX||0,n=e.movementY||e.mozMovementY||e.webkitMovementY||0;t._theta-=r*t._mouseSensitivity,t._phi-=n*t._mouseSensitivity,t._timeImmobile=0};z({targetElement:e.targetElement,enabledCallback:function(){e.targetElement.addEventListener("mousemove",r,!1)},disabledCallback:function(){e.targetElement.removeEventListener("mousemove",r,!1)}});var n=null,i=null,o=Date.now();e.targetElement.addEventListener("touchstart",(function(e){e.preventDefault(),n=null,i=null;var r=Date.now();1==e.targetTouches.length&&r-o<250&&(t._forceForward=!0),o=r})),e.targetElement.addEventListener("touchend",(function(e){e.preventDefault(),n=null,i=null,t._forceForward=!1})),e.targetElement.addEventListener("touchmove",(function(e){e.preventDefault();var r=e.targetTouches;if(!(0==r.length||r.length>2)){if(2==r.length){var o=r[0].pageX-r[1].pageX,s=r[0].pageY-r[1].pageY,a=Math.sqrt(o*o+s*s);i&&(t._movementFlag|=a>i?D.forward:D.backward),i=a}else{if(n){var u=n.pageX-r[0].pageX,h=n.pageY-r[0].pageY;t._theta-=u/3,t._phi-=h/3}n=r[0]}t._timeImmobile=0}}))}return e.prototype.update=function(e){this._handleKeys(e);var t=Date.now();if(this._timeImmobile+=e,t-this._lastTime>3e3&&(this._timeImmobile=10),this._lastTime=t,this._forceForward&&(this._timeImmobile=0),this._movementFlag&D.forward||1==this._forceForward)for(var r=0;r<3;++r)this._position[r]+=this._forward[r]*e*this._movingSpeed;else if(this._movementFlag&D.backward)for(r=0;r<3;++r)this._position[r]-=this._forward[r]*e*this._movingSpeed;if(this._movementFlag&D.left)for(r=0;r<3;++r)this._position[r]-=this._left[r]*e*this._movingSpeed;else if(this._movementFlag&D.right)for(r=0;r<3;++r)this._position[r]+=this._left[r]*e*this._movingSpeed;this._movementFlag=0;this._phi=Math.min(Math.max(this._phi,-89),89);var n=[0,0,1],i=Math.cos(3.14*(this._phi-90)/180);n[2]=Math.sin(3.14*(this._phi-90)/180),n[0]=i*Math.cos(3.14*this._theta/180),n[1]=i*Math.sin(3.14*this._theta/180);var o=Math.cos(3.14*this._phi/180);this._forward[2]=Math.sin(3.14*this._phi/180),this._forward[0]=o*Math.cos(3.14*this._theta/180),this._forward[1]=o*Math.sin(3.14*this._theta/180),this._left[0]=n[1]*this._forward[2]-n[2]*this._forward[1],this._left[1]=n[2]*this._forward[0]-n[0]*this._forward[2],this._left[2]=n[0]*this._forward[1]-n[1]*this._forward[0],this._target[0]=this._position[0]+this._forward[0],this._target[1]=this._position[1]+this._forward[1],this._target[2]=this._position[2]+this._forward[2]},e.prototype.updateViewMatrix=function(e){P(e,[this._position[0],this._position[1],this._position[2]],[this._target[0],this._target[1],this._target[2]],[0,0,1])},e.prototype.setPosition=function(e,t,r){this._position[0]=e,this._position[1]=t,this._position[2]=r},e.prototype.getPosition=function(){return[this._position[0],this._position[1],this._position[2]]},e.prototype.getTheta=function(){return this._theta},e.prototype.getPhi=function(){return this._phi},e.prototype.getForceForward=function(){return this._forceForward},e.prototype.getTimeImmobile=function(){return this._timeImmobile},e.prototype.activate=function(){this._keyboardHandler.activate()},e.prototype.deactivate=function(){this._keyboardHandler.deactivate()},e.prototype._handleKeys=function(e){var t=this._movementFlag,r=this._phi,n=this._theta;(this._keyboardHandler.isPressed(F.KEY_Z)||this._keyboardHandler.isPressed(F.KEY_W))&&(this._movementFlag|=D.forward),this._keyboardHandler.isPressed(F.KEY_S)&&(this._movementFlag|=D.backward),(this._keyboardHandler.isPressed(F.KEY_A)||this._keyboardHandler.isPressed(F.KEY_Q))&&(this._movementFlag|=D.left),this._keyboardHandler.isPressed(F.KEY_D)&&(this._movementFlag|=D.right),this._keyboardHandler.isPressed(F.ARROW_UP)&&(this._phi+=this._keyboardSensitivity*e),this._keyboardHandler.isPressed(F.ARROW_DOWN)&&(this._phi-=this._keyboardSensitivity*e),this._keyboardHandler.isPressed(F.ARROW_LEFT)&&(this._theta+=this._keyboardSensitivity*e),this._keyboardHandler.isPressed(F.ARROW_RIGHT)&&(this._theta-=this._keyboardSensitivity*e),t==this._movementFlag&&r==this._phi&&n==this._theta||(this._timeImmobile=0)},e}();!function(e){e[e.Right=0]="Right",e[e.Left=1]="Left",e[e.Bottom=2]="Bottom",e[e.Top=3]="Top",e[e.Back=4]="Back",e[e.Front=5]="Front"}(L||(L={})),function(e){e[e.A=0]="A",e[e.B=1]="B",e[e.C=2]="C",e[e.D=3]="D"}(B||(B={}));var G=function(){function e(){this._frustum=new Float32Array(24)}return e.prototype.normalizePlane=function(e){var t=4*e,r=Math.sqrt(this._frustum[t+B.A]*this._frustum[t+B.A]+this._frustum[t+B.B]*this._frustum[t+B.B]+this._frustum[t+B.C]*this._frustum[t+B.C]);this._frustum[t+B.A]/=r,this._frustum[t+B.B]/=r,this._frustum[t+B.C]/=r,this._frustum[t+B.D]/=r},e.prototype.calculateFrustum=function(e,t){var r=new Float32Array(16);r[0]=t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+t[3]*e[12],r[1]=t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+t[3]*e[13],r[2]=t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+t[3]*e[14],r[3]=t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+t[3]*e[15],r[4]=t[4]*e[0]+t[5]*e[4]+t[6]*e[8]+t[7]*e[12],r[5]=t[4]*e[1]+t[5]*e[5]+t[6]*e[9]+t[7]*e[13],r[6]=t[4]*e[2]+t[5]*e[6]+t[6]*e[10]+t[7]*e[14],r[7]=t[4]*e[3]+t[5]*e[7]+t[6]*e[11]+t[7]*e[15],r[8]=t[8]*e[0]+t[9]*e[4]+t[10]*e[8]+t[11]*e[12],r[9]=t[8]*e[1]+t[9]*e[5]+t[10]*e[9]+t[11]*e[13],r[10]=t[8]*e[2]+t[9]*e[6]+t[10]*e[10]+t[11]*e[14],r[11]=t[8]*e[3]+t[9]*e[7]+t[10]*e[11]+t[11]*e[15],r[12]=t[12]*e[0]+t[13]*e[4]+t[14]*e[8]+t[15]*e[12],r[13]=t[12]*e[1]+t[13]*e[5]+t[14]*e[9]+t[15]*e[13],r[14]=t[12]*e[2]+t[13]*e[6]+t[14]*e[10]+t[15]*e[14],r[15]=t[12]*e[3]+t[13]*e[7]+t[14]*e[11]+t[15]*e[15];var n=4*L.Right;this._frustum[n+B.A]=r[3]-r[0],this._frustum[n+B.B]=r[7]-r[4],this._frustum[n+B.C]=r[11]-r[8],this._frustum[n+B.D]=r[15]-r[12],this.normalizePlane(L.Right),n=4*L.Left,this._frustum[n+B.A]=r[3]+r[0],this._frustum[n+B.B]=r[7]+r[4],this._frustum[n+B.C]=r[11]+r[8],this._frustum[n+B.D]=r[15]+r[12],this.normalizePlane(L.Left),n=4*L.Bottom,this._frustum[n+B.A]=r[3]+r[1],this._frustum[n+B.B]=r[7]+r[5],this._frustum[n+B.C]=r[11]+r[9],this._frustum[n+B.D]=r[15]+r[13],this.normalizePlane(L.Bottom),n=4*L.Top,this._frustum[n+B.A]=r[3]-r[1],this._frustum[n+B.B]=r[7]-r[5],this._frustum[n+B.C]=r[11]-r[9],this._frustum[n+B.D]=r[15]-r[13],this.normalizePlane(L.Top),n=4*L.Back,this._frustum[n+B.A]=r[3]-r[2],this._frustum[n+B.B]=r[7]-r[6],this._frustum[n+B.C]=r[11]-r[10],this._frustum[n+B.D]=r[15]-r[14],this.normalizePlane(L.Back),n=4*L.Front,this._frustum[n+B.A]=r[3]+r[2],this._frustum[n+B.B]=r[7]+r[6],this._frustum[n+B.C]=r[11]+r[10],this._frustum[n+B.D]=r[15]+r[14],this.normalizePlane(L.Front)},e.prototype.sphereInFrustum=function(e,t,r,n){for(var i=0;i<6;++i)if(this._frustum[4*i+B.A]*e+this._frustum[4*i+B.B]*t+this._frustum[4*i+B.C]*r+this._frustum[4*i+B.D]<=n)return!1;return!0},e.prototype.pointInFrustum=function(e,t,r){return this.sphereInFrustum(e,t,r,0)},e.prototype.cubeInFrustum=function(e,t,r,n){for(var i=0;i<6;++i){var o=4*i;if(!(this._frustum[o+B.A]*(e-n)+this._frustum[o+B.B]*(t-n)+this._frustum[o+B.C]*(r-n)+this._frustum[o+B.D]>0)&&!(this._frustum[o+B.A]*(e+n)+this._frustum[o+B.B]*(t-n)+this._frustum[o+B.C]*(r-n)+this._frustum[o+B.D]>0||this._frustum[o+B.A]*(e-n)+this._frustum[o+B.B]*(t+n)+this._frustum[o+B.C]*(r-n)+this._frustum[o+B.D]>0||this._frustum[o+B.A]*(e+n)+this._frustum[o+B.B]*(t+n)+this._frustum[o+B.C]*(r-n)+this._frustum[o+B.D]>0||this._frustum[o+B.A]*(e-n)+this._frustum[o+B.B]*(t-n)+this._frustum[o+B.C]*(r+n)+this._frustum[o+B.D]>0||this._frustum[o+B.A]*(e+n)+this._frustum[o+B.B]*(t-n)+this._frustum[o+B.C]*(r+n)+this._frustum[o+B.D]>0||this._frustum[o+B.A]*(e-n)+this._frustum[o+B.B]*(t+n)+this._frustum[o+B.C]*(r+n)+this._frustum[o+B.D]>0||this._frustum[o+B.A]*(e+n)+this._frustum[o+B.B]*(t+n)+this._frustum[o+B.C]*(r+n)+this._frustum[o+B.D]>0))return!1}return!0},e}(),W=function(e,t,r,n){var i=function(e,t,r,n){var i=new p(4);return i[0]=e,i[1]=t,i[2]=r,i[3]=n,i}(e[0],e[1],e[2],1),o=x(),s=M();return function(e,t,r){var n=t[0],i=t[1],o=t[2],s=t[3],a=t[4],u=t[5],h=t[6],_=t[7],c=t[8],f=t[9],l=t[10],d=t[11],m=t[12],v=t[13],g=t[14],p=t[15],x=r[0],y=r[1],w=r[2],b=r[3];e[0]=x*n+y*a+w*c+b*m,e[1]=x*i+y*u+w*f+b*v,e[2]=x*o+y*h+w*l+b*g,e[3]=x*s+y*_+w*d+b*p,x=r[4],y=r[5],w=r[6],b=r[7],e[4]=x*n+y*a+w*c+b*m,e[5]=x*i+y*u+w*f+b*v,e[6]=x*o+y*h+w*l+b*g,e[7]=x*s+y*_+w*d+b*p,x=r[8],y=r[9],w=r[10],b=r[11],e[8]=x*n+y*a+w*c+b*m,e[9]=x*i+y*u+w*f+b*v,e[10]=x*o+y*h+w*l+b*g,e[11]=x*s+y*_+w*d+b*p,x=r[12],y=r[13],w=r[14],b=r[15],e[12]=x*n+y*a+w*c+b*m,e[13]=x*i+y*u+w*f+b*v,e[14]=x*o+y*h+w*l+b*g,e[15]=x*s+y*_+w*d+b*p}(o,r,t),function(e,t,r){var n=t[0],i=t[1],o=t[2],s=t[3];e[0]=r[0]*n+r[4]*i+r[8]*o+r[12]*s,e[1]=r[1]*n+r[5]*i+r[9]*o+r[13]*s,e[2]=r[2]*n+r[6]*i+r[10]*o+r[14]*s,e[3]=r[3]*n+r[7]*i+r[11]*o+r[15]*s}(s,i,o),0===s[3]?null:(s[3]=1/s[3],s[0]*=s[3],s[1]*=s[3],s[2]*=s[3],[(.5*s[0]+.5)*n[2]+n[0],(.5*s[1]+.5)*n[3]+n[1]])},O=function(e,t,r){void 0===r&&(r=!1);var n=e/2,i=e/2.1,o=[n,n,n,-n,n,n,n,-n,n,-n,-n,n,n,n,-n,-n,n,-n,n,-n,-n,-n,-n,-n,i,i,i,-i,i,i,i,-i,i,-i,-i,i,i,i,-i,-i,i,-i,i,-i,-i,-i,-i,-i],s=[0,1,1,3,3,2,2,0,4,5,5,7,7,6,6,4,0,4,1,5,3,7,2,6,8,9,9,11,11,10,10,8,12,13,13,15,15,14,14,12,8,12,9,13,11,15,10,14];r&&(s.length/=2);for(var a=[],u=0;u<s.length;++u){for(var h=3*s[u],_=0;_<3;++_)a.push(o[h+_]+n);for(_=0;_<3;++_)a.push(t[_])}return a},V=function(e,t,r,n){for(var i=Math.tan(e/360*Math.PI)*r,o=i*t,s=-o,a=+o,u=+i,h=-i,_=n*Math.sin(e*Math.PI/180),c=_*t,f=[r,s,u,r,a,u,r,s,h,r,a,h,n,-c,+_,n,+c,+_,n,-c,-_,n,+c,-_,n,1.66*-c,-_,n,1.66*-c,+_],l=[0,1,1,3,3,2,2,0,0,4,1,5,2,6,3,7,4,5,5,7,7,6,6,4,8,9,7,8,5,9],d=[],m=0;m<l.length;++m){for(var v=3*l[m],g=0;g<3;++g)d.push(f[v+g]);d.push(1,1,0)}return d},H=function(){function r(e){var t=this;this.onContextLost=null,this.onContextRestored=null,this._fpsmeterAngle=0,this._fpsmeterSpeed=0,this._touchesAngle=new Map,this._def=e,l.initialise(this._def.canvasDomElement),this._def.canvasDomElement.addEventListener("webglcontextlost",(function(e){e.preventDefault(),console.log("context is lost"),t.onContextLost&&t.onContextLost()}),!1),this._def.canvasDomElement.addEventListener("webglcontextrestored",(function(){console.log("context is restored"),l.initialise(t._def.canvasDomElement),t.onContextRestored&&t.onContextRestored()}),!1);var r=l.getViewportSize();this._freeFlyCamera=new U({targetElement:this._def.canvasDomElement,mouseSensitivity:this._def.mouseSensitivity,movingSpeed:this._def.movingSpeed,keyboardSensitivity:this._def.keyboardSensitivity}),this._freeFlyCamera.activate(),this._frustumCulling=new G,this._projectionMatrix=x(),this._modelviewMatrix=x(),this._aspectRatio=.75*r[0]/r[1],this._initialiseChunkRendering(),this._initialiseWireframeRendering(),this._initialiseTextRendering()}return r.prototype._initialiseChunkRendering=function(){var e=new d({vertexSrc:"\n\nattribute vec3 a_vertexPosition;\nattribute vec3 a_vertexColor;\nattribute vec3 a_vertexNormal;\nattribute vec3 a_vertexBCenter;\n\nuniform mat4 u_modelviewMatrix;\nuniform mat4 u_projMatrix;\nuniform vec3 u_cameraPos;\n\nvarying vec3 v_color;\n\n// lighting\nvarying vec3 v_normalInterp;\nvarying vec3 v_vertPos;\n// lighting\n\n// wireframe\nvarying float v_distanceToCamera;\nvarying vec3  v_baryCenter;\n// wireframe\n\n// texturing\nvarying vec3 v_pureVertexPos;\nvarying vec3 v_pureNormalInterp;\n// texturing\n\nconst float k_rangeMin = 20.0;\nconst float k_rangeMax = 23.0;\n\nvoid main(void)\n{\n    vec4 vertPos4 = u_modelviewMatrix * vec4(a_vertexPosition, 1.0);\n    v_vertPos = vec3(vertPos4) / vertPos4.w;\n    v_normalInterp = vec3(u_modelviewMatrix * vec4(a_vertexNormal, 0.0));\n\n    v_pureVertexPos = a_vertexPosition;\n    v_pureNormalInterp = a_vertexNormal;\n\n    float distanceToCamera = length(a_vertexPosition - u_cameraPos);\n\n    v_distanceToCamera = distanceToCamera;\n\n    v_color = a_vertexColor;\n    v_baryCenter = a_vertexBCenter;\n\n    if (distanceToCamera < k_rangeMin ||\n        distanceToCamera > k_rangeMax)\n    {\n        gl_Position = u_projMatrix * u_modelviewMatrix * vec4(a_vertexPosition, 1.0);\n    }\n    else\n    {\n        // bump effect -> bump in the direction of the normal\n\n        gl_Position = u_projMatrix * u_modelviewMatrix * vec4(a_vertexPosition + a_vertexNormal, 1.0);\n    }\n}\n",fragmentSrc:'\n\nprecision mediump float;\n\nuniform sampler2D u_sampler;\n\nvarying vec3 v_color;\n\n// lighting\nvarying vec3 v_normalInterp;\nvarying vec3 v_vertPos;\n// lighting\n\n// wireframe\nvarying float v_distanceToCamera;\nvarying vec3  v_baryCenter;\n// wireframe\n\n// texturing\nvarying vec3 v_pureVertexPos;\nvarying vec3 v_pureNormalInterp;\n// texturing\n\nconst vec3 k_lightPos = vec3(0.0,0.0,0.0);\nconst vec3 k_specColor = vec3(1.0, 1.0, 1.0);\n\nconst float k_rangeMin = 20.0;\nconst float k_rangeMax = 23.0;\n\nvoid main(void)\n{\n\n    { // wireframe\n\n        if (gl_FrontFacing)\n        {\n            // "bumped wireframe" effect on the front facing\n\n            if (v_distanceToCamera > k_rangeMin &&\n                v_distanceToCamera < k_rangeMax)\n            {\n                if (all(greaterThan(v_baryCenter, vec3(0.03))) &&\n                    any(lessThan(v_baryCenter, vec3(0.08))))\n                {\n                    gl_FragColor = vec4(v_color, 1.0);\n                    return;\n                }\n            }\n        }\n        else\n        {\n            // normal wireframe effect on the back facing\n\n            if (any(lessThan(v_baryCenter, vec3(0.06))))\n            {\n                gl_FragColor = vec4(1);\n                return;\n            }\n            else\n            {\n                // discard what is not part fo the wireframe\n                discard;\n            }\n        }\n\n    } // /wireframe\n\n    vec3 currentColor = vec3(1);\n\n    { // texture\n\n        // current 3d texture coordinate\n        vec3 flooredPos = vec3(\n            v_pureVertexPos.x - floor(v_pureVertexPos.x),\n            v_pureVertexPos.y - floor(v_pureVertexPos.y),\n            v_pureVertexPos.z - floor(v_pureVertexPos.z)\n        );\n\n        vec3 blendWeights = abs( normalize( v_pureNormalInterp.xyz ) );\n        blendWeights = max( ( blendWeights - 0.2 ) * 7.0, 0.0 );\n        blendWeights /= ( blendWeights.x + blendWeights.y + blendWeights.z );\n\n        // horizontal texture coordinates -> should be a wall\n        vec2 texCoordX = vec2(flooredPos.y * 0.5 + 0.5, flooredPos.z * 0.5);\n        vec2 texCoordY = vec2(flooredPos.x * 0.5 + 0.5, flooredPos.z * 0.5);\n\n        // vertical texture coord -> should be green grass\n        vec2 texCoordZ = vec2(flooredPos.x * 0.5, flooredPos.y * 0.5 + 0.5);\n\n        if (v_pureNormalInterp.z < 0.0)\n        {\n            // switch the texture Y -> dirt on the ceilling instead of grass\n            texCoordZ.y -= 0.5;\n        }\n\n        // horizontal color\n        vec3 texColorX = texture2D( u_sampler, texCoordX ).rgb;\n        vec3 texColorY = texture2D( u_sampler, texCoordY ).rgb;\n\n        // vertical color\n        vec3 texColorZ = texture2D( u_sampler, texCoordZ ).rgb;\n\n        currentColor = texColorX * blendWeights.xxx +\n                       texColorY * blendWeights.yyy +\n                       texColorZ * blendWeights.zzz;\n\n    } // texture\n\n    { // lighting\n\n        vec3 normal = normalize(v_normalInterp);\n        vec3 lightDir = normalize(k_lightPos - v_vertPos);\n\n        float lambertian = max(dot(lightDir,v_normalInterp.xyz), 0.0);\n        float specular = 0.0;\n\n        if (lambertian > 0.0)\n        {\n            // specular\n\n            vec3 reflectDir = reflect(-lightDir, normal);\n            vec3 viewDir = normalize(-v_vertPos);\n\n            float specAngle = max(dot(reflectDir, viewDir), 0.0);\n            specular = pow(specAngle, 16.0);\n        }\n\n        vec3 ambiantColor = currentColor.xyz * 0.05;\n        vec3 diffuseColor = currentColor.xyz * lambertian;\n        vec3 specularColor = k_specColor * specular;\n\n        currentColor = ambiantColor + diffuseColor + specularColor;\n\n    } // lighting\n\n    gl_FragColor = vec4(currentColor, 1.0);\n}\n',attributes:["a_vertexPosition","a_vertexColor","a_vertexNormal","a_vertexBCenter"],uniforms:["u_modelviewMatrix","u_projMatrix","u_cameraPos","u_sampler"]}),t={vbos:[{attrs:[{name:"a_vertexPosition",type:v.AttributeType.vec3f,index:0},{name:"a_vertexColor",type:v.AttributeType.vec3f,index:3},{name:"a_vertexNormal",type:v.AttributeType.vec3f,index:6},{name:"a_vertexBCenter",type:v.AttributeType.vec3f,index:9}],stride:48,instanced:!1}],primitiveType:v.PrimitiveType.triangles};this._chunkRendering={texture:new m,shader:e,geometryDefinition:t}},r.prototype._initialiseWireframeRendering=function(){var e=new d({vertexSrc:"\n\nattribute vec3 a_vertexPosition;\nattribute vec3 a_vertexColor;\n\nvarying vec4 v_color;\n\nuniform mat4 u_modelviewMatrix;\nuniform mat4 u_projMatrix;\n\nvoid main(void)\n{\n    v_color = vec4(a_vertexColor,1.0);\n\n    gl_Position = u_projMatrix * u_modelviewMatrix * vec4(a_vertexPosition, 1.0);\n}\n",fragmentSrc:"\n\nprecision mediump float;\n\nvarying vec4 v_color;\n\nvoid main(void)\n{\n    gl_FragColor = v_color;\n}\n",attributes:["a_vertexPosition","a_vertexColor"],uniforms:["u_modelviewMatrix","u_projMatrix"]}),t={vbos:[{attrs:[{name:"a_vertexPosition",type:v.AttributeType.vec3f,index:0},{name:"a_vertexColor",type:v.AttributeType.vec3f,index:3}],stride:24,instanced:!1}],primitiveType:v.PrimitiveType.lines},r=[];r.push(0,0,0,1,0,0,20,0,0,1,0,0),r.push(0,0,0,0,1,0,0,20,0,0,1,0),r.push(0,0,0,0,0,1,0,0,20,0,0,1);var n=new v.Geometry(e,t);n.updateBuffer(0,r),n.setPrimitiveCount(r.length/6),r.length=0;r.push(-5,0,0,1,1,1),r.push(25,0,0,1,1,1),r.push(0,-5,0,1,1,1),r.push(0,5,0,1,1,1),r.push(0,0,-5,1,1,1),r.push(0,0,5,1,1,1);var i=new v.Geometry(e,t);i.updateBuffer(0,r),i.setPrimitiveCount(r.length/6),r=O(this._def.chunkSize,[1,0,0]);var o=new v.Geometry(e,t);o.updateBuffer(0,r),o.setPrimitiveCount(r.length/6),r=O(this._def.chunkSize,[1,1,1]);var s=new v.Geometry(e,t);s.updateBuffer(0,r),s.setPrimitiveCount(r.length/6),r=O(this._def.chunkSize,[0,1,0]);var a=new v.Geometry(e,t);a.updateBuffer(0,r),a.setPrimitiveCount(r.length/6);var u=new v.Geometry(e,t);r=V(70,this._aspectRatio,.1,40);var h=new v.Geometry(e,t);h.updateBuffer(0,r),h.setPrimitiveCount(r.length/6);var _={vbos:[{attrs:[{name:"a_vertexPosition",type:v.AttributeType.vec3f,index:0},{name:"a_vertexColor",type:v.AttributeType.vec3f,index:3}],stride:24,instanced:!1}],primitiveType:v.PrimitiveType.triangles},c=new v.Geometry(e,_);this._wireframeRendering={shader:e,geometry_frustum:h,geometry_axis:n,geometry_cross:i,geometry_cubeR:o,geometry_cubeW:s,geometry_cubeG:a,geometry_wireframe_stack_rendering:u,geometry_thick_line_stack_rendering:c}},r.prototype._initialiseTextRendering=function(){for(var e=new d({vertexSrc:"\n\nprecision mediump float;\n\nuniform mat4 u_modelviewMatrix;\nuniform mat4 u_projectionMatrix;\n\n\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nattribute vec2 a_offsetPosition;\nattribute vec2 a_offsetTexCoord;\nattribute float a_offsetScale;\n\nvarying vec2 v_texCoord;\n\nvoid main(void)\n{\n    vec2 position = a_position * a_offsetScale + a_offsetPosition;\n\n    gl_Position = u_projectionMatrix * u_modelviewMatrix * vec4(position, 0.0, 1.0);\n\n    v_texCoord = a_texCoord + a_offsetTexCoord;\n}\n",fragmentSrc:"\n\nprecision mediump float;\n\nuniform sampler2D u_texture;\n\nvarying vec2 v_texCoord;\n\nvoid main(void)\n{\n    gl_FragColor = texture2D(u_texture, v_texCoord);\n}\n\n",attributes:["a_position","a_texCoord","a_offsetPosition","a_offsetTexCoord","a_offsetScale"],uniforms:["u_modelviewMatrix","u_projectionMatrix","u_texture"]}),t={vbos:[{attrs:[{name:"a_position",type:v.AttributeType.vec2f,index:0},{name:"a_texCoord",type:v.AttributeType.vec2f,index:2}],stride:16,instanced:!1},{attrs:[{name:"a_offsetPosition",type:v.AttributeType.vec2f,index:0},{name:"a_offsetTexCoord",type:v.AttributeType.vec2f,index:2},{name:"a_offsetScale",type:v.AttributeType.float,index:4}],stride:20,instanced:!0}],primitiveType:v.PrimitiveType.triangles},r=new v.Geometry(e,t),n=[256,256],i=[16,16],o=[n[0]/i[0],n[1]/i[1]],s=[o[0]/n[0],o[1]/n[1]],a=[[[+o[0],0],[s[0],s[1]]],[[0,0],[0,s[1]]],[[+o[0],+o[1]],[s[0],0]],[[0,+o[1]],[0,0]]],u=[],h=0,_=[1,0,2,1,3,2];h<_.length;h++){var c=a[_[h]];u.push(c[0][0],c[0][1],c[1][0],c[1][1])}r.updateBuffer(0,u),r.setPrimitiveCount(u.length/4);var f=new Map([[" ",[0*s[0],0*s[1]]],["!",[1*s[0],0*s[1]]],['"',[2*s[0],0*s[1]]],["#",[3*s[0],0*s[1]]],["$",[4*s[0],0*s[1]]],["%",[5*s[0],0*s[1]]],["&",[6*s[0],0*s[1]]],["'",[7*s[0],0*s[1]]],["(",[8*s[0],0*s[1]]],[")",[9*s[0],0*s[1]]],["*",[10*s[0],0*s[1]]],["+",[11*s[0],0*s[1]]],[",",[12*s[0],0*s[1]]],["-",[13*s[0],0*s[1]]],[".",[14*s[0],0*s[1]]],["/",[15*s[0],0*s[1]]],["0",[0*s[0],1*s[1]]],["1",[1*s[0],1*s[1]]],["2",[2*s[0],1*s[1]]],["3",[3*s[0],1*s[1]]],["4",[4*s[0],1*s[1]]],["5",[5*s[0],1*s[1]]],["6",[6*s[0],1*s[1]]],["7",[7*s[0],1*s[1]]],["8",[8*s[0],1*s[1]]],["9",[9*s[0],1*s[1]]],[":",[10*s[0],1*s[1]]],[";",[11*s[0],1*s[1]]],["<",[12*s[0],1*s[1]]],["=",[13*s[0],1*s[1]]],[">",[14*s[0],1*s[1]]],["?",[15*s[0],1*s[1]]],["@",[0*s[0],2*s[1]]],["A",[1*s[0],2*s[1]]],["B",[2*s[0],2*s[1]]],["C",[3*s[0],2*s[1]]],["D",[4*s[0],2*s[1]]],["E",[5*s[0],2*s[1]]],["F",[6*s[0],2*s[1]]],["G",[7*s[0],2*s[1]]],["H",[8*s[0],2*s[1]]],["I",[9*s[0],2*s[1]]],["J",[10*s[0],2*s[1]]],["K",[11*s[0],2*s[1]]],["L",[12*s[0],2*s[1]]],["M",[13*s[0],2*s[1]]],["N",[14*s[0],2*s[1]]],["O",[15*s[0],2*s[1]]],["P",[0*s[0],3*s[1]]],["Q",[1*s[0],3*s[1]]],["R",[2*s[0],3*s[1]]],["S",[3*s[0],3*s[1]]],["T",[4*s[0],3*s[1]]],["U",[5*s[0],3*s[1]]],["V",[6*s[0],3*s[1]]],["W",[7*s[0],3*s[1]]],["X",[8*s[0],3*s[1]]],["Y",[9*s[0],3*s[1]]],["Z",[10*s[0],3*s[1]]],["[",[11*s[0],3*s[1]]],["\\",[12*s[0],3*s[1]]],["]",[13*s[0],3*s[1]]],["^",[14*s[0],3*s[1]]],["_",[15*s[0],3*s[1]]],["`",[0*s[0],4*s[1]]],["a",[1*s[0],4*s[1]]],["b",[2*s[0],4*s[1]]],["c",[3*s[0],4*s[1]]],["d",[4*s[0],4*s[1]]],["e",[5*s[0],4*s[1]]],["f",[6*s[0],4*s[1]]],["g",[7*s[0],4*s[1]]],["h",[8*s[0],4*s[1]]],["i",[9*s[0],4*s[1]]],["j",[10*s[0],4*s[1]]],["k",[11*s[0],4*s[1]]],["l",[12*s[0],4*s[1]]],["m",[13*s[0],4*s[1]]],["n",[14*s[0],4*s[1]]],["o",[15*s[0],4*s[1]]],["p",[0*s[0],5*s[1]]],["q",[1*s[0],5*s[1]]],["r",[2*s[0],5*s[1]]],["s",[3*s[0],5*s[1]]],["t",[4*s[0],5*s[1]]],["u",[5*s[0],5*s[1]]],["v",[6*s[0],5*s[1]]],["w",[7*s[0],5*s[1]]],["x",[8*s[0],5*s[1]]],["y",[9*s[0],5*s[1]]],["z",[10*s[0],5*s[1]]],["{",[11*s[0],5*s[1]]],["|",[12*s[0],5*s[1]]],["}",[13*s[0],5*s[1]]],["~",[14*s[0],5*s[1]]]]);this._textRendering={characterSize:16,texture:new m,shader:e,geometry:r,TexCoordMap:f,stack_vertices:[]}},r.prototype.chunkIsVisible=function(e){var t=.5*this._def.chunkSize;return this._frustumCulling.cubeInFrustum(e[0]+t,e[1]+t,e[2]+t,t)},r.prototype.pointIsVisible=function(e){return this._frustumCulling.pointInFrustum(e[0],e[1],e[2])},r.prototype.addGeometry=function(e){var t=new v.Geometry(this._chunkRendering.shader,this._chunkRendering.geometryDefinition);return t.updateBuffer(0,e),t.setPrimitiveCount(e.length/12),t},r.prototype.updateGeometry=function(e,t){e.updateBuffer(0,t)},r.prototype.getCameraPosition=function(){return this._freeFlyCamera.getPosition()},r.prototype.getFreeFlyCamera=function(){return this._freeFlyCamera},r.prototype.getCharacterSize=function(){return this._textRendering.characterSize},r.prototype.resize=function(e,t){var r=l.getViewportSize();r[0]=e,r[1]=t,this._aspectRatio=.75*r[0]/r[1];var n=V(70,this._aspectRatio,.1,40);this._wireframeRendering.geometry_frustum.updateBuffer(0,n),this._wireframeRendering.geometry_frustum.setPrimitiveCount(n.length/6)},r.prototype.toggleContextLoss=function(){var e=l.getContext(),t=l.getExtensionLoseContext();t&&(e.isContextLost()?t.restoreContext():t.loseContext())},r.prototype.contextIsLost=function(){return l.getContext().isContextLost()},r.prototype.setOnContextLost=function(e){this.onContextLost=e},r.prototype.setOnContextRestored=function(e){this.onContextRestored=e},r.prototype.init=function(){return e(this,void 0,void 0,(function(){var e;return t(this,(function(t){switch(t.label){case 0:return(e=l.getContext()).clearColor(0,0,0,1),e.enable(e.DEPTH_TEST),e.activeTexture(e.TEXTURE0),[4,this._chunkRendering.texture.load("assets/texture.png")];case 1:return t.sent(),[4,this._textRendering.texture.load("assets/ascii_font.png")];case 2:return t.sent(),[2]}}))}))},r.prototype.getSize=function(){var e=l.getViewportSize();return[e[0],e[1]]},r.prototype.update=function(e,t){var r=l.getViewportSize();this._freeFlyCamera.update(e),C(this._projectionMatrix,70,this._aspectRatio,.1,70),this._freeFlyCamera.updateViewMatrix(this._modelviewMatrix),this._frustumCulling.calculateFrustum(this._projectionMatrix,this._modelviewMatrix);for(var n=[0,0,.75*r[0],r[1]],i=0,o=t;i<o.length;i++){var s=o[i];if(s.visible=this.chunkIsVisible(s.position),s.coord2d=null,this.pointIsVisible(s.position)){var a=W(s.position,this._modelviewMatrix,this._projectionMatrix,n);a&&(s.coord2d=a)}}},r.prototype.pushText=function(e,t,r){for(var n=[256,256],i=[this._textRendering.characterSize,this._textRendering.characterSize],o=[n[0]/i[0],n[1]/i[1]],s=[t[0],t[1]],a=0;a<e.length;++a){var u=e[a];if("\n"!=u){var h=this._textRendering.TexCoordMap.get(u);if(!h)throw new Error("fail to find a letter, letter="+u);this._textRendering.stack_vertices.push(s[0],s[1],h[0],h[1],r),s[0]+=o[0]*r}else s[0]=t[0],s[1]-=o[1]*r}},r.prototype.renderScene=function(e){var t=l.getContext(),r=l.getViewportSize();t.viewport(0,0,.75*r[0],r[1]),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),this._chunkRendering.shader.bind(),this._chunkRendering.texture.bind(),t.uniform1i(this._chunkRendering.shader.getUniform("u_sampler"),0),t.uniformMatrix4fv(this._chunkRendering.shader.getUniform("u_modelviewMatrix"),!1,this._modelviewMatrix),t.uniformMatrix4fv(this._chunkRendering.shader.getUniform("u_projMatrix"),!1,this._projectionMatrix);var n=this._freeFlyCamera.getPosition();t.uniform3f(this._chunkRendering.shader.getUniform("u_cameraPos"),n[0],n[1],n[2]);for(var i=0;i<e.length;++i)e[i].visible&&e[i].geometry.render();this._wireframeRendering.shader.bind(),t.uniformMatrix4fv(this._wireframeRendering.shader.getUniform("u_projMatrix"),!1,this._projectionMatrix),t.uniformMatrix4fv(this._wireframeRendering.shader.getUniform("u_modelviewMatrix"),!1,this._modelviewMatrix);var o=x();for(i=0;i<e.length;++i)e[i].visible&&(w(o,this._modelviewMatrix,e[i].position),t.uniformMatrix4fv(this._wireframeRendering.shader.getUniform("u_modelviewMatrix"),!1,o),this._wireframeRendering.geometry_cubeW.render());d.unbind()},r.prototype.renderHUD=function(e,t,r,n){var i=l.getContext(),o=l.getViewportSize();this._wireframeRendering.shader.bind(),i.clear(i.DEPTH_BUFFER_BIT),this._renderMainHud(e,r,n,t),this._wireframeRendering.shader.bind();var s=.25*o[0],a=.33*o[1],u=.75*o[0];this._renderSideHud(e,t,[u,0*a,s,a],[1,1.2,1],[0,0,1]),this._renderSideHud(e,t,[u,1*a,s,a],[0,1,0],[0,0,1]),this._renderSideHud(e,t,[u,2*a,s,a],[0,0,1],[0,1,0]),d.unbind()},r.prototype._renderMainHud=function(e,t,r,n){var i=this,o=l.getContext(),s=l.getViewportSize(),a=.75*s[0],u=s[1];o.viewport(0,0,a,u);var h=x();E(h,.5*-a,.5*+a,.5*-u,.5*+u,-200,200);var _=x();P(_,[.5*+a,.5*+u,1],[.5*+a,.5*+u,0],[0,1,0]),o.uniformMatrix4fv(this._wireframeRendering.shader.getUniform("u_modelviewMatrix"),!1,_),o.uniformMatrix4fv(this._wireframeRendering.shader.getUniform("u_projMatrix"),!1,h);var c=[100,50],f=[10,s[1]-10-c[1]],d=[],v=1/30;d.push(f[0],f[1],0,1,1,1),d.push(f[0]+c[0],f[1],0,1,1,1),d.push(f[0]+c[0],f[1],0,1,1,1),d.push(f[0]+c[0],f[1]+c[1],0,1,1,1),d.push(f[0]+c[0],f[1]+c[1],0,1,1,1),d.push(f[0],f[1]+c[1],0,1,1,1),d.push(f[0],f[1]+c[1],0,1,1,1),d.push(f[0],f[1],0,1,1,1);for(var g=1;g<r.length;++g){var p=(g-1)/r.length,y=g/r.length,w=Math.min(r[g-1],v)/v,b=Math.min(r[g],v)/v;d.push(f[0]+c[0]*p,f[1]+c[1]*w,0,1,1,1),d.push(f[0]+c[0]*y,f[1]+c[1]*b,0,1,1,1)}for(var k=0,C=0,R=r;C<R.length;C++){k+=R[C]}var S=1/(k/=r.length),M="999";S<999&&(M=S.toFixed(0).padStart(3," ")),this.pushText(M+"fps",[f[0],f[1]-this._textRendering.characterSize],1),this._wireframeRendering.geometry_wireframe_stack_rendering.updateBuffer(0,d),this._wireframeRendering.geometry_wireframe_stack_rendering.setPrimitiveCount(d.length/6),this._wireframeRendering.geometry_wireframe_stack_rendering.render();var T=[],A=function(e,t,r,n,i){void 0===i&&(i=[1,1,1]),function(e,t,r,n){void 0===n&&(n=[1,1,1]);var i=Math.atan2(t[1]-e[1],t[0]-e[0])+.5*Math.PI,o=Math.cos(i)*r*.5,s=Math.sin(i)*r*.5,a=[[e[0]-o,e[1]-s],[e[0]+o,e[1]+s],[t[0]-o,t[1]-s],[t[0]+o,t[1]+s]];T.push(a[0][0],a[0][1],0,n[0],n[1],n[2]),T.push(a[3][0],a[3][1],0,n[0],n[1],n[2]),T.push(a[2][0],a[2][1],0,n[0],n[1],n[2]),T.push(a[0][0],a[0][1],0,n[0],n[1],n[2]),T.push(a[1][0],a[1][1],0,n[0],n[1],n[2]),T.push(a[3][0],a[3][1],0,n[0],n[1],n[2])}([e[0]-r*Math.cos(t),e[1]-r*Math.sin(t)],[e[0]+r*Math.cos(t),e[1]+r*Math.sin(t)],n,i)};n.length>0?(this._fpsmeterSpeed+=5e-4,this._fpsmeterSpeed>.02&&(this._fpsmeterSpeed=.02)):(this._fpsmeterSpeed-=5e-4,this._fpsmeterSpeed<0&&(this._fpsmeterSpeed=0)),this._fpsmeterAngle+=this._fpsmeterSpeed;var F=[[f[0]+c[0]+.6*c[1],f[1]+.5*c[1]],[f[0]+c[0]+.6*c[1],f[1]+.5*c[1]],[f[0]+c[0]+1.3*c[1],f[1]+.5*c[1]],[f[0]+c[0]+1.3*c[1],f[1]+.5*c[1]]],D=[this._fpsmeterAngle,this._fpsmeterAngle+.5*Math.PI,-this._fpsmeterAngle+.25*Math.PI,-this._fpsmeterAngle+.75*Math.PI],I=.45*c[1],z=[1,1,1];A(F[0],D[0],I,10,z),A(F[1],D[1],I,10,z),A(F[2],D[2],I,10,z),A(F[3],D[3],I,10,z);for(var L=new Set,B=0,U=t;B<U.length;B++){var G=U[B];L.add(G.id);var W=this._touchesAngle.get(G.id);void 0===W&&(W=0,this._touchesAngle.set(G.id,W));z=[1,0,0],D=[W,W+.5*Math.PI];this._freeFlyCamera.getForceForward()&&(D.push(W+.25*Math.PI),D.push(W+.75*Math.PI));for(var O=0,V=D;O<V.length;O++){var H=V[O];A([G.x,G.y],H,150,15,z)}W+=.1,this._touchesAngle.set(G.id,W)}var N=new Set;this._touchesAngle.forEach((function(e,t){L.has(t)||N.add(t)})),N.forEach((function(e){i._touchesAngle.delete(e)})),this._wireframeRendering.geometry_thick_line_stack_rendering.updateBuffer(0,T),this._wireframeRendering.geometry_thick_line_stack_rendering.setPrimitiveCount(T.length/6),this._wireframeRendering.geometry_thick_line_stack_rendering.render(),this._textRendering.shader.bind(),this._textRendering.texture.bind(),o.uniformMatrix4fv(this._textRendering.shader.getUniform("u_modelviewMatrix"),!1,_),o.uniformMatrix4fv(this._textRendering.shader.getUniform("u_projectionMatrix"),!1,h),this._textRendering.geometry.updateBuffer(1,this._textRendering.stack_vertices,!0),this._textRendering.geometry.setInstancedCount(this._textRendering.stack_vertices.length/5),this._textRendering.geometry.render(),m.unbind(),this._textRendering.stack_vertices.length=0},r.prototype._renderSideHud=function(e,t,r,n,i){var o=l.getContext();o.viewport(r[0],r[1],r[2],r[3]);var s=x(),a=r[2]/r[3];E(s,-65*a,65*a,-65,65,-200,200);var u=this._freeFlyCamera.getPosition(),h=x();P(h,[u[0]+n[0],u[1]+n[1],u[2]+n[2]],u,i),o.uniformMatrix4fv(this._wireframeRendering.shader.getUniform("u_modelviewMatrix"),!1,h),o.uniformMatrix4fv(this._wireframeRendering.shader.getUniform("u_projMatrix"),!1,s),this._wireframeRendering.geometry_axis.render();for(var _=x(),c=0;c<e.length;++c){var f=e[c].position;if(y(_),e[c].visible)w(_,h,f),o.uniformMatrix4fv(this._wireframeRendering.shader.getUniform("u_modelviewMatrix"),!1,_),this._wireframeRendering.geometry_cubeW.render();else w(_,h,[f[0]+.15*this._def.chunkSize,f[1]+.15*this._def.chunkSize,f[2]+.15*this._def.chunkSize]),b(_,_,[.7,.7,.7]),o.uniformMatrix4fv(this._wireframeRendering.shader.getUniform("u_modelviewMatrix"),!1,_),this._wireframeRendering.geometry_cubeR.render()}if(t.length>0)for(c=0;c<t.length;++c)w(_,h,[t[c][0]+.2*this._def.chunkSize,t[c][1]+.2*this._def.chunkSize,t[c][2]+.2*this._def.chunkSize]),b(_,_,[.6,.6,.6]),o.uniformMatrix4fv(this._wireframeRendering.shader.getUniform("u_modelviewMatrix"),!1,_),this._wireframeRendering.geometry_cubeG.render();w(h,h,this._freeFlyCamera.getPosition()),k(h,h,this._freeFlyCamera.getTheta()*Math.PI/180,[0,0,1]),k(h,h,this._freeFlyCamera.getPhi()*Math.PI/180,[0,-1,0]),o.uniformMatrix4fv(this._wireframeRendering.shader.getUniform("u_modelviewMatrix"),!1,h),this._wireframeRendering.geometry_cross.render(),this._wireframeRendering.geometry_frustum.render()},r}(),N=function(){function r(){var e=this;this._touches=[],this._chunksCreated=0,this._chunksDiscarded=0,this._currFrameTime=-1,this._framesDuration=[];var t=document.getElementById("main-canvas");if(!t)throw new Error("main-canvas not found");this._renderer=new H({canvasDomElement:t,chunkSize:n,mouseSensitivity:s,movingSpeed:o,keyboardSensitivity:a}),this._renderer.getFreeFlyCamera().setPosition(n/4*3,n/4*3,0),this._chunkGenerator=new f({chunkSize:n,chunkRange:i,workerTotal:h,workerFile:u,workerBufferSize:_,chunkIsVisible:function(t){return e._renderer.chunkIsVisible(t)},pointIsVisible:function(t){return e._renderer.pointIsVisible(t)},addGeometry:function(t){return e._renderer.addGeometry(t)},updateGeometry:function(t,r){e._renderer.updateGeometry(t,r)},onChunkCreated:function(){++e._chunksCreated},onChunkDiscarded:function(){++e._chunksDiscarded}});var r=function(t){var r=t.targetTouches,n=e._renderer.getSize();e._touches.length=0;for(var i=0;i<r.length;++i)e._touches.push({id:r[i].identifier,x:r[i].pageX,y:n[1]-r[i].pageY})};t.addEventListener("touchstart",r),t.addEventListener("touchend",r),t.addEventListener("touchmove",r);var c=document.getElementById("gui_fullscreen");if(!c)throw new Error("guiFullscreen not found");c.addEventListener("click",(function(){t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullscreen?t.webkitRequestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.msRequestFullscreen&&t.msRequestFullscreen()}));var l=function(){var r=null,n=null;null!==document.fullscreenElement||document.mozFullScreen||document.webkitIsFullScreen||document.msFullscreenElement?(t.style.position="absolute",r=window.innerWidth,n=window.innerHeight):(t.style.position="relative",r=800,n=600),t.style.left="0px",t.style.top="0px",t.width=r,t.height=n,e._renderer.resize(r,n)};document.addEventListener("fullscreenchange",l,!1),document.addEventListener("mozfullscreenchange",l,!1),document.addEventListener("webkitfullscreenchange",l,!1),document.addEventListener("msfullscreenchange",l,!1),this._running=!1,this._errorGraphicContext=!1,this._renderer.setOnContextLost((function(){console.log("on_context_lost"),e._errorGraphicContext=!0,e.stop()})),this._renderer.setOnContextRestored((function(){console.log("on_context_restored"),e._errorGraphicContext=!1,e.start()}))}return r.prototype.init=function(){return e(this,void 0,void 0,(function(){return t(this,(function(e){switch(e.label){case 0:return[4,this._renderer.init()];case 1:return e.sent(),[2]}}))}))},r.prototype.start=function(){this.isRunning()||(this._running=!0,this._chunkGenerator.start(),this._tick())},r.prototype.stop=function(){this._running=!1,this._chunkGenerator.stop()},r.prototype.isRunning=function(){return this._running&&!this._errorGraphicContext},r.prototype._tick=function(){var e=this,t=function(){e._running&&!e._errorGraphicContext&&(e._mainLoop(),window.requestAnimationFrame(t))};t()},r.prototype._mainLoop=function(){var e=Date.now(),t=e-this._currFrameTime;this._currFrameTime=e,this._framesDuration.push(t/1e3);var r=this._renderer.getCameraPosition();this._chunkGenerator.update(r);var i=this._chunkGenerator.getChunks();this._renderer.update(t/1e3,i),this._renderer.renderScene(i);for(var o=[Math.floor(r[0]/n),Math.floor(r[1]/n),Math.floor(r[2]/n)],s=0,a=0,u=i;a<u.length;a++){u[a].visible&&++s}for(var h=[10,10],_=["Chunks:",">Generated: "+this._chunksCreated,">Discarded: "+this._chunksDiscarded,">Live:      "+(this._chunksCreated-this._chunksDiscarded),">Visible:   "+s,"","Coordinates: "+o[0]+"/"+o[1]+"/"+o[2]],c=this._renderer.getCharacterSize(),f=0;f<_.length;++f)this._renderer.pushText(_[f],[h[0],h[1]+c*(6-f)],1);var l=this._renderer.getFreeFlyCamera().getTimeImmobile();if(l>3){var d=l>5?1:(l-3)/2,m=this._renderer.getSize();m[0]=.75*m[0];var v=["         *---*         ","         |W/Z|         ","         *---*         ","                       ","   *---* *---* *---*   ","   |A/Q| | S | | D |   ","   *---* *---* *---*   ","","        *----*         ","        | UP |         ","        *----*         ","                       "," *----* *----* *-----* "," |LEFT| |DOWN| |RIGHT| "," *----* *----* *-----* ","","   *---------------*   ","   |MOUSE SUPPORTED|   ","   *---------------*   ","","*---------------------*","|TOUCHSCREEN SUPPORTED|","*---------------------*"],g=0;v.forEach((function(e){return g=Math.max(g,e.length)})),g*=this._renderer.getCharacterSize()*d;var p=v.length*this._renderer.getCharacterSize()*d,x=v.join("\n"),y=[.5*m[0]-.5*g,.5*m[1]+.5*p];this._renderer.pushText(x,y,d)}this._renderer.renderHUD(this._chunkGenerator.getChunks(),this._chunkGenerator.getProcessingPositions(),this._touches,this._framesDuration),this._framesDuration.length>100&&this._framesDuration.splice(0,this._framesDuration.length-100)},r}();window.onerror=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];alert(JSON.stringify(e))};e(void 0,void 0,void 0,(function(){var e,r,n;return t(this,(function(t){switch(t.label){case 0:return[4,(e=new N).init()];case 1:if(t.sent(),e.start(),(r=document.getElementById("touch_id"))&&("ontouchstart"in window?r.innerHTML+="Supported":r.innerHTML+="Not Supported"),!(n=document.getElementById("gui_toggle_start")))throw new Error("gui_toggle_start not found");return n.addEventListener("click",(function(){console.log("toggle_start"),e.isRunning()?e.stop():e.start()})),[2]}}))}));
